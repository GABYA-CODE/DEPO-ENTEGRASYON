<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GABYA HOME</title>

  <style>
    *{box-sizing:border-box}
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel2:#f9fafb;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;
      --green:#00c853;
      --green2:#00b84c;
      --danger:#ef4444;
      --danger2:#dc2626;
      --input:#ffffff;
      --shadow:0 18px 50px rgba(2,6,23,.12);
      --shadow2:0 10px 30px rgba(2,6,23,.10);
      --amber:#f59e0b;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* LOGIN */
    .center{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .loginCard{
      width:min(520px,96vw);
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:28px;
    }
    .title{
      text-align:center;
      font-weight:900;
      font-size:42px;
      letter-spacing:.5px;
      margin:0 0 8px;
      color:var(--text);
    }
    .subtitle{
      text-align:center;
      font-weight:900;
      font-size:22px;
      margin:0 0 18px;
      color:var(--text);
    }

    .fieldLabel{
      font-weight:900;
      letter-spacing:.8px;
      color:var(--muted);
      margin:0 0 6px;
      text-transform:uppercase;
      font-size:18px;
    }
    .input{
      width:100%;
      padding:14px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--input);
      color:var(--text);
      font-size:18px;
      outline:none;
      box-shadow:0 1px 0 rgba(2,6,23,.03) inset;
    }
    .input:focus{
      border-color:rgba(0,200,83,.55);
      box-shadow:0 0 0 3px rgba(0,200,83,.15);
    }

    .btn{
      width:100%;
      padding:16px 16px;
      border:0;
      border-radius:12px;
      background:var(--green);
      color:#07210f;
      font-weight:900;
      letter-spacing:1px;
      font-size:22px;
      cursor:pointer;
      margin-top:14px;
      box-shadow:0 10px 20px rgba(0,200,83,.18);
    }
    .btn:hover{ background:var(--green2); }
    .btn:active{ transform:translateY(1px); }

    .note{
      margin-top:14px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      color:var(--muted);
      font-weight:800;
      font-size:16px;
      text-align:center;
    }
    .note.error{
      background:rgba(239,68,68,.08);
      border-color:rgba(239,68,68,.25);
      color:#7f1d1d;
    }
    .note.ok{
      background:rgba(0,200,83,.10);
      border-color:rgba(0,200,83,.22);
      color:#065f46;
    }
    .note.warn{
      background:rgba(245,158,11,.12);
      border-color:rgba(245,158,11,.25);
      color:#7c2d12;
    }

    /* APP */
    .appWrap{ padding:18px; display:none; }
    .appPanel{
      width:min(1200px,98vw);
      margin:0 auto;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .appHeader{
      text-align:center;
      font-weight:1000;
      font-size:44px;
      letter-spacing:.5px;
      padding:22px 14px 8px;
      margin:0;
      color:var(--text);
    }
    .roleLine{
      text-align:center;
      margin:0 0 12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.6px;
    }

    .tabbar{
      display:flex;
      gap:0;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin; /* Firefox: show thin scrollbar */
      scrollbar-color: rgba(0,0,0,.12) transparent;
      -ms-overflow-style: auto; /* IE 10+ */
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      background:var(--panel2);
      scroll-behavior: smooth;
    }
    .tabbar::-webkit-scrollbar{ height:6px; }
    .tabbar::-webkit-scrollbar-track{ background: transparent; }
    .tabbar::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.12); border-radius:4px; }
    @media (max-width: 900px){
      .tabbar{ /* keep horizontal scroll on small screens */ }
      .tabbar .logoutBtn{ margin-left:auto; }
    }
    .tab{
      flex:1;
      padding:16px 10px;
      text-align:center;
      font-weight:1000;
      letter-spacing:1px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      font-size:18px;
      border-right:1px solid var(--border);
    }
    .tab:last-child{ border-right:0; }
    .tab.active{
      background:rgba(0,200,83,.14);
      color:#064e3b;
      box-shadow: inset 0 -3px 0 rgba(0,200,83,.55);
    }
    #logoutBtn:hover{
      background:rgba(239,68,68,.08);
    }
    #logoutBtn:hover svg{
      color:var(--danger);
    }

    .content{ padding:18px; background:var(--bg); }
    .sectionTitle{
      text-align:center;
      font-weight:1000;
      font-size:26px;
      margin:8px 0 14px;
      color:var(--text);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow:var(--shadow2);
      height:100%;
    }
    .card h3{
      margin:0 0 12px;
      text-align:center;
      font-weight:1000;
      font-size:22px;
      color:var(--text);
    }

    .actionBtn{
      width:100%;
      padding:16px 14px;
      border:0;
      border-radius:14px;
      background:var(--green);
      color:#07210f;
      font-weight:1000;
      letter-spacing:1px;
      font-size:20px;
      cursor:pointer;
      margin-top:10px;
      box-shadow:0 10px 18px rgba(0,200,83,.14);
    }
    .actionBtn:hover{ background:var(--green2); }
    .actionBtn.red{
      background:var(--danger);
      color:#1b0707;
      box-shadow:0 10px 18px rgba(239,68,68,.14);
    }
    .actionBtn.red:hover{ background:var(--danger2); }

    .statusBox{
      margin-top:12px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      font-size:16px;
      font-weight:900;
      color:var(--muted);
      min-height:56px;
      display:flex;
      align-items:center;
    }
    .statusBox.ok{
      background:rgba(0,200,83,.10);
      border-color:rgba(0,200,83,.22);
      color:#065f46;
    }
    .statusBox.error{
      background:rgba(239,68,68,.08);
      border-color:rgba(239,68,68,.22);
      color:#7f1d1d;
    }
    .statusBox.warn{
      background:rgba(245,158,11,.12);
      border-color:rgba(245,158,11,.25);
      color:#7c2d12;
    }

    .searchRow{
      display:grid;
      grid-template-columns: 1fr 180px;
      gap:12px;
    }
    @media (max-width: 720px){
      .searchRow{ grid-template-columns: 1fr; }
    }
    .searchBtn{
      width:100%;
      padding:14px 14px;
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--panel2);
      color:var(--text);
      font-weight:1000;
      font-size:18px;
      cursor:pointer;
    }
    .searchBtn:hover{ background:#eef2f7; }

    .hintLine{
      text-align:center;
      margin-top:8px;
      color:var(--muted);
      font-weight:800;
      word-break:break-word;
      font-size:14px;
    }

    .subBox{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--panel2);
      display:none;
    }
    .subTitle{
      font-weight:1000;
      margin:0 0 10px;
      text-align:center;
      color:var(--text);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:12px;
      font-size:15px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
    }
    th, td{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
      color:var(--text);
    }
    th{
      background:var(--panel2);
      font-weight:1000;
      letter-spacing:.6px;
      color:var(--muted);
      text-transform:uppercase;
      font-size:12px;
    }
    tr:last-child td{ border-bottom:0; }

    .tableWrap{
      max-height:460px;
      overflow:auto;
      border-radius:14px;
      margin-top:10px;
    }

    .badge{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      line-height:22px;
      border:1px solid transparent;
    }
    .b-admin{ background:rgba(2,6,23,.06); color:#0f172a; border-color:rgba(2,6,23,.10); }
    .b-packer{ background:rgba(245,158,11,.14); color:#7c2d12; border-color:rgba(245,158,11,.22); }
    .b-stower{ background:rgba(59,130,246,.12); color:#1e3a8a; border-color:rgba(59,130,246,.18); }
    .b-welder{ background:rgba(139,92,246,.12); color:#5b21b6; border-color:rgba(139,92,246,.20); }
    .b-empty{ background:rgba(0,200,83,.12); color:#065f46; border-color:rgba(0,200,83,.20); }
    .b-full{ background:rgba(239,68,68,.10); color:#7f1d1d; border-color:rgba(239,68,68,.20); }

    .setupBox{
      margin-top:14px;
      padding:14px;
      border-radius:16px;
      border:1px dashed rgba(100,116,139,.45);
      background:var(--panel2);
      display:none;
    }
    .setupTitle{
      font-weight:1000;
      font-size:16px;
      margin:0 0 10px;
      text-align:center;
      color:var(--text);
    }
    .setupRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:720px){
      .setupRow{ grid-template-columns:1fr; }
    }
    .setupBtn{
      margin-top:10px;
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#eef2f7;
      color:var(--text);
      font-weight:1000;
      font-size:16px;
      cursor:pointer;
    }
    .setupBtn:hover{ background:#e7edf6; }

    /* ADMIN SUMMARY */
    .statsGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){
      .statsGrid{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      .statsGrid{ grid-template-columns: 1fr; }
    }
    .stat{
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--panel2);
      padding:14px;
    }
    .stat .k{
      font-weight:1000;
      letter-spacing:.8px;
      color:var(--muted);
      text-transform:uppercase;
      font-size:12px;
    }
    .stat .v{
      margin-top:6px;
      font-weight:1000;
      font-size:26px;
      color:var(--text);
    }

    .adminRow{
      display:grid;
      grid-template-columns: 1fr 180px;
      gap:12px;
    }
    @media (max-width: 720px){
      .adminRow{ grid-template-columns: 1fr; }
    }

    .b-wait{ background:rgba(100,116,139,.12); color:#334155; border-color:rgba(100,116,139,.18); }
    .b-done{ background:rgba(0,200,83,.12); color:#065f46; border-color:rgba(0,200,83,.20); }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 4px 0;
      z-index: 10000;
      min-width: 150px;
      display: none;
    }
    .context-menu-item {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s;
    }
    .context-menu-item:hover {
      background: rgba(59,130,246,.08);
    }
    .context-menu-item.danger {
      color: #dc2626;
    }
    .context-menu-item.danger:hover {
      background: rgba(239,68,68,.08);
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div class="center" id="loginView">
    <div class="loginCard">
      <h1 class="title">Gabya Home</h1>

      <input id="pwInput" class="input" type="password" placeholder="Şifreyi girin" />

      <button class="btn" id="loginBtn" type="button">GİRİŞ YAP</button>

      <div class="note" id="loginNote" style="display:none;"></div>
    </div>
  </div>

  <!-- APP -->
  <div class="appWrap" id="appView">
    <div class="appPanel">
      <div style="display:grid;grid-template-columns:auto 1fr auto;align-items:center;padding:0 18px;">
        <button id="logoutBtn" style="background:none;border:none;cursor:pointer;padding:8px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:background .2s;" title="Çıkış Yap">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#64748b;">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </button>
        <h1 class="appHeader" style="margin:0;text-align:center;">GABYA HOME</h1>
        <div style="width:44px;"></div>
      </div>
      <div class="roleLine" id="roleLine"></div>

      <!-- Context Menu -->
      <div id="contextMenu" class="context-menu">
        <div class="context-menu-item danger" id="contextMenuDelete">Talebi Sil</div>
      </div>

      <div class="tabbar" id="tabbar">
        <div class="tab" id="tabPut">RAFA ÜRÜN KOY</div>
        <div class="tab" id="tabClear">RAF BOŞALT</div>
        <div class="tab" id="tabSearch">ÜRÜN ARA</div>
        <div class="tab" id="tabRack">RAF DURUMU</div>
        <div class="tab" id="tabRequest">ÜRÜN TALEP</div>
        <div class="tab" id="tabMaterialRequest">MALZEME TALEP</div>
        <div class="tab" id="tabWelder">ÜRETİM GİRİŞİ</div>
        <div class="tab" id="tabWelderRequests">TALEPLER</div>
        <div class="tab" id="tabProduction">ÜRETİM KAYITLARI</div>
        <div class="tab" id="tabPurchase">SATIN ALMA</div>
        <div class="tab" id="tabInstructions">ÜRETİM TALİMATLARI</div>
        <div class="tab" id="tabPackaging">PAKETLEME TALİMATLARI</div>
        <div class="tab" id="tabAdmin">YÖNETİCİ</div>
      </div>

      <div class="content">

        <!-- VIEW: PUT -->
        <div id="viewPut" style="display:none;">
          <div class="sectionTitle"></div>
          <div class="card">
            <h3></h3>

            <label class="fieldLabel">Ürün Kodu</label>
            <input id="inProduct" class="input" />

            <label class="fieldLabel">Raf Numarası</label>
            <input id="inShelfNum" class="input" type="number" min="1" />

            <label class="fieldLabel">Adet</label>
            <input id="inQty" class="input" type="number" min="1" value="1" />

            <button class="actionBtn" id="btnPut" type="button">ÜRÜNÜ RAFA KOY</button>

            <div class="statusBox" id="statusPut" style="display:none;"></div>
          </div>
        </div>

        <!-- VIEW: CLEAR -->
        <div id="viewClear" style="display:none;">
          <div class="sectionTitle"></div>
          <div class="card">
            <h3></h3>

            <label class="fieldLabel">Raf Numarası</label>
            <input id="outShelfNum" class="input" type="number" min="1" />

            <div class="subBox" id="clearProductBox">
              <div class="subTitle" id="clearBoxTitle">Bu rafta birden fazla ürün var</div>

              <label class="fieldLabel">Ürün Kodu</label>
              <input id="outProductCode" class="input" />

              <!-- ✅ Adet azalt (sadece gerekli olduğunda açılır) -->
              <div id="clearQtyBox" style="display:none; margin-top:10px;">
                <label class="fieldLabel">Adet (Azalt)</label>
                <input id="outReduceQty" class="input" type="number" min="1" value="1" />
                <div class="hintLine" id="clearQtyHint"></div>
              </div>

              <div class="hintLine" id="clearHint"></div>
            </div>

            <button class="actionBtn red" id="btnClear" type="button">RAFI BOŞALT</button>

            <div class="statusBox" id="statusClear" style="display:none;"></div>
          </div>
        </div>

        <!-- VIEW: SEARCH -->
        <div id="viewSearch" style="display:none;">
          <div class="sectionTitle"></div>

          <div class="card">
            <h3 style="margin-top:0;"></h3>
            <div class="searchRow">
              <input id="searchCode" class="input" style="margin:0;" />
              <button class="searchBtn" id="btnSearch" type="button">ARA</button>
            </div>

            <div class="statusBox" id="statusSearch" style="margin-top:12px;display:none;"></div>

            <div class="tableWrap" id="searchWrap" style="display:none;">
              <table>
                <thead>
                  <tr><th>Raf</th><th>Adet</th></tr>
                </thead>
                <tbody id="searchBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: RACK STATUS -->
        <div id="viewRack" style="display:none;">
          <div class="sectionTitle"></div>

          <div class="card">
            <h3 style="margin-top:0;"></h3>

            <div class="hintLine" id="rackHint"></div>

            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Raf</th>
                    <th>Durum</th>
                    <th>Ürünler</th>
                  </tr>
                </thead>
                <tbody id="rackBody"></tbody>
              </table>
            </div>

            <div class="setupBox" id="setupBox">
              <div class="setupTitle">İlk Kurulum</div>
              <div class="setupRow">
                <input id="setupCount" class="input" type="number" min="1" value="300" style="margin:0;" />
                <input id="setupPrefix" class="input" value="R" style="margin:0;" />
              </div>
              <button class="setupBtn" id="btnSetup" type="button">RAFLARI OLUŞTUR</button>
              <div class="hintLine" id="setupStatus"></div>
            </div>
          </div>
        </div>

        <!-- VIEW: REQUEST -->
        <div id="viewRequest" style="display:none;">

          <div class="card">

            <label class="fieldLabel">Ürün Kodu</label>
            <input id="reqProduct" class="input" placeholder="" />

            <label class="fieldLabel" style="margin-top:14px;">Üretim Modeli</label>
            <select id="reqProductionType" class="input">
              <option value="">Seçiniz</option>
              <option value="welder">Kaynak</option>
              <option value="laser">Lazer</option>
            </select>

            <button class="actionBtn" id="btnReq" type="button">ÜRETİMDEN TALEP ET</button>

            <div class="statusBox" id="statusReq" style="display:none;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Üretim Taleplerim</h3>

            <div class="statusBox" id="statusReqList">Yükleniyor...</div>

            <div class="tableWrap" id="reqWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Ürün Kodu</th>
                    <th>Durum</th>
                    <th>Talep Eden</th>
                    <th>Talebi Karşılayan</th>
                  </tr>
                </thead>
                <tbody id="reqBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: PRODUCTION (For Admin & Packer) -->
        <div id="viewProduction" style="display:none;">

          <div class="card">
            <h3 style="margin-top:0;">Tüm Üretimler</h3>
            
            <div class="adminRow" style="gap:8px;">
              <button class="searchBtn" id="btnProdDay" type="button">GÜNLÜK</button>
              <button class="searchBtn" id="btnProdWeek" type="button">HAFTALIK</button>
              <button class="searchBtn" id="btnProdMonth" type="button">AYLIK</button>
              <button class="searchBtn" id="btnProdYear" type="button">YILLIK</button>
            </div>

            <div class="statusBox" id="statusProduction" style="margin-top:12px;display:none;"></div>

            <div class="tableWrap" id="productionWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih & Saat</th>
                    <th>Ürün Kodu</th>
                    <th>Adet</th>
                    <th>Üretim</th>
                  </tr>
                </thead>
                <tbody id="productionBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: WELDER -->
        <div id="viewWelder" style="display:none;">
          <div class="sectionTitle">Üretim Girişi</div>

          <div class="card">
            <h3 style="margin-top:0;">Üretilen Ürün Girişi</h3>
            
            <div class="formRow">
              <label>Ürün Kodu</label>
              <input id="welderCode" class="input" type="text" placeholder="Ürün kodu giriniz" />
            </div>

            <div class="formRow">
              <label>Adet</label>
              <input id="welderQty" class="input" type="number" min="1" placeholder="Adet giriniz" />
            </div>

            <button class="btn" id="welderSave">KAYDET</button>

            <div class="statusBox" id="statusWelder" style="display:none;margin-top:12px;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Bugünkü Üretim</h3>
            <div class="statusBox" id="statusWelderToday" style="display:none;"></div>
            <div class="tableWrap" id="welderTodayWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Saat</th>
                    <th>Ürün Kodu</th>
                    <th>Adet</th>
                  </tr>
                </thead>
                <tbody id="welderTodayBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: WELDER REQUESTS -->
        <div id="viewWelderRequests" style="display:none;">
          <div class="sectionTitle">Talepler</div>

          <div class="card">
            <h3 style="margin-top:0;">Tüm Talepler</h3>
            <div class="statusBox" id="statusWelderRequests" style="display:none;"></div>
            <div class="tableWrap" id="welderRequestsWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Ürün Kodu</th>
                    <th>Talep Eden</th>
                    <th>Durum</th>
                    <th>İşlem</th>
                  </tr>
                </thead>
                <tbody id="welderRequestsBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: MATERIAL REQUEST -->
        <div id="viewMaterialRequest" style="display:none;">

          <div class="card">

            <label class="fieldLabel">Malzeme</label>
            <input id="matReqName" class="input" placeholder="" />

            <label class="fieldLabel" style="margin-top:14px;">Adet</label>
            <input id="matReqQty" class="input" type="number" min="1" value="1" />

            <label class="fieldLabel" style="margin-top:14px;">Not</label>
            <input id="matReqNote" class="input" placeholder="Ek bilgi yazabilirsiniz" />

            <button class="actionBtn" id="btnMatReq" type="button">TALEP OLUŞTUR</button>

            <div class="statusBox" id="statusMatReq" style="display:none;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Malzeme Taleplerim</h3>

            <div class="statusBox" id="statusMatReqList">Yükleniyor...</div>

            <div class="tableWrap" id="matReqWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Malzeme</th>
                    <th>Adet</th>
                    <th>Durum</th>
                    <th>Talep Eden</th>
                    <th>Not</th>
                  </tr>
                </thead>
                <tbody id="matReqBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: PURCHASE MANAGEMENT -->
        <div id="viewPurchase" style="display:none;">

          <div class="card">
            <h3 style="margin-top:0;">Tüm Malzeme Talepleri</h3>
            
            <div class="statusBox" id="statusPurchase" style="margin-top:12px;display:none;"></div>

            <div class="tableWrap" id="purchaseWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Malzeme</th>
                    <th>Adet</th>
                    <th>Talep Eden</th>
                    <th>Not</th>
                    <th>Durum</th>
                    <th>İşlem</th>
                    <th>Not Ekle</th>
                    <th>Reddet</th>
                  </tr>
                </thead>
                <tbody id="purchaseBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: INSTRUCTIONS -->
        <div id="viewInstructions" style="display:none;">
          <div class="card">
            <h3 style="margin-top:0;">Üretim Talimatları</h3>
            
            <label class="fieldLabel">Ürün Kodu</label>
            <input id="instructionsProductCode" class="input" placeholder="Örn: 7001" />
            
            <button class="actionBtn" id="btnLoadInstructions" type="button" style="margin-top:16px;">TALİMATI GÖSTER</button>
            
            <div class="statusBox" id="statusInstructions" style="display:none;margin-top:16px;"></div>
            
            <div id="instructionsContent" style="margin-top:24px;display:none;">
              <h4 style="margin:0 0 12px 0;color:var(--text);">Üretim Talimatı</h4>
              <div id="instructionContainer" style="width:100%;min-height:600px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--panel2);display:flex;align-items:center;justify-content:center;"></div>
            </div>
          </div>
        </div>

        <!-- VIEW: PACKAGING -->
        <div id="viewPackaging" style="display:none;">
          <div class="card">
            <h3 style="margin-top:0;">Paketleme Talimatları</h3>
            
            <label class="fieldLabel">Ürün Kodu</label>
            <input id="packagingProductCode" class="input" placeholder="Örn: 7001" />
            
            <button class="actionBtn" id="btnLoadPackaging" type="button" style="margin-top:16px;">TALİMATI GÖSTER</button>
            
            <div class="statusBox" id="statusPackaging" style="display:none;margin-top:16px;"></div>
            
            <div id="packagingContent" style="margin-top:24px;display:none;">
              <h4 style="margin:0 0 12px 0;color:var(--text);">Paketleme Talimatı</h4>
              <div id="packagingContainer" style="width:100%;min-height:600px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--panel2);display:flex;align-items:center;justify-content:center;"></div>
            </div>
          </div>
        </div>

        <!-- VIEW: ADMIN -->
        <div id="viewAdmin" style="display:none;">
          <div class="sectionTitle">Yönetici Paneli</div>

          <div class="card">
            <h3 style="margin-top:0;">Özet Panel</h3>

            <div class="statsGrid" style="margin-top:10px;">
              <div class="stat"><div class="k">Toplam Raf</div><div class="v" id="stTotal">-</div></div>
              <div class="stat"><div class="k">Boş Raf</div><div class="v" id="stEmpty">-</div></div>
              <div class="stat"><div class="k">Dolu Raf</div><div class="v" id="stFull">-</div></div>
              <div class="stat"><div class="k">Toplam Ürün Adedi</div><div class="v" id="stQty">-</div></div>
            </div>

            <div class="hintLine" id="stHint" style="margin-top:10px;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Toplu Üretim Talimatı Yükleme</h3>
            
            <div style="margin-bottom:12px;color:var(--muted);font-size:14px;font-weight:800;">
              Her satıra bir ürün yazın. Format: <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">ÜrünKodu,Tip,URL</code>
              <br>Tip: <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">pdf</code>, <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">image</code> veya <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">link</code>
            </div>

            <textarea id="bulkInstructionsInput" class="input" rows="10" placeholder="Örnek:
7001,pdf,https://firebasestorage.googleapis.com/.../talimat.pdf
7002,image,https://drive.google.com/.../resim.png
7003,link,https://drive.google.com/file/d/..." style="font-family:monospace;font-size:13px;"></textarea>

            <button class="actionBtn" id="btnBulkUploadInstructions" type="button" style="margin-top:12px;">TOPLU YÜKLE</button>

            <div class="statusBox" id="statusBulkInstructions" style="display:none;margin-top:12px;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Toplu Paketleme Talimatı Yükleme</h3>
            
            <div style="margin-bottom:12px;color:var(--muted);font-size:14px;font-weight:800;">
              Her satıra bir ürün yazın. Format: <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">ÜrünKodu,Tip,URL</code>
              <br>Tip: <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">pdf</code>, <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">image</code> veya <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">link</code>
            </div>

            <textarea id="bulkPackagingInput" class="input" rows="10" placeholder="Örnek:
7001,pdf,https://firebasestorage.googleapis.com/.../paketleme.pdf
7002,image,https://drive.google.com/.../resim.png
7003,link,https://drive.google.com/file/d/..." style="font-family:monospace;font-size:13px;"></textarea>

            <button class="actionBtn" id="btnBulkUploadPackaging" type="button" style="margin-top:12px;">TOPLU YÜKLE</button>

            <div class="statusBox" id="statusBulkPackaging" style="display:none;margin-top:12px;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">İşlem Geçmişi (LOG)</h3>

            <div style="margin-bottom:12px;">
              <div style="font-weight:900;font-size:14px;color:var(--muted);margin-bottom:6px;">İŞLEM TİPİNE GÖRE FİLTRELE:</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:8px;">
                <button class="searchBtn" id="btnLogPut" type="button" style="font-size:13px;padding:10px;">RAFA KOY</button>
                <button class="searchBtn" id="btnLogClear" type="button" style="font-size:13px;padding:10px;">RAF BOŞALT</button>
                <button class="searchBtn" id="btnLogDecrease" type="button" style="font-size:13px;padding:10px;">ADET AZALT</button>
                <button class="searchBtn" id="btnLogMaterial" type="button" style="font-size:13px;padding:10px;">MALZEME TALEBİ</button>
                <button class="searchBtn" id="btnLogProduction" type="button" style="font-size:13px;padding:10px;">ÜRETİM</button>
                <button class="searchBtn" id="btnLogAllActions" type="button" style="font-size:13px;padding:10px;">TÜM İŞLEMLER</button>
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <div style="font-weight:900;font-size:14px;color:var(--muted);margin-bottom:6px;">ROLE GÖRE FİLTRELE:</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;">
                <button class="searchBtn" id="btnLogAdmin" type="button" style="font-size:13px;padding:10px;">YÖNETİCİ</button>
                <button class="searchBtn" id="btnLogPacker" type="button" style="font-size:13px;padding:10px;">PAKETÇİ</button>
                <button class="searchBtn" id="btnLogStower" type="button" style="font-size:13px;padding:10px;">RAF DİZEN</button>
                <button class="searchBtn" id="btnLogWelder" type="button" style="font-size:13px;padding:10px;">ÜRETİM</button>
                <button class="searchBtn" id="btnLogPurchase" type="button" style="font-size:13px;padding:10px;">SATIN ALMA</button>
                <button class="searchBtn" id="btnLogAllRoles" type="button" style="font-size:13px;padding:10px;">TÜM ROLLER</button>
              </div>
            </div>

            <div class="adminRow">
              <input id="logLimit" class="input" type="number" min="10" max="500" value="100" style="margin:0;" />
              <button class="searchBtn" id="btnLoadLogs" type="button">LOG YÜKLE</button>
            </div>

            <div class="statusBox" id="statusLogs" style="margin-top:12px;display:none;"></div>

            <div class="tableWrap" id="logsWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Kullanıcı</th>
                    <th>İşlem</th>
                    <th>Raf</th>
                    <th>Ürün</th>
                    <th>Adet</th>
                    <th>Detay</th>
                  </tr>
                </thead>
                <tbody id="logsBody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- LOGIN (module DIŞI) -->
  <script>
    // ====== PINLER ======
    const ADMIN_PINS = new Set(["601","602","603"]);

    const PACKER_PINS = new Set(
      Array.from({length: 9}, (_,i)=> String(2001+i))
    );

    const STOWER_PINS = new Set(
      Array.from({length: 4}, (_,i)=> String(3001+i))
    );

    const WELDER_PINS = new Set(["4001","4002","4003","4004"]);

    const LASER_PINS = new Set(["5001","5002","5003"]);

    const PURCHASE_PINS = new Set(["6001","6002"]);

    window.__SESSION = { role: null, pin: null };

    // PIN-isim eşleştirmesi
    const PIN_NAMES = {
      "601": "Burak",
      "602": "Mesut",
      "2001": "Gökmen",
      "2002": "Şaban",
      "2003": "Salim",
      "3001": "Salim",
      "4001": "Emin",
      "4002": "İlhami",
      "5001": "Emre K.",
      "6001": "Satın Alma 1",
      "6002": "Satın Alma 2"
    };

    function getNameByPin(pin){
      return PIN_NAMES[pin] || pin;
    }

    const loginView = document.getElementById("loginView");
    const appView   = document.getElementById("appView");
    const pwInput   = document.getElementById("pwInput");
    const loginBtn  = document.getElementById("loginBtn");
    const loginNote = document.getElementById("loginNote");
    const roleLine  = document.getElementById("roleLine");

    function setLoginNote(msg, type){
      loginNote.className = "note" + (type ? " " + type : "");
      loginNote.textContent = msg;
    }

    function showApp(){
      loginView.style.display="none";
      appView.style.display="block";
    }

    function showLogin(){
      appView.style.display="none";
      loginView.style.display="flex";
      pwInput.value="";
      setLoginNote("Sadece yetkili kullanıcılar erişebilir.", "");
      window.__SESSION = { role: null, pin: null };
    }

    function getRoleByPin(pin){
      if(ADMIN_PINS.has(pin)) return "admin";
      if(PACKER_PINS.has(pin)) return "packer";
      if(STOWER_PINS.has(pin)) return "stower";
      if(WELDER_PINS.has(pin)) return "welder";
      if(LASER_PINS.has(pin)) return "welder";
      if(PURCHASE_PINS.has(pin)) return "purchase";
      return null;
    }

    function roleBadge(role){
      if(role==="admin")  return `<span class="badge b-admin">YÖNETİCİ</span>`;
      if(role==="packer") return `<span class="badge b-packer">PAKETÇİ</span>`;
      if(role==="stower") return `<span class="badge b-stower">RAF DİZEN</span>`;
      if(role==="welder") return `<span class="badge b-welder">ÜRETİM</span>`;
      if(role==="purchase") return `<span class="badge b-admin">SATIN ALMA</span>`;
      return `<span class="badge">-</span>`;
    }

    function doLogin(){
      const v = (pwInput.value || "").trim();
      const role = getRoleByPin(v);

      if(!role){
        setLoginNote("Şifre yanlış.", "error");
        return;
      }

      window.__SESSION = { role, pin: v };

      setLoginNote("Giriş başarılı.", "ok");
      showApp();

      if(roleLine){
        const userName = getNameByPin(v);
        roleLine.innerHTML = `${roleBadge(role)} | ${userName}`;
      }

      if (window.startFirebase) window.startFirebase();
    }

    loginBtn.addEventListener("click", doLogin);
    pwInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") doLogin(); });

    showLogin();
  </script>

  <!-- FIREBASE + UYGULAMA (module) -->
  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyC……",
      authDomain: "depo-paketleme.firebaseapp.com",
      projectId: "depo-paketleme",
      storageBucket: "depo-paketleme.appspot.com",
      messagingSenderId: "2429493…",
      appId: "1:24294…"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, updateDoc, addDoc, deleteDoc,
      onSnapshot, serverTimestamp, writeBatch,
      getDoc, getDocs, query, limit, orderBy, where
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const tabbar   = document.getElementById("tabbar");
    const logoutBtn= document.getElementById("logoutBtn");

    const tabPut   = document.getElementById("tabPut");
    const tabClear = document.getElementById("tabClear");
    const tabSearch= document.getElementById("tabSearch");
    const tabRack  = document.getElementById("tabRack");
    const tabRequest= document.getElementById("tabRequest");
    const tabMaterialRequest= document.getElementById("tabMaterialRequest");
    const tabWelder= document.getElementById("tabWelder");
    const tabWelderRequests= document.getElementById("tabWelderRequests");
    const tabProduction= document.getElementById("tabProduction");
    const tabPurchase= document.getElementById("tabPurchase");
    const tabInstructions= document.getElementById("tabInstructions");
    const tabPackaging= document.getElementById("tabPackaging");
    const tabAdmin = document.getElementById("tabAdmin");

    const viewPut  = document.getElementById("viewPut");
    const viewClear= document.getElementById("viewClear");
    const viewSearch= document.getElementById("viewSearch");
    const viewRack = document.getElementById("viewRack");
    const viewRequest= document.getElementById("viewRequest");
    const viewMaterialRequest= document.getElementById("viewMaterialRequest");
    const viewWelder= document.getElementById("viewWelder");
    const viewWelderRequests= document.getElementById("viewWelderRequests");
    const viewProduction= document.getElementById("viewProduction");
    const viewPurchase= document.getElementById("viewPurchase");
    const viewInstructions= document.getElementById("viewInstructions");
    const viewPackaging= document.getElementById("viewPackaging");
    const viewAdmin= document.getElementById("viewAdmin");

    const inProduct  = document.getElementById("inProduct");
    const inShelfNum = document.getElementById("inShelfNum");
    const inQty      = document.getElementById("inQty");
    const btnPut     = document.getElementById("btnPut");
    const statusPut  = document.getElementById("statusPut");

    const outShelfNum     = document.getElementById("outShelfNum");
    const outProductCode  = document.getElementById("outProductCode");
    const clearProductBox = document.getElementById("clearProductBox");
    const clearHint       = document.getElementById("clearHint");
    const btnClear        = document.getElementById("btnClear");
    const statusClear     = document.getElementById("statusClear");

    // ✅ yeni alanlar (adet azalt)
    const clearBoxTitle  = document.getElementById("clearBoxTitle");
    const clearQtyBox    = document.getElementById("clearQtyBox");
    const outReduceQty   = document.getElementById("outReduceQty");
    const clearQtyHint   = document.getElementById("clearQtyHint");

    const searchCode   = document.getElementById("searchCode");
    const btnSearch    = document.getElementById("btnSearch");
    const statusSearch = document.getElementById("statusSearch");
    const searchWrap   = document.getElementById("searchWrap");
    const searchBody   = document.getElementById("searchBody");

    const rackHint  = document.getElementById("rackHint");
    const rackBody  = document.getElementById("rackBody");

    const setupBox    = document.getElementById("setupBox");
    const setupCount  = document.getElementById("setupCount");
    const setupPrefix = document.getElementById("setupPrefix");
    const btnSetup    = document.getElementById("btnSetup");
    const setupStatus = document.getElementById("setupStatus");

    const reqProduct = document.getElementById("reqProduct");
    const reqProductionType = document.getElementById("reqProductionType");
    const btnReq     = document.getElementById("btnReq");
    const statusReq  = document.getElementById("statusReq");
    const statusReqList = document.getElementById("statusReqList");
    const reqWrap    = document.getElementById("reqWrap");
    const reqBody    = document.getElementById("reqBody");

    const stTotal = document.getElementById("stTotal");
    const stEmpty = document.getElementById("stEmpty");
    const stFull  = document.getElementById("stFull");
    const stQty   = document.getElementById("stQty");
    const stHint  = document.getElementById("stHint");

    const logLimit = document.getElementById("logLimit");
    const btnLoadLogs = document.getElementById("btnLoadLogs");
    const btnLogPut = document.getElementById("btnLogPut");
    const btnLogClear = document.getElementById("btnLogClear");
    const btnLogDecrease = document.getElementById("btnLogDecrease");
    const btnLogMaterial = document.getElementById("btnLogMaterial");
    const btnLogProduction = document.getElementById("btnLogProduction");
    const btnLogAllActions = document.getElementById("btnLogAllActions");
    const btnLogAdmin = document.getElementById("btnLogAdmin");
    const btnLogPacker = document.getElementById("btnLogPacker");
    const btnLogStower = document.getElementById("btnLogStower");
    const btnLogWelder = document.getElementById("btnLogWelder");
    const btnLogPurchase = document.getElementById("btnLogPurchase");
    const btnLogAllRoles = document.getElementById("btnLogAllRoles");
    const statusLogs = document.getElementById("statusLogs");
    const logsWrap = document.getElementById("logsWrap");
    const logsBody = document.getElementById("logsBody");

    const welderCode = document.getElementById("welderCode");
    const welderQty = document.getElementById("welderQty");
    const welderSave = document.getElementById("welderSave");
    const statusWelder = document.getElementById("statusWelder");
    const statusWelderToday = document.getElementById("statusWelderToday");
    const welderTodayWrap = document.getElementById("welderTodayWrap");
    const welderTodayBody = document.getElementById("welderTodayBody");
    const statusWelderRequests = document.getElementById("statusWelderRequests");
    const welderRequestsWrap = document.getElementById("welderRequestsWrap");
    const welderRequestsBody = document.getElementById("welderRequestsBody");

    const btnProdDay = document.getElementById("btnProdDay");
    const btnProdWeek = document.getElementById("btnProdWeek");
    const btnProdMonth = document.getElementById("btnProdMonth");
    const btnProdYear = document.getElementById("btnProdYear");
    const statusProduction = document.getElementById("statusProduction");
    const productionWrap = document.getElementById("productionWrap");
    const productionBody = document.getElementById("productionBody");

    const matReqName = document.getElementById("matReqName");
    const matReqQty = document.getElementById("matReqQty");
    const matReqNote = document.getElementById("matReqNote");
    const btnMatReq = document.getElementById("btnMatReq");
    const statusMatReq = document.getElementById("statusMatReq");
    const statusMatReqList = document.getElementById("statusMatReqList");
    const matReqWrap = document.getElementById("matReqWrap");
    const matReqBody = document.getElementById("matReqBody");

    const statusPurchase = document.getElementById("statusPurchase");
    const purchaseWrap = document.getElementById("purchaseWrap");
    const purchaseBody = document.getElementById("purchaseBody");

    const instructionsProductCode = document.getElementById("instructionsProductCode");
    const btnLoadInstructions = document.getElementById("btnLoadInstructions");
    const statusInstructions = document.getElementById("statusInstructions");
    const instructionsContent = document.getElementById("instructionsContent");
    const instructionContainer = document.getElementById("instructionContainer");

    const bulkInstructionsInput = document.getElementById("bulkInstructionsInput");
    const btnBulkUploadInstructions = document.getElementById("btnBulkUploadInstructions");
    const statusBulkInstructions = document.getElementById("statusBulkInstructions");

    const packagingProductCode = document.getElementById("packagingProductCode");
    const btnLoadPackaging = document.getElementById("btnLoadPackaging");
    const statusPackaging = document.getElementById("statusPackaging");
    const packagingContent = document.getElementById("packagingContent");
    const packagingContainer = document.getElementById("packagingContainer");

    const bulkPackagingInput = document.getElementById("bulkPackagingInput");
    const btnBulkUploadPackaging = document.getElementById("btnBulkUploadPackaging");
    const statusBulkPackaging = document.getElementById("statusBulkPackaging");

    let shelvesCache = {};
    let role = null;
    let sessionPin = null;

    function padShelf(num){ return "R" + String(num).padStart(3,"0"); }

    function formatLogDate(date){
      if(!date) return "-";
      
      const now = new Date();
      const logDate = new Date(date);
      
      // Bugünün başlangıcı
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      // Dünün başlangıcı
      const yesterdayStart = new Date(todayStart);
      yesterdayStart.setDate(yesterdayStart.getDate() - 1);
      // 2 gün öncesinin başlangıcı
      const twoDaysAgoStart = new Date(todayStart);
      twoDaysAgoStart.setDate(twoDaysAgoStart.getDate() - 2);
      
      const timeStr = logDate.toLocaleTimeString("tr-TR", { hour: "2-digit", minute: "2-digit" });
      
      if(logDate >= todayStart){
        return `Bugün-${timeStr}`;
      } else if(logDate >= yesterdayStart){
        return `Dün-${timeStr}`;
      } else {
        const day = logDate.getDate();
        const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", 
                           "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        const month = monthNames[logDate.getMonth()];
        return `${day} ${month}-${timeStr}`;
      }
    }

    function translateAction(action){
      const translations = {
        "PUT": "RAFA KOY",
        "CLEAR_SHELF": "RAF BOŞALT",
        "REMOVE_PRODUCT_ALL": "ÜRÜN TAMAMEN ÇIKAR",
        "DECREASE_QTY": "ADET AZALT",
        "REMOVE_PRODUCT": "ÜRÜN ÇIKAR",
        "PRODUCTION_REQUEST": "ÜRETİM TALEBİ",
        "FULFILL_REQUESTS": "TALEPLERİ KARŞILA",
        "MATERIAL_REQUEST": "MALZEME TALEBİ",
        "MATERIAL_STATUS_UPDATE": "MALZEME DURUM GÜNCELLENMESİ",
        "SETUP": "KURULUM",
        "PRODUCTION_COMPLETED": "ÜRETİM TAMAMLANDI"
      };
      return translations[action] || action;
    }

    function setStatusBox(el,msg,type){
      if(!el) return;
      if(!msg){
        el.style.display = "none";
        return;
      }
      el.style.display = "flex";
      el.className = "statusBox" + (type ? " " + type : "");
      el.textContent = msg || "";
    }

    function productsSummary(products){
      if(!products || Object.keys(products).length===0) return "-";
      return Object.entries(products).map(([c,q])=>`${c} x${q}`).join(", ");
    }

    function isEmpty(data){
      const p = data?.products || {};
      return Object.keys(p).length===0;
    }

    function refreshClearMode(){
      const nStr = (outShelfNum.value || "").trim();
      if(!nStr){
        clearProductBox.style.display="none";
        clearHint.textContent="";
        if(clearQtyBox) clearQtyBox.style.display="none";
        if(outProductCode) outProductCode.value="";
        if(outReduceQty) outReduceQty.value="1";
        return;
      }

      const n = Number(nStr);
      if(!n || n < 1){
        clearProductBox.style.display="none";
        clearHint.textContent="";
        if(clearQtyBox) clearQtyBox.style.display="none";
        if(outReduceQty) outReduceQty.value="1";
        return;
      }

      const shelfName = padShelf(n);
      const shelfData = shelvesCache[shelfName];
      if(!shelfData){
        clearProductBox.style.display="none";
        clearHint.textContent="";
        if(clearQtyBox) clearQtyBox.style.display="none";
        if(outReduceQty) outReduceQty.value="1";
        return;
      }

      const products = shelfData.products || {};
      const keys = Object.keys(products);
      const pcount = keys.length;

      if(pcount === 0){
        clearProductBox.style.display="none";
        clearHint.textContent="";
        if(clearQtyBox) clearQtyBox.style.display="none";
        if(outReduceQty) outReduceQty.value="1";
        return;
      }

      // Tek ürün varsa
      if(pcount === 1){
        const onlyCode = keys[0];
        const onlyQty  = Number(products[onlyCode] || 0);

        // sadece 1 adet => adet kutusu açılmasın, ürün bilgisi göster
        if(onlyQty === 1){
          clearProductBox.style.display="block";
          if(clearBoxTitle) clearBoxTitle.textContent = "Raftaki Ürün";
          outProductCode.value = onlyCode;
          outProductCode.readOnly = true;
          clearHint.textContent = `${onlyCode} x${onlyQty}`;
          if(clearQtyBox) clearQtyBox.style.display="none";
          if(outReduceQty) outReduceQty.value="1";
          return;
        }

        // 2+ adet => ürün kodu kilitli + adet kutusu açık
        clearProductBox.style.display="block";
        if(clearBoxTitle) clearBoxTitle.textContent = "Bu rafta aynı üründen birden fazla adet var";
        outProductCode.value = onlyCode;
        outProductCode.readOnly = true;

        clearHint.textContent = `${onlyCode} x${onlyQty}`;

        if(clearQtyBox) clearQtyBox.style.display="block";
        if(outReduceQty){
          outReduceQty.value = "1";
          outReduceQty.max = String(onlyQty);
        }
        if(clearQtyHint) clearQtyHint.textContent = `Mevcut: ${onlyQty} adet (Max: ${onlyQty})`;
        return;
      }

      // Birden fazla ürün varsa
      clearProductBox.style.display="block";
      if(clearBoxTitle) clearBoxTitle.textContent = "Bu rafta birden fazla ürün var";
      outProductCode.readOnly = false;

      clearHint.textContent = keys.map(k=>`${k} x${products[k]}`).join(" , ");

      const selected = (outProductCode.value || "").trim();
      const selQty = Number(products[selected] || 0);

      if(selected && selQty > 1){
        if(clearQtyBox) clearQtyBox.style.display="block";
        if(outReduceQty){
          outReduceQty.value = "1";
          outReduceQty.max = String(selQty);
        }
        if(clearQtyHint) clearQtyHint.textContent = `Mevcut: ${selQty} adet (Max: ${selQty})`;
      }else{
        if(clearQtyBox) clearQtyBox.style.display="none";
        if(outReduceQty) outReduceQty.value = "1";
        if(clearQtyHint) clearQtyHint.textContent = "";
      }
    }

    outShelfNum?.addEventListener("input", refreshClearMode);
    outProductCode?.addEventListener("input", refreshClearMode);
    outReduceQty?.addEventListener("input", ()=>{
      const v = Number(outReduceQty.value || 1);
      if(v < 1) outReduceQty.value = "1";
    });

    function runSearch(){
      setStatusBox(statusSearch, "Aranıyor...", "");
      searchBody.innerHTML = "";
      searchWrap.style.display = "none";

      const code = (searchCode.value || "").trim();
      if(!code) return setStatusBox(statusSearch, "Ürün kodu boş olamaz.", "error");

      const results = [];
      for(const [raf, data] of Object.entries(shelvesCache)){
        const qty = Number((data.products && data.products[code]) || 0);
        if(qty > 0) results.push({ raf, qty });
      }

      if(results.length === 0) return setStatusBox(statusSearch, "Bulunamadı.", "error");

      results.sort((a,b)=>a.raf.localeCompare(b.raf));
      for(const r of results){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.raf}</td><td>${r.qty}</td>`;
        searchBody.appendChild(tr);
      }
      searchWrap.style.display = "block";
      setStatusBox(statusSearch, "Bulundu.", "ok");
    }
    btnSearch && (btnSearch.onclick = runSearch);
    searchCode && searchCode.addEventListener("keydown",(e)=>{ if(e.key==="Enter") runSearch(); });

    function computeSummary(){
      const names = Object.keys(shelvesCache);
      const total = names.length;
      let empty = 0;
      let full = 0;
      let totalQty = 0;

      for(const n of names){
        const p = shelvesCache[n]?.products || {};
        const keys = Object.keys(p);
        if(keys.length===0) empty++;
        else full++;
        for(const k of keys) totalQty += Number(p[k] || 0);
      }

      stTotal && (stTotal.textContent = total);
      stEmpty && (stEmpty.textContent = empty);
      stFull  && (stFull.textContent  = full);
      stQty   && (stQty.textContent   = totalQty);
      stHint  && (stHint.textContent  = `Son güncelleme: ${new Date().toLocaleString("tr-TR")}`);
    }

    function setActiveTab(target){
      const allTabs = [tabPut, tabClear, tabSearch, tabRack, tabRequest, tabMaterialRequest, tabWelder, tabWelderRequests, tabProduction, tabPurchase, tabInstructions, tabPackaging, tabAdmin].filter(Boolean);
      allTabs.forEach(t=>t.classList.remove("active"));

      const hideAll = ()=>{
        viewPut && (viewPut.style.display="none");
        viewClear && (viewClear.style.display="none");
        viewSearch && (viewSearch.style.display="none");
        viewRack && (viewRack.style.display="none");
        viewRequest && (viewRequest.style.display="none");
        viewMaterialRequest && (viewMaterialRequest.style.display="none");
        viewWelder && (viewWelder.style.display="none");
        viewWelderRequests && (viewWelderRequests.style.display="none");
        viewProduction && (viewProduction.style.display="none");
        viewPurchase && (viewPurchase.style.display="none");
        viewInstructions && (viewInstructions.style.display="none");
        viewPackaging && (viewPackaging.style.display="none");
        viewAdmin && (viewAdmin.style.display="none");
      };

      hideAll();

      if(target==="put"){ tabPut?.classList.add("active"); viewPut.style.display="block"; setTimeout(()=>{ try{ inProduct.focus(); inProduct.select && inProduct.select(); }catch(e){} },50); }
      if(target==="clear"){ tabClear?.classList.add("active"); viewClear.style.display="block"; setTimeout(()=>{ try{ outShelfNum.focus(); outShelfNum.select && outShelfNum.select(); }catch(e){} },50); }
      if(target==="search"){ tabSearch?.classList.add("active"); viewSearch.style.display="block"; setTimeout(()=>{ try{ searchCode.focus(); searchCode.select && searchCode.select(); }catch(e){} },50); }
      if(target==="rack"){ tabRack?.classList.add("active"); viewRack.style.display="block"; setTimeout(()=>{ try{ rackBody && rackBody.scrollIntoView && rackBody.scrollIntoView(); }catch(e){} },50); }
      if(target==="request"){ tabRequest?.classList.add("active"); viewRequest.style.display="block"; setTimeout(()=>{ try{ reqProduct.focus(); reqProduct.select && reqProduct.select(); }catch(e){} },50); }
      if(target==="materialRequest"){ tabMaterialRequest?.classList.add("active"); viewMaterialRequest.style.display="block"; setTimeout(()=>{ try{ matReqName.focus(); matReqName.select && matReqName.select(); }catch(e){} },50); }
      if(target==="welder"){ tabWelder?.classList.add("active"); viewWelder.style.display="block"; setTimeout(()=>{ try{ welderCode.focus(); welderCode.select && welderCode.select(); }catch(e){} },50); }
      if(target==="welderRequests"){ tabWelderRequests?.classList.add("active"); viewWelderRequests.style.display="block"; }
      if(target==="production"){ tabProduction?.classList.add("active"); viewProduction.style.display="block"; }
      if(target==="purchase"){ tabPurchase?.classList.add("active"); viewPurchase.style.display="block"; }
      if(target==="instructions"){ tabInstructions?.classList.add("active"); viewInstructions.style.display="block"; setTimeout(()=>{ try{ instructionsProductCode.focus(); instructionsProductCode.select && instructionsProductCode.select(); }catch(e){} },50); }
      if(target==="packaging"){ tabPackaging?.classList.add("active"); viewPackaging.style.display="block"; setTimeout(()=>{ try{ packagingProductCode.focus(); packagingProductCode.select && packagingProductCode.select(); }catch(e){} },50); }
      if(target==="admin"){ tabAdmin?.classList.add("active"); viewAdmin.style.display="block"; }
    }

    function setTabsByRole(r){
      const pairs = [
        [tabPut, viewPut],
        [tabClear, viewClear],
        [tabSearch, viewSearch],
        [tabRack, viewRack],
        [tabRequest, viewRequest],
        [tabMaterialRequest, viewMaterialRequest],
        [tabWelder, viewWelder],
        [tabWelderRequests, viewWelderRequests],
        [tabProduction, viewProduction],
        [tabPurchase, viewPurchase],
        [tabInstructions, viewInstructions],
        [tabPackaging, viewPackaging],
        [tabAdmin, viewAdmin]
      ];

      pairs.forEach(([t,v])=>{
        t && (t.style.display="none");
        v && (v.style.display="none");
      });

      if(r==="packer"){
        tabClear.style.display="block";
        tabSearch.style.display="block";
        tabRack.style.display="block";
        tabPackaging.style.display="block";
        
        // Sadece 2001 şifresi ile giriş yapan paketçi talep sekmelerini görebilir
        const currentPin = window.__SESSION?.pin;
        if(currentPin === "2001"){
          tabRequest.style.display="block";
          tabMaterialRequest.style.display="block";
          tabbar.style.gridTemplateColumns = "1fr 1fr 1fr 1fr 1fr 1fr";
        } else {
          tabbar.style.gridTemplateColumns = "1fr 1fr 1fr 1fr";
        }
        
        setActiveTab("clear");
      }else if(r==="stower"){
        tabPut.style.display="block";
        tabPackaging.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr 1fr";
        setActiveTab("put");
      }else if(r==="welder"){
        tabWelder.style.display="block";
        tabWelderRequests.style.display="block";
        tabMaterialRequest.style.display="block";
        tabInstructions.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr 1fr 1fr 1fr";
        setActiveTab("welder");
      }else if(r==="purchase"){
        tabPurchase.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr";
        setActiveTab("purchase");
      }else if(r==="admin"){
        tabPut.style.display="block";
        tabClear.style.display="block";
        tabSearch.style.display="block";
        tabRack.style.display="block";
        tabRequest.style.display="block";
        tabMaterialRequest.style.display="block";
        tabProduction.style.display="block";
        tabPurchase.style.display="block";
        tabInstructions.style.display="block";
        tabPackaging.style.display="block";
        tabAdmin.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr";
        setActiveTab("admin");
      }else{
        tabbar.style.gridTemplateColumns = "1fr";
      }
    }

    function playBeep(){
      try{
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if(!AudioCtx) return;

        const ctx = new AudioCtx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.type = "sine";
        osc.frequency.value = 880;

        gain.gain.setValueAtTime(0.001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);

        osc.connect(gain);
        gain.connect(ctx.destination);

        osc.start();
        osc.stop(ctx.currentTime + 0.26);
        osc.onended = ()=>{ try{ ctx.close(); }catch(e){} };
      }catch(e){}
    }

    window.startFirebase = async function(){
      try{
        const sess = window.__SESSION || {};
        role = sess.role;
        sessionPin = sess.pin || null;

        setTabsByRole(role);

        tabPut && (tabPut.onclick = ()=>setActiveTab("put"));
        tabClear && (tabClear.onclick = ()=>setActiveTab("clear"));
        tabSearch && (tabSearch.onclick = ()=>setActiveTab("search"));
        tabRack && (tabRack.onclick = ()=>setActiveTab("rack"));
        tabRequest && (tabRequest.onclick = ()=>setActiveTab("request"));
        tabMaterialRequest && (tabMaterialRequest.onclick = ()=>setActiveTab("materialRequest"));
        tabWelder && (tabWelder.onclick = ()=>setActiveTab("welder"));
        tabWelderRequests && (tabWelderRequests.onclick = ()=>setActiveTab("welderRequests"));
        tabProduction && (tabProduction.onclick = ()=>setActiveTab("production"));
        tabPurchase && (tabPurchase.onclick = ()=>setActiveTab("purchase"));
        tabInstructions && (tabInstructions.onclick = ()=>setActiveTab("instructions"));
        tabPackaging && (tabPackaging.onclick = ()=>setActiveTab("packaging"));
        tabAdmin && (tabAdmin.onclick = ()=>setActiveTab("admin"));

        logoutBtn.onclick = ()=>location.reload();

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        const db = window.db;

        const shelvesCol = collection(db, "shelves");
        const logsCol = collection(db, "logs");
        const reqCol = collection(db, "requests");
        const productionCol = collection(db, "production");
        const materialReqCol = collection(db, "materialRequests");
        const instructionsCol = collection(db, "productInstructions");
        const packagingCol = collection(db, "packagingInstructions");

        const initRef = doc(db, "system", "shelves_init");

        // Context Menu için global değişken
        let currentContextRequestId = null;
        const contextMenu = document.getElementById('contextMenu');
        const contextMenuDelete = document.getElementById('contextMenuDelete');

        // Context menü göster
        window.showContextMenu = function(event, requestId) {
          currentContextRequestId = requestId;
          contextMenu.style.display = 'block';
          contextMenu.style.left = event.pageX + 'px';
          contextMenu.style.top = event.pageY + 'px';
        };

        // Context menü gizle
        function hideContextMenu() {
          contextMenu.style.display = 'none';
          currentContextRequestId = null;
        }

        // Sayfa herhangi bir yerine tıklandığında menüyü gizle
        document.addEventListener('click', hideContextMenu);
        
        // Context menünün içine tıklandığında kapatma
        contextMenu.addEventListener('click', (e) => {
          e.stopPropagation();
        });

        // Silme işlemi
        contextMenuDelete.addEventListener('click', async () => {
          if (!currentContextRequestId) return;
          
          if (confirm('Bu malzeme talebini silmek istediğinize emin misiniz?')) {
            try {
              const requestRef = doc(db, 'materialRequests', currentContextRequestId);
              await deleteDoc(requestRef);
              
              await addDoc(logsCol, {
                action: 'MATERIAL_STATUS_UPDATE',
                shelf: '-',
                product: '-',
                qty: 0,
                detail: 'Malzeme talebi silindi',
                ts: serverTimestamp(),
                role: role || '-',
                pin: sessionPin || '-'
              });
              
              playBeep();
              if (typeof loadMaterialRequests === 'function') {
                loadMaterialRequests();
              }
              alert('Talep başarıyla silindi.');
            } catch (e) {
              alert('Hata: ' + e.message);
            }
          }
          hideContextMenu();
        });

        async function ensureShelvesOnce(){
          const initSnap = await getDoc(initRef);
          if (initSnap.exists() && initSnap.data()?.done === true) return;

          const q = query(shelvesCol, limit(1));
          const existing = await getDocs(q);
          if (!existing.empty) {
            await setDoc(initRef, { done:true, count: null, updated: serverTimestamp() }, { merge:true });
            return;
          }

          const count = Number(setupCount?.value || 300);
          const CHUNK_SIZE = 450;

          for (let start = 1; start <= count; start += CHUNK_SIZE) {
            const batch = writeBatch(db);
            const end = Math.min(start + CHUNK_SIZE - 1, count);

            for (let i = start; i <= end; i++) {
              const rafAdi = padShelf(i);
              batch.set(
                doc(shelvesCol, rafAdi),
                { name: rafAdi, products: {}, updated: serverTimestamp() },
                { merge: true }
              );
            }
            await batch.commit();
          }

          await setDoc(initRef, { done:true, count, updated: serverTimestamp() }, { merge:true });
        }

        await ensureShelvesOnce();

        async function writeLog(payload){
          try{
            await addDoc(logsCol, { ...payload, ts: serverTimestamp(), role: role || "-", pin: sessionPin || "-" });
          }catch(e){}
        }

        // raf kurulum kutusu sadece admin
        if(role !== "admin"){
          if(setupBox) setupBox.style.display = "none";
          if(btnSetup){
            btnSetup.disabled = true;
            btnSetup.style.opacity = .6;
            btnSetup.style.pointerEvents = "none";
          }
        }

        // Raflar snapshot
        onSnapshot(shelvesCol, (snapshot) => {
          shelvesCache = {};
          rackBody && (rackBody.innerHTML = "");

          const total = snapshot.size;
          let emptyCount = 0;
          let fullCount = 0;

          snapshot.forEach((docSnap) => {
            const d = docSnap.data();
            const name = d.name || docSnap.id;
            const products = d.products || {};
            shelvesCache[name] = { ...d, name, products };

            const empty = Object.keys(products).length===0;
            if(empty) emptyCount++; else fullCount++;

            // PACKER/STOWER (admin değil) => sadece dolu rafları göster
            if(role !== "admin" && empty) return;

            if(rackBody){
              const badge = empty
                ? '<span class="badge b-empty">BOŞ</span>'
                : '<span class="badge b-full">DOLU</span>';

              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${name}</td><td>${badge}</td><td>${productsSummary(products)}</td>`;
              rackBody.appendChild(tr);
            }
          });

          if(rackHint){
            if(role === "admin"){
              rackHint.textContent = `Toplam raf: ${total} | Dolu: ${fullCount} | Boş: ${emptyCount}`;
            }else{
              rackHint.textContent = `Dolu raf: ${fullCount}`;
            }
          }

          refreshClearMode();
          if(role==="admin") computeSummary();
        });

        // REQUEST LIST
        function renderReqRows(docs){
          if(!reqBody) return;
          reqBody.innerHTML = "";
          if(!docs || docs.length===0){
            reqWrap.style.display="none";
            setStatusBox(statusReqList, "Talep yok.", "warn");
            return;
          }

          for(const x of docs){
            const d = x.data();
            const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
            const dtStr = formatLogDate(dt);

            const badge = (d.status === "produced")
              ? `<span class="badge b-done">ÜRETİLDİ</span>`
              : `<span class="badge b-wait">BEKLİYOR</span>`;

            const requesterName = getNameByPin(d.requestedBy);
            const producerName = d.producedBy ? getNameByPin(d.producedBy) : "-";

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${dtStr}</td>
              <td>${d.product || "-"}</td>
              <td>${badge}</td>
              <td>${requesterName}</td>
              <td>${producerName}</td>
            `;
            reqBody.appendChild(tr);
          }

          reqWrap.style.display="block";
          setStatusBox(statusReqList, `Gösteriliyor: ${docs.length}`, "ok");
        }

        if(role==="packer" || role==="admin"){
          const qReq = query(reqCol, orderBy("createdAt","desc"), limit(200));
          onSnapshot(qReq, (snap)=> renderReqRows(snap.docs));
        }

        // Packer: fulfilled taleplerde sesli bildirim
        if(role==="packer"){
          const key = "seen_fulfilled_requests";
          const seen = new Set(JSON.parse(localStorage.getItem(key) || "[]"));

          const qFul = query(reqCol, where("status","==","fulfilled"), orderBy("fulfilledAt","desc"), limit(50));
          onSnapshot(qFul, (snap)=>{
            let playedAny = false;

            snap.forEach(docSnap=>{
              const id = docSnap.id;
              if(seen.has(id)) return;
              seen.add(id);
              playedAny = true;
            });

            if(playedAny){
              localStorage.setItem(key, JSON.stringify(Array.from(seen).slice(-500)));
              playBeep(); setTimeout(()=>playBeep(), 350);
              setStatusBox(statusReq, "🔔 Bildirim: Yeni talep karşılandı!", "ok");
              setTimeout(()=>setStatusBox(statusReq, "Hazır.", ""), 2500);
            }
          });
        }

        // PUT
        btnPut && (btnPut.onclick = async () => {
          setStatusBox(statusPut, "İşlem yapılıyor...", "");

          const code = (inProduct.value || "").trim();
          const nStr = (inShelfNum.value || "").trim();
          const qty  = Number(inQty.value || 0);

          if(!code) return setStatusBox(statusPut, "Ürün kodu boş olamaz.", "error");
          if(!nStr) return setStatusBox(statusPut, "Raf numarası boş olamaz.", "error");
          if(!qty || qty < 1) return setStatusBox(statusPut, "Adet en az 1 olmalı.", "error");

          const n = Number(nStr);
          if(!n || n < 1) return setStatusBox(statusPut, "Raf numarası 1 veya daha büyük olmalı.", "error");

          const shelfName = padShelf(n);
          const shelfData = shelvesCache[shelfName];
          if(!shelfData) return setStatusBox(statusPut, "Bu raf yok: " + shelfName, "error");

          const products = { ...(shelfData.products || {}) };
          products[code] = (products[code] || 0) + qty;

          try{
            await updateDoc(doc(shelvesCol, shelfName), { products, updated: serverTimestamp() });

            await writeLog({ action: "PUT", shelf: shelfName, product: code, qty, detail: "Rafa ürün eklendi" });

            // talepleri karşıla
            try{
              const qWait = query(reqCol, where("status","==","waiting"), where("product","==",code), limit(200));
              const waitSnap = await getDocs(qWait);
              if(!waitSnap.empty){
                const batch = writeBatch(db);
                waitSnap.forEach(r=>{
                  batch.update(r.ref, {
                    status: "fulfilled",
                    fulfilledAt: serverTimestamp(),
                    fulfilledBy: sessionPin || "-",
                    fulfilledShelf: shelfName
                  });
                });
                await batch.commit();

                await writeLog({ action: "FULFILL_REQUESTS", shelf: shelfName, product: code, qty, detail: `Bekleyen talepler: ${waitSnap.size}` });
                setStatusBox(statusPut, `Kaydedildi. ✅ Talepler karşılandı: ${waitSnap.size}`, "ok");
              }else{
                setStatusBox(statusPut, "Kaydedildi.", "ok");
              }
            }catch(e){
              setStatusBox(statusPut, "Kaydedildi. (Talep kontrolü hata: " + e.message + ")", "warn");
            }

            inProduct.value = "";
            inShelfNum.value = "";
            inQty.value = "1";
          }catch(e){
            setStatusBox(statusPut, "Hata: " + e.message, "error");
          }
        });

        // CLEAR (adet azalt modu)
        btnClear && (btnClear.onclick = async () => {
          setStatusBox(statusClear, "İşlem yapılıyor...", "");

          const nStr = (outShelfNum.value || "").trim();
          if(!nStr) return setStatusBox(statusClear, "Raf numarası boş olamaz.", "error");

          const n = Number(nStr);
          if(!n || n < 1) return setStatusBox(statusClear, "Raf numarası 1 veya daha büyük olmalı.", "error");

          const shelfName = padShelf(n);
          const shelfData = shelvesCache[shelfName];
          if(!shelfData) return setStatusBox(statusClear, "Bu raf yok: " + shelfName, "error");
          if(isEmpty(shelfData)) return setStatusBox(statusClear, "Raf zaten boş.", "error");

          const productsNow = { ...(shelfData.products || {}) };
          const keys = Object.keys(productsNow);

          try{
            // 1 ürün varsa
            if(keys.length === 1){
              const onlyCode = keys[0];
              const onlyQty  = Number(productsNow[onlyCode] || 0);

              // qty=1 => rafı komple boşalt
              if(onlyQty <= 1){
                await updateDoc(doc(shelvesCol, shelfName), { products: {}, updated: serverTimestamp() });
                await writeLog({ action: "CLEAR_SHELF", shelf: shelfName, product: "-", qty: 0, detail: "Raf tamamen boşaltıldı" });

                setStatusBox(statusClear, "Raf boşaltıldı.", "ok");
                outShelfNum.value = "";
                outProductCode.value = "";
                if(outReduceQty) outReduceQty.value = "1";
                clearProductBox.style.display = "none";
                clearHint.textContent = "";
                if(clearQtyBox) clearQtyBox.style.display="none";
                return;
              }

              // qty>1 => adet azalt
              const reduce = Math.max(1, Number(outReduceQty?.value || 1));
              const newQty = onlyQty - reduce;

              if(newQty <= 0){
                await updateDoc(doc(shelvesCol, shelfName), { products: {}, updated: serverTimestamp() });
                await writeLog({ action: "REMOVE_PRODUCT_ALL", shelf: shelfName, product: onlyCode, qty: reduce, detail: `Ürün tamamen çıkarıldı (Mevcut ${onlyQty})` });
                setStatusBox(statusClear, "Ürün tamamen çıkarıldı.", "ok");
              }else{
                productsNow[onlyCode] = newQty;
                await updateDoc(doc(shelvesCol, shelfName), { products: productsNow, updated: serverTimestamp() });
                await writeLog({ action: "DECREASE_QTY", shelf: shelfName, product: onlyCode, qty: reduce, detail: `Adet azaltıldı: ${onlyQty} → ${newQty}` });
                setStatusBox(statusClear, `Adet azaltıldı. Kalan: ${newQty}`, "ok");
              }

              outProductCode.value = "";
              if(outReduceQty) outReduceQty.value = "1";
              refreshClearMode();
              return;
            }

            // Birden fazla ürün varsa: ürün kodu şart
            const code = (outProductCode.value || "").trim();
            if(!code) return setStatusBox(statusClear, "Ürün kodu yazın.", "error");
            if(!(code in productsNow)) return setStatusBox(statusClear, "Bu ürün bu rafta yok.", "error");

            const currentQty = Number(productsNow[code] || 0);
            if(currentQty <= 0) return setStatusBox(statusClear, "Bu ürünün adedi geçersiz.", "error");

            // qty>1 ise azalt; qty=1 ise direkt kaldır
            let reduce = 1;
            if(currentQty > 1){
              reduce = Math.max(1, Number(outReduceQty?.value || 1));
            }

            const newQty = currentQty - reduce;

            if(newQty <= 0){
              delete productsNow[code];
              await writeLog({ action: "REMOVE_PRODUCT", shelf: shelfName, product: code, qty: reduce, detail: `Ürün çıkarıldı (Mevcut ${currentQty})` });
            }else{
              productsNow[code] = newQty;
              await writeLog({ action: "DECREASE_QTY", shelf: shelfName, product: code, qty: reduce, detail: `Adet azaltıldı: ${currentQty} → ${newQty}` });
            }

            await updateDoc(doc(shelvesCol, shelfName), { products: productsNow, updated: serverTimestamp() });

            setStatusBox(
              statusClear,
              (newQty <= 0) ? "Ürün raftan çıkarıldı." : `Adet azaltıldı. Kalan: ${newQty}`,
              "ok"
            );

            outProductCode.value = "";
            if(outReduceQty) outReduceQty.value = "1";
            refreshClearMode();

          }catch(e){
            setStatusBox(statusClear, "Hata: " + e.message, "error");
          }
        });

        // PRODUCTION REQUEST CREATE
        btnReq && (btnReq.onclick = async () => {
          setStatusBox(statusReq, "Talep gönderiliyor...", "");

          const code = (reqProduct.value || "").trim();
          const prodType = reqProductionType?.value || "welder";
          
          if(!code) return setStatusBox(statusReq, "Ürün kodu boş olamaz.", "error");

          try{
            await addDoc(reqCol, {
              product: code,
              productionType: prodType,
              status: "pending",
              createdAt: serverTimestamp(),
              requestedBy: sessionPin || "-",
              producedAt: null,
              producedBy: null
            });

            await writeLog({ action: "PRODUCTION_REQUEST", shelf: "-", product: code, qty: 0, detail: `Üretim talebi oluşturuldu (${prodType === 'laser' ? 'Lazer' : 'Kaynak'})` });

            setStatusBox(statusReq, "Talep alındı. ✅", "ok");
            reqProduct.value = "";
            playBeep();
          }catch(e){
            setStatusBox(statusReq, "Hata: " + e.message, "error");
          }
        });

        // MATERIAL REQUEST CREATE
        btnMatReq && (btnMatReq.onclick = async () => {
          setStatusBox(statusMatReq, "Talep gönderiliyor...", "");

          const name = (matReqName.value || "").trim();
          const qty = Math.max(1, Number(matReqQty.value || 1));
          const note = (matReqNote.value || "").trim();
          
          if(!name) return setStatusBox(statusMatReq, "Malzeme adı boş olamaz.", "error");

          try{
            await addDoc(materialReqCol, {
              materialName: name,
              quantity: qty,
              note: note,
              status: "pending",
              createdAt: serverTimestamp(),
              requestedBy: sessionPin || "-",
              requestedByRole: role || "-",
              completedAt: null,
              completedBy: null
            });

            await writeLog({ action: "MATERIAL_REQUEST", shelf: "-", product: name, qty: qty, detail: `Malzeme talebi oluşturuldu: ${note || '-'}` });

            setStatusBox(statusMatReq, "Malzeme talebi alındı. ✅", "ok");
            matReqName.value = "";
            matReqQty.value = "1";
            matReqNote.value = "";
            playBeep();
          }catch(e){
            setStatusBox(statusMatReq, "Hata: " + e.message, "error");
          }
        });

        // MATERIAL REQUEST LIST (for requester)
        function renderMatReqRows(docs){
          if(!matReqBody) return;
          matReqBody.innerHTML = "";
          if(!docs || docs.length===0){
            matReqWrap.style.display="none";
            setStatusBox(statusMatReqList, "Talep yok.", "warn");
            return;
          }

          for(const x of docs){
            const d = x.data();
            const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
            const dtStr = formatLogDate(dt);

            let badge = `<span class="badge b-wait">BEKLEYEN</span>`;
            if(d.status === "processing") badge = `<span class="badge" style="background:rgba(59,130,246,.12);color:#1e3a8a;border-color:rgba(59,130,246,.18);">SİPARİŞ VERİLDİ</span>`;
            if(d.status === "completed") badge = `<span class="badge b-done">MALZEME ALINDI</span>`;
            if(d.status === "rejected") badge = `<span class="badge" style="background:rgba(239,68,68,.12);color:#7f1d1d;border-color:rgba(239,68,68,.18);">REDDEDİLDİ</span>`;

            const requesterName = getNameByPin(d.requestedBy);
            
            let noteDisplay = d.note || "-";
            if(d.status === "rejected" && d.rejectionNote){
              noteDisplay = `<span style="color:#dc2626;font-weight:500;">Red Nedeni: ${d.rejectionNote}</span>`;
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${dtStr}</td>
              <td>${d.materialName || "-"}</td>
              <td>${d.quantity || 1}</td>
              <td>${badge}</td>
              <td>${requesterName}</td>
              <td>${noteDisplay}</td>
            `;
            matReqBody.appendChild(tr);
          }

          matReqWrap.style.display="block";
          setStatusBox(statusMatReqList, `Gösteriliyor: ${docs.length}`, "ok");
        }

        if(role==="packer" || role==="admin" || role==="welder" || role==="stower"){
          const qMatReq = query(materialReqCol, orderBy("createdAt","desc"), limit(200));
          onSnapshot(qMatReq, (snap)=> renderMatReqRows(snap.docs));
        }

        // PURCHASE MANAGEMENT (for purchase role)
        async function loadMaterialRequests(){
          try{
            setStatusBox(statusPurchase, "Yükleniyor...", "");
            
            const q = query(materialReqCol, orderBy("createdAt", "desc"), limit(500));
            
            const snap = await getDocs(q);
            purchaseBody.innerHTML = "";
            
            if(snap.empty){
              purchaseWrap.style.display = "none";
              setStatusBox(statusPurchase, "Talep bulunamadı.", "warn");
              return;
            }

            snap.forEach(docSnap => {
              const d = docSnap.data();
              const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
              const dateStr = formatLogDate(dt);
              
              let statusBadge = `<span class="badge b-wait">BEKLEYEN</span>`;
              if(d.status === "processing") statusBadge = `<span class="badge" style="background:rgba(59,130,246,.12);color:#1e3a8a;border-color:rgba(59,130,246,.18);">SİPARİŞ VERİLDİ</span>`;
              if(d.status === "completed") statusBadge = `<span class="badge b-done">MALZEME ALINDI</span>`;
              if(d.status === "rejected") statusBadge = `<span class="badge" style="background:rgba(239,68,68,.12);color:#7f1d1d;border-color:rgba(239,68,68,.18);">REDDEDİLDİ</span>`;
              
              const requesterName = getNameByPin(d.requestedBy);
              
              // Not gösterimi - önce kullanıcı notu, sonra satın alma notu
              let noteDisplay = d.note || "-";
              if(d.purchaseNote) {
                noteDisplay = `${d.note || '-'} <br><span style="color:#2563eb;font-weight:500;">Satın Alma: ${d.purchaseNote}</span>`;
              }
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${d.materialName || "-"}</td>
                <td>${d.quantity || 1}</td>
                <td>${requesterName}</td>
                <td>${noteDisplay}</td>
                <td>${statusBadge}</td>
                <td class="action-cell"></td>
              `;
              
              const actionCell = tr.querySelector('.action-cell');
              
              if(d.status === "pending"){
                const processBtn = document.createElement('button');
                processBtn.className = 'searchBtn';
                processBtn.textContent = 'SİPARİŞ VER';
                processBtn.style.cssText = 'font-size:14px;padding:8px;';
                processBtn.onclick = () => window.updateMaterialStatus(docSnap.id, 'processing');
                
                actionCell.appendChild(processBtn);
              } else if(d.status === "processing"){
                const completeBtn = document.createElement('button');
                completeBtn.className = 'searchBtn';
                completeBtn.textContent = 'MALZEME ALINDI';
                completeBtn.style.cssText = 'font-size:14px;padding:8px;background:rgba(0,200,83,.12);';
                completeBtn.onclick = () => window.updateMaterialStatus(docSnap.id, 'completed');
                
                actionCell.appendChild(completeBtn);
              } else {
                actionCell.textContent = '-';
              }
              
              // Not ekleme butonu
              const noteTd = document.createElement('td');
              noteTd.style.textAlign = 'center';
              
              const noteBtn = document.createElement('button');
              noteBtn.textContent = '📝';
              noteBtn.title = 'Not Ekle/Düzenle';
              noteBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:18px;padding:4px 8px;';
              noteBtn.onclick = () => window.addPurchaseNote(docSnap.id, d.purchaseNote || '');
              
              noteTd.appendChild(noteBtn);
              tr.appendChild(noteTd);
              
              // Reddet butonu (sadece bekleyen ve işlemdeki talepler için)
              const rejectTd = document.createElement('td');
              rejectTd.style.textAlign = 'center';
              
              if(d.status === 'pending' || d.status === 'processing') {
                const rejectBtn = document.createElement('button');
                rejectBtn.textContent = '❌';
                rejectBtn.title = 'Reddet';
                rejectBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:18px;padding:4px 8px;';
                rejectBtn.onclick = () => window.rejectMaterialRequest(docSnap.id);
                rejectTd.appendChild(rejectBtn);
              } else {
                rejectTd.textContent = '-';
              }
              
              tr.appendChild(rejectTd);
              
              purchaseBody.appendChild(tr);
            });

            purchaseWrap.style.display = "block";
            setStatusBox(statusPurchase, `Toplam: ${snap.size} kayıt`, "ok");
          }catch(e){
            setStatusBox(statusPurchase, "Hata: " + e.message, "error");
          }
        }

        window.deleteMaterialRequest = async function(requestId){
          if(!requestId) return;
          
          if(!confirm("Bu talebi silmek istediğinize emin misiniz?")){
            return;
          }
          
          try{
            const requestRef = doc(db, "materialRequests", requestId);
            await deleteDoc(requestRef);
            
            await writeLog({ 
              action: "MATERIAL_STATUS_UPDATE", 
              shelf: "-", 
              product: "-", 
              qty: 0, 
              detail: `Malzeme talebi silindi` 
            });
            
            playBeep();
            loadMaterialRequests();
          }catch(e){
            alert("Hata: " + e.message);
          }
        };

        window.addPurchaseNote = async function(requestId, currentNote){
          try {
            const newNote = prompt('Satın alma notu:', currentNote || '');
            if(newNote !== null) {
              await updateDoc(doc(db, 'materialRequests', requestId), {
                purchaseNote: newNote.trim()
              });
              playBeep();
              loadMaterialRequests();
            }
          } catch (e) {
            console.error('Not ekleme hatası:', e);
            alert('Hata: ' + e.message);
          }
        };

        window.rejectMaterialRequest = async function(requestId){
          try {
            if(!confirm('Bu talebi reddetmek istediğinize emin misiniz?')){
              return;
            }
            await updateDoc(doc(db, 'materialRequests', requestId), {
              status: 'rejected',
              rejectedAt: serverTimestamp(),
              rejectedBy: sessionPin || '-'
            });
            playBeep();
            loadMaterialRequests();
          } catch (e) {
            console.error('Reddetme hatası:', e);
            alert('Hata: ' + e.message);
          }
        };

        window.updateMaterialStatus = async function(requestId, newStatus){
          if(!requestId) return;
          
          try{
            const requestRef = doc(db, "materialRequests", requestId);
            const updateData = { status: newStatus };
            
            if(newStatus === "completed"){
              updateData.completedAt = serverTimestamp();
              updateData.completedBy = sessionPin || "-";
            }
            
            await updateDoc(requestRef, updateData);
            
            await writeLog({ 
              action: "MATERIAL_STATUS_UPDATE", 
              shelf: "-", 
              product: "-", 
              qty: 0, 
              detail: `Malzeme talebi durumu: ${newStatus}` 
            });
            
            playBeep();
            loadMaterialRequests();
          }catch(e){
            alert("Hata: " + e.message);
          }
        };
        
        if(role === 'purchase' || role === 'admin'){
          loadMaterialRequests();
        }

        // SETUP (admin only)
        if(btnSetup && role==="admin"){
          btnSetup.onclick = async () => {
            setupStatus.textContent = "Raflar oluşturuluyor...";

            const count = Number(setupCount.value || 0);
            const prefix = (setupPrefix.value || "R").trim().toUpperCase();

            if (!count || count < 1) {
              setupStatus.textContent = "Raf sayısı 1 veya daha büyük olmalı.";
              return;
            }
            if (prefix !== "R") {
              setupStatus.textContent = "Prefix R olmalı.";
              return;
            }

            try {
              const CHUNK_SIZE = 450;
              let created = 0;

              for (let start = 1; start <= count; start += CHUNK_SIZE) {
                const batch = writeBatch(db);
                const end = Math.min(start + CHUNK_SIZE - 1, count);

                for (let i = start; i <= end; i++) {
                  const rafAdi = padShelf(i);
                  batch.set(
                    doc(shelvesCol, rafAdi),
                    { name: rafAdi, products: {}, updated: serverTimestamp() },
                    { merge: true }
                  );
                }

                await batch.commit();
                created = end;
                setupStatus.textContent = `Oluşturuldu: ${created} / ${count}`;
              }

              await setDoc(initRef, { done:true, count, updated: serverTimestamp() }, { merge:true });
              await writeLog({ action: "SETUP", shelf: "-", product: "-", qty: 0, detail: `Manuel kurulum: ${count} raf` });

              setupStatus.textContent = `BİTTİ ✅ Toplam ${count} raf oluşturuldu.`;
            } catch (e) {
              setupStatus.textContent = "Hata: " + e.message;
            }
          };
        }

        // ADMIN: LOG YÜKLE
        let currentLogActionFilter = 'all';
        let currentLogRoleFilter = 'all';

        async function loadLogs(actionFilter = 'all', roleFilter = 'all'){
          if(role!=="admin") return;

          setStatusBox(statusLogs, "Loglar yükleniyor...", "");
          logsBody.innerHTML = "";
          logsWrap.style.display = "none";

          currentLogActionFilter = actionFilter;
          currentLogRoleFilter = roleFilter;

          // Action filter butonlarını güncelle
          [btnLogPut, btnLogClear, btnLogDecrease, btnLogMaterial, btnLogProduction, btnLogAllActions].forEach(btn => {
            btn && btn.classList.remove('active');
          });
          // Role filter butonlarını güncelle
          [btnLogAdmin, btnLogPacker, btnLogStower, btnLogWelder, btnLogPurchase, btnLogAllRoles].forEach(btn => {
            btn && btn.classList.remove('active');
          });

          if(actionFilter === 'put') btnLogPut?.classList.add('active');
          else if(actionFilter === 'clear') btnLogClear?.classList.add('active');
          else if(actionFilter === 'decrease') btnLogDecrease?.classList.add('active');
          else if(actionFilter === 'material') btnLogMaterial?.classList.add('active');
          else if(actionFilter === 'production') btnLogProduction?.classList.add('active');
          else btnLogAllActions?.classList.add('active');

          if(roleFilter === 'admin') btnLogAdmin?.classList.add('active');
          else if(roleFilter === 'packer') btnLogPacker?.classList.add('active');
          else if(roleFilter === 'stower') btnLogStower?.classList.add('active');
          else if(roleFilter === 'welder') btnLogWelder?.classList.add('active');
          else if(roleFilter === 'purchase') btnLogPurchase?.classList.add('active');
          else btnLogAllRoles?.classList.add('active');

          const lim = Math.max(10, Math.min(500, Number(logLimit.value || 100)));

          try{
            const ql = query(logsCol, orderBy("ts","desc"), limit(lim));
            const snap = await getDocs(ql);

            if(snap.empty){
              setStatusBox(statusLogs, "Log bulunamadı.", "warn");
              return;
            }

            let filteredLogs = [];

            snap.forEach(docSnap=>{
              const d = docSnap.data() || {};
              
              // Action filter
              let passActionFilter = true;
              if(actionFilter !== 'all'){
                const action = d.action || "";
                if(actionFilter === 'put' && action !== 'PUT') passActionFilter = false;
                else if(actionFilter === 'clear' && !['CLEAR_SHELF', 'REMOVE_PRODUCT_ALL', 'REMOVE_PRODUCT'].includes(action)) passActionFilter = false;
                else if(actionFilter === 'decrease' && action !== 'DECREASE_QTY') passActionFilter = false;
                else if(actionFilter === 'material' && !['MATERIAL_REQUEST', 'MATERIAL_STATUS_UPDATE'].includes(action)) passActionFilter = false;
                else if(actionFilter === 'production' && !['PRODUCTION_REQUEST', 'PRODUCTION_COMPLETED', 'FULFILL_REQUESTS'].includes(action)) passActionFilter = false;
              }

              // Role filter
              let passRoleFilter = true;
              if(roleFilter !== 'all'){
                const logRole = d.role || "";
                if(logRole !== roleFilter) passRoleFilter = false;
              }

              if(passActionFilter && passRoleFilter){
                filteredLogs.push(d);
              }
            });

            if(filteredLogs.length === 0){
              setStatusBox(statusLogs, "Bu filtreye uygun log bulunamadı.", "warn");
              return;
            }

            filteredLogs.forEach(d => {
              const dt = d.ts?.toDate ? d.ts.toDate() : null;
              const dtStr = formatLogDate(dt);
              
              const userName = getNameByPin(d.pin);
              const roleText = d.role || "-";

              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${dtStr}</td>
                <td>${roleText} / ${userName}</td>
                <td>${translateAction(d.action || "-")}</td>
                <td>${(d.shelf || "-")}</td>
                <td>${(d.product || "-")}</td>
                <td>${(d.qty ?? "-")}</td>
                <td>${(d.detail || "-")}</td>
              `;
              logsBody.appendChild(tr);
            });

            logsWrap.style.display = "block";
            const actionText = actionFilter === 'put' ? 'Rafa Koy' : 
                              actionFilter === 'clear' ? 'Raf Boşalt' : 
                              actionFilter === 'decrease' ? 'Adet Azalt' : 
                              actionFilter === 'material' ? 'Malzeme' : 
                              actionFilter === 'production' ? 'Üretim' : 'Tüm';
            const roleText = roleFilter === 'admin' ? 'Yönetici' : 
                            roleFilter === 'packer' ? 'Paketçi' : 
                            roleFilter === 'stower' ? 'Raf Dizen' : 
                            roleFilter === 'welder' ? 'Üretim' : 
                            roleFilter === 'purchase' ? 'Satın Alma' : 'Tüm';
            setStatusBox(statusLogs, `${actionText} / ${roleText}: ${filteredLogs.length} kayıt`, "ok");
          }catch(e){
            setStatusBox(statusLogs, "Hata: " + e.message, "error");
          }
        }

        btnLoadLogs && (btnLoadLogs.onclick = () => loadLogs(currentLogActionFilter, currentLogRoleFilter));
        
        btnLogPut && (btnLogPut.onclick = () => loadLogs('put', currentLogRoleFilter));
        btnLogClear && (btnLogClear.onclick = () => loadLogs('clear', currentLogRoleFilter));
        btnLogDecrease && (btnLogDecrease.onclick = () => loadLogs('decrease', currentLogRoleFilter));
        btnLogMaterial && (btnLogMaterial.onclick = () => loadLogs('material', currentLogRoleFilter));
        btnLogProduction && (btnLogProduction.onclick = () => loadLogs('production', currentLogRoleFilter));
        btnLogAllActions && (btnLogAllActions.onclick = () => loadLogs('all', currentLogRoleFilter));
        
        btnLogAdmin && (btnLogAdmin.onclick = () => loadLogs(currentLogActionFilter, 'admin'));
        btnLogPacker && (btnLogPacker.onclick = () => loadLogs(currentLogActionFilter, 'packer'));
        btnLogStower && (btnLogStower.onclick = () => loadLogs(currentLogActionFilter, 'stower'));
        btnLogWelder && (btnLogWelder.onclick = () => loadLogs(currentLogActionFilter, 'welder'));
        btnLogPurchase && (btnLogPurchase.onclick = () => loadLogs(currentLogActionFilter, 'purchase'));
        btnLogAllRoles && (btnLogAllRoles.onclick = () => loadLogs(currentLogActionFilter, 'all'));

        // Welder (Kaynak İmalat) functionality
        async function saveProduction(){
          const code = (welderCode.value || "").trim();
          const qty = parseInt(welderQty.value || "0", 10);

          if(!code){
            setStatusBox(statusWelder, "Ürün kodu giriniz.", "error");
            return;
          }
          if(qty <= 0){
            setStatusBox(statusWelder, "Geçerli bir adet giriniz.", "error");
            return;
          }

          try{
            setStatusBox(statusWelder, "Kaydediliyor...", "");
            await addDoc(productionCol, {
              productCode: code,
              quantity: qty,
              welderPin: sessionPin,
              createdAt: serverTimestamp()
            });

            setStatusBox(statusWelder, "Üretim kaydedildi!", "ok");
            welderCode.value = "";
            welderQty.value = "";
            
            playBeep();
            setTimeout(()=>welderCode.focus(), 100);
            loadTodayProduction();
          }catch(e){
            setStatusBox(statusWelder, "Hata: " + e.message, "error");
          }
        }

        async function loadTodayProduction(){
          try{
            setStatusBox(statusWelderToday, "Yükleniyor...", "");
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const q = query(
              productionCol,
              where("createdAt", ">=", today),
              orderBy("createdAt", "desc")
            );
            
            const snap = await getDocs(q);
            welderTodayBody.innerHTML = "";
            
            if(snap.empty){
              welderTodayWrap.style.display = "none";
              setStatusBox(statusWelderToday, "Bugün üretim kaydı yok.", "warn");
              return;
            }

            snap.forEach(doc => {
              const d = doc.data();
              const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
              const timeStr = dt ? dt.toLocaleTimeString("tr-TR") : "-";
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${timeStr}</td>
                <td>${d.productCode || "-"}</td>
                <td>${d.quantity || 0}</td>
              `;
              welderTodayBody.appendChild(tr);
            });

            welderTodayWrap.style.display = "block";
            setStatusBox(statusWelderToday, `Toplam ${snap.size} kayıt`, "ok");
          }catch(e){
            setStatusBox(statusWelderToday, "Hata: " + e.message, "error");
          }
        }

        welderSave && (welderSave.onclick = saveProduction);
        
        if(role === "welder"){
          loadTodayProduction();
          loadWelderRequests();
        }

        // Welder requests list
        async function loadWelderRequests(){
          try{
            setStatusBox(statusWelderRequests, "Yükleniyor...", "");
            
            // Kullanıcının tipini belirle (laser mi welder mı?)
            let userProductionType = null;
            if(LASER_PINS.has(sessionPin)){
              userProductionType = "laser";
            } else if(WELDER_PINS.has(sessionPin)){
              userProductionType = "welder";
            }
            
            // Tüm talepleri al ve client-side filtrele (index hatası olmasın diye)
            const q = query(reqCol, orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            
            welderRequestsBody.innerHTML = "";
            
            let filteredDocs = [];
            if(role === "admin"){
              // Admin tüm talepleri görür
              filteredDocs = snap.docs;
            } else if(userProductionType){
              // Sadece kendi tipine ait talepleri filtrele
              filteredDocs = snap.docs.filter(doc => {
                const data = doc.data();
                return data.productionType === userProductionType;
              });
            }
            
            if(filteredDocs.length === 0){
              welderRequestsWrap.style.display = "none";
              setStatusBox(statusWelderRequests, "Talep bulunamadı.", "warn");
              return;
            }

            filteredDocs.forEach(doc => {
              const d = doc.data();
              const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
              const dateStr = dt ? formatLogDate(dt) : "-";
              
              const statusBadge = (d.status === "produced")
                ? `<span class="badge b-done">ÜRETİLDİ</span>`
                : `<span class="badge b-wait">BEKLİYOR</span>`;
              
              const actionBtn = (d.status === "pending")
                ? `<button class="searchBtn" onclick="markAsProduced('${doc.id}', '${d.product}')">ÜRETTİM</button>`
                : "-";
              
              const requesterName = getNameByPin(d.requestedBy);
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${d.product || "-"}</td>
                <td>${requesterName}</td>
                <td>${statusBadge}</td>
                <td>${actionBtn}</td>
              `;
              welderRequestsBody.appendChild(tr);
            });

            welderRequestsWrap.style.display = "block";
            setStatusBox(statusWelderRequests, `Toplam ${filteredDocs.length} talep`, "ok");
          }catch(e){
            setStatusBox(statusWelderRequests, "Hata: " + e.message, "error");
          }
        }

        // Mark production request as produced
        window.markAsProduced = async function(requestId, productCode){
          if(!requestId) return;
          
          try{
            const requestRef = doc(db, "requests", requestId);
            await updateDoc(requestRef, {
              status: "produced",
              producedAt: serverTimestamp(),
              producedBy: sessionPin || "-"
            });
            
            await writeLog({ 
              action: "PRODUCTION_COMPLETED", 
              shelf: "-", 
              product: productCode, 
              qty: 0, 
              detail: `Üretim talebi tamamlandı (Kaynakçı: ${sessionPin})` 
            });
            
            playBeep();
            loadWelderRequests(); // Reload the list
          }catch(e){
            alert("Hata: " + e.message);
          }
        };

        // Production list for admin & packer
        async function loadProduction(filter = 'day'){
          try{
            setStatusBox(statusProduction, "Yükleniyor...", "");
            
            // Filtre butonlarının aktif durumunu güncelle
            [btnProdDay, btnProdWeek, btnProdMonth, btnProdYear].forEach(btn => {
              btn && btn.classList.remove('active');
            });
            
            if(filter === 'day') btnProdDay?.classList.add('active');
            else if(filter === 'week') btnProdWeek?.classList.add('active');
            else if(filter === 'month') btnProdMonth?.classList.add('active');
            else if(filter === 'year') btnProdYear?.classList.add('active');
            
            const now = new Date();
            let startDate = new Date();
            
            if(filter === 'day'){
              startDate.setHours(0, 0, 0, 0);
            } else if(filter === 'week'){
              startDate.setDate(now.getDate() - 7);
              startDate.setHours(0, 0, 0, 0);
            } else if(filter === 'month'){
              startDate.setMonth(now.getMonth() - 1);
              startDate.setHours(0, 0, 0, 0);
            } else if(filter === 'year'){
              startDate.setFullYear(now.getFullYear() - 1);
              startDate.setHours(0, 0, 0, 0);
            }
            
            const q = query(
              productionCol,
              where("createdAt", ">=", startDate),
              orderBy("createdAt", "desc")
            );
            
            const snap = await getDocs(q);
            productionBody.innerHTML = "";
            
            if(snap.empty){
              productionWrap.style.display = "none";
              setStatusBox(statusProduction, "Üretim kaydı bulunamadı.", "warn");
              return;
            }

            let totalQty = 0;
            snap.forEach(doc => {
              const d = doc.data();
              const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
              const dateStr = formatLogDate(dt);
              totalQty += (d.quantity || 0);
              
              const welderName = getNameByPin(d.welderPin);
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${d.productCode || "-"}</td>
                <td>${d.quantity || 0}</td>
                <td>${welderName}</td>
              `;
              productionBody.appendChild(tr);
            });

            productionWrap.style.display = "block";
            const filterText = filter === 'day' ? 'Günlük' : filter === 'week' ? 'Haftalık' : filter === 'month' ? 'Aylık' : 'Yıllık';
            setStatusBox(statusProduction, `${filterText}: ${snap.size} kayıt, Toplam ${totalQty} adet`, "ok");
          }catch(e){
            setStatusBox(statusProduction, "Hata: " + e.message, "error");
          }
        }

        btnProdDay && (btnProdDay.onclick = () => loadProduction('day'));
        btnProdWeek && (btnProdWeek.onclick = () => loadProduction('week'));
        btnProdMonth && (btnProdMonth.onclick = () => loadProduction('month'));
        btnProdYear && (btnProdYear.onclick = () => loadProduction('year'));
        
        // Admin veya packer için otomatik yükleme
        if(role === 'admin' || role === 'packer'){
          // Önce günlük kontrol et
          (async () => {
            try {
              const now = new Date();
              const todayStart = new Date();
              todayStart.setHours(0, 0, 0, 0);
              
              const qDay = query(
                productionCol,
                where("createdAt", ">=", todayStart),
                limit(1)
              );
              
              const daySnap = await getDocs(qDay);
              
              if(daySnap.empty) {
                // Günlük üretim yoksa haftalık göster
                loadProduction('week');
              } else {
                // Günlük üretim varsa günlük göster
                loadProduction('day');
              }
            } catch(e) {
              // Hata durumunda günlük göster
              loadProduction('day');
            }
          })();
        }

        // INSTRUCTIONS: Ürün talimatlarını yükle
        async function loadInstructions() {
          const productCode = (instructionsProductCode.value || "").trim();
          if(!productCode) {
            setStatusBox(statusInstructions, "Ürün kodu giriniz.", "error");
            return;
          }

          setStatusBox(statusInstructions, "Yükleniyor...", "");
          instructionsContent.style.display = "none";
          instructionContainer.innerHTML = "";

          try {
            // Firestore'dan ürün talimatını getir
            const q = query(instructionsCol, where("productCode", "==", productCode), limit(1));
            const snap = await getDocs(q);
            
            if(snap.empty) {
              setStatusBox(statusInstructions, `${productCode} kodlu ürün için talimat bulunamadı.`, "error");
              instructionContainer.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);">Bu ürün için henüz talimat eklenmemiş.</div>';
              instructionsContent.style.display = "block";
              return;
            }

            const data = snap.docs[0].data();
            const type = data.instructionType || "pdf"; // pdf, image, link
            const url = data.instructionUrl || "";

            if(!url) {
              setStatusBox(statusInstructions, "Talimat URL'si bulunamadı.", "error");
              return;
            }

            instructionsContent.style.display = "block";

            if(type === "pdf") {
              // PDF için iframe
              const iframe = document.createElement('iframe');
              iframe.src = url;
              iframe.style.cssText = 'width:100%;height:600px;border:none;';
              instructionContainer.appendChild(iframe);
              setStatusBox(statusInstructions, "Talimat yüklendi.", "ok");
            } else if(type === "image") {
              // Resim için img
              const img = document.createElement('img');
              img.src = url;
              img.style.cssText = 'width:100%;height:auto;max-height:600px;object-fit:contain;';
              img.onerror = () => {
                setStatusBox(statusInstructions, "Resim yüklenemedi.", "error");
              };
              img.onload = () => {
                setStatusBox(statusInstructions, "Talimat yüklendi.", "ok");
              };
              instructionContainer.appendChild(img);
            } else if(type === "link") {
              // Link için buton
              const linkDiv = document.createElement('div');
              linkDiv.style.cssText = 'padding:40px;text-align:center;';
              
              const linkBtn = document.createElement('a');
              linkBtn.href = url;
              linkBtn.target = "_blank";
              linkBtn.textContent = "Talimatı Aç (Yeni Sekmede)";
              linkBtn.style.cssText = 'display:inline-block;padding:14px 24px;background:var(--green);color:#07210f;text-decoration:none;border-radius:12px;font-weight:900;font-size:16px;';
              
              linkDiv.appendChild(linkBtn);
              instructionContainer.appendChild(linkDiv);
              setStatusBox(statusInstructions, "Talimat linki hazır.", "ok");
            } else {
              setStatusBox(statusInstructions, "Bilinmeyen talimat tipi.", "error");
            }
          } catch(e) {
            console.error('Talimat yükleme hatası:', e);
            setStatusBox(statusInstructions, "Hata: " + e.message, "error");
          }
        }

        btnLoadInstructions && (btnLoadInstructions.onclick = loadInstructions);
        instructionsProductCode && instructionsProductCode.addEventListener("keydown", (e) => {
          if(e.key === "Enter") loadInstructions();
        });

        // Toplu talimat yükleme fonksiyonu
        async function bulkUploadInstructions() {
          if(!bulkInstructionsInput || !statusBulkInstructions) return;
          
          try {
            const text = bulkInstructionsInput.value.trim();
            if(!text) {
              setStatusBox(statusBulkInstructions, "Lütfen veri girin.", "error");
              return;
            }

            const lines = text.split('\n').filter(line => line.trim());
            if(lines.length === 0) {
              setStatusBox(statusBulkInstructions, "Hiç satır bulunamadı.", "error");
              return;
            }

            setStatusBox(statusBulkInstructions, `${lines.length} satır yükleniyor...`, "info");

            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            for(let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              const parts = line.split(',').map(p => p.trim());
              
              if(parts.length !== 3) {
                errorCount++;
                errors.push(`Satır ${i+1}: Yanlış format (3 alan gerekli)`);
                continue;
              }

              const [productCode, instructionType, instructionUrl] = parts;

              if(!productCode || !instructionType || !instructionUrl) {
                errorCount++;
                errors.push(`Satır ${i+1}: Boş alan var`);
                continue;
              }

              if(!['pdf', 'image', 'link'].includes(instructionType.toLowerCase())) {
                errorCount++;
                errors.push(`Satır ${i+1}: Geçersiz tip (pdf, image veya link olmalı)`);
                continue;
              }

              try {
                await addDoc(instructionsCol, {
                  productCode: productCode,
                  instructionType: instructionType.toLowerCase(),
                  instructionUrl: instructionUrl,
                  createdAt: serverTimestamp(),
                  updatedAt: serverTimestamp()
                });
                successCount++;
              } catch(e) {
                errorCount++;
                errors.push(`Satır ${i+1}: ${e.message}`);
              }
            }

            let message = `✓ ${successCount} başarılı`;
            if(errorCount > 0) {
              message += `, ✗ ${errorCount} hata`;
            }
            
            if(errors.length > 0 && errors.length <= 5) {
              message += '\n' + errors.join('\n');
            } else if(errors.length > 5) {
              message += '\n' + errors.slice(0, 5).join('\n') + `\n... ve ${errors.length - 5} hata daha`;
            }

            setStatusBox(statusBulkInstructions, message, errorCount > 0 ? "warn" : "ok");
            
            if(successCount > 0) {
              bulkInstructionsInput.value = '';
            }
          } catch(e) {
            console.error('Toplu yükleme hatası:', e);
            setStatusBox(statusBulkInstructions, "Hata: " + e.message, "error");
          }
        }

        btnBulkUploadInstructions && (btnBulkUploadInstructions.onclick = bulkUploadInstructions);

        // Paketleme talimatlarını yükleme fonksiyonu
        async function loadPackagingInstructions() {
          if(!packagingProductCode || !statusPackaging || !packagingContainer) return;
          
          try {
            const productCode = (packagingProductCode.value || "").trim();
            if(!productCode) {
              setStatusBox(statusPackaging, "Lütfen ürün kodu girin.", "error");
              return;
            }

            setStatusBox(statusPackaging, "Yükleniyor...", "info");
            packagingContainer.innerHTML = "";
            packagingContent.style.display = "none";

            const snap = await getDocs(query(packagingCol, where("productCode", "==", productCode), limit(1)));
            
            if(snap.empty) {
              setStatusBox(statusPackaging, "Bu ürün için paketleme talimatı bulunamadı.", "warn");
              return;
            }

            const data = snap.docs[0].data();
            const type = data.instructionType;
            const url = data.instructionUrl;

            packagingContent.style.display = "block";

            if(type === "pdf") {
              const iframe = document.createElement('iframe');
              iframe.src = url;
              iframe.style.cssText = 'width:100%;height:600px;border:none;';
              iframe.onload = () => {
                setStatusBox(statusPackaging, "Talimat yüklendi.", "ok");
              };
              packagingContainer.appendChild(iframe);
            } else if(type === "image") {
              const img = document.createElement('img');
              img.src = url;
              img.style.cssText = 'max-width:100%;height:auto;display:block;margin:0 auto;';
              img.onload = () => {
                setStatusBox(statusPackaging, "Talimat yüklendi.", "ok");
              };
              packagingContainer.appendChild(img);
            } else if(type === "link") {
              const linkDiv = document.createElement('div');
              linkDiv.style.cssText = 'padding:40px;text-align:center;';
              
              const linkBtn = document.createElement('a');
              linkBtn.href = url;
              linkBtn.target = "_blank";
              linkBtn.textContent = "Talimatı Aç (Yeni Sekmede)";
              linkBtn.style.cssText = 'display:inline-block;padding:14px 24px;background:var(--green);color:#07210f;text-decoration:none;border-radius:12px;font-weight:900;font-size:16px;';
              
              linkDiv.appendChild(linkBtn);
              packagingContainer.appendChild(linkDiv);
              setStatusBox(statusPackaging, "Talimat linki hazır.", "ok");
            } else {
              setStatusBox(statusPackaging, "Bilinmeyen talimat tipi.", "error");
            }
          } catch(e) {
            console.error('Paketleme talimatı yükleme hatası:', e);
            setStatusBox(statusPackaging, "Hata: " + e.message, "error");
          }
        }

        btnLoadPackaging && (btnLoadPackaging.onclick = loadPackagingInstructions);
        packagingProductCode && packagingProductCode.addEventListener("keydown", (e) => {
          if(e.key === "Enter") loadPackagingInstructions();
        });

        // Toplu paketleme talimatı yükleme fonksiyonu
        async function bulkUploadPackaging() {
          if(!bulkPackagingInput || !statusBulkPackaging) return;
          
          try {
            const text = bulkPackagingInput.value.trim();
            if(!text) {
              setStatusBox(statusBulkPackaging, "Lütfen veri girin.", "error");
              return;
            }

            const lines = text.split('\n').filter(line => line.trim());
            if(lines.length === 0) {
              setStatusBox(statusBulkPackaging, "Hiç satır bulunamadı.", "error");
              return;
            }

            setStatusBox(statusBulkPackaging, `${lines.length} satır yükleniyor...`, "info");

            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            for(let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              const parts = line.split(',').map(p => p.trim());
              
              if(parts.length !== 3) {
                errorCount++;
                errors.push(`Satır ${i+1}: Yanlış format (3 alan gerekli)`);
                continue;
              }

              const [productCode, instructionType, instructionUrl] = parts;

              if(!productCode || !instructionType || !instructionUrl) {
                errorCount++;
                errors.push(`Satır ${i+1}: Boş alan var`);
                continue;
              }

              if(!['pdf', 'image', 'link'].includes(instructionType.toLowerCase())) {
                errorCount++;
                errors.push(`Satır ${i+1}: Geçersiz tip (pdf, image veya link olmalı)`);
                continue;
              }

              try {
                await addDoc(packagingCol, {
                  productCode: productCode,
                  instructionType: instructionType.toLowerCase(),
                  instructionUrl: instructionUrl,
                  createdAt: serverTimestamp(),
                  updatedAt: serverTimestamp()
                });
                successCount++;
              } catch(e) {
                errorCount++;
                errors.push(`Satır ${i+1}: ${e.message}`);
              }
            }

            let message = `✓ ${successCount} başarılı`;
            if(errorCount > 0) {
              message += `, ✗ ${errorCount} hata`;
            }
            
            if(errors.length > 0 && errors.length <= 5) {
              message += '\n' + errors.join('\n');
            } else if(errors.length > 5) {
              message += '\n' + errors.slice(0, 5).join('\n') + `\n... ve ${errors.length - 5} hata daha`;
            }

            setStatusBox(statusBulkPackaging, message, errorCount > 0 ? "warn" : "ok");
            
            if(successCount > 0) {
              bulkPackagingInput.value = '';
            }
          } catch(e) {
            console.error('Toplu paketleme yükleme hatası:', e);
            setStatusBox(statusBulkPackaging, "Hata: " + e.message, "error");
          }
        }

        btnBulkUploadPackaging && (btnBulkUploadPackaging.onclick = bulkUploadPackaging);

        setStatusBox(statusReqList, "Yükleniyor...", "");
      }catch(e){
        setStatusBox(statusPut, "Firebase yüklenemedi: " + e.message, "error");
        setStatusBox(statusClear, "Firebase yüklenemedi: " + e.message, "error");
        setStatusBox(statusSearch, "Firebase yüklenemedi: " + e.message, "error");
        setStatusBox(statusReq, "Firebase yüklenemedi: " + e.message, "error");
        setStatusBox(statusReqList, "Firebase yüklenemedi: " + e.message, "error");
        setStatusBox(statusLogs, "Firebase yüklenemedi: " + e.message, "error");
      }
    };
  </script>

</body>
</html>
