<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GABYA HOME</title>

  <style>
    *{box-sizing:border-box}
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel2:#f9fafb;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;
      --green:#00c853;
      --green2:#00b84c;
      --danger:#ef4444;
      --danger2:#dc2626;
      --input:#ffffff;
      --shadow:0 18px 50px rgba(2,6,23,.12);
      --shadow2:0 10px 30px rgba(2,6,23,.10);
      --amber:#f59e0b;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* LOGIN */
    .center{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .loginCard{
      width:min(520px,96vw);
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:28px;
    }
    .title{
      text-align:center;
      font-weight:900;
      font-size:42px;
      letter-spacing:.5px;
      margin:0 0 8px;
      color:var(--text);
    }
    .subtitle{
      text-align:center;
      font-weight:900;
      font-size:22px;
      margin:0 0 18px;
      color:var(--text);
    }

    .fieldLabel{
      font-weight:900;
      letter-spacing:.8px;
      color:var(--muted);
      margin:0 0 6px;
      text-transform:uppercase;
      font-size:18px;
    }
    .input{
      width:100%;
      padding:14px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--input);
      color:var(--text);
      font-size:18px;
      outline:none;
      box-shadow:0 1px 0 rgba(2,6,23,.03) inset;
    }
    .input:focus{
      border-color:rgba(0,200,83,.55);
      box-shadow:0 0 0 3px rgba(0,200,83,.15);
    }

    .btn{
      width:100%;
      padding:16px 16px;
      border:0;
      border-radius:12px;
      background:var(--green);
      color:#07210f;
      font-weight:900;
      letter-spacing:1px;
      font-size:22px;
      cursor:pointer;
      margin-top:14px;
      box-shadow:0 10px 20px rgba(0,200,83,.18);
    }
    .btn:hover{ background:var(--green2); }
    .btn:active{ transform:translateY(1px); }

    .note{
      margin-top:14px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      color:var(--muted);
      font-weight:800;
      font-size:16px;
      text-align:center;
    }
    .note.error{
      background:rgba(239,68,68,.08);
      border-color:rgba(239,68,68,.25);
      color:#7f1d1d;
    }
    .note.ok{
      background:rgba(0,200,83,.10);
      border-color:rgba(0,200,83,.22);
      color:#065f46;
    }
    .note.warn{
      background:rgba(245,158,11,.12);
      border-color:rgba(245,158,11,.25);
      color:#7c2d12;
    }

    /* APP */
    .appWrap{ padding:18px; display:none; }
    .appPanel{
      width:min(1200px,98vw);
      margin:0 auto;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .appHeader{
      text-align:center;
      font-weight:1000;
      font-size:44px;
      letter-spacing:.5px;
      padding:22px 14px 8px;
      margin:0;
      color:var(--text);
    }
    .roleLine{
      text-align:center;
      margin:0 0 12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.6px;
    }

    .tabbar{
      display:flex;
      gap:0;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin; /* Firefox: show thin scrollbar */
      scrollbar-color: rgba(0,0,0,.12) transparent;
      -ms-overflow-style: auto; /* IE 10+ */
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      background:var(--panel2);
      scroll-behavior: smooth;
    }
    .tabbar::-webkit-scrollbar{ height:6px; }
    .tabbar::-webkit-scrollbar-track{ background: transparent; }
    .tabbar::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.12); border-radius:4px; }
    @media (max-width: 900px){
      .tabbar{ /* keep horizontal scroll on small screens */ }
      .tabbar .logoutBtn{ margin-left:auto; }
    }
    .tab{
      flex:1;
      padding:16px 10px;
      text-align:center;
      font-weight:1000;
      letter-spacing:1px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      font-size:18px;
      border-right:1px solid var(--border);
    }
    .tab:last-child{ border-right:0; }
    .tab.active{
      background:rgba(0,200,83,.14);
      color:#064e3b;
      box-shadow: inset 0 -3px 0 rgba(0,200,83,.55);
    }
    #logoutBtn:hover{
      background:rgba(239,68,68,.08);
    }
    #logoutBtn:hover svg{
      color:var(--danger);
    }

    .content{ padding:18px; background:var(--bg); }
    .sectionTitle{
      text-align:center;
      font-weight:1000;
      font-size:26px;
      margin:8px 0 14px;
      color:var(--text);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow:var(--shadow2);
      height:100%;
    }
    .card h3{
      margin:0 0 12px;
      text-align:center;
      font-weight:1000;
      font-size:22px;
      color:var(--text);
    }

    .actionBtn{
      width:100%;
      padding:16px 14px;
      border:0;
      border-radius:14px;
      background:var(--green);
      color:#07210f;
      font-weight:1000;
      letter-spacing:1px;
      font-size:20px;
      cursor:pointer;
      margin-top:10px;
      box-shadow:0 10px 18px rgba(0,200,83,.14);
    }
    .actionBtn:hover{ background:var(--green2); }
    .actionBtn.red{
      background:var(--danger);
      color:#1b0707;
      box-shadow:0 10px 18px rgba(239,68,68,.14);
    }
    .actionBtn.red:hover{ background:var(--danger2); }

    .statusBox{
      margin-top:12px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      font-size:16px;
      font-weight:900;
      color:var(--muted);
      min-height:56px;
      display:flex;
      align-items:center;
    }
    .statusBox.ok{
      background:rgba(0,200,83,.10);
      border-color:rgba(0,200,83,.22);
      color:#065f46;
    }
    .statusBox.error{
      background:rgba(239,68,68,.08);
      border-color:rgba(239,68,68,.22);
      color:#7f1d1d;
    }
    .statusBox.warn{
      background:rgba(245,158,11,.12);
      border-color:rgba(245,158,11,.25);
      color:#7c2d12;
    }

    .searchRow{
      display:grid;
      grid-template-columns: 1fr 180px;
      gap:12px;
    }
    @media (max-width: 720px){
      .searchRow{ grid-template-columns: 1fr; }
    }
    .searchBtn{
      width:100%;
      padding:14px 14px;
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--panel2);
      color:var(--text);
      font-weight:1000;
      font-size:18px;
      cursor:pointer;
    }
    .searchBtn:hover{ background:#eef2f7; }

    .hintLine{
      text-align:center;
      margin-top:8px;
      color:var(--muted);
      font-weight:800;
      word-break:break-word;
      font-size:14px;
    }

    .subBox{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--panel2);
      display:none;
    }
    .subTitle{
      font-weight:1000;
      margin:0 0 10px;
      text-align:center;
      color:var(--text);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:12px;
      font-size:15px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
    }
    th, td{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
      color:var(--text);
    }
    th{
      background:var(--panel2);
      font-weight:1000;
      letter-spacing:.6px;
      color:var(--muted);
      text-transform:uppercase;
      font-size:12px;
    }
    tr:last-child td{ border-bottom:0; }

    .tableWrap{
      max-height:460px;
      overflow:auto;
      border-radius:14px;
      margin-top:10px;
    }

    .badge{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      line-height:22px;
      border:1px solid transparent;
    }
    .b-admin{ background:rgba(2,6,23,.06); color:#0f172a; border-color:rgba(2,6,23,.10); }
    .b-packer{ background:rgba(245,158,11,.14); color:#7c2d12; border-color:rgba(245,158,11,.22); }
    .b-stower{ background:rgba(59,130,246,.12); color:#1e3a8a; border-color:rgba(59,130,246,.18); }
    .b-welder{ background:rgba(139,92,246,.12); color:#5b21b6; border-color:rgba(139,92,246,.20); }
    .b-empty{ background:rgba(0,200,83,.12); color:#065f46; border-color:rgba(0,200,83,.20); }
    .b-full{ background:rgba(239,68,68,.10); color:#7f1d1d; border-color:rgba(239,68,68,.20); }

    .setupBox{
      margin-top:14px;
      padding:14px;
      border-radius:16px;
      border:1px dashed rgba(100,116,139,.45);
      background:var(--panel2);
      display:none;
    }
    .setupTitle{
      font-weight:1000;
      font-size:16px;
      margin:0 0 10px;
      text-align:center;
      color:var(--text);
    }
    .setupRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:720px){
      .setupRow{ grid-template-columns:1fr; }
    }
    .setupBtn{
      margin-top:10px;
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#eef2f7;
      color:var(--text);
      font-weight:1000;
      font-size:16px;
      cursor:pointer;
    }
    .setupBtn:hover{ background:#e7edf6; }

    /* ADMIN SUMMARY */
    .statsGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){
      .statsGrid{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      .statsGrid{ grid-template-columns: 1fr; }
    }
    .stat{
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--panel2);
      padding:14px;
    }
    .stat .k{
      font-weight:1000;
      letter-spacing:.8px;
      color:var(--muted);
      text-transform:uppercase;
      font-size:12px;
    }
    .stat .v{
      margin-top:6px;
      font-weight:1000;
      font-size:26px;
      color:var(--text);
    }

    .adminRow{
      display:grid;
      grid-template-columns: 1fr 180px;
      gap:12px;
    }
    @media (max-width: 720px){
      .adminRow{ grid-template-columns: 1fr; }
    }

    .b-wait{ background:rgba(100,116,139,.12); color:#334155; border-color:rgba(100,116,139,.18); }
    .b-done{ background:rgba(0,200,83,.12); color:#065f46; border-color:rgba(0,200,83,.20); }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 4px 0;
      z-index: 10000;
      min-width: 150px;
      display: none;
    }
    .context-menu-item {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s;
    }
    .context-menu-item:hover {
      background: rgba(59,130,246,.08);
    }
    .context-menu-item.danger {
      color: #dc2626;
    }
    .context-menu-item.danger:hover {
      background: rgba(239,68,68,.08);
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div class="center" id="loginView">
    <div class="loginCard">
      <h1 class="title">Gabya Home</h1>

      <input id="pwInput" class="input" type="password" placeholder="≈ûifreyi girin" />

      <button class="btn" id="loginBtn" type="button">Gƒ∞Rƒ∞≈û YAP</button>

      <div class="note" id="loginNote" style="display:none;"></div>
    </div>
  </div>

  <!-- APP -->
  <div class="appWrap" id="appView">
    <div class="appPanel">
      <div style="display:grid;grid-template-columns:auto 1fr auto;align-items:center;padding:0 18px;">
        <button id="logoutBtn" style="background:none;border:none;cursor:pointer;padding:8px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:background .2s;" title="√áƒ±kƒ±≈ü Yap">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#64748b;">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </button>
        <h1 class="appHeader" style="margin:0;text-align:center;">GABYA HOME</h1>
        <div style="width:44px;"></div>
      </div>
      <div class="roleLine" id="roleLine"></div>

      <!-- Context Menu -->
      <div id="contextMenu" class="context-menu">
        <div class="context-menu-item danger" id="contextMenuDelete">Talebi Sil</div>
      </div>

      <div class="tabbar" id="tabbar">
        <div class="tab" id="tabPut">RAFA √úR√úN KOY</div>
        <div class="tab" id="tabClear">RAF BO≈ûALT</div>
        <div class="tab" id="tabSearch">√úR√úN ARA</div>
        <div class="tab" id="tabRack">RAF DURUMU</div>
        <div class="tab" id="tabRequest">√úR√úN TALEP</div>
        <div class="tab" id="tabMaterialRequest">MALZEME TALEP</div>
        <div class="tab" id="tabWelder">√úRETƒ∞M Gƒ∞Rƒ∞≈ûƒ∞</div>
        <div class="tab" id="tabWelderRequests">Sƒ∞PARƒ∞≈ûLER</div>
        <div class="tab" id="tabProduction">√úRETƒ∞M KAYITLARI</div>
        <div class="tab" id="tabPurchase">SATIN ALMA</div>
        <div class="tab" id="tabInstructions">√úRETƒ∞M TALƒ∞MATLARI</div>
        <div class="tab" id="tabPackaging">PAKETLEME TALƒ∞MATLARI</div>
        <div class="tab" id="tabPayments">PERSONEL √ñDEMELERƒ∞</div>
        <div class="tab" id="tabAccounts">CARƒ∞ HESAPLAR</div>
        <div class="tab" id="tabCommissionSummary">ETSY BAYƒ∞LERƒ∞</div>
        <div class="tab" id="tabCommission">KOMƒ∞SYONLU SATI≈ûLAR</div>
        <div class="tab" id="tabAdmin">Y√ñNETƒ∞Cƒ∞</div>
      </div>

      <div class="content">

        <!-- VIEW: PUT -->
        <div id="viewPut" style="display:none;">
          <div class="sectionTitle"></div>
          <div class="card">
            <h3></h3>

            <label class="fieldLabel">√úr√ºn Kodu</label>
            <input id="inProduct" class="input" />

            <label class="fieldLabel">Raf Numarasƒ±</label>
            <input id="inShelfNum" class="input" type="number" min="1" />

            <label class="fieldLabel">Adet</label>
            <input id="inQty" class="input" type="number" min="1" value="1" />

            <button class="actionBtn" id="btnPut" type="button">√úR√úN√ú RAFA KOY</button>

            <div class="statusBox" id="statusPut" style="display:none;"></div>
          </div>
        </div>

        <!-- VIEW: CLEAR -->
        <div id="viewClear" style="display:none;">
          <div class="sectionTitle"></div>
          <div class="card">
            <h3></h3>

            <label class="fieldLabel">Raf Numarasƒ±</label>
            <input id="outShelfNum" class="input" type="number" min="1" />

            <div class="subBox" id="clearProductBox">
              <div class="subTitle" id="clearBoxTitle">Bu rafta birden fazla √ºr√ºn var</div>

              <label class="fieldLabel">√úr√ºn Kodu</label>
              <input id="outProductCode" class="input" />

              <!-- ‚úÖ Adet azalt (sadece gerekli olduƒüunda a√ßƒ±lƒ±r) -->
              <div id="clearQtyBox" style="display:none; margin-top:10px;">
                <label class="fieldLabel">Adet (Azalt)</label>
                <input id="outReduceQty" class="input" type="number" min="1" value="1" />
                <div class="hintLine" id="clearQtyHint"></div>
              </div>

              <div class="hintLine" id="clearHint"></div>
            </div>

            <button class="actionBtn red" id="btnClear" type="button">RAFI BO≈ûALT</button>

            <div class="statusBox" id="statusClear" style="display:none;"></div>
          </div>
        </div>

        <!-- VIEW: SEARCH -->
        <div id="viewSearch" style="display:none;">
          <div class="sectionTitle"></div>

          <div class="card">
            <h3 style="margin-top:0;"></h3>
            <div class="searchRow">
              <input id="searchCode" class="input" style="margin:0;" />
              <button class="searchBtn" id="btnSearch" type="button">ARA</button>
            </div>

            <div class="statusBox" id="statusSearch" style="margin-top:12px;display:none;"></div>

            <div class="tableWrap" id="searchWrap" style="display:none;">
              <table>
                <thead>
                  <tr><th>Raf</th><th>Adet</th></tr>
                </thead>
                <tbody id="searchBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: RACK STATUS -->
        <div id="viewRack" style="display:none;">
          <div class="sectionTitle"></div>

          <div class="card">
            <h3 style="margin-top:0;"></h3>

            <div class="hintLine" id="rackHint"></div>

            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Raf</th>
                    <th>Durum</th>
                    <th>√úr√ºnler</th>
                  </tr>
                </thead>
                <tbody id="rackBody"></tbody>
              </table>
            </div>

            <div class="setupBox" id="setupBox">
              <div class="setupTitle">ƒ∞lk Kurulum</div>
              <div class="setupRow">
                <input id="setupCount" class="input" type="number" min="1" value="300" style="margin:0;" />
                <input id="setupPrefix" class="input" value="R" style="margin:0;" />
              </div>
              <button class="setupBtn" id="btnSetup" type="button">RAFLARI OLU≈ûTUR</button>
              <div class="hintLine" id="setupStatus"></div>
            </div>
          </div>
        </div>

        <!-- VIEW: REQUEST -->
        <div id="viewRequest" style="display:none;">

          <div class="card">

            <label class="fieldLabel">√úr√ºn Kodu</label>
            <input id="reqProduct" class="input" placeholder="" />

            <label class="fieldLabel" style="margin-top:14px;">√úretim Modeli</label>
            <select id="reqProductionType" class="input">
              <option value="">Se√ßiniz</option>
              <option value="welder">Kaynak</option>
              <option value="laser">Lazer</option>
            </select>

            <button class="actionBtn" id="btnReq" type="button">√úRETƒ∞MDEN TALEP ET</button>

            <div class="statusBox" id="statusReq" style="display:none;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">√úretim Taleplerim</h3>

            <div class="statusBox" id="statusReqList">Y√ºkleniyor...</div>

            <div class="tableWrap" id="reqWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>√úr√ºn Kodu</th>
                    <th>Durum</th>
                    <th>Talep Eden</th>
                    <th>Talebi Kar≈üƒ±layan</th>
                  </tr>
                </thead>
                <tbody id="reqBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: PRODUCTION (For Admin & Packer) -->
        <div id="viewProduction" style="display:none;">

          <div class="card">
            <h3 style="margin-top:0;">T√ºm √úretimler</h3>
            
            <div class="adminRow" style="gap:8px;">
              <button class="searchBtn" id="btnProdDay" type="button">G√úNL√úK</button>
              <button class="searchBtn" id="btnProdWeek" type="button">HAFTALIK</button>
              <button class="searchBtn" id="btnProdMonth" type="button">AYLIK</button>
              <button class="searchBtn" id="btnProdYear" type="button">YILLIK</button>
            </div>

            <div class="statusBox" id="statusProduction" style="margin-top:12px;display:none;"></div>

            <div class="tableWrap" id="productionWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih & Saat</th>
                    <th>√úr√ºn Kodu</th>
                    <th>Adet</th>
                    <th>√úretim</th>
                  </tr>
                </thead>
                <tbody id="productionBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: WELDER -->
        <div id="viewWelder" style="display:none;">
          <div class="sectionTitle">√úretim Giri≈üi</div>

          <div class="card">
            <h3 style="margin-top:0;">√úretilen √úr√ºn Giri≈üi</h3>
            
            <div class="formRow">
              <label>√úr√ºn Kodu</label>
              <input id="welderCode" class="input" type="text" placeholder="√úr√ºn kodu giriniz" />
            </div>

            <div class="formRow">
              <label>Adet</label>
              <input id="welderQty" class="input" type="number" min="1" placeholder="Adet giriniz" />
            </div>

            <button class="btn" id="welderSave">KAYDET</button>

            <div class="statusBox" id="statusWelder" style="display:none;margin-top:12px;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Bug√ºnk√º √úretim</h3>
            <div class="statusBox" id="statusWelderToday" style="display:none;"></div>
            <div class="tableWrap" id="welderTodayWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Saat</th>
                    <th>√úr√ºn Kodu</th>
                    <th>Adet</th>
                  </tr>
                </thead>
                <tbody id="welderTodayBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: WELDER REQUESTS -->
        <div id="viewWelderRequests" style="display:none;">
          <div class="sectionTitle">Talepler</div>

          <div class="card">
            <h3 style="margin-top:0;">T√ºm Talepler</h3>
            <div class="statusBox" id="statusWelderRequests" style="display:none;"></div>
            <div class="tableWrap" id="welderRequestsWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>√úr√ºn Kodu</th>
                    <th>Talep Eden</th>
                    <th>Durum</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody id="welderRequestsBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: MATERIAL REQUEST -->
        <div id="viewMaterialRequest" style="display:none;">

          <div class="card">

            <label class="fieldLabel">Malzeme</label>
            <input id="matReqName" class="input" placeholder="" />

            <label class="fieldLabel" style="margin-top:14px;">Adet</label>
            <input id="matReqQty" class="input" type="number" min="1" value="1" />

            <label class="fieldLabel" style="margin-top:14px;">Not</label>
            <input id="matReqNote" class="input" placeholder="Ek bilgi yazabilirsiniz" />

            <button class="actionBtn" id="btnMatReq" type="button">TALEP OLU≈ûTUR</button>

            <div class="statusBox" id="statusMatReq" style="display:none;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Malzeme Taleplerim</h3>

            <div class="statusBox" id="statusMatReqList">Y√ºkleniyor...</div>

            <div class="tableWrap" id="matReqWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Malzeme</th>
                    <th>Adet</th>
                    <th>Durum</th>
                    <th>Talep Eden</th>
                    <th>Not</th>
                  </tr>
                </thead>
                <tbody id="matReqBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: PURCHASE MANAGEMENT -->
        <div id="viewPurchase" style="display:none;">

          <div class="card">
            <h3 style="margin-top:0;">T√ºm Malzeme Talepleri</h3>
            
            <div class="statusBox" id="statusPurchase" style="margin-top:12px;display:none;"></div>

            <div class="tableWrap" id="purchaseWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Malzeme</th>
                    <th>Adet</th>
                    <th>Talep Eden</th>
                    <th>Not</th>
                    <th>Durum</th>
                    <th>ƒ∞≈ülem</th>
                    <th>Not Ekle</th>
                    <th>Reddet</th>
                  </tr>
                </thead>
                <tbody id="purchaseBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: INSTRUCTIONS -->
        <div id="viewInstructions" style="display:none;">
          <div class="card">
            <h3 style="margin-top:0;">√úretim Talimatlarƒ±</h3>
            
            <label class="fieldLabel">√úr√ºn Kodu</label>
            <input id="instructionsProductCode" class="input" placeholder="√ñrn: 7001" />
            
            <button class="actionBtn" id="btnLoadInstructions" type="button" style="margin-top:16px;">TALƒ∞MATI G√ñSTER</button>
            
            <div class="statusBox" id="statusInstructions" style="display:none;margin-top:16px;"></div>
            
            <div id="instructionsContent" style="margin-top:24px;display:none;">
              <h4 style="margin:0 0 12px 0;color:var(--text);">√úretim Talimatƒ±</h4>
              <div id="instructionContainer" style="width:100%;min-height:600px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--panel2);display:flex;align-items:center;justify-content:center;"></div>
            </div>
          </div>
        </div>

        <!-- VIEW: PACKAGING -->
        <div id="viewPackaging" style="display:none;">
          <div class="card">
            <h3 style="margin-top:0;">Paketleme Talimatlarƒ±</h3>
            
            <label class="fieldLabel">√úr√ºn Kodu</label>
            <input id="packagingProductCode" class="input" placeholder="√ñrn: 7001" />
            
            <button class="actionBtn" id="btnLoadPackaging" type="button" style="margin-top:16px;">TALƒ∞MATI G√ñSTER</button>
            
            <div class="statusBox" id="statusPackaging" style="display:none;margin-top:16px;"></div>
            
            <div id="packagingContent" style="margin-top:24px;display:none;">
              <h4 style="margin:0 0 12px 0;color:var(--text);">Paketleme Talimatƒ±</h4>
              <div id="packagingContainer" style="width:100%;min-height:600px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--panel2);display:flex;align-items:center;justify-content:center;"></div>
            </div>
          </div>
        </div>

        <!-- VIEW: PAYMENTS -->
        <div id="viewPayments" style="display:none;">
          
          <!-- Yakla≈üan ve Gecikmi≈ü √ñdemeler -->
          <div class="card" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;margin-bottom:16px;">
            <h3 style="margin:0 0 16px 0;color:white;">Maa≈ü √ñdeme Takibi</h3>
            
            <div id="upcomingPaymentsAlert" style="background:rgba(255,255,255,0.2);padding:16px;border-radius:8px;margin-bottom:12px;">
              <div style="font-weight:900;font-size:14px;margin-bottom:8px;">‚è∞ YAKINLA≈ûAN √ñDEMELER (7 G√ºn ƒ∞√ßinde)</div>
              <div id="upcomingPaymentsList" style="font-size:13px;"></div>
            </div>
            
            <div id="overduePaymentsAlert" style="background:rgba(255,59,48,0.3);padding:16px;border-radius:8px;">
              <div style="font-weight:900;font-size:14px;margin-bottom:8px;">üö® GECƒ∞KMƒ∞≈û √ñDEMELER</div>
              <div id="overduePaymentsList" style="font-size:13px;"></div>
            </div>
          </div>

          <!-- Personel Y√∂netimi -->
          <div class="card">
            <h3 style="margin-top:0;">Personel Tanƒ±mlama</h3>
            
            <div style="margin-bottom:24px;">
              <label class="fieldLabel">Personel Adƒ±</label>
              <input id="personnelName" class="input" placeholder="√ñrn: Evan" />

              <label class="fieldLabel" style="margin-top:12px;">Maa≈ü Periyodu</label>
              <select id="personnelPaymentPeriod" class="input">
                <option value="monthly">Aylƒ±k</option>
                <option value="weekly">Haftalƒ±k</option>
              </select>

              <div id="monthlyPaymentFields">
                <label class="fieldLabel" style="margin-top:12px;">Maa≈ü √ñdeme G√ºn√º (Ayƒ±n Ka√ßƒ±nda)</label>
                <input id="personnelPaymentDayMonthly" class="input" type="number" min="1" max="31" placeholder="√ñrn: 10 (ayƒ±n 10'unda)" />
              </div>

              <div id="weeklyPaymentFields" style="display:none;">
                <label class="fieldLabel" style="margin-top:12px;">Maa≈ü √ñdeme G√ºn√º (Haftanƒ±n Hangi G√ºn√º)</label>
                <select id="personnelPaymentDayWeekly" class="input">
                  <option value="1">Pazartesi</option>
                  <option value="2">Salƒ±</option>
                  <option value="3">√áar≈üamba</option>
                  <option value="4">Per≈üembe</option>
                  <option value="5">Cuma</option>
                  <option value="6">Cumartesi</option>
                  <option value="0">Pazar</option>
                </select>
              </div>

              <label class="fieldLabel" style="margin-top:12px;">Maa≈ü Tutarƒ± (TL)</label>
              <input id="personnelSalary" class="input" type="number" placeholder="√ñrn: 17000" />

              <label class="fieldLabel" style="margin-top:12px;">ƒ∞≈üe Ba≈ülama Tarihi</label>
              <input id="personnelStartDate" class="input" type="date" />

              <button class="actionBtn" id="btnAddPersonnel" type="button" style="margin-top:16px;">PERSONEL EKLE</button>

              <div class="statusBox" id="statusPersonnel" style="display:none;margin-top:12px;"></div>
            </div>

            <!-- Personel D√ºzenleme Formu -->
            <div id="editPersonnelSection" style="display:none;background:#fff3cd;padding:16px;border-radius:8px;margin-bottom:24px;border:2px solid #ffc107;">
              <h4 style="margin:0 0 12px 0;color:#856404;">Personel D√ºzenle</h4>
              
              <input id="editPersonnelId" type="hidden" />
              
              <label class="fieldLabel">Personel Adƒ±</label>
              <input id="editPersonnelName" class="input" placeholder="√ñrn: Evan" />

              <label class="fieldLabel" style="margin-top:12px;">Maa≈ü Periyodu</label>
              <select id="editPersonnelPaymentPeriod" class="input">
                <option value="monthly">Aylƒ±k</option>
                <option value="weekly">Haftalƒ±k</option>
              </select>

              <div id="editMonthlyPaymentFields">
                <label class="fieldLabel" style="margin-top:12px;">Maa≈ü √ñdeme G√ºn√º (Ayƒ±n Ka√ßƒ±nda)</label>
                <input id="editPersonnelPaymentDayMonthly" class="input" type="number" min="1" max="31" placeholder="√ñrn: 10" />
              </div>

              <div id="editWeeklyPaymentFields" style="display:none;">
                <label class="fieldLabel" style="margin-top:12px;">Maa≈ü √ñdeme G√ºn√º (Haftanƒ±n Hangi G√ºn√º)</label>
                <select id="editPersonnelPaymentDayWeekly" class="input">
                  <option value="1">Pazartesi</option>
                  <option value="2">Salƒ±</option>
                  <option value="3">√áar≈üamba</option>
                  <option value="4">Per≈üembe</option>
                  <option value="5">Cuma</option>
                  <option value="6">Cumartesi</option>
                  <option value="0">Pazar</option>
                </select>
              </div>

              <label class="fieldLabel" style="margin-top:12px;">Maa≈ü Tutarƒ± (TL)</label>
              <input id="editPersonnelSalary" class="input" type="number" placeholder="√ñrn: 17000" />

              <label class="fieldLabel" style="margin-top:12px;">ƒ∞≈üe Ba≈ülama Tarihi</label>
              <input id="editPersonnelStartDate" class="input" type="date" />

              <div style="display:flex;gap:8px;margin-top:16px;">
                <button class="actionBtn" id="btnUpdatePersonnel" type="button" style="flex:1;">G√úNCELLE</button>
                <button class="actionBtn" id="btnCancelEdit" type="button" style="flex:1;background:var(--muted);">ƒ∞PTAL</button>
              </div>

              <div class="statusBox" id="statusEditPersonnel" style="display:none;margin-top:12px;"></div>
            </div>

            <h4 style="margin:0 0 12px 0;color:var(--text);">Kayƒ±tlƒ± Personeller</h4>
            
            <div id="personnelListWrap" style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);margin-bottom:24px;">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">PERSONEL</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">PERƒ∞YOT</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">√ñDEME G√úN√ú</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">MAA≈û</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">SONRAKƒ∞ √ñDEME</th>
                    <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                  </tr>
                </thead>
                <tbody id="personnelListBody">
                  <tr><td colspan="6" style="padding:24px;text-align:center;color:var(--muted);">Personel y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- √ñdeme Yapma -->
          <div class="card">
            <h3 style="margin-top:0;">√ñdeme Yap</h3>
            
            <label class="fieldLabel">Personel Se√ß</label>
            <select id="paymentPersonSelect" class="input">
              <option value="">Personel Se√ßiniz...</option>
            </select>

            <label class="fieldLabel" style="margin-top:12px;">ƒ∞≈ülem Tipi</label>
            <select id="paymentType" class="input">
              <option value="salary">Maa≈ü</option>
              <option value="advance">Avans</option>
            </select>

            <label class="fieldLabel" style="margin-top:12px;">Tutar (TL)</label>
            <input id="paymentAmount" class="input" type="number" placeholder="Tutar giriniz" />

            <label class="fieldLabel" style="margin-top:12px;">Tarih</label>
            <input id="paymentDate" class="input" type="date" />

            <label class="fieldLabel" style="margin-top:12px;">Not / A√ßƒ±klama</label>
            <textarea id="paymentNote" class="input" rows="2" placeholder="ƒ∞steƒüe baƒülƒ± not ekleyin..."></textarea>

            <button class="actionBtn" id="btnAddPayment" type="button" style="margin-top:16px;">√ñDEME KAYDET</button>

            <div class="statusBox" id="statusPayment" style="display:none;margin-top:12px;"></div>

            <div style="margin-top:24px;">
              <h4 style="margin:0 0 12px 0;color:var(--text);">√ñdeme Kayƒ±tlarƒ±</h4>
              
              <div style="margin-bottom:12px;">
                <input id="paymentSearchName" class="input" placeholder="Personel adƒ±na g√∂re filtrele..." style="margin-bottom:8px;" />
                
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;">
                  <button class="searchBtn" id="btnFilterAllPayments" type="button" style="font-size:13px;padding:10px;">T√úM√ú</button>
                  <button class="searchBtn" id="btnFilterSalary" type="button" style="font-size:13px;padding:10px;">MAA≈ûLAR</button>
                  <button class="searchBtn" id="btnFilterAdvance" type="button" style="font-size:13px;padding:10px;">AVANSLAR</button>
                </div>
              </div>

              <div id="paymentListWrap" style="max-height:500px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);">
                <table style="width:100%;border-collapse:collapse;">
                  <thead>
                    <tr style="background:var(--panel1);position:sticky;top:0;">
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TARƒ∞H</th>
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">PERSONEL</th>
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Tƒ∞P</th>
                      <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TUTAR</th>
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">NOT</th>
                      <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                    </tr>
                  </thead>
                  <tbody id="paymentListBody">
                    <tr><td colspan="6" style="padding:24px;text-align:center;color:var(--muted);">Kayƒ±t y√ºkleniyor...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- VIEW: ACCOUNTS -->
        <div id="viewAccounts" style="display:none;">
          <div class="card">
            <h3 style="margin-top:0;">Firma Bor√ß Takibi</h3>
            
            <div style="margin-bottom:24px;">
              
              <label class="fieldLabel">Firma Adƒ±</label>
              <input id="accountCompanyName" class="input" list="companyList" />
              <datalist id="companyList"></datalist>

              <label class="fieldLabel" style="margin-top:12px;">ƒ∞≈ülem Tipi</label>
              <select id="accountTransactionType" class="input">
                <option value="purchase">Mal Alƒ±mƒ± (Bor√ß)</option>
                <option value="payment">√ñdeme</option>
              </select>

              <div id="purchaseFields" style="display:block;">
                <label class="fieldLabel" style="margin-top:12px;">Mal/Hizmet Adƒ±</label>
                <input id="accountItemName" class="input" />

                <label class="fieldLabel" style="margin-top:12px;">Adet/Miktar</label>
                <input id="accountItemQuantity" class="input" type="number" />

                <label class="fieldLabel" style="margin-top:12px;">Fatura Tutarƒ± (TL)</label>
                <input id="accountInvoiceAmount" class="input" type="number" placeholder="√ñrn: 50000" />
              </div>

              <div id="paymentFields" style="display:none;">
                <label class="fieldLabel" style="margin-top:12px;">√ñdeme Tutarƒ± (TL)</label>
                <input id="accountPaymentAmount" class="input" type="number" placeholder="√ñrn: 25000" />
              </div>

              <label class="fieldLabel" style="margin-top:12px;">Not / A√ßƒ±klama</label>
              <textarea id="accountNote" class="input" rows="2" placeholder="ƒ∞steƒüe baƒülƒ± not ekleyin..."></textarea>

              <button class="actionBtn" id="btnAddAccountTransaction" type="button" style="margin-top:16px;">KAYDET</button>

              <div class="statusBox" id="statusAccount" style="display:none;margin-top:12px;"></div>
            </div>

            <!-- Firma Adƒ± D√ºzenleme Formu -->
            <div id="editCompanySection" style="display:none;background:#fff3cd;padding:16px;border-radius:8px;margin-top:24px;margin-bottom:24px;border:2px solid #ffc107;">
              <h4 style="margin:0 0 12px 0;color:#856404;">Firma Adƒ±nƒ± D√ºzenle</h4>
              
              <input id="editCompanyOldName" type="hidden" />
              
              <label class="fieldLabel">Yeni Firma Adƒ±</label>
              <input id="editCompanyNewName" class="input" placeholder="√ñrn: ABC Demir √áelik" />

              <div style="display:flex;gap:8px;margin-top:16px;">
                <button class="actionBtn" id="btnUpdateCompany" type="button" style="flex:1;">G√úNCELLE</button>
                <button class="actionBtn" id="btnCancelCompanyEdit" type="button" style="flex:1;background:var(--muted);">ƒ∞PTAL</button>
              </div>

              <div class="statusBox" id="statusEditCompany" style="display:none;margin-top:12px;"></div>
            </div>

            <div style="margin-top:24px;">
              <h4 style="margin:0 0 12px 0;color:var(--text);">Firma Bakiyeleri</h4>
              
              <div id="companyBalancesWrap" style="max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);margin-bottom:24px;">
                <table style="width:100%;border-collapse:collapse;">
                  <thead>
                    <tr style="background:var(--panel1);position:sticky;top:0;">
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Fƒ∞RMA</th>
                      <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TOPLAM ALIM</th>
                      <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TOPLAM √ñDEME</th>
                      <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">BAKƒ∞YE (BOR√á)</th>
                      <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                    </tr>
                  </thead>
                  <tbody id="companyBalancesBody">
                    <tr><td colspan="5" style="padding:24px;text-align:center;color:var(--muted);">Kayƒ±t y√ºkleniyor...</td></tr>
                  </tbody>
                </table>
              </div>

              <h4 style="margin:0 0 12px 0;color:var(--text);">ƒ∞≈ülem Ge√ßmi≈üi</h4>
              
              <div style="margin-bottom:12px;">
                <input id="accountSearchCompany" class="input" placeholder="Firmaya g√∂re filtrele..." style="margin-bottom:8px;" />
                
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;">
                  <button class="searchBtn" id="btnFilterAllTransactions" type="button" style="font-size:13px;padding:10px;">T√úM√ú</button>
                  <button class="searchBtn" id="btnFilterPurchases" type="button" style="font-size:13px;padding:10px;">ALIMLAR</button>
                  <button class="searchBtn" id="btnFilterPayments" type="button" style="font-size:13px;padding:10px;">√ñDEMELER</button>
                </div>
              </div>

              <div id="accountListWrap" style="max-height:500px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);">
                <table style="width:100%;border-collapse:collapse;">
                  <thead>
                    <tr style="background:var(--panel1);position:sticky;top:0;">
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TARƒ∞H</th>
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Fƒ∞RMA</th>
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Tƒ∞P</th>
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">DETAY</th>
                      <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TUTAR</th>
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">NOT</th>
                      <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                    </tr>
                  </thead>
                  <tbody id="accountListBody">
                    <tr><td colspan="7" style="padding:24px;text-align:center;color:var(--muted);">Kayƒ±t y√ºkleniyor...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- VIEW: COMMISSION -->
        <div id="viewCommission" style="display:none;">
          <div class="card">
            <h3 style="margin-top:0;">ETSY Komisyonlu Satƒ±≈ülar</h3>
            
            <h4 style="margin:0 0 12px 0;color:var(--text);">Hak Edi≈ü Durumu</h4>
            
            <div id="commissionSummarySection" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:20px;border-radius:8px;margin-bottom:24px;">
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
                <div>
                  <div style="font-size:13px;opacity:0.9;">Toplam Gelir</div>
                  <div style="font-size:24px;font-weight:900;" id="myTotalIncome">0 ‚Ç∫</div>
                </div>
                <div>
                  <div style="font-size:13px;opacity:0.9;">Toplam Gider (≈ûirket √ústlenir)</div>
                  <div style="font-size:24px;font-weight:900;" id="myTotalExpense">0 ‚Ç∫</div>
                </div>
                <div>
                  <div style="font-size:13px;opacity:0.9;">Benim Net Payƒ±m</div>
                  <div style="font-size:24px;font-weight:900;" id="myNetAmount">0 ‚Ç∫</div>
                </div>
                <div>
                  <div style="font-size:13px;opacity:0.9;">Benim Payƒ±m (Gelir √ó %20)</div>
                  <div style="font-size:28px;font-weight:900;color:#fbbf24;" id="myCommission">0 ‚Ç∫</div>
                </div>
              </div>
            </div>

            <div id="commissionFormSection" style="margin-bottom:24px;">
              <h4 style="margin:0 0 12px 0;color:var(--text);">Yeni ƒ∞≈ülem Ekle</h4>
              <label class="fieldLabel">ƒ∞≈ülem Tipi</label>
              <select id="commissionTransactionType" class="input">
                <option value="income">Gelir (Satƒ±≈ü)</option>
                <option value="expense">Gider (ƒ∞ade/Kesinti)</option>
              </select>

              <label class="fieldLabel" style="margin-top:12px;">Tutar (TL)</label>
              <input id="commissionAmount" class="input" type="number" placeholder="√ñrn: 5000" />

              <label class="fieldLabel" style="margin-top:12px;">A√ßƒ±klama</label>
              <textarea id="commissionNote" class="input" rows="2" placeholder="√ñrn: ETSY satƒ±≈ü √∂demesi, ƒ∞ade, Kargo kesintisi vb."></textarea>

              <button class="actionBtn" id="btnAddCommission" type="button" style="margin-top:16px;">KAYDET</button>

              <div class="statusBox" id="statusCommission" style="display:none;margin-top:12px;"></div>
            </div>

            <h4 style="margin:0 0 12px 0;color:var(--text);">ƒ∞≈ülem Ge√ßmi≈üi</h4>
            
            <div style="margin-bottom:12px;">
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;">
                <button class="searchBtn" id="btnFilterAllCommission" type="button" style="font-size:13px;padding:10px;">T√úM√ú</button>
                <button class="searchBtn" id="btnFilterIncome" type="button" style="font-size:13px;padding:10px;">GELƒ∞RLER</button>
                <button class="searchBtn" id="btnFilterExpense" type="button" style="font-size:13px;padding:10px;">Gƒ∞DERLER</button>
              </div>
            </div>

            <div id="commissionListWrap" style="max-height:500px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TARƒ∞H</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Tƒ∞P</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TUTAR</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">A√áIKLAMA</th>
                    <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                  </tr>
                </thead>
                <tbody id="commissionListBody">
                  <tr><td colspan="5" style="padding:24px;text-align:center;color:var(--muted);">Kayƒ±t y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>

            <h4 style="margin:24px 0 12px 0;color:var(--text);">Tahsilat Ge√ßmi≈üi</h4>
            <div id="myPaymentsWrap" style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TARƒ∞H</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TUTAR</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">A√áIKLAMA</th>
                  </tr>
                </thead>
                <tbody id="myPaymentsBody">
                  <tr><td colspan="3" style="padding:24px;text-align:center;color:var(--muted);">Y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: COMMISSION SUMMARY -->
        <div id="viewCommissionSummary" style="display:none;">
          <div class="sectionTitle">Satƒ±≈ü √ñzeti</div>
          
          <div class="card">
            <table style="width:100%;border-collapse:collapse;margin-top:16px;">
              <thead style="background:var(--card);">
                <tr>
                  <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);">SATICI</th>
                  <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);">TOPLAM GELƒ∞R</th>
                  <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);">TOPLAM Gƒ∞DER</th>
                  <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);">≈ûƒ∞RKET BR√úT (%80)</th>
                  <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);">SATICI PAYI (%20)</th>
                  <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);">≈ûƒ∞RKET NET</th>
                  <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);">ƒ∞≈ûLEM</th>
                </tr>
              </thead>
              <tbody id="commissionSummaryBody">
                <tr><td colspan="7" style="padding:24px;text-align:center;color:var(--muted);">Y√ºkleniyor...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="card" style="margin-top:24px;">
            <h2>Tahsilat Giri≈üi</h2>
            <p style="color:#666;font-size:14px;margin-top:8px;">Bayilerden yapƒ±lan tahsilatlarƒ± kaydedin. Tahsilatlar ≈üirket hak edi≈üinden d√º≈üer.</p>
            
            <div style="display:grid;grid-template-columns:1fr 1fr 2fr auto;gap:12px;margin-top:16px;align-items:end;">
              <div>
                <label class="fieldLabel">Satƒ±cƒ±</label>
                <select id="collectionSellerPin" class="input">
                  <option value="">Satƒ±cƒ± Se√ßin</option>
                </select>
              </div>
              <div>
                <label class="fieldLabel">Tahsilat Tutarƒ± (‚Ç∫)</label>
                <input type="number" id="collectionAmount" class="input" placeholder="0.00" step="0.01" />
              </div>
              <div>
                <label class="fieldLabel">A√ßƒ±klama</label>
                <input type="text" id="collectionNote" class="input" placeholder="√ñdeme a√ßƒ±klamasƒ±" />
              </div>
              <div>
                <button id="btnAddCollection" style="padding:12px 24px;background:#28a745;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-size:14px;">TAHSƒ∞LAT KAYDET</button>
              </div>
            </div>
            <div id="statusCollection" style="margin-top:12px;padding:8px;border-radius:4px;display:none;"></div>
          </div>

          <!-- Satƒ±cƒ± Detay Paneli -->
          <div id="sellerDetailSection" style="display:none;margin-top:24px;">
            <div class="card" style="background:#fff3cd;border:2px solid #ffc107;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h2 id="sellerDetailTitle" style="margin:0;">Satƒ±cƒ± Detaylarƒ±</h2>
                <button onclick="hideSellerDetail()" style="padding:8px 16px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:700;">KAPAT</button>
              </div>
              
              <div style="background:#fff;padding:16px;border-radius:8px;margin-bottom:16px;">
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;">
                  <div>
                    <div style="color:#666;font-size:12px;margin-bottom:4px;">Toplam Gelir</div>
                    <div id="detailIncome" style="font-size:20px;font-weight:bold;color:green;">0 ‚Ç∫</div>
                  </div>
                  <div>
                    <div style="color:#666;font-size:12px;margin-bottom:4px;">Toplam Gider</div>
                    <div id="detailExpense" style="font-size:20px;font-weight:bold;color:red;">0 ‚Ç∫</div>
                  </div>
                  <div>
                    <div style="color:#666;font-size:12px;margin-bottom:4px;">Net Tutar</div>
                    <div id="detailNet" style="font-size:20px;font-weight:bold;">0 ‚Ç∫</div>
                  </div>
                  <div>
                    <div style="color:#666;font-size:12px;margin-bottom:4px;">Y√∂netici Hak Edi≈ü (%80)</div>
                    <div id="detailCompanyShare" style="font-size:20px;font-weight:bold;color:blue;">0 ‚Ç∫</div>
                  </div>
                </div>
              </div>

              <h3 style="margin-top:24px;margin-bottom:12px;">ƒ∞≈ülem Ge√ßmi≈üi</h3>
              <table style="width:100%;border-collapse:collapse;">
                <thead style="background:#f8f9fa;">
                  <tr>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">TARƒ∞H</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">Tƒ∞P</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid #dee2e6;">TUTAR</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">A√áIKLAMA</th>
                    <th style="padding:12px;text-align:center;border-bottom:2px solid #dee2e6;">ƒ∞≈ûLEM</th>
                  </tr>
                </thead>
                <tbody id="detailTransactionsBody">
                  <tr><td colspan="5" style="padding:24px;text-align:center;color:#666;">Y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tahsilat Ge√ßmi≈üi -->
          <div class="card" style="margin-top:24px;">
            <h2>Tahsilat Ge√ßmi≈üi</h2>
            <table style="width:100%;border-collapse:collapse;margin-top:16px;">
              <thead style="background:var(--card);">
                <tr>
                  <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);">TARƒ∞H</th>
                  <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);">BAYƒ∞ ADI</th>
                  <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);">TUTAR</th>
                  <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);">A√áIKLAMA</th>
                  <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);">ƒ∞≈ûLEM</th>
                </tr>
              </thead>
              <tbody id="paymentsHistoryBody">
                <tr><td colspan="5" style="padding:24px;text-align:center;color:var(--muted);">Y√ºkleniyor...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- VIEW: ADMIN -->
        <div id="viewAdmin" style="display:none;">
          <div class="sectionTitle">Y√∂netici Paneli</div>

          <div class="card">
            <h3 style="margin-top:0;">√ñzet Panel</h3>

            <div class="statsGrid" style="margin-top:10px;">
              <div class="stat"><div class="k">Toplam Raf</div><div class="v" id="stTotal">-</div></div>
              <div class="stat"><div class="k">Bo≈ü Raf</div><div class="v" id="stEmpty">-</div></div>
              <div class="stat"><div class="k">Dolu Raf</div><div class="v" id="stFull">-</div></div>
              <div class="stat"><div class="k">Toplam √úr√ºn Adedi</div><div class="v" id="stQty">-</div></div>
            </div>

            <div class="hintLine" id="stHint" style="margin-top:10px;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            
            <div id="commissionSummaryWrap" style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);margin-top:16px;">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">SATICI</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TOPLAM GELƒ∞R</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TOPLAM Gƒ∞DER</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">NET TUTAR</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">SATICI PAYI (%20)</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Y√ñNETƒ∞Cƒ∞ HAK EDƒ∞≈û (%80)</th>
                    <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                  </tr>
                </thead>
                <tbody id="commissionSummaryBody">
                  <tr><td colspan="7" style="padding:24px;text-align:center;color:var(--muted);">Komisyon verileri y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card" id="sellerDetailSection" style="margin-top:14px;display:none;">
            <h3 style="margin-top:0;display:flex;justify-content:space-between;align-items:center;">
              <span id="sellerDetailName">Satƒ±cƒ± Detaylarƒ±</span>
              <button onclick="hideSellerDetail()" style="background:#6c757d;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:700;">KAPAT</button>
            </h3>
            
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;">
              <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:20px;border-radius:10px;color:#fff;">
                <div style="font-size:13px;font-weight:700;opacity:0.9;margin-bottom:8px;">TOPLAM GELƒ∞R</div>
                <div id="sellerDetailIncome" style="font-size:26px;font-weight:900;">0 ‚Ç∫</div>
              </div>
              <div style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);padding:20px;border-radius:10px;color:#fff;">
                <div style="font-size:13px;font-weight:700;opacity:0.9;margin-bottom:8px;">TOPLAM Gƒ∞DER</div>
                <div id="sellerDetailExpense" style="font-size:26px;font-weight:900;">0 ‚Ç∫</div>
              </div>
              <div style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);padding:20px;border-radius:10px;color:#fff;">
                <div style="font-size:13px;font-weight:700;opacity:0.9;margin-bottom:8px;">NET TUTAR</div>
                <div id="sellerDetailNet" style="font-size:26px;font-weight:900;">0 ‚Ç∫</div>
              </div>
              <div style="background:linear-gradient(135deg, #fa709a 0%, #fee140 100%);padding:20px;border-radius:10px;color:#fff;">
                <div style="font-size:13px;font-weight:700;opacity:0.9;margin-bottom:8px;">Y√ñNETƒ∞Cƒ∞ HAK EDƒ∞≈û (%80)</div>
                <div id="sellerDetailCommission" style="font-size:26px;font-weight:900;">0 ‚Ç∫</div>
              </div>
            </div>

            <h4 style="margin-top:24px;margin-bottom:12px;">ƒ∞≈ülem Ge√ßmi≈üi</h4>
            
            <div style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TARƒ∞H</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Tƒ∞P</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TUTAR</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">A√áIKLAMA</th>
                  </tr>
                </thead>
                <tbody id="sellerDetailTransactions">
                  <tr><td colspan="4" style="padding:24px;text-align:center;color:var(--muted);">ƒ∞≈ülem y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Toplu √úretim Talimatƒ± Y√ºkleme</h3>
            
            <div style="margin-bottom:12px;color:var(--muted);font-size:14px;font-weight:800;">
              Her satƒ±ra bir √ºr√ºn yazƒ±n. Format: <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">√úr√ºnKodu,Tip,URL</code>
              <br>Tip: <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">pdf</code>, <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">image</code> veya <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">link</code>
            </div>

            <textarea id="bulkInstructionsInput" class="input" rows="10" placeholder="√ñrnek:
7001,pdf,https://firebasestorage.googleapis.com/.../talimat.pdf
7002,image,https://drive.google.com/.../resim.png
7003,link,https://drive.google.com/file/d/..." style="font-family:monospace;font-size:13px;"></textarea>

            <button class="actionBtn" id="btnBulkUploadInstructions" type="button" style="margin-top:12px;">TOPLU Y√úKLE</button>

            <div class="statusBox" id="statusBulkInstructions" style="display:none;margin-top:12px;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Toplu Paketleme Talimatƒ± Y√ºkleme</h3>
            
            <div style="margin-bottom:12px;color:var(--muted);font-size:14px;font-weight:800;">
              Her satƒ±ra bir √ºr√ºn yazƒ±n. Format: <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">√úr√ºnKodu,Tip,URL</code>
              <br>Tip: <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">pdf</code>, <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">image</code> veya <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">link</code>
            </div>

            <textarea id="bulkPackagingInput" class="input" rows="10" placeholder="√ñrnek:
7001,pdf,https://firebasestorage.googleapis.com/.../paketleme.pdf
7002,image,https://drive.google.com/.../resim.png
7003,link,https://drive.google.com/file/d/..." style="font-family:monospace;font-size:13px;"></textarea>

            <button class="actionBtn" id="btnBulkUploadPackaging" type="button" style="margin-top:12px;">TOPLU Y√úKLE</button>

            <div class="statusBox" id="statusBulkPackaging" style="display:none;margin-top:12px;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">ƒ∞≈ülem Ge√ßmi≈üi (LOG)</h3>

            <div style="margin-bottom:12px;">
              <div style="font-weight:900;font-size:14px;color:var(--muted);margin-bottom:6px;">ƒ∞≈ûLEM Tƒ∞Pƒ∞NE G√ñRE Fƒ∞LTRELE:</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:8px;">
                <button class="searchBtn" id="btnLogPut" type="button" style="font-size:13px;padding:10px;">RAFA KOY</button>
                <button class="searchBtn" id="btnLogClear" type="button" style="font-size:13px;padding:10px;">RAF BO≈ûALT</button>
                <button class="searchBtn" id="btnLogDecrease" type="button" style="font-size:13px;padding:10px;">ADET AZALT</button>
                <button class="searchBtn" id="btnLogMaterial" type="button" style="font-size:13px;padding:10px;">MALZEME TALEBƒ∞</button>
                <button class="searchBtn" id="btnLogProduction" type="button" style="font-size:13px;padding:10px;">√úRETƒ∞M</button>
                <button class="searchBtn" id="btnLogAllActions" type="button" style="font-size:13px;padding:10px;">T√úM ƒ∞≈ûLEMLER</button>
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <div style="font-weight:900;font-size:14px;color:var(--muted);margin-bottom:6px;">ROLE G√ñRE Fƒ∞LTRELE:</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;">
                <button class="searchBtn" id="btnLogAdmin" type="button" style="font-size:13px;padding:10px;">Y√ñNETƒ∞Cƒ∞</button>
                <button class="searchBtn" id="btnLogPacker" type="button" style="font-size:13px;padding:10px;">PAKET√áƒ∞</button>
                <button class="searchBtn" id="btnLogStower" type="button" style="font-size:13px;padding:10px;">RAF Dƒ∞ZEN</button>
                <button class="searchBtn" id="btnLogWelder" type="button" style="font-size:13px;padding:10px;">√úRETƒ∞M</button>
                <button class="searchBtn" id="btnLogPurchase" type="button" style="font-size:13px;padding:10px;">SATIN ALMA</button>
                <button class="searchBtn" id="btnLogAllRoles" type="button" style="font-size:13px;padding:10px;">T√úM ROLLER</button>
              </div>
            </div>

            <div class="adminRow">
              <input id="logLimit" class="input" type="number" min="10" max="500" value="100" style="margin:0;" />
              <button class="searchBtn" id="btnLoadLogs" type="button">LOG Y√úKLE</button>
            </div>

            <div class="statusBox" id="statusLogs" style="margin-top:12px;display:none;"></div>

            <div class="tableWrap" id="logsWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Kullanƒ±cƒ±</th>
                    <th>ƒ∞≈ülem</th>
                    <th>Raf</th>
                    <th>√úr√ºn</th>
                    <th>Adet</th>
                    <th>Detay</th>
                  </tr>
                </thead>
                <tbody id="logsBody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- LOGIN (module DI≈ûI) -->
  <script>
    // ====== PINLER ======
    const ADMIN_PINS = new Set(["601","602","603"]);

    const PACKER_PINS = new Set(
      Array.from({length: 9}, (_,i)=> String(2001+i))
    );

    const STOWER_PINS = new Set(
      Array.from({length: 4}, (_,i)=> String(3001+i))
    );

    const WELDER_PINS = new Set(["4001","4002","4003","4004"]);

    const LASER_PINS = new Set(["5001","5002","5003"]);

    const PURCHASE_PINS = new Set(["6001","6002"]);

    const COMMISSION_PINS = new Set(["9001","9101","9201","9301","9401","9501","9601","9701","9801","9901"]);

    window.__SESSION = { role: null, pin: null };

    // PIN-isim e≈üle≈ütirmesi
    const PIN_NAMES = {
      "601": "Burak",
      "602": "Mesut",
      "2001": "G√∂kmen",
      "2002": "≈ûaban",
      "2003": "Salim",
      "3001": "Salim",
      "4001": "Emin",
      "4002": "ƒ∞lhami",
      "5001": "Emre K.",
      "6001": "Satƒ±n Alma 1",
      "6002": "Satƒ±n Alma 2",
      "9001": "Murat O.",
      "9101": "Aykut P.",
      "9201": "√ñznur P.",
      "9301": "√ñmer Faruk A.",
      "9401": "Hasibe G.",
      "9501": "Burak A.",
      "9601": "Rukiye A.",
      "9701": "Emre K.",
      "9801": "M√º≈üerref K.",
      "9901": "Komisyonlu Satƒ±≈ü 9901"
    };

    function getNameByPin(pin){
      return PIN_NAMES[pin] || pin;
    }

    // PIN_NAMES'i global scope'a da ekle (module script i√ßinden eri≈üim i√ßin)
    window.PIN_NAMES = PIN_NAMES;

    const loginView = document.getElementById("loginView");
    const appView   = document.getElementById("appView");
    const pwInput   = document.getElementById("pwInput");
    const loginBtn  = document.getElementById("loginBtn");
    const loginNote = document.getElementById("loginNote");
    const roleLine  = document.getElementById("roleLine");

    function setLoginNote(msg, type){
      loginNote.className = "note" + (type ? " " + type : "");
      loginNote.textContent = msg;
    }

    function showApp(){
      loginView.style.display="none";
      appView.style.display="block";
    }

    function showLogin(){
      appView.style.display="none";
      loginView.style.display="flex";
      pwInput.value="";
      setLoginNote("Sadece yetkili kullanƒ±cƒ±lar eri≈üebilir.", "");
      window.__SESSION = { role: null, pin: null };
    }

    function getRoleByPin(pin){
      if(ADMIN_PINS.has(pin)) return "admin";
      if(PACKER_PINS.has(pin)) return "packer";
      if(STOWER_PINS.has(pin)) return "stower";
      if(WELDER_PINS.has(pin)) return "welder";
      if(LASER_PINS.has(pin)) return "welder";
      if(PURCHASE_PINS.has(pin)) return "purchase";
      if(COMMISSION_PINS.has(pin)) return "commission";
      return null;
    }

    function roleBadge(role){
      if(role==="admin")  return `<span class="badge b-admin">Y√ñNETƒ∞Cƒ∞</span>`;
      if(role==="packer") return `<span class="badge b-packer">PAKET√áƒ∞</span>`;
      if(role==="stower") return `<span class="badge b-stower">RAF Dƒ∞ZEN</span>`;
      if(role==="welder") return `<span class="badge b-welder">√úRETƒ∞M</span>`;
      if(role==="purchase") return `<span class="badge b-admin">SATIN ALMA</span>`;
      if(role==="commission") return `<span class="badge" style="background:#9333ea;color:#fff;">KOMƒ∞SYONLU SATI≈û</span>`;
      return `<span class="badge">-</span>`;
    }

    function doLogin(){
      const v = (pwInput.value || "").trim();
      const role = getRoleByPin(v);

      if(!role){
        setLoginNote("≈ûifre yanlƒ±≈ü.", "error");
        return;
      }

      window.__SESSION = { role, pin: v };

      setLoginNote("Giri≈ü ba≈üarƒ±lƒ±.", "ok");
      showApp();

      if(roleLine){
        const userName = getNameByPin(v);
        roleLine.innerHTML = `${roleBadge(role)} | ${userName}`;
      }

      if (window.startFirebase) window.startFirebase();
    }

    loginBtn.addEventListener("click", doLogin);
    pwInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") doLogin(); });

    showLogin();
  </script>

  <!-- FIREBASE + UYGULAMA (module) -->
  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyC‚Ä¶‚Ä¶",
      authDomain: "depo-paketleme.firebaseapp.com",
      projectId: "depo-paketleme",
      storageBucket: "depo-paketleme.appspot.com",
      messagingSenderId: "2429493‚Ä¶",
      appId: "1:24294‚Ä¶"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, updateDoc, addDoc, deleteDoc,
      onSnapshot, serverTimestamp, writeBatch,
      getDoc, getDocs, query, limit, orderBy, where
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const tabbar   = document.getElementById("tabbar");
    const logoutBtn= document.getElementById("logoutBtn");

    const tabPut   = document.getElementById("tabPut");
    const tabClear = document.getElementById("tabClear");
    const tabSearch= document.getElementById("tabSearch");
    const tabRack  = document.getElementById("tabRack");
    const tabRequest= document.getElementById("tabRequest");
    const tabMaterialRequest= document.getElementById("tabMaterialRequest");
    const tabWelder= document.getElementById("tabWelder");
    const tabWelderRequests= document.getElementById("tabWelderRequests");
    const tabProduction= document.getElementById("tabProduction");
    const tabPurchase= document.getElementById("tabPurchase");
    const tabInstructions= document.getElementById("tabInstructions");
    const tabPackaging= document.getElementById("tabPackaging");
    const tabPayments= document.getElementById("tabPayments");
    const tabAccounts= document.getElementById("tabAccounts");
    const tabCommissionSummary= document.getElementById("tabCommissionSummary");
    const tabCommission= document.getElementById("tabCommission");
    const tabAdmin = document.getElementById("tabAdmin");

    const viewPut  = document.getElementById("viewPut");
    const viewClear= document.getElementById("viewClear");
    const viewSearch= document.getElementById("viewSearch");
    const viewRack = document.getElementById("viewRack");
    const viewRequest= document.getElementById("viewRequest");
    const viewMaterialRequest= document.getElementById("viewMaterialRequest");
    const viewWelder= document.getElementById("viewWelder");
    const viewWelderRequests= document.getElementById("viewWelderRequests");
    const viewProduction= document.getElementById("viewProduction");
    const viewPurchase= document.getElementById("viewPurchase");
    const viewInstructions= document.getElementById("viewInstructions");
    const viewPackaging= document.getElementById("viewPackaging");
    const viewPayments= document.getElementById("viewPayments");
    const viewAccounts= document.getElementById("viewAccounts");
    const viewCommissionSummary= document.getElementById("viewCommissionSummary");
    const viewCommission= document.getElementById("viewCommission");
    const viewAdmin= document.getElementById("viewAdmin");

    const inProduct  = document.getElementById("inProduct");
    const inShelfNum = document.getElementById("inShelfNum");
    const inQty      = document.getElementById("inQty");
    const btnPut     = document.getElementById("btnPut");
    const statusPut  = document.getElementById("statusPut");

    const outShelfNum     = document.getElementById("outShelfNum");
    const outProductCode  = document.getElementById("outProductCode");
    const clearProductBox = document.getElementById("clearProductBox");
    const clearHint       = document.getElementById("clearHint");
    const btnClear        = document.getElementById("btnClear");
    const statusClear     = document.getElementById("statusClear");

    // ‚úÖ yeni alanlar (adet azalt)
    const clearBoxTitle  = document.getElementById("clearBoxTitle");
    const clearQtyBox    = document.getElementById("clearQtyBox");
    const outReduceQty   = document.getElementById("outReduceQty");
    const clearQtyHint   = document.getElementById("clearQtyHint");

    const searchCode   = document.getElementById("searchCode");
    const btnSearch    = document.getElementById("btnSearch");
    const statusSearch = document.getElementById("statusSearch");
    const searchWrap   = document.getElementById("searchWrap");
    const searchBody   = document.getElementById("searchBody");

    const rackHint  = document.getElementById("rackHint");
    const rackBody  = document.getElementById("rackBody");

    const setupBox    = document.getElementById("setupBox");
    const setupCount  = document.getElementById("setupCount");
    const setupPrefix = document.getElementById("setupPrefix");
    const btnSetup    = document.getElementById("btnSetup");
    const setupStatus = document.getElementById("setupStatus");

    const reqProduct = document.getElementById("reqProduct");
    const reqProductionType = document.getElementById("reqProductionType");
    const btnReq     = document.getElementById("btnReq");
    const statusReq  = document.getElementById("statusReq");
    const statusReqList = document.getElementById("statusReqList");
    const reqWrap    = document.getElementById("reqWrap");
    const reqBody    = document.getElementById("reqBody");

    const stTotal = document.getElementById("stTotal");
    const stEmpty = document.getElementById("stEmpty");
    const stFull  = document.getElementById("stFull");
    const stQty   = document.getElementById("stQty");
    const stHint  = document.getElementById("stHint");

    // Personel y√∂netimi elementleri
    const personnelName = document.getElementById("personnelName");
    const personnelPaymentPeriod = document.getElementById("personnelPaymentPeriod");
    const personnelPaymentDayMonthly = document.getElementById("personnelPaymentDayMonthly");
    const personnelPaymentDayWeekly = document.getElementById("personnelPaymentDayWeekly");
    const personnelSalary = document.getElementById("personnelSalary");
    const personnelStartDate = document.getElementById("personnelStartDate");
    const btnAddPersonnel = document.getElementById("btnAddPersonnel");
    const statusPersonnel = document.getElementById("statusPersonnel");
    const personnelListBody = document.getElementById("personnelListBody");
    const monthlyPaymentFields = document.getElementById("monthlyPaymentFields");
    const weeklyPaymentFields = document.getElementById("weeklyPaymentFields");
    const upcomingPaymentsList = document.getElementById("upcomingPaymentsList");
    const overduePaymentsList = document.getElementById("overduePaymentsList");

    // Personel d√ºzenleme elementleri
    const editPersonnelSection = document.getElementById("editPersonnelSection");
    const editPersonnelId = document.getElementById("editPersonnelId");
    const editPersonnelName = document.getElementById("editPersonnelName");
    const editPersonnelPaymentPeriod = document.getElementById("editPersonnelPaymentPeriod");
    const editPersonnelPaymentDayMonthly = document.getElementById("editPersonnelPaymentDayMonthly");
    const editPersonnelPaymentDayWeekly = document.getElementById("editPersonnelPaymentDayWeekly");
    const editPersonnelSalary = document.getElementById("editPersonnelSalary");
    const editPersonnelStartDate = document.getElementById("editPersonnelStartDate");
    const editMonthlyPaymentFields = document.getElementById("editMonthlyPaymentFields");
    const editWeeklyPaymentFields = document.getElementById("editWeeklyPaymentFields");
    const btnUpdatePersonnel = document.getElementById("btnUpdatePersonnel");
    const btnCancelEdit = document.getElementById("btnCancelEdit");
    const statusEditPersonnel = document.getElementById("statusEditPersonnel");

    // √ñdeme elementleri
    const paymentPersonSelect = document.getElementById("paymentPersonSelect");
    const paymentType = document.getElementById("paymentType");
    const paymentAmount = document.getElementById("paymentAmount");
    const paymentDate = document.getElementById("paymentDate");
    const paymentNote = document.getElementById("paymentNote");
    const btnAddPayment = document.getElementById("btnAddPayment");
    const statusPayment = document.getElementById("statusPayment");
    const paymentListBody = document.getElementById("paymentListBody");
    const paymentSearchName = document.getElementById("paymentSearchName");
    const btnFilterAllPayments = document.getElementById("btnFilterAllPayments");
    const btnFilterSalary = document.getElementById("btnFilterSalary");
    const btnFilterAdvance = document.getElementById("btnFilterAdvance");

    // Komisyonlu satƒ±≈ü elementleri
    const commissionTransactionType = document.getElementById("commissionTransactionType");
    const commissionAmount = document.getElementById("commissionAmount");
    const commissionNote = document.getElementById("commissionNote");
    const btnAddCommission = document.getElementById("btnAddCommission");
    const statusCommission = document.getElementById("statusCommission");
    const myTotalIncome = document.getElementById("myTotalIncome");
    const myTotalExpense = document.getElementById("myTotalExpense");
    const myNetAmount = document.getElementById("myNetAmount");
    const myCommission = document.getElementById("myCommission");
    const commissionListBody = document.getElementById("commissionListBody");
    const myPaymentsBody = document.getElementById("myPaymentsBody");
    const btnFilterAllCommission = document.getElementById("btnFilterAllCommission");
    const btnFilterIncome = document.getElementById("btnFilterIncome");
    const btnFilterExpense = document.getElementById("btnFilterExpense");
    const commissionSummaryBody = document.getElementById("commissionSummaryBody");
    const paymentsHistoryBody = document.getElementById("paymentsHistoryBody");
    const collectionSellerPin = document.getElementById("collectionSellerPin");
    const collectionAmount = document.getElementById("collectionAmount");
    const collectionNote = document.getElementById("collectionNote");
    const btnAddCollection = document.getElementById("btnAddCollection");
    const statusCollection = document.getElementById("statusCollection");
    const sellerDetailSection = document.getElementById("sellerDetailSection");
    const sellerDetailTitle = document.getElementById("sellerDetailTitle");
    const detailIncome = document.getElementById("detailIncome");
    const detailExpense = document.getElementById("detailExpense");
    const detailNet = document.getElementById("detailNet");
    const detailCompanyShare = document.getElementById("detailCompanyShare");
    const detailTransactionsBody = document.getElementById("detailTransactionsBody");

    const accountCompanyName = document.getElementById("accountCompanyName");
    const accountTransactionType = document.getElementById("accountTransactionType");
    const purchaseFields = document.getElementById("purchaseFields");
    const paymentFields = document.getElementById("paymentFields");
    const accountItemName = document.getElementById("accountItemName");
    const accountItemQuantity = document.getElementById("accountItemQuantity");
    const accountInvoiceAmount = document.getElementById("accountInvoiceAmount");
    const accountPaymentAmount = document.getElementById("accountPaymentAmount");
    const accountTransactionDate = document.getElementById("accountTransactionDate");
    const accountNote = document.getElementById("accountNote");
    const btnAddAccountTransaction = document.getElementById("btnAddAccountTransaction");
    const statusAccount = document.getElementById("statusAccount");
    const companyBalancesBody = document.getElementById("companyBalancesBody");
    const accountListBody = document.getElementById("accountListBody");
    const accountSearchCompany = document.getElementById("accountSearchCompany");
    const btnFilterAllTransactions = document.getElementById("btnFilterAllTransactions");
    const btnFilterPurchases = document.getElementById("btnFilterPurchases");
    const btnFilterPayments = document.getElementById("btnFilterPayments");
    const companyList = document.getElementById("companyList");

    // Firma d√ºzenleme elementleri
    const editCompanySection = document.getElementById("editCompanySection");
    const editCompanyOldName = document.getElementById("editCompanyOldName");
    const editCompanyNewName = document.getElementById("editCompanyNewName");
    const btnUpdateCompany = document.getElementById("btnUpdateCompany");
    const btnCancelCompanyEdit = document.getElementById("btnCancelCompanyEdit");
    const statusEditCompany = document.getElementById("statusEditCompany");

    const logLimit = document.getElementById("logLimit");
    const btnLoadLogs = document.getElementById("btnLoadLogs");
    const btnLogPut = document.getElementById("btnLogPut");
    const btnLogClear = document.getElementById("btnLogClear");
    const btnLogDecrease = document.getElementById("btnLogDecrease");
    const btnLogMaterial = document.getElementById("btnLogMaterial");
    const btnLogProduction = document.getElementById("btnLogProduction");
    const btnLogAllActions = document.getElementById("btnLogAllActions");
    const btnLogAdmin = document.getElementById("btnLogAdmin");
    const btnLogPacker = document.getElementById("btnLogPacker");
    const btnLogStower = document.getElementById("btnLogStower");
    const btnLogWelder = document.getElementById("btnLogWelder");
    const btnLogPurchase = document.getElementById("btnLogPurchase");
    const btnLogAllRoles = document.getElementById("btnLogAllRoles");
    const statusLogs = document.getElementById("statusLogs");
    const logsWrap = document.getElementById("logsWrap");
    const logsBody = document.getElementById("logsBody");

    const welderCode = document.getElementById("welderCode");
    const welderQty = document.getElementById("welderQty");
    const welderSave = document.getElementById("welderSave");
    const statusWelder = document.getElementById("statusWelder");
    const statusWelderToday = document.getElementById("statusWelderToday");
    const welderTodayWrap = document.getElementById("welderTodayWrap");
    const welderTodayBody = document.getElementById("welderTodayBody");
    const statusWelderRequests = document.getElementById("statusWelderRequests");
    const welderRequestsWrap = document.getElementById("welderRequestsWrap");
    const welderRequestsBody = document.getElementById("welderRequestsBody");

    const btnProdDay = document.getElementById("btnProdDay");
    const btnProdWeek = document.getElementById("btnProdWeek");
    const btnProdMonth = document.getElementById("btnProdMonth");
    const btnProdYear = document.getElementById("btnProdYear");
    const statusProduction = document.getElementById("statusProduction");
    const productionWrap = document.getElementById("productionWrap");
    const productionBody = document.getElementById("productionBody");

    const matReqName = document.getElementById("matReqName");
    const matReqQty = document.getElementById("matReqQty");
    const matReqNote = document.getElementById("matReqNote");
    const btnMatReq = document.getElementById("btnMatReq");
    const statusMatReq = document.getElementById("statusMatReq");
    const statusMatReqList = document.getElementById("statusMatReqList");
    const matReqWrap = document.getElementById("matReqWrap");
    const matReqBody = document.getElementById("matReqBody");

    const statusPurchase = document.getElementById("statusPurchase");
    const purchaseWrap = document.getElementById("purchaseWrap");
    const purchaseBody = document.getElementById("purchaseBody");

    const instructionsProductCode = document.getElementById("instructionsProductCode");
    const btnLoadInstructions = document.getElementById("btnLoadInstructions");
    const statusInstructions = document.getElementById("statusInstructions");
    const instructionsContent = document.getElementById("instructionsContent");
    const instructionContainer = document.getElementById("instructionContainer");

    const bulkInstructionsInput = document.getElementById("bulkInstructionsInput");
    const btnBulkUploadInstructions = document.getElementById("btnBulkUploadInstructions");
    const statusBulkInstructions = document.getElementById("statusBulkInstructions");

    const packagingProductCode = document.getElementById("packagingProductCode");
    const btnLoadPackaging = document.getElementById("btnLoadPackaging");
    const statusPackaging = document.getElementById("statusPackaging");
    const packagingContent = document.getElementById("packagingContent");
    const packagingContainer = document.getElementById("packagingContainer");

    const bulkPackagingInput = document.getElementById("bulkPackagingInput");
    const btnBulkUploadPackaging = document.getElementById("btnBulkUploadPackaging");
    const statusBulkPackaging = document.getElementById("statusBulkPackaging");

    let shelvesCache = {};
    let role = null;
    let sessionPin = null;

    function padShelf(num){ return "R" + String(num).padStart(3,"0"); }

    function formatLogDate(date){
      if(!date) return "-";
      
      const now = new Date();
      const logDate = new Date(date);
      
      // Bug√ºn√ºn ba≈ülangƒ±cƒ±
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      // D√ºn√ºn ba≈ülangƒ±cƒ±
      const yesterdayStart = new Date(todayStart);
      yesterdayStart.setDate(yesterdayStart.getDate() - 1);
      // 2 g√ºn √∂ncesinin ba≈ülangƒ±cƒ±
      const twoDaysAgoStart = new Date(todayStart);
      twoDaysAgoStart.setDate(twoDaysAgoStart.getDate() - 2);
      
      const timeStr = logDate.toLocaleTimeString("tr-TR", { hour: "2-digit", minute: "2-digit" });
      
      if(logDate >= todayStart){
        return `Bug√ºn-${timeStr}`;
      } else if(logDate >= yesterdayStart){
        return `D√ºn-${timeStr}`;
      } else {
        const day = logDate.getDate();
        const monthNames = ["Ocak", "≈ûubat", "Mart", "Nisan", "Mayƒ±s", "Haziran", 
                           "Temmuz", "Aƒüustos", "Eyl√ºl", "Ekim", "Kasƒ±m", "Aralƒ±k"];
        const month = monthNames[logDate.getMonth()];
        return `${day} ${month}-${timeStr}`;
      }
    }

    function translateAction(action){
      const translations = {
        "PUT": "RAFA KOY",
        "CLEAR_SHELF": "RAF BO≈ûALT",
        "REMOVE_PRODUCT_ALL": "√úR√úN TAMAMEN √áIKAR",
        "DECREASE_QTY": "ADET AZALT",
        "REMOVE_PRODUCT": "√úR√úN √áIKAR",
        "PRODUCTION_REQUEST": "√úRETƒ∞M TALEBƒ∞",
        "FULFILL_REQUESTS": "TALEPLERƒ∞ KAR≈ûILA",
        "MATERIAL_REQUEST": "MALZEME TALEBƒ∞",
        "MATERIAL_STATUS_UPDATE": "MALZEME DURUM G√úNCELLENMESƒ∞",
        "SETUP": "KURULUM",
        "PRODUCTION_COMPLETED": "√úRETƒ∞M TAMAMLANDI"
      };
      return translations[action] || action;
    }

    function setStatusBox(el,msg,type){
      if(!el) return;
      if(!msg){
        el.style.display = "none";
        return;
      }
      el.style.display = "flex";
      el.className = "statusBox" + (type ? " " + type : "");
      el.textContent = msg || "";
    }

    function productsSummary(products){
      if(!products || Object.keys(products).length===0) return "-";
      return Object.entries(products).map(([c,q])=>`${c} x${q}`).join(", ");
    }

    function isEmpty(data){
      const p = data?.products || {};
      return Object.keys(p).length===0;
    }

    function refreshClearMode(){
      const nStr = (outShelfNum.value || "").trim();
      if(!nStr){
        clearProductBox.style.display="none";
        clearHint.textContent="";
        if(clearQtyBox) clearQtyBox.style.display="none";
        if(outProductCode) outProductCode.value="";
        if(outReduceQty) outReduceQty.value="1";
        return;
      }

      const n = Number(nStr);
      if(!n || n < 1){
        clearProductBox.style.display="none";
        clearHint.textContent="";
        if(clearQtyBox) clearQtyBox.style.display="none";
        if(outReduceQty) outReduceQty.value="1";
        return;
      }

      const shelfName = padShelf(n);
      const shelfData = shelvesCache[shelfName];
      if(!shelfData){
        clearProductBox.style.display="none";
        clearHint.textContent="";
        if(clearQtyBox) clearQtyBox.style.display="none";
        if(outReduceQty) outReduceQty.value="1";
        return;
      }

      const products = shelfData.products || {};
      const keys = Object.keys(products);
      const pcount = keys.length;

      if(pcount === 0){
        clearProductBox.style.display="none";
        clearHint.textContent="";
        if(clearQtyBox) clearQtyBox.style.display="none";
        if(outReduceQty) outReduceQty.value="1";
        return;
      }

      // Tek √ºr√ºn varsa
      if(pcount === 1){
        const onlyCode = keys[0];
        const onlyQty  = Number(products[onlyCode] || 0);

        // sadece 1 adet => adet kutusu a√ßƒ±lmasƒ±n, √ºr√ºn bilgisi g√∂ster
        if(onlyQty === 1){
          clearProductBox.style.display="block";
          if(clearBoxTitle) clearBoxTitle.textContent = "Raftaki √úr√ºn";
          outProductCode.value = onlyCode;
          outProductCode.readOnly = true;
          clearHint.textContent = `${onlyCode} x${onlyQty}`;
          if(clearQtyBox) clearQtyBox.style.display="none";
          if(outReduceQty) outReduceQty.value="1";
          return;
        }

        // 2+ adet => √ºr√ºn kodu kilitli + adet kutusu a√ßƒ±k
        clearProductBox.style.display="block";
        if(clearBoxTitle) clearBoxTitle.textContent = "Bu rafta aynƒ± √ºr√ºnden birden fazla adet var";
        outProductCode.value = onlyCode;
        outProductCode.readOnly = true;

        clearHint.textContent = `${onlyCode} x${onlyQty}`;

        if(clearQtyBox) clearQtyBox.style.display="block";
        if(outReduceQty){
          outReduceQty.value = "1";
          outReduceQty.max = String(onlyQty);
        }
        if(clearQtyHint) clearQtyHint.textContent = `Mevcut: ${onlyQty} adet (Max: ${onlyQty})`;
        return;
      }

      // Birden fazla √ºr√ºn varsa
      clearProductBox.style.display="block";
      if(clearBoxTitle) clearBoxTitle.textContent = "Bu rafta birden fazla √ºr√ºn var";
      outProductCode.readOnly = false;

      clearHint.textContent = keys.map(k=>`${k} x${products[k]}`).join(" , ");

      const selected = (outProductCode.value || "").trim();
      const selQty = Number(products[selected] || 0);

      if(selected && selQty > 1){
        if(clearQtyBox) clearQtyBox.style.display="block";
        if(outReduceQty){
          outReduceQty.value = "1";
          outReduceQty.max = String(selQty);
        }
        if(clearQtyHint) clearQtyHint.textContent = `Mevcut: ${selQty} adet (Max: ${selQty})`;
      }else{
        if(clearQtyBox) clearQtyBox.style.display="none";
        if(outReduceQty) outReduceQty.value = "1";
        if(clearQtyHint) clearQtyHint.textContent = "";
      }
    }

    outShelfNum?.addEventListener("input", refreshClearMode);
    outProductCode?.addEventListener("input", refreshClearMode);
    outReduceQty?.addEventListener("input", ()=>{
      const v = Number(outReduceQty.value || 1);
      if(v < 1) outReduceQty.value = "1";
    });

    function runSearch(){
      setStatusBox(statusSearch, "Aranƒ±yor...", "");
      searchBody.innerHTML = "";
      searchWrap.style.display = "none";

      const code = (searchCode.value || "").trim();
      if(!code) return setStatusBox(statusSearch, "√úr√ºn kodu bo≈ü olamaz.", "error");

      const results = [];
      for(const [raf, data] of Object.entries(shelvesCache)){
        const qty = Number((data.products && data.products[code]) || 0);
        if(qty > 0) results.push({ raf, qty });
      }

      if(results.length === 0) return setStatusBox(statusSearch, "Bulunamadƒ±.", "error");

      results.sort((a,b)=>a.raf.localeCompare(b.raf));
      for(const r of results){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.raf}</td><td>${r.qty}</td>`;
        searchBody.appendChild(tr);
      }
      searchWrap.style.display = "block";
      setStatusBox(statusSearch, "Bulundu.", "ok");
    }
    btnSearch && (btnSearch.onclick = runSearch);
    searchCode && searchCode.addEventListener("keydown",(e)=>{ if(e.key==="Enter") runSearch(); });

    function computeSummary(){
      const names = Object.keys(shelvesCache);
      const total = names.length;
      let empty = 0;
      let full = 0;
      let totalQty = 0;

      for(const n of names){
        const p = shelvesCache[n]?.products || {};
        const keys = Object.keys(p);
        if(keys.length===0) empty++;
        else full++;
        for(const k of keys) totalQty += Number(p[k] || 0);
      }

      stTotal && (stTotal.textContent = total);
      stEmpty && (stEmpty.textContent = empty);
      stFull  && (stFull.textContent  = full);
      stQty   && (stQty.textContent   = totalQty);
      stHint  && (stHint.textContent  = `Son g√ºncelleme: ${new Date().toLocaleString("tr-TR")}`);
    }

    function setActiveTab(target){
      const allTabs = [tabPut, tabClear, tabSearch, tabRack, tabRequest, tabMaterialRequest, tabWelder, tabWelderRequests, tabProduction, tabPurchase, tabInstructions, tabPackaging, tabPayments, tabAccounts, tabCommissionSummary, tabCommission, tabAdmin].filter(Boolean);
      allTabs.forEach(t=>t.classList.remove("active"));

      const hideAll = ()=>{
        viewPut && (viewPut.style.display="none");
        viewClear && (viewClear.style.display="none");
        viewSearch && (viewSearch.style.display="none");
        viewRack && (viewRack.style.display="none");
        viewRequest && (viewRequest.style.display="none");
        viewMaterialRequest && (viewMaterialRequest.style.display="none");
        viewWelder && (viewWelder.style.display="none");
        viewWelderRequests && (viewWelderRequests.style.display="none");
        viewProduction && (viewProduction.style.display="none");
        viewPurchase && (viewPurchase.style.display="none");
        viewInstructions && (viewInstructions.style.display="none");
        viewPackaging && (viewPackaging.style.display="none");
        viewPayments && (viewPayments.style.display="none");
        viewAccounts && (viewAccounts.style.display="none");
        viewCommissionSummary && (viewCommissionSummary.style.display="none");
        viewCommission && (viewCommission.style.display="none");
        viewAdmin && (viewAdmin.style.display="none");
      };

      hideAll();

      if(target==="put"){ tabPut?.classList.add("active"); viewPut.style.display="block"; setTimeout(()=>{ try{ inProduct.focus(); inProduct.select && inProduct.select(); }catch(e){} },50); }
      if(target==="clear"){ tabClear?.classList.add("active"); viewClear.style.display="block"; setTimeout(()=>{ try{ outShelfNum.focus(); outShelfNum.select && outShelfNum.select(); }catch(e){} },50); }
      if(target==="search"){ tabSearch?.classList.add("active"); viewSearch.style.display="block"; setTimeout(()=>{ try{ searchCode.focus(); searchCode.select && searchCode.select(); }catch(e){} },50); }
      if(target==="rack"){ tabRack?.classList.add("active"); viewRack.style.display="block"; setTimeout(()=>{ try{ rackBody && rackBody.scrollIntoView && rackBody.scrollIntoView(); }catch(e){} },50); }
      if(target==="request"){ tabRequest?.classList.add("active"); viewRequest.style.display="block"; setTimeout(()=>{ try{ reqProduct.focus(); reqProduct.select && reqProduct.select(); }catch(e){} },50); }
      if(target==="materialRequest"){ tabMaterialRequest?.classList.add("active"); viewMaterialRequest.style.display="block"; setTimeout(()=>{ try{ matReqName.focus(); matReqName.select && matReqName.select(); }catch(e){} },50); }
      if(target==="welder"){ tabWelder?.classList.add("active"); viewWelder.style.display="block"; setTimeout(()=>{ try{ welderCode.focus(); welderCode.select && welderCode.select(); }catch(e){} },50); }
      if(target==="welderRequests"){ tabWelderRequests?.classList.add("active"); viewWelderRequests.style.display="block"; }
      if(target==="production"){ tabProduction?.classList.add("active"); viewProduction.style.display="block"; }
      if(target==="purchase"){ tabPurchase?.classList.add("active"); viewPurchase.style.display="block"; }
      if(target==="instructions"){ tabInstructions?.classList.add("active"); viewInstructions.style.display="block"; setTimeout(()=>{ try{ instructionsProductCode.focus(); instructionsProductCode.select && instructionsProductCode.select(); }catch(e){} },50); }
      if(target==="packaging"){ tabPackaging?.classList.add("active"); viewPackaging.style.display="block"; setTimeout(()=>{ try{ packagingProductCode.focus(); packagingProductCode.select && packagingProductCode.select(); }catch(e){} },50); }
      if(target==="payments"){ tabPayments?.classList.add("active"); viewPayments.style.display="block"; setTimeout(()=>{ try{ paymentPersonSelect.focus(); }catch(e){} },50); }
      if(target==="accounts"){ tabAccounts?.classList.add("active"); viewAccounts.style.display="block"; setTimeout(()=>{ try{ accountCompanyName.focus(); accountCompanyName.select && accountCompanyName.select(); }catch(e){} },50); }
      if(target==="commissionSummary"){ tabCommissionSummary?.classList.add("active"); viewCommissionSummary.style.display="block"; setTimeout(()=>{ try{ if(typeof loadCommissionSummary === "function"){ loadCommissionSummary(); } if(typeof loadPaymentsHistory === "function"){ loadPaymentsHistory(); } }catch(e){console.error(e);} },100); }
      if(target==="commission"){ 
        tabCommission?.classList.add("active"); 
        viewCommission.style.display="block"; 
        
        // Admin rol√º ise formu gizle, sadece raporlarƒ± g√∂ster
        const currentRole = window.__SESSION?.role;
        if(currentRole === "admin") {
          const formSection = document.getElementById("commissionFormSection");
          const summarySection = document.getElementById("commissionSummarySection");
          if(formSection) formSection.style.display = "none";
          if(summarySection) summarySection.style.display = "none";
        } else {
          const formSection = document.getElementById("commissionFormSection");
          const summarySection = document.getElementById("commissionSummarySection");
          if(formSection) formSection.style.display = "block";
          if(summarySection) summarySection.style.display = "block";
        }
        
        setTimeout(()=>{ try{ commissionTransactionType.focus(); }catch(e){} },50); 
      }
      if(target==="admin"){ tabAdmin?.classList.add("active"); viewAdmin.style.display="block"; setTimeout(()=>{ try{ if(typeof loadCommissionSummary === "function"){ loadCommissionSummary(); } }catch(e){console.error(e);} },100); }
    }

    function setTabsByRole(r){
      const pairs = [
        [tabPut, viewPut],
        [tabClear, viewClear],
        [tabSearch, viewSearch],
        [tabRack, viewRack],
        [tabRequest, viewRequest],
        [tabMaterialRequest, viewMaterialRequest],
        [tabWelder, viewWelder],
        [tabWelderRequests, viewWelderRequests],
        [tabProduction, viewProduction],
        [tabPurchase, viewPurchase],
        [tabInstructions, viewInstructions],
        [tabPackaging, viewPackaging],
        [tabPayments, viewPayments],
        [tabAccounts, viewAccounts],
        [tabCommissionSummary, viewCommissionSummary],
        [tabCommission, viewCommission],
        [tabAdmin, viewAdmin]
      ];

      pairs.forEach(([t,v])=>{
        t && (t.style.display="none");
        v && (v.style.display="none");
      });

      if(r==="packer"){
        tabClear.style.display="block";
        tabSearch.style.display="block";
        tabRack.style.display="block";
        tabPackaging.style.display="block";
        
        // Sadece 2001 ≈üifresi ile giri≈ü yapan paket√ßi talep sekmelerini g√∂rebilir
        const currentPin = window.__SESSION?.pin;
        if(currentPin === "2001"){
          tabRequest.style.display="block";
          tabMaterialRequest.style.display="block";
          tabbar.style.gridTemplateColumns = "1fr 1fr 1fr 1fr 1fr 1fr";
        } else {
          tabbar.style.gridTemplateColumns = "1fr 1fr 1fr 1fr";
        }
        
        setActiveTab("clear");
      }else if(r==="stower"){
        tabPut.style.display="block";
        tabPackaging.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr 1fr";
        setActiveTab("put");
      }else if(r==="welder"){
        tabWelder.style.display="block";
        tabWelderRequests.style.display="block";
        tabMaterialRequest.style.display="block";
        tabInstructions.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr 1fr 1fr 1fr";
        setActiveTab("welder");
      }else if(r==="purchase"){
        tabPurchase.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr";
        setActiveTab("purchase");
      }else if(r==="admin"){
        tabPut.style.display="block";
        tabClear.style.display="block";
        tabSearch.style.display="block";
        tabRack.style.display="block";
        tabRequest.style.display="block";
        tabMaterialRequest.style.display="block";
        tabProduction.style.display="block";
        tabPurchase.style.display="block";
        tabInstructions.style.display="block";
        tabPackaging.style.display="block";
        tabPayments.style.display="block";
        tabAccounts.style.display="block";
        tabCommissionSummary.style.display="block";
        tabAdmin.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr";
        setActiveTab("admin");
      }else if(r==="commission"){
        tabCommission.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr";
        setActiveTab("commission");
      }else{
        tabbar.style.gridTemplateColumns = "1fr";
      }
    }

    function playBeep(){
      try{
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if(!AudioCtx) return;

        const ctx = new AudioCtx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.type = "sine";
        osc.frequency.value = 880;

        gain.gain.setValueAtTime(0.001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);

        osc.connect(gain);
        gain.connect(ctx.destination);

        osc.start();
        osc.stop(ctx.currentTime + 0.26);
        osc.onended = ()=>{ try{ ctx.close(); }catch(e){} };
      }catch(e){}
    }

    window.startFirebase = async function(){
      try{
        const sess = window.__SESSION || {};
        role = sess.role;
        sessionPin = sess.pin || null;

        setTabsByRole(role);

        tabPut && (tabPut.onclick = ()=>setActiveTab("put"));
        tabClear && (tabClear.onclick = ()=>setActiveTab("clear"));
        tabSearch && (tabSearch.onclick = ()=>setActiveTab("search"));
        tabRack && (tabRack.onclick = ()=>setActiveTab("rack"));
        tabRequest && (tabRequest.onclick = ()=>setActiveTab("request"));
        tabMaterialRequest && (tabMaterialRequest.onclick = ()=>setActiveTab("materialRequest"));
        tabWelder && (tabWelder.onclick = ()=>setActiveTab("welder"));
        tabWelderRequests && (tabWelderRequests.onclick = ()=>setActiveTab("welderRequests"));
        tabProduction && (tabProduction.onclick = ()=>setActiveTab("production"));
        tabPurchase && (tabPurchase.onclick = ()=>setActiveTab("purchase"));
        tabInstructions && (tabInstructions.onclick = ()=>setActiveTab("instructions"));
        tabPackaging && (tabPackaging.onclick = ()=>setActiveTab("packaging"));
        tabPayments && (tabPayments.onclick = ()=>setActiveTab("payments"));
        tabAccounts && (tabAccounts.onclick = ()=>setActiveTab("accounts"));
        tabCommissionSummary && (tabCommissionSummary.onclick = ()=>setActiveTab("commissionSummary"));
        tabCommission && (tabCommission.onclick = ()=>setActiveTab("commission"));
        tabAdmin && (tabAdmin.onclick = ()=>setActiveTab("admin"));

        logoutBtn.onclick = ()=>location.reload();

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        const db = window.db;

        const shelvesCol = collection(db, "shelves");
        const logsCol = collection(db, "logs");
        const reqCol = collection(db, "requests");
        const productionCol = collection(db, "production");
        const materialReqCol = collection(db, "materialRequests");
        const instructionsCol = collection(db, "productInstructions");
        const packagingCol = collection(db, "packagingInstructions");
        const paymentCol = collection(db, "paymentRecords");
        const personnelCol = collection(db, "personnel");
        const accountCol = collection(db, "accountTransactions");
        const commissionCol = collection(db, "commissionSales");
        const collectionCol = collection(db, "commissionCollections");

        const initRef = doc(db, "system", "shelves_init");

        // Context Menu i√ßin global deƒüi≈üken
        let currentContextRequestId = null;
        const contextMenu = document.getElementById('contextMenu');
        const contextMenuDelete = document.getElementById('contextMenuDelete');

        // Context men√º g√∂ster
        window.showContextMenu = function(event, requestId) {
          currentContextRequestId = requestId;
          contextMenu.style.display = 'block';
          contextMenu.style.left = event.pageX + 'px';
          contextMenu.style.top = event.pageY + 'px';
        };

        // Context men√º gizle
        function hideContextMenu() {
          contextMenu.style.display = 'none';
          currentContextRequestId = null;
        }

        // Sayfa herhangi bir yerine tƒ±klandƒ±ƒüƒ±nda men√ºy√º gizle
        document.addEventListener('click', hideContextMenu);
        
        // Context men√ºn√ºn i√ßine tƒ±klandƒ±ƒüƒ±nda kapatma
        contextMenu.addEventListener('click', (e) => {
          e.stopPropagation();
        });

        // Silme i≈ülemi
        contextMenuDelete.addEventListener('click', async () => {
          if (!currentContextRequestId) return;
          
          if (confirm('Bu malzeme talebini silmek istediƒüinize emin misiniz?')) {
            try {
              const requestRef = doc(db, 'materialRequests', currentContextRequestId);
              await deleteDoc(requestRef);
              
              await addDoc(logsCol, {
                action: 'MATERIAL_STATUS_UPDATE',
                shelf: '-',
                product: '-',
                qty: 0,
                detail: 'Malzeme talebi silindi',
                ts: serverTimestamp(),
                role: role || '-',
                pin: sessionPin || '-'
              });
              
              playBeep();
              if (typeof loadMaterialRequests === 'function') {
                loadMaterialRequests();
              }
              alert('Talep ba≈üarƒ±yla silindi.');
            } catch (e) {
              alert('Hata: ' + e.message);
            }
          }
          hideContextMenu();
        });

        async function ensureShelvesOnce(){
          const initSnap = await getDoc(initRef);
          if (initSnap.exists() && initSnap.data()?.done === true) return;

          const q = query(shelvesCol, limit(1));
          const existing = await getDocs(q);
          if (!existing.empty) {
            await setDoc(initRef, { done:true, count: null, updated: serverTimestamp() }, { merge:true });
            return;
          }

          const count = Number(setupCount?.value || 300);
          const CHUNK_SIZE = 450;

          for (let start = 1; start <= count; start += CHUNK_SIZE) {
            const batch = writeBatch(db);
            const end = Math.min(start + CHUNK_SIZE - 1, count);

            for (let i = start; i <= end; i++) {
              const rafAdi = padShelf(i);
              batch.set(
                doc(shelvesCol, rafAdi),
                { name: rafAdi, products: {}, updated: serverTimestamp() },
                { merge: true }
              );
            }
            await batch.commit();
          }

          await setDoc(initRef, { done:true, count, updated: serverTimestamp() }, { merge:true });
        }

        await ensureShelvesOnce();

        async function writeLog(payload){
          try{
            await addDoc(logsCol, { ...payload, ts: serverTimestamp(), role: role || "-", pin: sessionPin || "-" });
          }catch(e){}
        }

        // raf kurulum kutusu sadece admin
        if(role !== "admin"){
          if(setupBox) setupBox.style.display = "none";
          if(btnSetup){
            btnSetup.disabled = true;
            btnSetup.style.opacity = .6;
            btnSetup.style.pointerEvents = "none";
          }
        }

        // Raflar snapshot
        onSnapshot(shelvesCol, (snapshot) => {
          shelvesCache = {};
          rackBody && (rackBody.innerHTML = "");

          const total = snapshot.size;
          let emptyCount = 0;
          let fullCount = 0;

          snapshot.forEach((docSnap) => {
            const d = docSnap.data();
            const name = d.name || docSnap.id;
            const products = d.products || {};
            shelvesCache[name] = { ...d, name, products };

            const empty = Object.keys(products).length===0;
            if(empty) emptyCount++; else fullCount++;

            // PACKER/STOWER (admin deƒüil) => sadece dolu raflarƒ± g√∂ster
            if(role !== "admin" && empty) return;

            if(rackBody){
              const badge = empty
                ? '<span class="badge b-empty">BO≈û</span>'
                : '<span class="badge b-full">DOLU</span>';

              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${name}</td><td>${badge}</td><td>${productsSummary(products)}</td>`;
              rackBody.appendChild(tr);
            }
          });

          if(rackHint){
            if(role === "admin"){
              rackHint.textContent = `Toplam raf: ${total} | Dolu: ${fullCount} | Bo≈ü: ${emptyCount}`;
            }else{
              rackHint.textContent = `Dolu raf: ${fullCount}`;
            }
          }

          refreshClearMode();
          if(role==="admin") computeSummary();
        });

        // REQUEST LIST
        function renderReqRows(docs){
          if(!reqBody) return;
          reqBody.innerHTML = "";
          if(!docs || docs.length===0){
            reqWrap.style.display="none";
            setStatusBox(statusReqList, "Talep yok.", "warn");
            return;
          }

          for(const x of docs){
            const d = x.data();
            const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
            const dtStr = formatLogDate(dt);

            const badge = (d.status === "produced")
              ? `<span class="badge b-done">√úRETƒ∞LDƒ∞</span>`
              : `<span class="badge b-wait">BEKLƒ∞YOR</span>`;

            const requesterName = getNameByPin(d.requestedBy);
            const producerName = d.producedBy ? getNameByPin(d.producedBy) : "-";

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${dtStr}</td>
              <td>${d.product || "-"}</td>
              <td>${badge}</td>
              <td>${requesterName}</td>
              <td>${producerName}</td>
            `;
            reqBody.appendChild(tr);
          }

          reqWrap.style.display="block";
          setStatusBox(statusReqList, `G√∂steriliyor: ${docs.length}`, "ok");
        }

        if(role==="packer" || role==="admin"){
          const qReq = query(reqCol, orderBy("createdAt","desc"), limit(200));
          onSnapshot(qReq, (snap)=> renderReqRows(snap.docs));
        }

        // Packer: fulfilled taleplerde sesli bildirim
        if(role==="packer"){
          const key = "seen_fulfilled_requests";
          const seen = new Set(JSON.parse(localStorage.getItem(key) || "[]"));

          const qFul = query(reqCol, where("status","==","fulfilled"), orderBy("fulfilledAt","desc"), limit(50));
          onSnapshot(qFul, (snap)=>{
            let playedAny = false;

            snap.forEach(docSnap=>{
              const id = docSnap.id;
              if(seen.has(id)) return;
              seen.add(id);
              playedAny = true;
            });

            if(playedAny){
              localStorage.setItem(key, JSON.stringify(Array.from(seen).slice(-500)));
              playBeep(); setTimeout(()=>playBeep(), 350);
              setStatusBox(statusReq, "üîî Bildirim: Yeni talep kar≈üƒ±landƒ±!", "ok");
              setTimeout(()=>setStatusBox(statusReq, "Hazƒ±r.", ""), 2500);
            }
          });
        }

        // PUT
        btnPut && (btnPut.onclick = async () => {
          setStatusBox(statusPut, "ƒ∞≈ülem yapƒ±lƒ±yor...", "");

          const code = (inProduct.value || "").trim();
          const nStr = (inShelfNum.value || "").trim();
          const qty  = Number(inQty.value || 0);

          if(!code) return setStatusBox(statusPut, "√úr√ºn kodu bo≈ü olamaz.", "error");
          if(!nStr) return setStatusBox(statusPut, "Raf numarasƒ± bo≈ü olamaz.", "error");
          if(!qty || qty < 1) return setStatusBox(statusPut, "Adet en az 1 olmalƒ±.", "error");

          const n = Number(nStr);
          if(!n || n < 1) return setStatusBox(statusPut, "Raf numarasƒ± 1 veya daha b√ºy√ºk olmalƒ±.", "error");

          const shelfName = padShelf(n);
          const shelfData = shelvesCache[shelfName];
          if(!shelfData) return setStatusBox(statusPut, "Bu raf yok: " + shelfName, "error");

          const products = { ...(shelfData.products || {}) };
          products[code] = (products[code] || 0) + qty;

          try{
            await updateDoc(doc(shelvesCol, shelfName), { products, updated: serverTimestamp() });

            await writeLog({ action: "PUT", shelf: shelfName, product: code, qty, detail: "Rafa √ºr√ºn eklendi" });

            // talepleri kar≈üƒ±la
            try{
              const qWait = query(reqCol, where("status","==","waiting"), where("product","==",code), limit(200));
              const waitSnap = await getDocs(qWait);
              if(!waitSnap.empty){
                const batch = writeBatch(db);
                waitSnap.forEach(r=>{
                  batch.update(r.ref, {
                    status: "fulfilled",
                    fulfilledAt: serverTimestamp(),
                    fulfilledBy: sessionPin || "-",
                    fulfilledShelf: shelfName
                  });
                });
                await batch.commit();

                await writeLog({ action: "FULFILL_REQUESTS", shelf: shelfName, product: code, qty, detail: `Bekleyen talepler: ${waitSnap.size}` });
                setStatusBox(statusPut, `Kaydedildi. ‚úÖ Talepler kar≈üƒ±landƒ±: ${waitSnap.size}`, "ok");
              }else{
                setStatusBox(statusPut, "Kaydedildi.", "ok");
              }
            }catch(e){
              setStatusBox(statusPut, "Kaydedildi. (Talep kontrol√º hata: " + e.message + ")", "warn");
            }

            inProduct.value = "";
            inShelfNum.value = "";
            inQty.value = "1";
          }catch(e){
            setStatusBox(statusPut, "Hata: " + e.message, "error");
          }
        });

        // CLEAR (adet azalt modu)
        btnClear && (btnClear.onclick = async () => {
          setStatusBox(statusClear, "ƒ∞≈ülem yapƒ±lƒ±yor...", "");

          const nStr = (outShelfNum.value || "").trim();
          if(!nStr) return setStatusBox(statusClear, "Raf numarasƒ± bo≈ü olamaz.", "error");

          const n = Number(nStr);
          if(!n || n < 1) return setStatusBox(statusClear, "Raf numarasƒ± 1 veya daha b√ºy√ºk olmalƒ±.", "error");

          const shelfName = padShelf(n);
          const shelfData = shelvesCache[shelfName];
          if(!shelfData) return setStatusBox(statusClear, "Bu raf yok: " + shelfName, "error");
          if(isEmpty(shelfData)) return setStatusBox(statusClear, "Raf zaten bo≈ü.", "error");

          const productsNow = { ...(shelfData.products || {}) };
          const keys = Object.keys(productsNow);

          try{
            // 1 √ºr√ºn varsa
            if(keys.length === 1){
              const onlyCode = keys[0];
              const onlyQty  = Number(productsNow[onlyCode] || 0);

              // qty=1 => rafƒ± komple bo≈üalt
              if(onlyQty <= 1){
                await updateDoc(doc(shelvesCol, shelfName), { products: {}, updated: serverTimestamp() });
                await writeLog({ action: "CLEAR_SHELF", shelf: shelfName, product: "-", qty: 0, detail: "Raf tamamen bo≈üaltƒ±ldƒ±" });

                setStatusBox(statusClear, "Raf bo≈üaltƒ±ldƒ±.", "ok");
                outShelfNum.value = "";
                outProductCode.value = "";
                if(outReduceQty) outReduceQty.value = "1";
                clearProductBox.style.display = "none";
                clearHint.textContent = "";
                if(clearQtyBox) clearQtyBox.style.display="none";
                return;
              }

              // qty>1 => adet azalt
              const reduce = Math.max(1, Number(outReduceQty?.value || 1));
              const newQty = onlyQty - reduce;

              if(newQty <= 0){
                await updateDoc(doc(shelvesCol, shelfName), { products: {}, updated: serverTimestamp() });
                await writeLog({ action: "REMOVE_PRODUCT_ALL", shelf: shelfName, product: onlyCode, qty: reduce, detail: `√úr√ºn tamamen √ßƒ±karƒ±ldƒ± (Mevcut ${onlyQty})` });
                setStatusBox(statusClear, "√úr√ºn tamamen √ßƒ±karƒ±ldƒ±.", "ok");
              }else{
                productsNow[onlyCode] = newQty;
                await updateDoc(doc(shelvesCol, shelfName), { products: productsNow, updated: serverTimestamp() });
                await writeLog({ action: "DECREASE_QTY", shelf: shelfName, product: onlyCode, qty: reduce, detail: `Adet azaltƒ±ldƒ±: ${onlyQty} ‚Üí ${newQty}` });
                setStatusBox(statusClear, `Adet azaltƒ±ldƒ±. Kalan: ${newQty}`, "ok");
              }

              outProductCode.value = "";
              if(outReduceQty) outReduceQty.value = "1";
              refreshClearMode();
              return;
            }

            // Birden fazla √ºr√ºn varsa: √ºr√ºn kodu ≈üart
            const code = (outProductCode.value || "").trim();
            if(!code) return setStatusBox(statusClear, "√úr√ºn kodu yazƒ±n.", "error");
            if(!(code in productsNow)) return setStatusBox(statusClear, "Bu √ºr√ºn bu rafta yok.", "error");

            const currentQty = Number(productsNow[code] || 0);
            if(currentQty <= 0) return setStatusBox(statusClear, "Bu √ºr√ºn√ºn adedi ge√ßersiz.", "error");

            // qty>1 ise azalt; qty=1 ise direkt kaldƒ±r
            let reduce = 1;
            if(currentQty > 1){
              reduce = Math.max(1, Number(outReduceQty?.value || 1));
            }

            const newQty = currentQty - reduce;

            if(newQty <= 0){
              delete productsNow[code];
              await writeLog({ action: "REMOVE_PRODUCT", shelf: shelfName, product: code, qty: reduce, detail: `√úr√ºn √ßƒ±karƒ±ldƒ± (Mevcut ${currentQty})` });
            }else{
              productsNow[code] = newQty;
              await writeLog({ action: "DECREASE_QTY", shelf: shelfName, product: code, qty: reduce, detail: `Adet azaltƒ±ldƒ±: ${currentQty} ‚Üí ${newQty}` });
            }

            await updateDoc(doc(shelvesCol, shelfName), { products: productsNow, updated: serverTimestamp() });

            setStatusBox(
              statusClear,
              (newQty <= 0) ? "√úr√ºn raftan √ßƒ±karƒ±ldƒ±." : `Adet azaltƒ±ldƒ±. Kalan: ${newQty}`,
              "ok"
            );

            outProductCode.value = "";
            if(outReduceQty) outReduceQty.value = "1";
            refreshClearMode();

          }catch(e){
            setStatusBox(statusClear, "Hata: " + e.message, "error");
          }
        });

        // PRODUCTION REQUEST CREATE
        btnReq && (btnReq.onclick = async () => {
          setStatusBox(statusReq, "Talep g√∂nderiliyor...", "");

          const code = (reqProduct.value || "").trim();
          const prodType = reqProductionType?.value || "welder";
          
          if(!code) return setStatusBox(statusReq, "√úr√ºn kodu bo≈ü olamaz.", "error");

          try{
            await addDoc(reqCol, {
              product: code,
              productionType: prodType,
              status: "pending",
              createdAt: serverTimestamp(),
              requestedBy: sessionPin || "-",
              producedAt: null,
              producedBy: null
            });

            await writeLog({ action: "PRODUCTION_REQUEST", shelf: "-", product: code, qty: 0, detail: `√úretim talebi olu≈üturuldu (${prodType === 'laser' ? 'Lazer' : 'Kaynak'})` });

            setStatusBox(statusReq, "Talep alƒ±ndƒ±. ‚úÖ", "ok");
            reqProduct.value = "";
            playBeep();
          }catch(e){
            setStatusBox(statusReq, "Hata: " + e.message, "error");
          }
        });

        // MATERIAL REQUEST CREATE
        btnMatReq && (btnMatReq.onclick = async () => {
          setStatusBox(statusMatReq, "Talep g√∂nderiliyor...", "");

          const name = (matReqName.value || "").trim();
          const qty = Math.max(1, Number(matReqQty.value || 1));
          const note = (matReqNote.value || "").trim();
          
          if(!name) return setStatusBox(statusMatReq, "Malzeme adƒ± bo≈ü olamaz.", "error");

          try{
            await addDoc(materialReqCol, {
              materialName: name,
              quantity: qty,
              note: note,
              status: "pending",
              createdAt: serverTimestamp(),
              requestedBy: sessionPin || "-",
              requestedByRole: role || "-",
              completedAt: null,
              completedBy: null
            });

            await writeLog({ action: "MATERIAL_REQUEST", shelf: "-", product: name, qty: qty, detail: `Malzeme talebi olu≈üturuldu: ${note || '-'}` });

            setStatusBox(statusMatReq, "Malzeme talebi alƒ±ndƒ±. ‚úÖ", "ok");
            matReqName.value = "";
            matReqQty.value = "1";
            matReqNote.value = "";
            playBeep();
          }catch(e){
            setStatusBox(statusMatReq, "Hata: " + e.message, "error");
          }
        });

        // MATERIAL REQUEST LIST (for requester)
        function renderMatReqRows(docs){
          if(!matReqBody) return;
          matReqBody.innerHTML = "";
          if(!docs || docs.length===0){
            matReqWrap.style.display="none";
            setStatusBox(statusMatReqList, "Talep yok.", "warn");
            return;
          }

          for(const x of docs){
            const d = x.data();
            const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
            const dtStr = formatLogDate(dt);

            let badge = `<span class="badge b-wait">BEKLEYEN</span>`;
            if(d.status === "processing") badge = `<span class="badge" style="background:rgba(59,130,246,.12);color:#1e3a8a;border-color:rgba(59,130,246,.18);">Sƒ∞PARƒ∞≈û VERƒ∞LDƒ∞</span>`;
            if(d.status === "completed") badge = `<span class="badge b-done">MALZEME ALINDI</span>`;
            if(d.status === "rejected") badge = `<span class="badge" style="background:rgba(239,68,68,.12);color:#7f1d1d;border-color:rgba(239,68,68,.18);">REDDEDƒ∞LDƒ∞</span>`;

            const requesterName = getNameByPin(d.requestedBy);
            
            let noteDisplay = d.note || "-";
            if(d.status === "rejected" && d.rejectionNote){
              noteDisplay = `<span style="color:#dc2626;font-weight:500;">Red Nedeni: ${d.rejectionNote}</span>`;
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${dtStr}</td>
              <td>${d.materialName || "-"}</td>
              <td>${d.quantity || 1}</td>
              <td>${badge}</td>
              <td>${requesterName}</td>
              <td>${noteDisplay}</td>
            `;
            matReqBody.appendChild(tr);
          }

          matReqWrap.style.display="block";
          setStatusBox(statusMatReqList, `G√∂steriliyor: ${docs.length}`, "ok");
        }

        if(role==="packer" || role==="admin" || role==="welder" || role==="stower"){
          const qMatReq = query(materialReqCol, orderBy("createdAt","desc"), limit(200));
          onSnapshot(qMatReq, (snap)=> renderMatReqRows(snap.docs));
        }

        // PURCHASE MANAGEMENT (for purchase role)
        async function loadMaterialRequests(){
          try{
            setStatusBox(statusPurchase, "Y√ºkleniyor...", "");
            
            const q = query(materialReqCol, orderBy("createdAt", "desc"), limit(500));
            
            const snap = await getDocs(q);
            purchaseBody.innerHTML = "";
            
            if(snap.empty){
              purchaseWrap.style.display = "none";
              setStatusBox(statusPurchase, "Talep bulunamadƒ±.", "warn");
              return;
            }

            snap.forEach(docSnap => {
              const d = docSnap.data();
              const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
              const dateStr = formatLogDate(dt);
              
              let statusBadge = `<span class="badge b-wait">BEKLEYEN</span>`;
              if(d.status === "processing") statusBadge = `<span class="badge" style="background:rgba(59,130,246,.12);color:#1e3a8a;border-color:rgba(59,130,246,.18);">Sƒ∞PARƒ∞≈û VERƒ∞LDƒ∞</span>`;
              if(d.status === "completed") statusBadge = `<span class="badge b-done">MALZEME ALINDI</span>`;
              if(d.status === "rejected") statusBadge = `<span class="badge" style="background:rgba(239,68,68,.12);color:#7f1d1d;border-color:rgba(239,68,68,.18);">REDDEDƒ∞LDƒ∞</span>`;
              
              const requesterName = getNameByPin(d.requestedBy);
              
              // Not g√∂sterimi - √∂nce kullanƒ±cƒ± notu, sonra satƒ±n alma notu
              let noteDisplay = d.note || "-";
              if(d.purchaseNote) {
                noteDisplay = `${d.note || '-'} <br><span style="color:#2563eb;font-weight:500;">Satƒ±n Alma: ${d.purchaseNote}</span>`;
              }
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${d.materialName || "-"}</td>
                <td>${d.quantity || 1}</td>
                <td>${requesterName}</td>
                <td>${noteDisplay}</td>
                <td>${statusBadge}</td>
                <td class="action-cell"></td>
              `;
              
              const actionCell = tr.querySelector('.action-cell');
              
              if(d.status === "pending"){
                const processBtn = document.createElement('button');
                processBtn.className = 'searchBtn';
                processBtn.textContent = 'Sƒ∞PARƒ∞≈û VER';
                processBtn.style.cssText = 'font-size:14px;padding:8px;';
                processBtn.onclick = () => window.updateMaterialStatus(docSnap.id, 'processing');
                
                actionCell.appendChild(processBtn);
              } else if(d.status === "processing"){
                const completeBtn = document.createElement('button');
                completeBtn.className = 'searchBtn';
                completeBtn.textContent = 'MALZEME ALINDI';
                completeBtn.style.cssText = 'font-size:14px;padding:8px;background:rgba(0,200,83,.12);';
                completeBtn.onclick = () => window.updateMaterialStatus(docSnap.id, 'completed');
                
                actionCell.appendChild(completeBtn);
              } else {
                actionCell.textContent = '-';
              }
              
              // Not ekleme butonu
              const noteTd = document.createElement('td');
              noteTd.style.textAlign = 'center';
              
              const noteBtn = document.createElement('button');
              noteBtn.textContent = 'üìù';
              noteBtn.title = 'Not Ekle/D√ºzenle';
              noteBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:18px;padding:4px 8px;';
              noteBtn.onclick = () => window.addPurchaseNote(docSnap.id, d.purchaseNote || '');
              
              noteTd.appendChild(noteBtn);
              tr.appendChild(noteTd);
              
              // Reddet butonu (sadece bekleyen ve i≈ülemdeki talepler i√ßin)
              const rejectTd = document.createElement('td');
              rejectTd.style.textAlign = 'center';
              
              if(d.status === 'pending' || d.status === 'processing') {
                const rejectBtn = document.createElement('button');
                rejectBtn.textContent = '‚ùå';
                rejectBtn.title = 'Reddet';
                rejectBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:18px;padding:4px 8px;';
                rejectBtn.onclick = () => window.rejectMaterialRequest(docSnap.id);
                rejectTd.appendChild(rejectBtn);
              } else {
                rejectTd.textContent = '-';
              }
              
              tr.appendChild(rejectTd);
              
              purchaseBody.appendChild(tr);
            });

            purchaseWrap.style.display = "block";
            setStatusBox(statusPurchase, `Toplam: ${snap.size} kayƒ±t`, "ok");
          }catch(e){
            setStatusBox(statusPurchase, "Hata: " + e.message, "error");
          }
        }

        window.deleteMaterialRequest = async function(requestId){
          if(!requestId) return;
          
          if(!confirm("Bu talebi silmek istediƒüinize emin misiniz?")){
            return;
          }
          
          try{
            const requestRef = doc(db, "materialRequests", requestId);
            await deleteDoc(requestRef);
            
            await writeLog({ 
              action: "MATERIAL_STATUS_UPDATE", 
              shelf: "-", 
              product: "-", 
              qty: 0, 
              detail: `Malzeme talebi silindi` 
            });
            
            playBeep();
            loadMaterialRequests();
          }catch(e){
            alert("Hata: " + e.message);
          }
        };

        window.addPurchaseNote = async function(requestId, currentNote){
          try {
            const newNote = prompt('Satƒ±n alma notu:', currentNote || '');
            if(newNote !== null) {
              await updateDoc(doc(db, 'materialRequests', requestId), {
                purchaseNote: newNote.trim()
              });
              playBeep();
              loadMaterialRequests();
            }
          } catch (e) {
            console.error('Not ekleme hatasƒ±:', e);
            alert('Hata: ' + e.message);
          }
        };

        window.rejectMaterialRequest = async function(requestId){
          try {
            if(!confirm('Bu talebi reddetmek istediƒüinize emin misiniz?')){
              return;
            }
            await updateDoc(doc(db, 'materialRequests', requestId), {
              status: 'rejected',
              rejectedAt: serverTimestamp(),
              rejectedBy: sessionPin || '-'
            });
            playBeep();
            loadMaterialRequests();
          } catch (e) {
            console.error('Reddetme hatasƒ±:', e);
            alert('Hata: ' + e.message);
          }
        };

        window.updateMaterialStatus = async function(requestId, newStatus){
          if(!requestId) return;
          
          try{
            const requestRef = doc(db, "materialRequests", requestId);
            const updateData = { status: newStatus };
            
            if(newStatus === "completed"){
              updateData.completedAt = serverTimestamp();
              updateData.completedBy = sessionPin || "-";
            }
            
            await updateDoc(requestRef, updateData);
            
            await writeLog({ 
              action: "MATERIAL_STATUS_UPDATE", 
              shelf: "-", 
              product: "-", 
              qty: 0, 
              detail: `Malzeme talebi durumu: ${newStatus}` 
            });
            
            playBeep();
            loadMaterialRequests();
          }catch(e){
            alert("Hata: " + e.message);
          }
        };
        
        if(role === 'purchase' || role === 'admin'){
          loadMaterialRequests();
        }

        // SETUP (admin only)
        if(btnSetup && role==="admin"){
          btnSetup.onclick = async () => {
            setupStatus.textContent = "Raflar olu≈üturuluyor...";

            const count = Number(setupCount.value || 0);
            const prefix = (setupPrefix.value || "R").trim().toUpperCase();

            if (!count || count < 1) {
              setupStatus.textContent = "Raf sayƒ±sƒ± 1 veya daha b√ºy√ºk olmalƒ±.";
              return;
            }
            if (prefix !== "R") {
              setupStatus.textContent = "Prefix R olmalƒ±.";
              return;
            }

            try {
              const CHUNK_SIZE = 450;
              let created = 0;

              for (let start = 1; start <= count; start += CHUNK_SIZE) {
                const batch = writeBatch(db);
                const end = Math.min(start + CHUNK_SIZE - 1, count);

                for (let i = start; i <= end; i++) {
                  const rafAdi = padShelf(i);
                  batch.set(
                    doc(shelvesCol, rafAdi),
                    { name: rafAdi, products: {}, updated: serverTimestamp() },
                    { merge: true }
                  );
                }

                await batch.commit();
                created = end;
                setupStatus.textContent = `Olu≈üturuldu: ${created} / ${count}`;
              }

              await setDoc(initRef, { done:true, count, updated: serverTimestamp() }, { merge:true });
              await writeLog({ action: "SETUP", shelf: "-", product: "-", qty: 0, detail: `Manuel kurulum: ${count} raf` });

              setupStatus.textContent = `Bƒ∞TTƒ∞ ‚úÖ Toplam ${count} raf olu≈üturuldu.`;
            } catch (e) {
              setupStatus.textContent = "Hata: " + e.message;
            }
          };
        }

        // ADMIN: LOG Y√úKLE
        let currentLogActionFilter = 'all';
        let currentLogRoleFilter = 'all';

        async function loadLogs(actionFilter = 'all', roleFilter = 'all'){
          if(role!=="admin") return;

          setStatusBox(statusLogs, "Loglar y√ºkleniyor...", "");
          logsBody.innerHTML = "";
          logsWrap.style.display = "none";

          currentLogActionFilter = actionFilter;
          currentLogRoleFilter = roleFilter;

          // Action filter butonlarƒ±nƒ± g√ºncelle
          [btnLogPut, btnLogClear, btnLogDecrease, btnLogMaterial, btnLogProduction, btnLogAllActions].forEach(btn => {
            btn && btn.classList.remove('active');
          });
          // Role filter butonlarƒ±nƒ± g√ºncelle
          [btnLogAdmin, btnLogPacker, btnLogStower, btnLogWelder, btnLogPurchase, btnLogAllRoles].forEach(btn => {
            btn && btn.classList.remove('active');
          });

          if(actionFilter === 'put') btnLogPut?.classList.add('active');
          else if(actionFilter === 'clear') btnLogClear?.classList.add('active');
          else if(actionFilter === 'decrease') btnLogDecrease?.classList.add('active');
          else if(actionFilter === 'material') btnLogMaterial?.classList.add('active');
          else if(actionFilter === 'production') btnLogProduction?.classList.add('active');
          else btnLogAllActions?.classList.add('active');

          if(roleFilter === 'admin') btnLogAdmin?.classList.add('active');
          else if(roleFilter === 'packer') btnLogPacker?.classList.add('active');
          else if(roleFilter === 'stower') btnLogStower?.classList.add('active');
          else if(roleFilter === 'welder') btnLogWelder?.classList.add('active');
          else if(roleFilter === 'purchase') btnLogPurchase?.classList.add('active');
          else btnLogAllRoles?.classList.add('active');

          const lim = Math.max(10, Math.min(500, Number(logLimit.value || 100)));

          try{
            const ql = query(logsCol, orderBy("ts","desc"), limit(lim));
            const snap = await getDocs(ql);

            if(snap.empty){
              setStatusBox(statusLogs, "Log bulunamadƒ±.", "warn");
              return;
            }

            let filteredLogs = [];

            snap.forEach(docSnap=>{
              const d = docSnap.data() || {};
              
              // Action filter
              let passActionFilter = true;
              if(actionFilter !== 'all'){
                const action = d.action || "";
                if(actionFilter === 'put' && action !== 'PUT') passActionFilter = false;
                else if(actionFilter === 'clear' && !['CLEAR_SHELF', 'REMOVE_PRODUCT_ALL', 'REMOVE_PRODUCT'].includes(action)) passActionFilter = false;
                else if(actionFilter === 'decrease' && action !== 'DECREASE_QTY') passActionFilter = false;
                else if(actionFilter === 'material' && !['MATERIAL_REQUEST', 'MATERIAL_STATUS_UPDATE'].includes(action)) passActionFilter = false;
                else if(actionFilter === 'production' && !['PRODUCTION_REQUEST', 'PRODUCTION_COMPLETED', 'FULFILL_REQUESTS'].includes(action)) passActionFilter = false;
              }

              // Role filter
              let passRoleFilter = true;
              if(roleFilter !== 'all'){
                const logRole = d.role || "";
                if(logRole !== roleFilter) passRoleFilter = false;
              }

              if(passActionFilter && passRoleFilter){
                filteredLogs.push(d);
              }
            });

            if(filteredLogs.length === 0){
              setStatusBox(statusLogs, "Bu filtreye uygun log bulunamadƒ±.", "warn");
              return;
            }

            filteredLogs.forEach(d => {
              const dt = d.ts?.toDate ? d.ts.toDate() : null;
              const dtStr = formatLogDate(dt);
              
              const userName = getNameByPin(d.pin);
              const roleText = d.role || "-";

              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${dtStr}</td>
                <td>${roleText} / ${userName}</td>
                <td>${translateAction(d.action || "-")}</td>
                <td>${(d.shelf || "-")}</td>
                <td>${(d.product || "-")}</td>
                <td>${(d.qty ?? "-")}</td>
                <td>${(d.detail || "-")}</td>
              `;
              logsBody.appendChild(tr);
            });

            logsWrap.style.display = "block";
            const actionText = actionFilter === 'put' ? 'Rafa Koy' : 
                              actionFilter === 'clear' ? 'Raf Bo≈üalt' : 
                              actionFilter === 'decrease' ? 'Adet Azalt' : 
                              actionFilter === 'material' ? 'Malzeme' : 
                              actionFilter === 'production' ? '√úretim' : 'T√ºm';
            const roleText = roleFilter === 'admin' ? 'Y√∂netici' : 
                            roleFilter === 'packer' ? 'Paket√ßi' : 
                            roleFilter === 'stower' ? 'Raf Dizen' : 
                            roleFilter === 'welder' ? '√úretim' : 
                            roleFilter === 'purchase' ? 'Satƒ±n Alma' : 'T√ºm';
            setStatusBox(statusLogs, `${actionText} / ${roleText}: ${filteredLogs.length} kayƒ±t`, "ok");
          }catch(e){
            setStatusBox(statusLogs, "Hata: " + e.message, "error");
          }
        }

        btnLoadLogs && (btnLoadLogs.onclick = () => loadLogs(currentLogActionFilter, currentLogRoleFilter));
        
        btnLogPut && (btnLogPut.onclick = () => loadLogs('put', currentLogRoleFilter));
        btnLogClear && (btnLogClear.onclick = () => loadLogs('clear', currentLogRoleFilter));
        btnLogDecrease && (btnLogDecrease.onclick = () => loadLogs('decrease', currentLogRoleFilter));
        btnLogMaterial && (btnLogMaterial.onclick = () => loadLogs('material', currentLogRoleFilter));
        btnLogProduction && (btnLogProduction.onclick = () => loadLogs('production', currentLogRoleFilter));
        btnLogAllActions && (btnLogAllActions.onclick = () => loadLogs('all', currentLogRoleFilter));
        
        btnLogAdmin && (btnLogAdmin.onclick = () => loadLogs(currentLogActionFilter, 'admin'));
        btnLogPacker && (btnLogPacker.onclick = () => loadLogs(currentLogActionFilter, 'packer'));
        btnLogStower && (btnLogStower.onclick = () => loadLogs(currentLogActionFilter, 'stower'));
        btnLogWelder && (btnLogWelder.onclick = () => loadLogs(currentLogActionFilter, 'welder'));
        btnLogPurchase && (btnLogPurchase.onclick = () => loadLogs(currentLogActionFilter, 'purchase'));
        btnLogAllRoles && (btnLogAllRoles.onclick = () => loadLogs(currentLogActionFilter, 'all'));

        // Welder (Kaynak ƒ∞malat) functionality
        async function saveProduction(){
          const code = (welderCode.value || "").trim();
          const qty = parseInt(welderQty.value || "0", 10);

          if(!code){
            setStatusBox(statusWelder, "√úr√ºn kodu giriniz.", "error");
            return;
          }
          if(qty <= 0){
            setStatusBox(statusWelder, "Ge√ßerli bir adet giriniz.", "error");
            return;
          }

          try{
            setStatusBox(statusWelder, "Kaydediliyor...", "");
            await addDoc(productionCol, {
              productCode: code,
              quantity: qty,
              welderPin: sessionPin,
              createdAt: serverTimestamp()
            });

            setStatusBox(statusWelder, "√úretim kaydedildi!", "ok");
            welderCode.value = "";
            welderQty.value = "";
            
            playBeep();
            setTimeout(()=>welderCode.focus(), 100);
            loadTodayProduction();
          }catch(e){
            setStatusBox(statusWelder, "Hata: " + e.message, "error");
          }
        }

        async function loadTodayProduction(){
          try{
            setStatusBox(statusWelderToday, "Y√ºkleniyor...", "");
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const q = query(
              productionCol,
              where("createdAt", ">=", today),
              orderBy("createdAt", "desc")
            );
            
            const snap = await getDocs(q);
            welderTodayBody.innerHTML = "";
            
            if(snap.empty){
              welderTodayWrap.style.display = "none";
              setStatusBox(statusWelderToday, "Bug√ºn √ºretim kaydƒ± yok.", "warn");
              return;
            }

            snap.forEach(doc => {
              const d = doc.data();
              const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
              const timeStr = dt ? dt.toLocaleTimeString("tr-TR") : "-";
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${timeStr}</td>
                <td>${d.productCode || "-"}</td>
                <td>${d.quantity || 0}</td>
              `;
              welderTodayBody.appendChild(tr);
            });

            welderTodayWrap.style.display = "block";
            setStatusBox(statusWelderToday, `Toplam ${snap.size} kayƒ±t`, "ok");
          }catch(e){
            setStatusBox(statusWelderToday, "Hata: " + e.message, "error");
          }
        }

        welderSave && (welderSave.onclick = saveProduction);
        
        if(role === "welder"){
          loadTodayProduction();
          loadWelderRequests();
        }

        // Welder requests list
        async function loadWelderRequests(){
          try{
            setStatusBox(statusWelderRequests, "Y√ºkleniyor...", "");
            
            // Kullanƒ±cƒ±nƒ±n tipini belirle (laser mi welder mƒ±?)
            let userProductionType = null;
            if(LASER_PINS.has(sessionPin)){
              userProductionType = "laser";
            } else if(WELDER_PINS.has(sessionPin)){
              userProductionType = "welder";
            }
            
            // T√ºm talepleri al ve client-side filtrele (index hatasƒ± olmasƒ±n diye)
            const q = query(reqCol, orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            
            welderRequestsBody.innerHTML = "";
            
            let filteredDocs = [];
            if(role === "admin"){
              // Admin t√ºm talepleri g√∂r√ºr
              filteredDocs = snap.docs;
            } else if(userProductionType){
              // Sadece kendi tipine ait talepleri filtrele
              filteredDocs = snap.docs.filter(doc => {
                const data = doc.data();
                return data.productionType === userProductionType;
              });
            }
            
            if(filteredDocs.length === 0){
              welderRequestsWrap.style.display = "none";
              setStatusBox(statusWelderRequests, "Talep bulunamadƒ±.", "warn");
              return;
            }

            filteredDocs.forEach(doc => {
              const d = doc.data();
              const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
              const dateStr = dt ? formatLogDate(dt) : "-";
              
              const statusBadge = (d.status === "produced")
                ? `<span class="badge b-done">√úRETƒ∞LDƒ∞</span>`
                : `<span class="badge b-wait">BEKLƒ∞YOR</span>`;
              
              const actionBtn = (d.status === "pending")
                ? `<button class="searchBtn" onclick="markAsProduced('${doc.id}', '${d.product}')">√úRETTƒ∞M</button>`
                : "-";
              
              const requesterName = getNameByPin(d.requestedBy);
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${d.product || "-"}</td>
                <td>${requesterName}</td>
                <td>${statusBadge}</td>
                <td>${actionBtn}</td>
              `;
              welderRequestsBody.appendChild(tr);
            });

            welderRequestsWrap.style.display = "block";
            setStatusBox(statusWelderRequests, `Toplam ${filteredDocs.length} talep`, "ok");
          }catch(e){
            setStatusBox(statusWelderRequests, "Hata: " + e.message, "error");
          }
        }

        // Mark production request as produced
        window.markAsProduced = async function(requestId, productCode){
          if(!requestId) return;
          
          try{
            const requestRef = doc(db, "requests", requestId);
            await updateDoc(requestRef, {
              status: "produced",
              producedAt: serverTimestamp(),
              producedBy: sessionPin || "-"
            });
            
            await writeLog({ 
              action: "PRODUCTION_COMPLETED", 
              shelf: "-", 
              product: productCode, 
              qty: 0, 
              detail: `√úretim talebi tamamlandƒ± (Kaynak√ßƒ±: ${sessionPin})` 
            });
            
            playBeep();
            loadWelderRequests(); // Reload the list
          }catch(e){
            alert("Hata: " + e.message);
          }
        };

        // Production list for admin & packer
        async function loadProduction(filter = 'day'){
          try{
            setStatusBox(statusProduction, "Y√ºkleniyor...", "");
            
            // Filtre butonlarƒ±nƒ±n aktif durumunu g√ºncelle
            [btnProdDay, btnProdWeek, btnProdMonth, btnProdYear].forEach(btn => {
              btn && btn.classList.remove('active');
            });
            
            if(filter === 'day') btnProdDay?.classList.add('active');
            else if(filter === 'week') btnProdWeek?.classList.add('active');
            else if(filter === 'month') btnProdMonth?.classList.add('active');
            else if(filter === 'year') btnProdYear?.classList.add('active');
            
            const now = new Date();
            let startDate = new Date();
            
            if(filter === 'day'){
              startDate.setHours(0, 0, 0, 0);
            } else if(filter === 'week'){
              startDate.setDate(now.getDate() - 7);
              startDate.setHours(0, 0, 0, 0);
            } else if(filter === 'month'){
              startDate.setMonth(now.getMonth() - 1);
              startDate.setHours(0, 0, 0, 0);
            } else if(filter === 'year'){
              startDate.setFullYear(now.getFullYear() - 1);
              startDate.setHours(0, 0, 0, 0);
            }
            
            const q = query(
              productionCol,
              where("createdAt", ">=", startDate),
              orderBy("createdAt", "desc")
            );
            
            const snap = await getDocs(q);
            productionBody.innerHTML = "";
            
            if(snap.empty){
              productionWrap.style.display = "none";
              setStatusBox(statusProduction, "√úretim kaydƒ± bulunamadƒ±.", "warn");
              return;
            }

            let totalQty = 0;
            snap.forEach(doc => {
              const d = doc.data();
              const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
              const dateStr = formatLogDate(dt);
              totalQty += (d.quantity || 0);
              
              const welderName = getNameByPin(d.welderPin);
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${d.productCode || "-"}</td>
                <td>${d.quantity || 0}</td>
                <td>${welderName}</td>
              `;
              productionBody.appendChild(tr);
            });

            productionWrap.style.display = "block";
            const filterText = filter === 'day' ? 'G√ºnl√ºk' : filter === 'week' ? 'Haftalƒ±k' : filter === 'month' ? 'Aylƒ±k' : 'Yƒ±llƒ±k';
            setStatusBox(statusProduction, `${filterText}: ${snap.size} kayƒ±t, Toplam ${totalQty} adet`, "ok");
          }catch(e){
            setStatusBox(statusProduction, "Hata: " + e.message, "error");
          }
        }

        btnProdDay && (btnProdDay.onclick = () => loadProduction('day'));
        btnProdWeek && (btnProdWeek.onclick = () => loadProduction('week'));
        btnProdMonth && (btnProdMonth.onclick = () => loadProduction('month'));
        btnProdYear && (btnProdYear.onclick = () => loadProduction('year'));
        
        // Admin veya packer i√ßin otomatik y√ºkleme
        if(role === 'admin' || role === 'packer'){
          // √ñnce g√ºnl√ºk kontrol et
          (async () => {
            try {
              const now = new Date();
              const todayStart = new Date();
              todayStart.setHours(0, 0, 0, 0);
              
              const qDay = query(
                productionCol,
                where("createdAt", ">=", todayStart),
                limit(1)
              );
              
              const daySnap = await getDocs(qDay);
              
              if(daySnap.empty) {
                // G√ºnl√ºk √ºretim yoksa haftalƒ±k g√∂ster
                loadProduction('week');
              } else {
                // G√ºnl√ºk √ºretim varsa g√ºnl√ºk g√∂ster
                loadProduction('day');
              }
            } catch(e) {
              // Hata durumunda g√ºnl√ºk g√∂ster
              loadProduction('day');
            }
          })();
        }

        // INSTRUCTIONS: √úr√ºn talimatlarƒ±nƒ± y√ºkle
        async function loadInstructions() {
          const productCode = (instructionsProductCode.value || "").trim();
          if(!productCode) {
            setStatusBox(statusInstructions, "√úr√ºn kodu giriniz.", "error");
            return;
          }

          setStatusBox(statusInstructions, "Y√ºkleniyor...", "");
          instructionsContent.style.display = "none";
          instructionContainer.innerHTML = "";

          try {
            // Firestore'dan √ºr√ºn talimatƒ±nƒ± getir
            const q = query(instructionsCol, where("productCode", "==", productCode), limit(1));
            const snap = await getDocs(q);
            
            if(snap.empty) {
              setStatusBox(statusInstructions, `${productCode} kodlu √ºr√ºn i√ßin talimat bulunamadƒ±.`, "error");
              instructionContainer.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);">Bu √ºr√ºn i√ßin hen√ºz talimat eklenmemi≈ü.</div>';
              instructionsContent.style.display = "block";
              return;
            }

            const data = snap.docs[0].data();
            const type = data.instructionType || "pdf"; // pdf, image, link
            const url = data.instructionUrl || "";

            if(!url) {
              setStatusBox(statusInstructions, "Talimat URL'si bulunamadƒ±.", "error");
              return;
            }

            instructionsContent.style.display = "block";

            if(type === "pdf") {
              // PDF i√ßin iframe
              const iframe = document.createElement('iframe');
              iframe.src = url;
              iframe.style.cssText = 'width:100%;height:600px;border:none;';
              instructionContainer.appendChild(iframe);
              setStatusBox(statusInstructions, "Talimat y√ºklendi.", "ok");
            } else if(type === "image") {
              // Resim i√ßin img
              const img = document.createElement('img');
              img.src = url;
              img.style.cssText = 'width:100%;height:auto;max-height:600px;object-fit:contain;';
              img.onerror = () => {
                setStatusBox(statusInstructions, "Resim y√ºklenemedi.", "error");
              };
              img.onload = () => {
                setStatusBox(statusInstructions, "Talimat y√ºklendi.", "ok");
              };
              instructionContainer.appendChild(img);
            } else if(type === "link") {
              // Link i√ßin buton
              const linkDiv = document.createElement('div');
              linkDiv.style.cssText = 'padding:40px;text-align:center;';
              
              const linkBtn = document.createElement('a');
              linkBtn.href = url;
              linkBtn.target = "_blank";
              linkBtn.textContent = "Talimatƒ± A√ß (Yeni Sekmede)";
              linkBtn.style.cssText = 'display:inline-block;padding:14px 24px;background:var(--green);color:#07210f;text-decoration:none;border-radius:12px;font-weight:900;font-size:16px;';
              
              linkDiv.appendChild(linkBtn);
              instructionContainer.appendChild(linkDiv);
              setStatusBox(statusInstructions, "Talimat linki hazƒ±r.", "ok");
            } else {
              setStatusBox(statusInstructions, "Bilinmeyen talimat tipi.", "error");
            }
          } catch(e) {
            console.error('Talimat y√ºkleme hatasƒ±:', e);
            setStatusBox(statusInstructions, "Hata: " + e.message, "error");
          }
        }

        btnLoadInstructions && (btnLoadInstructions.onclick = loadInstructions);
        instructionsProductCode && instructionsProductCode.addEventListener("keydown", (e) => {
          if(e.key === "Enter") loadInstructions();
        });

        // Toplu talimat y√ºkleme fonksiyonu
        async function bulkUploadInstructions() {
          if(!bulkInstructionsInput || !statusBulkInstructions) return;
          
          try {
            const text = bulkInstructionsInput.value.trim();
            if(!text) {
              setStatusBox(statusBulkInstructions, "L√ºtfen veri girin.", "error");
              return;
            }

            const lines = text.split('\n').filter(line => line.trim());
            if(lines.length === 0) {
              setStatusBox(statusBulkInstructions, "Hi√ß satƒ±r bulunamadƒ±.", "error");
              return;
            }

            setStatusBox(statusBulkInstructions, `${lines.length} satƒ±r y√ºkleniyor...`, "info");

            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            for(let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              const parts = line.split(',').map(p => p.trim());
              
              if(parts.length !== 3) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: Yanlƒ±≈ü format (3 alan gerekli)`);
                continue;
              }

              const [productCode, instructionType, instructionUrl] = parts;

              if(!productCode || !instructionType || !instructionUrl) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: Bo≈ü alan var`);
                continue;
              }

              if(!['pdf', 'image', 'link'].includes(instructionType.toLowerCase())) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: Ge√ßersiz tip (pdf, image veya link olmalƒ±)`);
                continue;
              }

              try {
                await addDoc(instructionsCol, {
                  productCode: productCode,
                  instructionType: instructionType.toLowerCase(),
                  instructionUrl: instructionUrl,
                  createdAt: serverTimestamp(),
                  updatedAt: serverTimestamp()
                });
                successCount++;
              } catch(e) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: ${e.message}`);
              }
            }

            let message = `‚úì ${successCount} ba≈üarƒ±lƒ±`;
            if(errorCount > 0) {
              message += `, ‚úó ${errorCount} hata`;
            }
            
            if(errors.length > 0 && errors.length <= 5) {
              message += '\n' + errors.join('\n');
            } else if(errors.length > 5) {
              message += '\n' + errors.slice(0, 5).join('\n') + `\n... ve ${errors.length - 5} hata daha`;
            }

            setStatusBox(statusBulkInstructions, message, errorCount > 0 ? "warn" : "ok");
            
            if(successCount > 0) {
              bulkInstructionsInput.value = '';
            }
          } catch(e) {
            console.error('Toplu y√ºkleme hatasƒ±:', e);
            setStatusBox(statusBulkInstructions, "Hata: " + e.message, "error");
          }
        }

        btnBulkUploadInstructions && (btnBulkUploadInstructions.onclick = bulkUploadInstructions);

        // Paketleme talimatlarƒ±nƒ± y√ºkleme fonksiyonu
        async function loadPackagingInstructions() {
          if(!packagingProductCode || !statusPackaging || !packagingContainer) return;
          
          try {
            const productCode = (packagingProductCode.value || "").trim();
            if(!productCode) {
              setStatusBox(statusPackaging, "L√ºtfen √ºr√ºn kodu girin.", "error");
              return;
            }

            setStatusBox(statusPackaging, "Y√ºkleniyor...", "info");
            packagingContainer.innerHTML = "";
            packagingContent.style.display = "none";

            const snap = await getDocs(query(packagingCol, where("productCode", "==", productCode), limit(1)));
            
            if(snap.empty) {
              setStatusBox(statusPackaging, "Bu √ºr√ºn i√ßin paketleme talimatƒ± bulunamadƒ±.", "warn");
              return;
            }

            const data = snap.docs[0].data();
            const type = data.instructionType;
            const url = data.instructionUrl;

            packagingContent.style.display = "block";

            if(type === "pdf") {
              const iframe = document.createElement('iframe');
              iframe.src = url;
              iframe.style.cssText = 'width:100%;height:600px;border:none;';
              iframe.onload = () => {
                setStatusBox(statusPackaging, "Talimat y√ºklendi.", "ok");
              };
              packagingContainer.appendChild(iframe);
            } else if(type === "image") {
              const img = document.createElement('img');
              img.src = url;
              img.style.cssText = 'max-width:100%;height:auto;display:block;margin:0 auto;';
              img.onload = () => {
                setStatusBox(statusPackaging, "Talimat y√ºklendi.", "ok");
              };
              packagingContainer.appendChild(img);
            } else if(type === "link") {
              const linkDiv = document.createElement('div');
              linkDiv.style.cssText = 'padding:40px;text-align:center;';
              
              const linkBtn = document.createElement('a');
              linkBtn.href = url;
              linkBtn.target = "_blank";
              linkBtn.textContent = "Talimatƒ± A√ß (Yeni Sekmede)";
              linkBtn.style.cssText = 'display:inline-block;padding:14px 24px;background:var(--green);color:#07210f;text-decoration:none;border-radius:12px;font-weight:900;font-size:16px;';
              
              linkDiv.appendChild(linkBtn);
              packagingContainer.appendChild(linkDiv);
              setStatusBox(statusPackaging, "Talimat linki hazƒ±r.", "ok");
            } else {
              setStatusBox(statusPackaging, "Bilinmeyen talimat tipi.", "error");
            }
          } catch(e) {
            console.error('Paketleme talimatƒ± y√ºkleme hatasƒ±:', e);
            setStatusBox(statusPackaging, "Hata: " + e.message, "error");
          }
        }

        btnLoadPackaging && (btnLoadPackaging.onclick = loadPackagingInstructions);
        packagingProductCode && packagingProductCode.addEventListener("keydown", (e) => {
          if(e.key === "Enter") loadPackagingInstructions();
        });

        // Toplu paketleme talimatƒ± y√ºkleme fonksiyonu
        async function bulkUploadPackaging() {
          if(!bulkPackagingInput || !statusBulkPackaging) return;
          
          try {
            const text = bulkPackagingInput.value.trim();
            if(!text) {
              setStatusBox(statusBulkPackaging, "L√ºtfen veri girin.", "error");
              return;
            }

            const lines = text.split('\n').filter(line => line.trim());
            if(lines.length === 0) {
              setStatusBox(statusBulkPackaging, "Hi√ß satƒ±r bulunamadƒ±.", "error");
              return;
            }

            setStatusBox(statusBulkPackaging, `${lines.length} satƒ±r y√ºkleniyor...`, "info");

            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            for(let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              const parts = line.split(',').map(p => p.trim());
              
              if(parts.length !== 3) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: Yanlƒ±≈ü format (3 alan gerekli)`);
                continue;
              }

              const [productCode, instructionType, instructionUrl] = parts;

              if(!productCode || !instructionType || !instructionUrl) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: Bo≈ü alan var`);
                continue;
              }

              if(!['pdf', 'image', 'link'].includes(instructionType.toLowerCase())) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: Ge√ßersiz tip (pdf, image veya link olmalƒ±)`);
                continue;
              }

              try {
                await addDoc(packagingCol, {
                  productCode: productCode,
                  instructionType: instructionType.toLowerCase(),
                  instructionUrl: instructionUrl,
                  createdAt: serverTimestamp(),
                  updatedAt: serverTimestamp()
                });
                successCount++;
              } catch(e) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: ${e.message}`);
              }
            }

            let message = `‚úì ${successCount} ba≈üarƒ±lƒ±`;
            if(errorCount > 0) {
              message += `, ‚úó ${errorCount} hata`;
            }
            
            if(errors.length > 0 && errors.length <= 5) {
              message += '\n' + errors.join('\n');
            } else if(errors.length > 5) {
              message += '\n' + errors.slice(0, 5).join('\n') + `\n... ve ${errors.length - 5} hata daha`;
            }

            setStatusBox(statusBulkPackaging, message, errorCount > 0 ? "warn" : "ok");
            
            if(successCount > 0) {
              bulkPackagingInput.value = '';
            }
          } catch(e) {
            console.error('Toplu paketleme y√ºkleme hatasƒ±:', e);
            setStatusBox(statusBulkPackaging, "Hata: " + e.message, "error");
          }
        }

        btnBulkUploadPackaging && (btnBulkUploadPackaging.onclick = bulkUploadPackaging);

        // ============================
        // PERSONEL Y√ñNETƒ∞Mƒ∞ VE MAA≈û TAKƒ∞Bƒ∞
        // ============================

        // Periyot alanlarƒ±nƒ± g√∂ster/gizle
        personnelPaymentPeriod && personnelPaymentPeriod.addEventListener("change", (e) => {
          if(e.target.value === "monthly") {
            monthlyPaymentFields.style.display = "block";
            weeklyPaymentFields.style.display = "none";
          } else {
            monthlyPaymentFields.style.display = "none";
            weeklyPaymentFields.style.display = "block";
          }
        });

        // Personel ekleme
        async function addPersonnel() {
          try {
            const name = personnelName.value.trim();
            const period = personnelPaymentPeriod.value;
            const salary = Number(personnelSalary.value);
            const startDate = personnelStartDate.value;

            if(!name) {
              setStatusBox(statusPersonnel, "Personel adƒ± zorunludur.", "error");
              return;
            }

            if(!salary || salary <= 0) {
              setStatusBox(statusPersonnel, "Ge√ßerli bir maa≈ü tutarƒ± girin.", "error");
              return;
            }

            if(!startDate) {
              setStatusBox(statusPersonnel, "ƒ∞≈üe ba≈ülama tarihi zorunludur.", "error");
              return;
            }

            let paymentDay;
            if(period === "monthly") {
              paymentDay = Number(personnelPaymentDayMonthly.value);
              if(!paymentDay || paymentDay < 1 || paymentDay > 31) {
                setStatusBox(statusPersonnel, "Ge√ßerli bir √∂deme g√ºn√º girin (1-31).", "error");
                return;
              }
            } else {
              paymentDay = Number(personnelPaymentDayWeekly.value);
            }

            setStatusBox(statusPersonnel, "Kaydediliyor...", "info");

            await addDoc(personnelCol, {
              name,
              paymentPeriod: period,
              paymentDay,
              salary,
              startDate,
              active: true,
              createdAt: new Date().toISOString(),
              createdBy: window.__SESSION?.pin || "admin"
            });

            setStatusBox(statusPersonnel, "Personel ba≈üarƒ±yla eklendi.", "ok");
            
            // Formu temizle
            personnelName.value = "";
            personnelSalary.value = "";
            personnelStartDate.value = "";
            personnelPaymentDayMonthly.value = "";

            loadPersonnel();
            updatePaymentAlerts();
          } catch(e) {
            console.error('Personel ekleme hatasƒ±:', e);
            setStatusBox(statusPersonnel, "Hata: " + e.message, "error");
          }
        }

        btnAddPersonnel && (btnAddPersonnel.onclick = addPersonnel);

        // Sonraki √∂deme tarihini hesapla
        function calculateNextPaymentDate(personnel, lastPaymentDate = null) {
          const today = new Date();
          let referenceDate = lastPaymentDate ? new Date(lastPaymentDate) : new Date(personnel.startDate);

          if(personnel.paymentPeriod === "monthly") {
            const paymentDay = personnel.paymentDay;
            let nextDate = new Date(referenceDate);
            
            // Bir sonraki √∂deme ayƒ±nƒ± bul
            if(lastPaymentDate) {
              nextDate.setMonth(nextDate.getMonth() + 1);
            }
            
            // √ñdeme g√ºn√ºn√º ayarla
            nextDate.setDate(Math.min(paymentDay, new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate()));
            
            // Eƒüer tarih ge√ßmi≈üte kaldƒ±ysa, bir sonraki aya ge√ß
            while(nextDate <= today) {
              nextDate.setMonth(nextDate.getMonth() + 1);
              nextDate.setDate(Math.min(paymentDay, new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate()));
            }
            
            return nextDate;
          } else {
            // Haftalƒ±k
            const targetDay = personnel.paymentDay;
            let nextDate = new Date(referenceDate);
            
            if(lastPaymentDate) {
              nextDate.setDate(nextDate.getDate() + 7);
            } else {
              // ƒ∞lk √∂deme tarihini bul
              while(nextDate.getDay() !== targetDay) {
                nextDate.setDate(nextDate.getDate() + 1);
              }
            }
            
            // Eƒüer tarih ge√ßmi≈üte kaldƒ±ysa, bir sonraki haftaya ge√ß
            while(nextDate <= today) {
              nextDate.setDate(nextDate.getDate() + 7);
            }
            
            return nextDate;
          }
        }

        // Personelleri y√ºkle
        let allPersonnel = [];
        async function loadPersonnel() {
          if(!personnelListBody) return;

          try {
            const snap = await getDocs(query(personnelCol, where("active", "==", true)));
            
            allPersonnel = snap.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));

            // Her personel i√ßin son √∂deme tarihini bul
            const paymentSnap = await getDocs(query(paymentCol, where("paymentType", "==", "salary"), orderBy("paymentDate", "desc")));
            const lastPayments = {};
            
            paymentSnap.docs.forEach(doc => {
              const data = doc.data();
              if(!lastPayments[data.personnelId]) {
                lastPayments[data.personnelId] = data.paymentDate;
              }
            });

            if(allPersonnel.length === 0) {
              personnelListBody.innerHTML = `<tr><td colspan="6" style="padding:24px;text-align:center;color:var(--muted);">Hen√ºz personel eklenmedi.</td></tr>`;
            } else {
              personnelListBody.innerHTML = allPersonnel.map(p => {
                const nextPayment = calculateNextPaymentDate(p, lastPayments[p.id]);
                const daysUntil = Math.ceil((nextPayment - new Date()) / (1000 * 60 * 60 * 24));
                const periodText = p.paymentPeriod === "monthly" ? "Aylƒ±k" : "Haftalƒ±k";
                const dayText = p.paymentPeriod === "monthly" 
                  ? `Ayƒ±n ${p.paymentDay}. g√ºn√º`
                  : ["Pazar", "Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma", "Cumartesi"][p.paymentDay];
                
                const dateColor = daysUntil <= 3 ? "red" : daysUntil <= 7 ? "orange" : "var(--text)";
                
                return `
                  <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:12px;font-weight:900;font-size:13px;">${p.name}</td>
                    <td style="padding:12px;font-size:13px;">${periodText}</td>
                    <td style="padding:12px;font-size:13px;">${dayText}</td>
                    <td style="padding:12px;text-align:right;font-weight:900;font-size:14px;">${new Intl.NumberFormat('tr-TR').format(p.salary)} ‚Ç∫</td>
                    <td style="padding:12px;font-size:13px;color:${dateColor};font-weight:${daysUntil <= 7 ? 'bold' : 'normal'};">
                      ${nextPayment.toLocaleDateString('tr-TR')} (${daysUntil} g√ºn)
                    </td>
                    <td style="padding:12px;text-align:center;">
                      <div style="display:flex;gap:4px;justify-content:center;">
                        <button onclick="editPersonnel('${p.id}')" style="background:#007bff;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:12px;font-weight:900;cursor:pointer;">D√úZENLE</button>
                        <button onclick="deletePersonnel('${p.id}')" style="background:#dc3545;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:12px;font-weight:900;cursor:pointer;">Sƒ∞L</button>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('');
            }

            // Personel se√ßim listesini g√ºncelle
            updatePersonnelSelectList();
          } catch(e) {
            console.error('Personel y√ºkleme hatasƒ±:', e);
            personnelListBody.innerHTML = `<tr><td colspan="6" style="padding:24px;text-align:center;color:var(--red);">Hata: ${e.message}</td></tr>`;
          }
        }

        // Personeli pasife al
        // Personeli sil
        window.deletePersonnel = async function(personnelId) {
          if(!confirm('Bu personeli kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz!')) return;

          try {
            await deleteDoc(doc(personnelCol, personnelId));
            loadPersonnel();
            updatePaymentAlerts();
            alert('Personel silindi.');
          } catch(e) {
            alert('Hata: ' + e.message);
          }
        };

        // Personel d√ºzenleme formunu a√ß
        window.editPersonnel = function(personnelId) {
          const personnel = allPersonnel.find(p => p.id === personnelId);
          if(!personnel) return;

          // Formu doldur
          editPersonnelId.value = personnelId;
          editPersonnelName.value = personnel.name;
          editPersonnelPaymentPeriod.value = personnel.paymentPeriod;
          editPersonnelSalary.value = personnel.salary;
          editPersonnelStartDate.value = personnel.startDate;

          if(personnel.paymentPeriod === "monthly") {
            editPersonnelPaymentDayMonthly.value = personnel.paymentDay;
            editMonthlyPaymentFields.style.display = "block";
            editWeeklyPaymentFields.style.display = "none";
          } else {
            editPersonnelPaymentDayWeekly.value = personnel.paymentDay;
            editMonthlyPaymentFields.style.display = "none";
            editWeeklyPaymentFields.style.display = "block";
          }

          // D√ºzenleme b√∂l√ºm√ºn√º g√∂ster
          editPersonnelSection.style.display = "block";
          editPersonnelSection.scrollIntoView({ behavior: 'smooth' });
        };

        // D√ºzenleme periyot deƒüi≈üimi
        editPersonnelPaymentPeriod && editPersonnelPaymentPeriod.addEventListener("change", (e) => {
          if(e.target.value === "monthly") {
            editMonthlyPaymentFields.style.display = "block";
            editWeeklyPaymentFields.style.display = "none";
          } else {
            editMonthlyPaymentFields.style.display = "none";
            editWeeklyPaymentFields.style.display = "block";
          }
        });

        // Personel g√ºncelleme
        btnUpdatePersonnel && (btnUpdatePersonnel.onclick = async function() {
          try {
            const personnelId = editPersonnelId.value;
            const name = editPersonnelName.value.trim();
            const period = editPersonnelPaymentPeriod.value;
            const salary = Number(editPersonnelSalary.value);
            const startDate = editPersonnelStartDate.value;

            if(!name) {
              setStatusBox(statusEditPersonnel, "Personel adƒ± zorunludur.", "error");
              return;
            }

            if(!salary || salary <= 0) {
              setStatusBox(statusEditPersonnel, "Ge√ßerli bir maa≈ü tutarƒ± girin.", "error");
              return;
            }

            if(!startDate) {
              setStatusBox(statusEditPersonnel, "ƒ∞≈üe ba≈ülama tarihi zorunludur.", "error");
              return;
            }

            let paymentDay;
            if(period === "monthly") {
              paymentDay = Number(editPersonnelPaymentDayMonthly.value);
              if(!paymentDay || paymentDay < 1 || paymentDay > 31) {
                setStatusBox(statusEditPersonnel, "Ge√ßerli bir √∂deme g√ºn√º girin (1-31).", "error");
                return;
              }
            } else {
              paymentDay = Number(editPersonnelPaymentDayWeekly.value);
            }

            setStatusBox(statusEditPersonnel, "G√ºncelleniyor...", "info");

            await updateDoc(doc(personnelCol, personnelId), {
              name,
              paymentPeriod: period,
              paymentDay,
              salary,
              startDate,
              updatedAt: new Date().toISOString()
            });

            setStatusBox(statusEditPersonnel, "Personel g√ºncellendi.", "ok");
            
            // Formu gizle
            editPersonnelSection.style.display = "none";
            
            loadPersonnel();
            updatePaymentAlerts();
          } catch(e) {
            console.error('Personel g√ºncelleme hatasƒ±:', e);
            setStatusBox(statusEditPersonnel, "Hata: " + e.message, "error");
          }
        });

        // D√ºzenleme iptali
        btnCancelEdit && (btnCancelEdit.onclick = function() {
          editPersonnelSection.style.display = "none";
        });

        // Personel se√ßim listesini g√ºncelle
        function updatePersonnelSelectList() {
          if(!paymentPersonSelect) return;
          
          paymentPersonSelect.innerHTML = '<option value="">Personel Se√ßiniz...</option>' +
            allPersonnel.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        // Yakla≈üan ve gecikmi≈ü √∂demeleri g√∂ster
        async function updatePaymentAlerts() {
          if(!upcomingPaymentsList || !overduePaymentsList) return;

          try {
            const paymentSnap = await getDocs(query(paymentCol, where("paymentType", "==", "salary"), orderBy("paymentDate", "desc")));
            const lastPayments = {};
            
            paymentSnap.docs.forEach(doc => {
              const data = doc.data();
              if(!lastPayments[data.personnelId]) {
                lastPayments[data.personnelId] = data.paymentDate;
              }
            });

            const today = new Date();
            const upcoming = [];
            const overdue = [];

            allPersonnel.forEach(p => {
              const nextPayment = calculateNextPaymentDate(p, lastPayments[p.id]);
              const daysUntil = Math.ceil((nextPayment - today) / (1000 * 60 * 60 * 24));

              if(daysUntil < 0) {
                overdue.push({ ...p, nextPayment, daysUntil: Math.abs(daysUntil) });
              } else if(daysUntil <= 7) {
                upcoming.push({ ...p, nextPayment, daysUntil });
              }
            });

            if(upcoming.length === 0) {
              upcomingPaymentsList.innerHTML = '<div style="color:rgba(255,255,255,0.8);">üìÖ Yakla≈üan √∂deme yok.</div>';
            } else {
              upcomingPaymentsList.innerHTML = upcoming.map(p => 
                `<div style="padding:4px 0;color:rgba(255,255,255,0.9);">‚Ä¢ <strong>${p.name}</strong>: ${p.nextPayment.toLocaleDateString('tr-TR')} (${p.daysUntil} g√ºn kaldƒ±) - ${new Intl.NumberFormat('tr-TR').format(p.salary)} ‚Ç∫</div>`
              ).join('');
            }

            if(overdue.length === 0) {
              overduePaymentsList.innerHTML = '<div style="color:rgba(255,255,255,0.8);">‚úÖ Gecikmi≈ü √∂deme yok.</div>';
            } else {
              overduePaymentsList.innerHTML = overdue.map(p => 
                `<div style="padding:4px 0;color:#fff;font-weight:bold;">‚Ä¢ <strong>${p.name}</strong>: ${p.nextPayment.toLocaleDateString('tr-TR')} (${p.daysUntil} g√ºn gecikmi≈ü!) - ${new Intl.NumberFormat('tr-TR').format(p.salary)} ‚Ç∫</div>`
              ).join('');
            }
          } catch(e) {
            console.error('√ñdeme uyarƒ±larƒ± hatasƒ±:', e);
          }
        }

        // √ñdeme kaydƒ± ekleme (YENƒ∞ Sƒ∞STEM)
        let currentPaymentFilter = "all";
        let allPayments = [];

        // Tarih input'una bug√ºn√ºn tarihini otomatik ayarla
        if(paymentDate) {
          const today = new Date().toISOString().split('T')[0];
          paymentDate.value = today;
        }

        async function addPaymentRecord() {
          if(!paymentPersonSelect || !paymentType || !paymentAmount || !paymentDate || !statusPayment) return;

          try {
            const personnelId = paymentPersonSelect.value;
            const type = paymentType.value;
            const amount = Number(paymentAmount.value);
            const date = paymentDate.value;
            const note = (paymentNote?.value || "").trim();

            if(!personnelId) {
              setStatusBox(statusPayment, "Personel se√ßiniz.", "error");
              return;
            }

            if(!amount || amount <= 0) {
              setStatusBox(statusPayment, "Ge√ßerli bir tutar girin.", "error");
              return;
            }

            if(!date) {
              setStatusBox(statusPayment, "Tarih se√ßin.", "error");
              return;
            }

            const personnel = allPersonnel.find(p => p.id === personnelId);
            if(!personnel) {
              setStatusBox(statusPayment, "Personel bulunamadƒ±.", "error");
              return;
            }

            setStatusBox(statusPayment, "Kaydediliyor...", "info");

            await addDoc(paymentCol, {
              personnelId: personnelId,
              personName: personnel.name,
              paymentType: type,
              amount: amount,
              paymentDate: date,
              note: note,
              createdAt: serverTimestamp(),
              createdBy: window.__SESSION?.pin || "admin"
            });

            setStatusBox(statusPayment, "√ñdeme kaydƒ± ba≈üarƒ±yla eklendi.", "ok");
            
            // Formu temizle
            paymentPersonSelect.value = "";
            paymentAmount.value = "";
            paymentNote && (paymentNote.value = "");
            const today = new Date().toISOString().split('T')[0];
            paymentDate.value = today;

            // Listeyi ve uyarƒ±larƒ± yenile
            loadPaymentRecords();
            loadPersonnel();
            updatePaymentAlerts();
          } catch(e) {
            console.error('√ñdeme kaydƒ± hatasƒ±:', e);
            setStatusBox(statusPayment, "Hata: " + e.message, "error");
          }
        }

        btnAddPayment && (btnAddPayment.onclick = addPaymentRecord);

        // Personel se√ßildiƒüinde maa≈ü tutarƒ±nƒ± otomatik doldur
        paymentPersonSelect && paymentPersonSelect.addEventListener("change", (e) => {
          const personnelId = e.target.value;
          if(personnelId && paymentType.value === "salary") {
            const personnel = allPersonnel.find(p => p.id === personnelId);
            if(personnel && paymentAmount) {
              paymentAmount.value = personnel.salary;
            }
          }
        });

        // √ñdeme tipi deƒüi≈ütiƒüinde maa≈ü tutarƒ±nƒ± otomatik ayarla
        paymentType && paymentType.addEventListener("change", (e) => {
          if(e.target.value === "salary" && paymentPersonSelect.value) {
            const personnelId = paymentPersonSelect.value;
            const personnel = allPersonnel.find(p => p.id === personnelId);
            if(personnel && paymentAmount) {
              paymentAmount.value = personnel.salary;
            }
          } else if(e.target.value === "advance" && paymentAmount) {
            paymentAmount.value = "";
          }
        });

        // √ñdeme kayƒ±tlarƒ±nƒ± y√ºkleme
        async function loadPaymentRecords(filterType = "all", searchName = "") {
          if(!paymentListBody) return;

          try {
            const snap = await getDocs(query(paymentCol, orderBy("paymentDate", "desc")));
            
            allPayments = snap.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));

            displayPayments(filterType, searchName);
          } catch(e) {
            console.error('√ñdeme kayƒ±tlarƒ± y√ºkleme hatasƒ±:', e);
            paymentListBody.innerHTML = `<tr><td colspan="6" style="padding:24px;text-align:center;color:var(--red);">Hata: ${e.message}</td></tr>`;
          }
        }

        // √ñdeme kayƒ±tlarƒ±nƒ± filtreleyip g√∂r√ºnt√ºleme
        function displayPayments(filterType = "all", searchName = "") {
          if(!paymentListBody) return;

          let filtered = allPayments;

          // Tip filtreleme
          if(filterType === "salary") {
            filtered = filtered.filter(p => p.paymentType === "salary");
          } else if(filterType === "advance") {
            filtered = filtered.filter(p => p.paymentType === "advance");
          }

          // ƒ∞sim filtreleme
          if(searchName) {
            const search = searchName.toLowerCase();
            filtered = filtered.filter(p => p.personName.toLowerCase().includes(search));
          }

          if(filtered.length === 0) {
            paymentListBody.innerHTML = `<tr><td colspan="6" style="padding:24px;text-align:center;color:var(--muted);">Kayƒ±t bulunamadƒ±.</td></tr>`;
            return;
          }

          paymentListBody.innerHTML = filtered.map(payment => {
            const typeText = payment.paymentType === "salary" ? "Maa≈ü" : "Avans";
            const typeColor = payment.paymentType === "salary" ? "var(--green)" : "var(--yellow)";
            const formattedAmount = new Intl.NumberFormat('tr-TR').format(payment.amount);
            
            return `
              <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:12px;font-size:13px;">${payment.paymentDate}</td>
                <td style="padding:12px;font-weight:900;font-size:13px;">${payment.personName}</td>
                <td style="padding:12px;"><span style="background:${typeColor};color:#07210f;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:900;">${typeText}</span></td>
                <td style="padding:12px;text-align:right;font-weight:900;font-size:14px;">${formattedAmount} ‚Ç∫</td>
                <td style="padding:12px;font-size:13px;color:var(--muted);">${payment.note || "-"}</td>
                <td style="padding:12px;text-align:center;">
                  <button onclick="deletePaymentRecord('${payment.id}')" style="background:var(--red);color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:900;cursor:pointer;">Sƒ∞L</button>
                </td>
              </tr>
            `;
          }).join('');
        }

        // √ñdeme kaydƒ± silme
        window.deletePaymentRecord = async function(paymentId) {
          if(!confirm('Bu √∂deme kaydƒ±nƒ± silmek istediƒüinizden emin misiniz?')) return;

          try {
            await deleteDoc(doc(paymentCol, paymentId));
            loadPaymentRecords(currentPaymentFilter, paymentSearchName?.value || "");
            alert('√ñdeme kaydƒ± silindi.');
          } catch(e) {
            alert('Hata: ' + e.message);
          }
        };

        // Filtre butonlarƒ±
        btnFilterAllPayments && (btnFilterAllPayments.onclick = () => {
          currentPaymentFilter = "all";
          displayPayments("all", paymentSearchName?.value || "");
        });

        btnFilterSalary && (btnFilterSalary.onclick = () => {
          currentPaymentFilter = "salary";
          displayPayments("salary", paymentSearchName?.value || "");
        });

        btnFilterAdvance && (btnFilterAdvance.onclick = () => {
          currentPaymentFilter = "advance";
          displayPayments("advance", paymentSearchName?.value || "");
        });

        // Arama kutusu
        paymentSearchName && paymentSearchName.addEventListener("input", (e) => {
          displayPayments(currentPaymentFilter, e.target.value);
        });

        // Sayfa y√ºklendiƒüinde personel ve √∂deme kayƒ±tlarƒ±nƒ± y√ºkle
        loadPersonnel();
        loadPaymentRecords();
        updatePaymentAlerts();
        
        // Her 5 dakikada bir √∂deme uyarƒ±larƒ±nƒ± g√ºncelle
        setInterval(updatePaymentAlerts, 5 * 60 * 1000);

        // ============================
        // CARƒ∞ HESAPLAR FONKSƒ∞YONLARI
        // ============================

        // ƒ∞≈ülem tipi deƒüi≈ütiƒüinde alanlarƒ± g√∂ster/gizle
        accountTransactionType && accountTransactionType.addEventListener("change", (e) => {
          if(e.target.value === "purchase") {
            purchaseFields.style.display = "block";
            paymentFields.style.display = "none";
          } else {
            purchaseFields.style.display = "none";
            paymentFields.style.display = "block";
          }
        });

        // Cari i≈ülem ekleme
        window.addAccountTransaction = async function() {
          try {
            const companyName = accountCompanyName.value.trim();
            const transactionType = accountTransactionType.value;
            const note = accountNote.value.trim();
            const now = new Date().toISOString();
            
            if(!companyName) {
              setStatusBox(statusAccount, "Firma adƒ± bo≈ü olamaz.", "error");
              return;
            }
            
            const transactionData = {
              companyName,
              transactionType,
              transactionDate: now,
              note,
              createdAt: now,
              createdBy: window.__SESSION?.pin || "admin"
            };
            
            if(transactionType === "purchase") {
              const itemName = accountItemName.value.trim();
              const quantity = accountItemQuantity.value.trim();
              const invoiceAmount = Number(accountInvoiceAmount.value);
              
              if(!itemName) {
                setStatusBox(statusAccount, "Mal adƒ± bo≈ü olamaz.", "error");
                return;
              }
              
              if(!quantity) {
                setStatusBox(statusAccount, "Adet bo≈ü olamaz.", "error");
                return;
              }
              
              if(!invoiceAmount || invoiceAmount <= 0) {
                setStatusBox(statusAccount, "Fatura tutarƒ± ge√ßersiz.", "error");
                return;
              }
              
              transactionData.itemName = itemName;
              transactionData.quantity = quantity;
              transactionData.invoiceAmount = invoiceAmount;
            } else {
              const paymentAmount = Number(accountPaymentAmount.value);
              
              if(!paymentAmount || paymentAmount <= 0) {
                setStatusBox(statusAccount, "√ñdeme tutarƒ± ge√ßersiz.", "error");
                return;
              }
              
              transactionData.paymentAmount = paymentAmount;
            }
            
            setStatusBox(statusAccount, "Kaydediliyor...", "");
            await addDoc(accountCol, transactionData);
            
            // Formu temizle
            accountCompanyName.value = "";
            accountTransactionType.value = "purchase";
            accountItemName.value = "";
            accountItemQuantity.value = "";
            accountInvoiceAmount.value = "";
            accountPaymentAmount.value = "";
            accountNote.value = "";
            purchaseFields.style.display = "block";
            paymentFields.style.display = "none";
            
            setStatusBox(statusAccount, "Cari i≈ülem kaydedildi.", "ok");
            loadAccountTransactions();
          } catch(e) {
            setStatusBox(statusAccount, "Hata: " + e.message, "error");
          }
        };
        
        // KAYDET butonuna event listener ekle
        btnAddAccountTransaction && (btnAddAccountTransaction.onclick = addAccountTransaction);

        // Cari i≈ülemleri y√ºkleme ve bakiye hesaplama
        async function loadAccountTransactions() {
          try {
            const snap = await getDocs(query(accountCol, orderBy("transactionDate", "desc")));
            const transactions = [];
            snap.forEach(doc => {
              transactions.push({ id: doc.id, ...doc.data() });
            });
            
            // Firma bazlƒ± bakiye hesaplama
            const companyBalances = {};
            transactions.forEach(t => {
              if(!companyBalances[t.companyName]) {
                companyBalances[t.companyName] = { purchases: 0, payments: 0 };
              }
              
              if(t.transactionType === "purchase") {
                companyBalances[t.companyName].purchases += t.invoiceAmount || 0;
              } else {
                companyBalances[t.companyName].payments += t.paymentAmount || 0;
              }
            });
            
            // Bakiyeleri g√∂ster
            companyBalancesBody.innerHTML = "";
            for(const [company, balance] of Object.entries(companyBalances)) {
              const totalDebt = balance.purchases - balance.payments;
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td style="padding:12px;border-bottom:1px solid var(--border);">${company}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;">${balance.purchases.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;">${balance.payments.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;color:${totalDebt > 0 ? 'red' : 'green'};">${totalDebt.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;">
                  <div style="display:flex;gap:4px;justify-content:center;">
                    <button onclick="editCompany('${company.replace(/'/g, "\\'")}')" style="background:#007bff;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:12px;font-weight:900;cursor:pointer;">D√úZENLE</button>
                    <button onclick="deleteCompany('${company.replace(/'/g, "\\'")}')" style="background:#dc3545;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:12px;font-weight:900;cursor:pointer;">Sƒ∞L</button>
                  </div>
                </td>
              `;
              companyBalancesBody.appendChild(tr);
            }
            
            // T√ºm i≈ülemleri g√∂ster
            displayAccountTransactions(transactions, "all", "");
            
            // Autocomplete i√ßin firma listesi
            const companyList = document.getElementById("companyList");
            companyList.innerHTML = "";
            Object.keys(companyBalances).forEach(company => {
              const option = document.createElement("option");
              option.value = company;
              companyList.appendChild(option);
            });
            
          } catch(e) {
            console.error("Cari i≈ülemler y√ºklenemedi:", e);
          }
        }

        // ƒ∞≈ülemleri filtreleme ve g√∂r√ºnt√ºleme
        function displayAccountTransactions(transactions, filterType, searchText) {
          accountListBody.innerHTML = "";
          
          const filtered = transactions.filter(t => {
            const matchesType = filterType === "all" || t.transactionType === filterType;
            const matchesSearch = !searchText || t.companyName.toLowerCase().includes(searchText.toLowerCase());
            return matchesType && matchesSearch;
          });
          
          filtered.forEach(t => {
            const tr = document.createElement("tr");
            const typeText = t.transactionType === "purchase" ? "MAL ALIMI" : "√ñDEME";
            const amount = t.transactionType === "purchase" 
              ? `${(t.invoiceAmount || 0).toLocaleString('tr-TR')} ‚Ç∫`
              : `${(t.paymentAmount || 0).toLocaleString('tr-TR')} ‚Ç∫`;
            const details = t.transactionType === "purchase"
              ? `${t.itemName || ""} (${t.quantity || ""})`
              : "";
            
            tr.innerHTML = `
              <td style="padding:12px;border-bottom:1px solid var(--border);">${new Date(t.transactionDate).toLocaleDateString('tr-TR')}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);">${t.companyName}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);">${typeText}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);">${details}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;">${amount}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);">${t.note || ""}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;"><button onclick="deleteAccountTransaction('${t.id}')" style="padding:6px 12px;background:red;color:white;border:none;border-radius:4px;cursor:pointer;">Sil</button></td>
            `;
            accountListBody.appendChild(tr);
          });
        }

        // Cari i≈ülem silme
        window.deleteAccountTransaction = async function(docId) {
          if(!confirm("Bu i≈ülemi silmek istediƒüinizden emin misiniz?")) return;
          
          try {
            await deleteDoc(doc(db, "accountTransactions", docId));
            setStatusBox(statusAccount, "ƒ∞≈ülem silindi.", "ok");
            loadAccountTransactions();
          } catch(e) {
            alert("Hata: " + e.message);
          }
        };

        // Filtre butonlarƒ±
        let currentAccountFilter = "all";
        
        btnFilterAllTransactions && (btnFilterAllTransactions.onclick = async () => {
          currentAccountFilter = "all";
          const snap = await getDocs(query(accountCol, orderBy("transactionDate", "desc")));
          const transactions = [];
          snap.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
          displayAccountTransactions(transactions, "all", accountSearchCompany?.value || "");
        });

        btnFilterPurchases && (btnFilterPurchases.onclick = async () => {
          currentAccountFilter = "purchase";
          const snap = await getDocs(query(accountCol, orderBy("transactionDate", "desc")));
          const transactions = [];
          snap.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
          displayAccountTransactions(transactions, "purchase", accountSearchCompany?.value || "");
        });

        btnFilterPayments && (btnFilterPayments.onclick = async () => {
          currentAccountFilter = "payment";
          const snap = await getDocs(query(accountCol, orderBy("transactionDate", "desc")));
          const transactions = [];
          snap.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
          displayAccountTransactions(transactions, "payment", accountSearchCompany?.value || "");
        });

        // Arama kutusu
        accountSearchCompany && accountSearchCompany.addEventListener("input", async (e) => {
          const snap = await getDocs(query(accountCol, orderBy("transactionDate", "desc")));
          const transactions = [];
          snap.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
          displayAccountTransactions(transactions, currentAccountFilter, e.target.value);
        });

        // Firma adƒ±nƒ± d√ºzenle
        window.editCompany = function(companyName) {
          editCompanyOldName.value = companyName;
          editCompanyNewName.value = companyName;
          editCompanySection.style.display = "block";
          editCompanySection.scrollIntoView({ behavior: 'smooth' });
        };

        // Firma adƒ± g√ºncelleme
        btnUpdateCompany && (btnUpdateCompany.onclick = async function() {
          try {
            const oldName = editCompanyOldName.value;
            const newName = editCompanyNewName.value.trim();

            if(!newName) {
              setStatusBox(statusEditCompany, "Firma adƒ± bo≈ü olamaz.", "error");
              return;
            }

            if(oldName === newName) {
              setStatusBox(statusEditCompany, "Yeni firma adƒ± eskisiyle aynƒ±.", "error");
              return;
            }

            setStatusBox(statusEditCompany, "G√ºncelleniyor...", "info");

            // Bu firmaya ait t√ºm i≈ülemleri bul ve g√ºncelle
            const snap = await getDocs(query(accountCol, where("companyName", "==", oldName)));
            const batch = writeBatch(db);

            snap.docs.forEach(docSnap => {
              batch.update(docSnap.ref, { companyName: newName });
            });

            await batch.commit();

            setStatusBox(statusEditCompany, "Firma adƒ± g√ºncellendi.", "ok");
            editCompanySection.style.display = "none";
            loadAccountTransactions();
          } catch(e) {
            console.error('Firma g√ºncelleme hatasƒ±:', e);
            setStatusBox(statusEditCompany, "Hata: " + e.message, "error");
          }
        });

        // D√ºzenleme iptali
        btnCancelCompanyEdit && (btnCancelCompanyEdit.onclick = function() {
          editCompanySection.style.display = "none";
        });

        // Firmayƒ± ve t√ºm i≈ülemlerini sil
        window.deleteCompany = async function(companyName) {
          if(!confirm(`${companyName} firmasƒ±nƒ± ve bu firmaya ait T√úM i≈ülemleri silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz!`)) return;

          try {
            const snap = await getDocs(query(accountCol, where("companyName", "==", companyName)));
            const batch = writeBatch(db);

            snap.docs.forEach(docSnap => {
              batch.delete(docSnap.ref);
            });

            await batch.commit();

            alert(`${companyName} firmasƒ± ve ${snap.docs.length} i≈ülem silindi.`);
            loadAccountTransactions();
          } catch(e) {
            alert('Hata: ' + e.message);
          }
        };

        // Sayfa y√ºklendiƒüinde cari i≈ülemleri y√ºkle
        loadAccountTransactions();

        // ============================
        // KOMƒ∞SYONLU SATI≈ûLAR FONKSƒ∞YONLARI
        // ============================

        // Komisyon i≈ülemi ekleme
        window.addCommissionTransaction = async function() {
          try {
            console.log("addCommissionTransaction called");
            const transactionType = commissionTransactionType.value;
            const amount = Number(commissionAmount.value);
            const note = commissionNote.value.trim();
            const sellerPin = window.__SESSION?.pin;
            const sellerName = PIN_NAMES[sellerPin] || "Bilinmeyen Satƒ±cƒ±";
            
            console.log("Commission data:", { transactionType, amount, note, sellerPin, sellerName });
            
            if(!amount || amount <= 0) {
              setStatusBox(statusCommission, "Tutar ge√ßersiz.", "error");
              console.error("Invalid amount:", amount);
              return;
            }
            
            setStatusBox(statusCommission, "Kaydediliyor...", "");
            
            console.log("Attempting to save to commissionCol...");
            await addDoc(commissionCol, {
              sellerPin,
              sellerName,
              transactionType,
              amount,
              note,
              createdAt: new Date().toISOString()
            });
            
            console.log("Document saved successfully");
            
            // Formu temizle
            commissionTransactionType.value = "income";
            commissionAmount.value = "";
            commissionNote.value = "";
            
            setStatusBox(statusCommission, "ƒ∞≈ülem kaydedildi.", "ok");
            loadMyCommissions();
          } catch(e) {
            console.error("addCommissionTransaction error:", e);
            setStatusBox(statusCommission, "Hata: " + e.message, "error");
          }
        };
        
        // KAYDET butonuna event listener ekle
        btnAddCommission && (btnAddCommission.onclick = addCommissionTransaction);

        // Satƒ±cƒ±nƒ±n kendi i≈ülemlerini y√ºkleme
        async function loadMyCommissions() {
          try {
            const sellerPin = window.__SESSION?.pin;
            console.log("Loading commissions for PIN:", sellerPin);
            
            // orderBy kaldƒ±rƒ±ldƒ± - Firebase index gerektirebilir
            const snap = await getDocs(query(commissionCol, where("sellerPin", "==", sellerPin)));
            
            console.log("Found documents:", snap.size);
            
            let totalIncome = 0;
            let totalExpense = 0;
            const transactions = [];
            
            snap.forEach(docSnap => {
              const data = docSnap.data();
              console.log("Transaction data:", data);
              transactions.push({ id: docSnap.id, ...data });
              
              if(data.transactionType === "income") {
                totalIncome += data.amount || 0;
              } else {
                totalExpense += data.amount || 0;
              }
            });
            
            // Tarihe g√∂re sƒ±rala (client-side)
            transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Satƒ±cƒ± payƒ± sadece gelirden hesaplanƒ±r (gider satƒ±cƒ±yƒ± etkilemez)
            const sellerShare = totalIncome * 0.20;
            const companyGrossShare = totalIncome * 0.80;
            const companyNetShare = companyGrossShare - totalExpense;
            
            myTotalIncome.textContent = totalIncome.toLocaleString('tr-TR') + " ‚Ç∫";
            myTotalExpense.textContent = totalExpense.toLocaleString('tr-TR') + " ‚Ç∫ (≈ûirket √ústlenir)";
            myNetAmount.textContent = sellerShare.toLocaleString('tr-TR') + " ‚Ç∫";
            myCommission.textContent = sellerShare.toLocaleString('tr-TR') + " ‚Ç∫";
            
            console.log("Calling displayMyCommissions with", transactions.length, "transactions");
            displayMyCommissions(transactions, "all");
            loadMyPayments(); // Tahsilatlarƒ± y√ºkle
            
          } catch(e) {
            console.error("Komisyon i≈ülemleri y√ºklenemedi:", e);
            setStatusBox(statusCommission, "Y√ºkleme hatasƒ±: " + e.message, "error");
          }
        }

        // ƒ∞≈ülemleri g√∂r√ºnt√ºleme
        function displayMyCommissions(transactions, filter) {
          commissionListBody.innerHTML = "";
          
          const filtered = transactions.filter(t => {
            if(filter === "all") return true;
            return t.transactionType === filter;
          });
          
          filtered.forEach(t => {
            const tr = document.createElement("tr");
            const typeText = t.transactionType === "income" ? "GELƒ∞R" : "Gƒ∞DER";
            const typeColor = t.transactionType === "income" ? "green" : "red";
            const date = new Date(t.createdAt).toLocaleDateString('tr-TR');
            
            tr.innerHTML = `
              <td style="padding:12px;border-bottom:1px solid var(--border);">${date}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);color:${typeColor};font-weight:bold;">${typeText}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;">${t.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);">${t.note || ""}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;">
                <button onclick="deleteCommissionTransaction('${t.id}')" style="padding:6px 12px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:700;">Sƒ∞L</button>
              </td>
            `;
            commissionListBody.appendChild(tr);
          });
        }

        // Komisyon i≈ülemi silme
        window.deleteCommissionTransaction = async function(docId) {
          if(!confirm("Bu i≈ülemi silmek istediƒüinizden emin misiniz?")) return;
          
          try {
            await deleteDoc(doc(db, "commissionSales", docId));
            setStatusBox(statusCommission, "ƒ∞≈ülem silindi.", "ok");
            loadMyCommissions();
          } catch(e) {
            alert("Hata: " + e.message);
          }
        };

        // Filtre butonlarƒ±
        let allCommissionTransactions = [];

        btnFilterAllCommission && (btnFilterAllCommission.onclick = async () => {
          const sellerPin = window.__SESSION?.pin;
          const snap = await getDocs(query(commissionCol, where("sellerPin", "==", sellerPin)));
          const transactions = [];
          snap.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
          transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          displayMyCommissions(transactions, "all");
        });

        btnFilterIncome && (btnFilterIncome.onclick = async () => {
          const sellerPin = window.__SESSION?.pin;
          const snap = await getDocs(query(commissionCol, where("sellerPin", "==", sellerPin)));
          const transactions = [];
          snap.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
          transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          displayMyCommissions(transactions, "income");
        });

        btnFilterExpense && (btnFilterExpense.onclick = async () => {
          const sellerPin = window.__SESSION?.pin;
          const snap = await getDocs(query(commissionCol, where("sellerPin", "==", sellerPin)));
          const transactions = [];
          snap.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
          transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          displayMyCommissions(transactions, "expense");
        });

        // Admin i√ßin t√ºm satƒ±cƒ±larƒ±n √∂zetini y√ºkleme
        async function loadCommissionSummary() {
          try {
            console.log("üîÑ loadCommissionSummary √ßaƒürƒ±ldƒ±");
            const snap = await getDocs(commissionCol);
            const collectionSnap = await getDocs(collectionCol);
            
            const sellerData = {};
            let totalCompanyShare = 0;
            let totalCollections = 0;
            
            // Komisyon i≈ülemlerini topla
            snap.forEach(doc => {
              const data = doc.data();
              if(!sellerData[data.sellerPin]) {
                sellerData[data.sellerPin] = {
                  name: data.sellerName,
                  income: 0,
                  expense: 0,
                  collections: 0
                };
              }
              
              if(data.transactionType === "income") {
                sellerData[data.sellerPin].income += data.amount || 0;
              } else {
                sellerData[data.sellerPin].expense += data.amount || 0;
              }
            });
            
            // Tahsilatlarƒ± topla
            collectionSnap.forEach(doc => {
              const data = doc.data();
              if(sellerData[data.sellerPin]) {
                sellerData[data.sellerPin].collections += data.amount || 0;
              }
            });
            
            // Satƒ±cƒ± se√ßim listesini g√ºncelle
            if(collectionSellerPin) {
              collectionSellerPin.innerHTML = "<option value=''>Satƒ±cƒ± Se√ßin</option>";
              for(const [pin, data] of Object.entries(sellerData)) {
                const option = document.createElement("option");
                option.value = pin;
                option.textContent = data.name;
                collectionSellerPin.appendChild(option);
              }
            }
            
            commissionSummaryBody.innerHTML = "";
            
            if(Object.keys(sellerData).length === 0) {
              commissionSummaryBody.innerHTML = "<tr><td colspan='7' style='padding:24px;text-align:center;color:var(--muted);'>Hen√ºz komisyon verisi yok.</td></tr>";
              return;
            }
            
            for(const [pin, data] of Object.entries(sellerData)) {
              // Satƒ±cƒ± payƒ± = Gelir * %20 (giderden etkilenmez)
              // ≈ûirket br√ºt payƒ± = Gelir * %80
              // ≈ûirket net payƒ± = Br√ºt pay - Gider - Tahsilat
              const sellerShare = data.income * 0.20;
              const companyGrossShare = data.income * 0.80;
              const companyNetBeforeCollection = companyGrossShare - data.expense;
              const companyFinalShare = companyNetBeforeCollection - data.collections;
              totalCompanyShare += companyFinalShare;
              totalCollections += data.collections;
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td style="padding:12px;border-bottom:1px solid var(--border);">${data.name}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;">${data.income.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;">${data.expense.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;">${companyGrossShare.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;color:green;font-weight:bold;">${sellerShare.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;">
                  <div style="color:blue;font-weight:bold;">${companyNetBeforeCollection.toLocaleString('tr-TR')} ‚Ç∫</div>
                  ${data.collections > 0 ? `<div style="color:red;font-size:12px;margin-top:4px;">- ${data.collections.toLocaleString('tr-TR')} ‚Ç∫ (tahsilat)</div>` : ''}
                  ${data.collections > 0 ? `<div style="color:#0d47a1;font-size:13px;margin-top:2px;font-weight:bold;">${companyFinalShare.toLocaleString('tr-TR')} ‚Ç∫ (kalan)</div>` : ''}
                </td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;">
                  <button onclick="showSellerDetail('${pin}')" style="padding:8px 14px;background:#007bff;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:700;">DETAY</button>
                </td>
              `;
              commissionSummaryBody.appendChild(tr);
            }
            
            // Toplam ≈üirket hak edi≈üi satƒ±rƒ±
            const totalTr = document.createElement("tr");
            totalTr.style.background = "#e3f2fd";
            totalTr.style.fontWeight = "bold";
            totalTr.innerHTML = `
              <td colspan="5" style="padding:16px;text-align:right;font-size:16px;">
                <div>TOPLAM ≈ûƒ∞RKET HAK EDƒ∞≈ûƒ∞</div>
                ${totalCollections > 0 ? `<div style="color:red;font-size:14px;margin-top:4px;">- ${totalCollections.toLocaleString('tr-TR')} ‚Ç∫ (tahsilatlar)</div>` : ''}
              </td>
              <td style="padding:16px;text-align:right;color:#0d47a1;font-size:18px;font-weight:900;">${totalCompanyShare.toLocaleString('tr-TR')} ‚Ç∫</td>
              <td></td>
            `;
            commissionSummaryBody.appendChild(totalTr);
            
            console.log("‚úÖ Komisyon √∂zeti y√ºklendi");
            
          } catch(e) {
            console.error("‚ùå Komisyon √∂zeti y√ºklenemedi:", e);
            commissionSummaryBody.innerHTML = `<tr><td colspan='7' style='padding:24px;text-align:center;color:red;'>Hata: ${e.message}</td></tr>`;
          }
        }

        // Satƒ±cƒ± detaylarƒ±nƒ± g√∂ster
        window.showSellerDetail = async function(sellerPin) {
          try {
            console.log('üìã Satƒ±cƒ± detayƒ± y√ºkleniyor, PIN:', sellerPin);
            const snap = await getDocs(query(commissionCol, where("sellerPin", "==", sellerPin)));
            
            let totalIncome = 0;
            let totalExpense = 0;
            const transactions = [];
            
            snap.forEach(doc => {
              const data = doc.data();
              transactions.push({ id: doc.id, ...data });
              
              if(data.transactionType === "income") {
                totalIncome += data.amount || 0;
              } else {
                totalExpense += data.amount || 0;
              }
            });
            
            // Satƒ±cƒ± payƒ± = Gelir * %20
            // ≈ûirket br√ºt payƒ± = Gelir * %80
            // ≈ûirket net payƒ± = Br√ºt pay - Gider
            const sellerShare = totalIncome * 0.20;
            const companyGrossShare = totalIncome * 0.80;
            const companyNetShare = companyGrossShare - totalExpense;
            const sellerName = transactions.length > 0 ? transactions[0].sellerName : "Satƒ±cƒ±";
            
            console.log('üí∞ Gelir:', totalIncome, 'Gider:', totalExpense, '≈ûirket Net:', companyNetShare);
            
            sellerDetailTitle.textContent = sellerName + " - Detaylarƒ±";
            detailIncome.textContent = totalIncome.toLocaleString('tr-TR') + " ‚Ç∫";
            detailExpense.textContent = totalExpense.toLocaleString('tr-TR') + " ‚Ç∫ (≈ûirket √ústlenir)";
            detailNet.textContent = companyGrossShare.toLocaleString('tr-TR') + " ‚Ç∫ (Br√ºt)";
            detailCompanyShare.textContent = companyNetShare.toLocaleString('tr-TR') + " ‚Ç∫ (Net)";
            
            detailTransactionsBody.innerHTML = "";
            
            if(transactions.length === 0) {
              detailTransactionsBody.innerHTML = "<tr><td colspan='5' style='padding:24px;text-align:center;color:var(--muted);'>ƒ∞≈ülem bulunamadƒ±.</td></tr>";
            } else {
              transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
              
              transactions.forEach(t => {
                const tr = document.createElement("tr");
                const typeText = t.transactionType === "income" ? "GELƒ∞R" : "Gƒ∞DER";
                const typeColor = t.transactionType === "income" ? "green" : "red";
                const date = new Date(t.createdAt).toLocaleDateString('tr-TR');
                
                tr.innerHTML = `
                  <td style="padding:12px;border-bottom:1px solid var(--border);">${date}</td>
                  <td style="padding:12px;border-bottom:1px solid var(--border);color:${typeColor};font-weight:bold;">${typeText}</td>
                  <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;">${t.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                  <td style="padding:12px;border-bottom:1px solid var(--border);">${t.note || ""}</td>
                  <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;">
                    <button onclick="deleteCommissionFromDetail('${t.id}', '${sellerPin}')" style="padding:6px 12px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:700;">Sƒ∞L</button>
                  </td>
                `;
                detailTransactionsBody.appendChild(tr);
              });
            }
            
            sellerDetailSection.style.display = "block";
            sellerDetailSection.scrollIntoView({ behavior: 'smooth' });
            console.log('‚úÖ Detay paneli g√∂sterildi');
            
          } catch(e) {
            console.error("‚ùå Satƒ±cƒ± detaylarƒ± hatasƒ±:", e);
            alert("Satƒ±cƒ± detaylarƒ± y√ºklenemedi: " + e.message);
          }
        };

        // Satƒ±cƒ± detay panelini kapat
        window.hideSellerDetail = function() {
          sellerDetailSection.style.display = "none";
        };

        // Tahsilat ekleme
        window.addCollection = async function() {
          try {
            const sellerPin = collectionSellerPin.value;
            const amount = Number(collectionAmount.value);
            const note = collectionNote.value.trim();
            
            if(!sellerPin) {
              setStatusBox(statusCollection, "Satƒ±cƒ± se√ßin.", "error");
              return;
            }
            
            if(!amount || amount <= 0) {
              setStatusBox(statusCollection, "Tutar ge√ßersiz.", "error");
              return;
            }
            
            setStatusBox(statusCollection, "Kaydediliyor...", "");
            
            // Satƒ±cƒ± adƒ±nƒ± bul
            const sellerName = collectionSellerPin.options[collectionSellerPin.selectedIndex].text;
            
            await addDoc(collectionCol, {
              sellerPin,
              sellerName,
              amount,
              note,
              createdAt: new Date().toISOString(),
              createdBy: window.__SESSION?.pin || "admin"
            });
            
            // Formu temizle
            collectionSellerPin.value = "";
            collectionAmount.value = "";
            collectionNote.value = "";
            
            setStatusBox(statusCollection, "Tahsilat kaydedildi.", "ok");
            loadCommissionSummary();
            loadPaymentsHistory(); // Tahsilat ge√ßmi≈üini g√ºncelle
          } catch(e) {
            setStatusBox(statusCollection, "Hata: " + e.message, "error");
          }
        };
        
        btnAddCollection && (btnAddCollection.onclick = addCollection);

        // Tahsilat ge√ßmi≈üini y√ºkleme
        async function loadPaymentsHistory() {
          try {
            const snap = await getDocs(query(collectionCol, orderBy("createdAt", "desc")));
            paymentsHistoryBody.innerHTML = "";
            
            if(snap.empty) {
              paymentsHistoryBody.innerHTML = "<tr><td colspan='5' style='padding:24px;text-align:center;color:var(--muted);'>Hen√ºz tahsilat kaydƒ± yok.</td></tr>";
              return;
            }
            
            snap.forEach(doc => {
              const data = doc.data();
              const date = new Date(data.createdAt).toLocaleDateString('tr-TR');
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td style="padding:12px;border-bottom:1px solid var(--border);">${date}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);">${data.sellerName}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;color:#28a745;">${data.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);">${data.note || ""}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;">
                  <button onclick="deletePayment('${doc.id}')" style="padding:6px 12px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:700;">Sƒ∞L</button>
                </td>
              `;
              paymentsHistoryBody.appendChild(tr);
            });
          } catch(e) {
            console.error("Tahsilat ge√ßmi≈üi y√ºklenemedi:", e);
            paymentsHistoryBody.innerHTML = `<tr><td colspan='5' style='padding:24px;text-align:center;color:red;'>Hata: ${e.message}</td></tr>`;
          }
        }

        // Tahsilat kaydƒ±nƒ± silme
        window.deletePayment = async function(docId) {
          if(!confirm("Bu tahsilat kaydƒ±nƒ± silmek istediƒüinizden emin misiniz?")) return;
          
          try {
            await deleteDoc(doc(db, "sellerCollections", docId));
            alert("Tahsilat kaydƒ± silindi.");
            loadPaymentsHistory();
            loadCommissionSummary(); // √ñzeti de g√ºncelle
          } catch(e) {
            alert("Hata: " + e.message);
          }
        };

        // Komisyonlu satƒ±cƒ±nƒ±n kendi tahsilatlarƒ±nƒ± y√ºkleme
        async function loadMyPayments() {
          try {
            const sellerPin = window.__SESSION?.pin;
            const snap = await getDocs(query(collectionCol, where("sellerPin", "==", sellerPin), orderBy("createdAt", "desc")));
            
            myPaymentsBody.innerHTML = "";
            
            if(snap.empty) {
              myPaymentsBody.innerHTML = "<tr><td colspan='3' style='padding:24px;text-align:center;color:var(--muted);'>Hen√ºz tahsilat kaydƒ± yok.</td></tr>";
              return;
            }
            
            snap.forEach(doc => {
              const data = doc.data();
              const date = new Date(data.createdAt).toLocaleDateString('tr-TR');
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td style="padding:12px;border-bottom:1px solid var(--border);">${date}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;color:#28a745;">${data.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);">${data.note || ""}</td>
              `;
              myPaymentsBody.appendChild(tr);
            });
          } catch(e) {
            console.error("Tahsilat ge√ßmi≈üi y√ºklenemedi:", e);
            myPaymentsBody.innerHTML = `<tr><td colspan='3' style='padding:24px;text-align:center;color:red;'>Hata: ${e.message}</td></tr>`;
          }
        }

        // Detaydan komisyon i≈ülemi silme
        window.deleteCommissionFromDetail = async function(docId, sellerPin) {
          if(!confirm("Bu i≈ülemi silmek istediƒüinizden emin misiniz?")) return;
          
          try {
            await deleteDoc(doc(db, "commissionSales", docId));
            alert("ƒ∞≈ülem silindi.");
            showSellerDetail(sellerPin); // Detayƒ± yeniden y√ºkle
            loadCommissionSummary(); // √ñzeti g√ºncelle
          } catch(e) {
            alert("Hata: " + e.message);
          }
        };

        // Sayfa y√ºklendiƒüinde komisyon verilerini y√ºkle
        const currentRole = window.__SESSION?.role;
        if(currentRole === "commission") {
          loadMyCommissions();
        } else if(currentRole === "admin") {
          loadCommissionSummary();
          loadPaymentsHistory();
        }

        setStatusBox(statusReqList, "Y√ºkleniyor...", "");
      }catch(e){
        setStatusBox(statusPut, "Firebase y√ºklenemedi: " + e.message, "error");
        setStatusBox(statusClear, "Firebase y√ºklenemedi: " + e.message, "error");
        setStatusBox(statusSearch, "Firebase y√ºklenemedi: " + e.message, "error");
        setStatusBox(statusReq, "Firebase y√ºklenemedi: " + e.message, "error");
        setStatusBox(statusReqList, "Firebase y√ºklenemedi: " + e.message, "error");
        setStatusBox(statusLogs, "Firebase y√ºklenemedi: " + e.message, "error");
      }
    };
  </script>

</body>
</html>
