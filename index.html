<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GABYA">
  <link rel="manifest" href="/manifest.json">
  <title>GABYA HOME</title>

  <style>
    *{box-sizing:border-box}
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel2:#f9fafb;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;
      --green:#00c853;
      --green2:#00b84c;
      --danger:#ef4444;
      --danger2:#dc2626;
      --input:#ffffff;
      --shadow:0 18px 50px rgba(2,6,23,.12);
      --shadow2:0 10px 30px rgba(2,6,23,.10);
      --amber:#f59e0b;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* LOGIN */
    .center{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .loginCard{
      width:min(520px,96vw);
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:28px;
    }
    .title{
      text-align:center;
      font-weight:900;
      font-size:42px;
      letter-spacing:.5px;
      margin:0 0 8px;
      color:var(--text);
    }
    .subtitle{
      text-align:center;
      font-weight:900;
      font-size:22px;
      margin:0 0 18px;
      color:var(--text);
    }

    .fieldLabel{
      font-weight:900;
      letter-spacing:.8px;
      color:var(--muted);
      margin:0 0 6px;
      text-transform:uppercase;
      font-size:18px;
    }
    .input{
      width:100%;
      padding:14px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--input);
      color:var(--text);
      font-size:18px;
      outline:none;
      box-shadow:0 1px 0 rgba(2,6,23,.03) inset;
    }
    .input:focus{
      border-color:rgba(0,200,83,.55);
      box-shadow:0 0 0 3px rgba(0,200,83,.15);
    }
    select.input{
      cursor:pointer;
      padding-right:30px;
      position:relative;
    }
    .subBox{
      position:relative;
      overflow:visible !important;
    }

    .product-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }
    .product-item{
      width:100%;
      padding:10px 16px;
      border:2px solid var(--border);
      border-radius:10px;
      background:var(--panel);
      cursor:pointer;
      font-weight:800;
      font-size:16px;
      color:var(--text);
      transition:all 0.2s ease;
      user-select:none;
    }
    .product-item:hover{
      border-color:rgba(0,200,83,.4);
      background:rgba(0,200,83,.05);
    }
    .product-item.selected{
      border-color:rgba(0,200,83,.7);
      background:rgba(0,200,83,.15);
      color:#065f46;
      font-weight:900;
    }

    .btn{
      width:100%;
      padding:16px 16px;
      border:0;
      border-radius:12px;
      background:var(--green);
      color:#07210f;
      font-weight:900;
      letter-spacing:1px;
      font-size:22px;
      cursor:pointer;
      margin-top:14px;
      box-shadow:0 10px 20px rgba(0,200,83,.18);
    }
    .btn:hover{ background:var(--green2); }
    .btn:active{ transform:translateY(1px); }

    .note{
      margin-top:14px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      color:var(--muted);
      font-weight:800;
      font-size:16px;
      text-align:center;
    }
    .note.error{
      background:rgba(239,68,68,.08);
      border-color:rgba(239,68,68,.25);
      color:#7f1d1d;
    }
    .note.ok{
      background:rgba(0,200,83,.10);
      border-color:rgba(0,200,83,.22);
      color:#065f46;
    }
    .note.warn{
      background:rgba(245,158,11,.12);
      border-color:rgba(245,158,11,.25);
      color:#7c2d12;
    }

    /* APP */
    .appWrap{ padding:18px; display:none; }
    .appPanel{
      width:min(1200px,98vw);
      margin:0 auto;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .appHeader{
      text-align:center;
      font-weight:1000;
      font-size:44px;
      letter-spacing:.5px;
      padding:22px 14px 8px;
      margin:0;
      color:var(--text);
    }
    .roleLine{
      text-align:center;
      margin:0 0 12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.6px;
    }

    .tabbar{
      display:flex;
      gap:0;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin; /* Firefox: show thin scrollbar */
      scrollbar-color: rgba(0,0,0,.12) transparent;
      -ms-overflow-style: auto; /* IE 10+ */
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      background:var(--panel2);
      scroll-behavior: smooth;
    }
    .tabbar::-webkit-scrollbar{ height:6px; }
    .tabbar::-webkit-scrollbar-track{ background: transparent; }
    .tabbar::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.12); border-radius:4px; }
    @media (max-width: 900px){
      .tabbar{ /* keep horizontal scroll on small screens */ }
      .tabbar .logoutBtn{ margin-left:auto; }
    }
    .tab{
      flex:1;
      padding:12px 8px;
      text-align:center;
      font-weight:600;
      letter-spacing:0.3px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      font-size:13px;
      border-right:1px solid transparent;
      transition:all 0.2s ease;
    }
    .tab:last-child{ border-right:0; }
    .tab.active{
      background:rgba(0,200,83,.06);
      color:#064e3b;
      box-shadow: inset 0 -2px 0 rgba(0,200,83,.4);
    }
    #logoutBtn:hover{
      background:rgba(239,68,68,.08);
    }
    #logoutBtn:hover svg{
      color:var(--danger);
    }

    /* Gruplandƒ±rƒ±lmƒ±≈ü Tabbar */
    .tabbar-grouped{
      display:flex;
      gap:8px;
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      background:var(--panel2);
      padding:8px 12px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: rgba(0,0,0,.12) transparent;
    }
    .tabbar-grouped::-webkit-scrollbar{ height:6px; }
    .tabbar-grouped::-webkit-scrollbar-track{ background: transparent; }
    .tabbar-grouped::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.12); border-radius:4px; }
    .tab-group{
      position:relative;
      flex:1;
      min-width:200px;
    }
    .tab-group-header{
      display:flex;
      align-items:center;
      gap:6px;
      padding:10px 16px;
      background:rgba(0,200,83,.08);
      border:1px solid rgba(0,200,83,.2);
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
      width:100%;
      color:#064e3b;
      transition:all 0.2s ease;
      user-select:none;
    }
    .tab-group-header:hover{
      background:rgba(0,200,83,.15);
      border-color:rgba(0,200,83,.35);
    }
    .tab-group-header.open{
      background:rgba(0,200,83,.2);
      border-bottom-left-radius:0;
      border-bottom-right-radius:0;
    }
    .tab-group-header .dropdown-icon{
      transition:transform 0.2s ease;
      stroke:currentColor;
      fill:none;
      stroke-width:2;
    }
    .tab-group-header.open .dropdown-icon{
      transform:rotate(180deg);
    }
    .tab-group-content{
      display:none;
      position:fixed;
      min-width:220px;
      width:max-content;
      max-width:calc(100vw - 32px);
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:8px;
      box-shadow:0 6px 20px rgba(0,0,0,.15);
      z-index:10001;
      padding:4px;
    }
    .tab-group-content.open{
      display:block;
    }
    .tab-sub{
      padding:10px 14px;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      color:var(--text);
      border-radius:6px;
      transition:all 0.15s ease;
      white-space:nowrap;
    }
    .tab-sub:hover{
      background:rgba(0,200,83,.08);
      color:#064e3b;
    }
    .tab-sub.active{
      background:rgba(0,200,83,.15);
      color:#064e3b;
      font-weight:800;
    }

    .content{ padding:18px; background:var(--bg); }
    .sectionTitle{
      text-align:center;
      font-weight:1000;
      font-size:26px;
      margin:8px 0 14px;
      color:var(--text);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      padding-bottom:200px;
      box-shadow:var(--shadow2);
      height:100%;
      min-height:600px;
      overflow:visible;
    }
    .card h3{
      margin:0 0 12px;
      text-align:center;
      font-weight:1000;
      font-size:22px;
      color:var(--text);
    }

    .actionBtn{
      width:100%;
      padding:16px 14px;
      border:0;
      border-radius:14px;
      background:var(--green);
      color:#07210f;
      font-weight:1000;
      letter-spacing:1px;
      font-size:20px;
      cursor:pointer;
      margin-top:10px;
      box-shadow:0 10px 18px rgba(0,200,83,.14);
    }
    .actionBtn:hover{ background:var(--green2); }
    .actionBtn.red{
      background:var(--danger);
      color:#1b0707;
      box-shadow:0 10px 18px rgba(239,68,68,.14);
    }
    .actionBtn.red:hover{ background:var(--danger2); }

    .statusBox{
      margin-top:12px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      font-size:16px;
      font-weight:900;
      color:var(--muted);
      min-height:56px;
      display:flex;
      align-items:center;
    }
    .statusBox.ok{
      background:rgba(0,200,83,.10);
      border-color:rgba(0,200,83,.22);
      color:#065f46;
    }
    .statusBox.error{
      background:rgba(239,68,68,.08);
      border-color:rgba(239,68,68,.22);
      color:#7f1d1d;
    }
    .statusBox.warn{
      background:rgba(245,158,11,.12);
      border-color:rgba(245,158,11,.25);
      color:#7c2d12;
    }

    .searchRow{
      display:grid;
      grid-template-columns: 1fr 180px;
      gap:12px;
    }
    @media (max-width: 720px){
      .searchRow{ grid-template-columns: 1fr; }
    }
    .searchBtn{
      width:100%;
      padding:14px 14px;
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--panel2);
      color:var(--text);
      font-weight:1000;
      font-size:18px;
      cursor:pointer;
    }
    .searchBtn:hover{ background:#eef2f7; }

    .hintLine{
      text-align:center;
      margin-top:8px;
      color:var(--muted);
      font-weight:800;
      word-break:break-word;
      font-size:14px;
    }

    .subBox{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--panel2);
      display:none;
      overflow:visible;
    }
    .subTitle{
      font-weight:1000;
      margin:0 0 10px;
      text-align:center;
      color:var(--text);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:12px;
      font-size:15px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
    }
    th, td{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
      color:var(--text);
    }
    th{
      background:var(--panel2);
      font-weight:1000;
      letter-spacing:.6px;
      color:var(--muted);
      text-transform:uppercase;
      font-size:12px;
    }
    tr:last-child td{ border-bottom:0; }

    .tableWrap{
      max-height:460px;
      overflow:auto;
      border-radius:14px;
      margin-top:10px;
    }

    .badge{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      line-height:22px;
      border:1px solid transparent;
    }
    .b-admin{ background:rgba(2,6,23,.06); color:#0f172a; border-color:rgba(2,6,23,.10); }
    .b-packer{ background:rgba(245,158,11,.14); color:#7c2d12; border-color:rgba(245,158,11,.22); }
    .b-stower{ background:rgba(59,130,246,.12); color:#1e3a8a; border-color:rgba(59,130,246,.18); }
    .b-welder{ background:rgba(139,92,246,.12); color:#5b21b6; border-color:rgba(139,92,246,.20); }
    .b-empty{ background:rgba(0,200,83,.12); color:#065f46; border-color:rgba(0,200,83,.20); }
    .b-full{ background:rgba(239,68,68,.10); color:#7f1d1d; border-color:rgba(239,68,68,.20); }

    .setupBox{
      margin-top:14px;
      padding:14px;
      border-radius:16px;
      border:1px dashed rgba(100,116,139,.45);
      background:var(--panel2);
      display:none;
    }
    .setupTitle{
      font-weight:1000;
      font-size:16px;
      margin:0 0 10px;
      text-align:center;
      color:var(--text);
    }
    .setupRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:720px){
      .setupRow{ grid-template-columns:1fr; }
    }
    .setupBtn{
      margin-top:10px;
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#eef2f7;
      color:var(--text);
      font-weight:1000;
      font-size:16px;
      cursor:pointer;
    }
    .setupBtn:hover{ background:#e7edf6; }

    /* ADMIN SUMMARY */
    .statsGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){
      .statsGrid{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      .statsGrid{ grid-template-columns: 1fr; }
    }
    .stat{
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--panel2);
      padding:14px;
    }
    .stat .k{
      font-weight:1000;
      letter-spacing:.8px;
      color:var(--muted);
      text-transform:uppercase;
      font-size:12px;
    }
    .stat .v{
      margin-top:6px;
      font-weight:1000;
      font-size:26px;
      color:var(--text);
    }

    .adminRow{
      display:grid;
      grid-template-columns: 1fr 180px;
      gap:12px;
    }
    @media (max-width: 720px){
      .adminRow{ grid-template-columns: 1fr; }
    }

    .b-wait{ background:rgba(100,116,139,.12); color:#334155; border-color:rgba(100,116,139,.18); }
    .b-done{ background:rgba(0,200,83,.12); color:#065f46; border-color:rgba(0,200,83,.20); }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 4px 0;
      z-index: 10000;
      min-width: 150px;
      display: none;
    }
    .context-menu-item {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s;
    }
    .context-menu-item:hover {
      background: rgba(59,130,246,.08);
    }
    .context-menu-item.danger {
      color: #dc2626;
    }
    .context-menu-item.danger:hover {
      background: rgba(239,68,68,.08);
    }

    /* Role Switch Modal */
    .role-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20000;
    }
    .role-modal-overlay.active {
      display: flex;
    }
    .role-modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: min(420px, 90vw);
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .role-modal h3 {
      margin: 0 0 20px 0;
      font-size: 20px;
      color: var(--text);
      flex-shrink: 0;
    }
    .role-modal #roleOptions {
      overflow-y: auto;
      flex: 1;
      margin-bottom: 12px;
      padding-right: 8px;
    }
    .role-modal #roleOptions::-webkit-scrollbar {
      width: 6px;
    }
    .role-modal #roleOptions::-webkit-scrollbar-track {
      background: var(--panel2);
      border-radius: 3px;
    }
    .role-modal #roleOptions::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    .role-modal #roleOptions::-webkit-scrollbar-thumb:hover {
      background: var(--muted);
    }
    .role-option {
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .role-option:hover {
      border-color: var(--green);
      background: rgba(0,200,83,0.05);
    }
    .role-option .role-badge-preview {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: 0.8px;
      white-space: nowrap;
    }
    .role-option .role-name {
      font-weight: 600;
      color: var(--text);
    }
    .role-modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 8px;
      flex-shrink: 0;
    }
    .role-modal-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .role-modal-buttons .btn-cancel {
      background: var(--panel2);
      color: var(--muted);
    }
    .role-modal-buttons .btn-cancel:hover {
      background: var(--border);
    }
    
    /* Raf Grid Kartlarƒ± */
    .rack-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      transition: all 0.2s ease;
      cursor: default;
    }
    .rack-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border-color: rgba(0,200,83,0.2);
    }
    .rack-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .rack-card-name {
      font-weight: 700;
      font-size: 15px;
      color: var(--text);
      letter-spacing: 0.3px;
    }
    .rack-card-status {
      font-size: 10px;
      font-weight: 900;
      letter-spacing: 0.8px;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .rack-card-status.empty {
      background: rgba(100,116,139,0.1);
      color: var(--muted);
    }
    .rack-card-status.full {
      background: rgba(239,68,68,0.1);
      color: #ef4444;
    }
    .rack-card-products {
      font-size: 13px;
      color: var(--text);
      line-height: 1.6;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .product-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(0,200,83,0.08);
      border: 1px solid rgba(0,200,83,0.2);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }
    .product-tag-code {
      color: #00c853;
      font-weight: 700;
    }
    .product-tag-qty {
      color: var(--muted);
      font-size: 11px;
    }
    .rack-card.empty .rack-card-products {
      color: var(--muted);
      font-style: italic;
    }
    .rack-filter-btn:hover {
      background: var(--panel2);
      border-color: var(--green);
    }
    .rack-filter-btn.active {
      background: var(--green);
      color: white;
      border-color: var(--green);
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div class="center" id="loginView" style="display:none;">
    <div class="loginCard">
      <h1 class="title">Gabya Home</h1>

      <input id="pwInput" class="input" type="password" placeholder="≈ûifreyi girin" />

      <div style="display:flex;align-items:center;gap:8px;margin-top:12px;">
        <input type="checkbox" id="rememberMe" style="width:auto;cursor:pointer;" />
        <label for="rememberMe" style="cursor:pointer;color:var(--muted);font-size:14px;">Beni Hatƒ±rla</label>
      </div>

      <button class="btn" id="loginBtn" type="button">Gƒ∞Rƒ∞≈û YAP</button>

      <div class="note" id="loginNote" style="display:none;"></div>
    </div>
  </div>

  <!-- APP -->
  <div class="appWrap" id="appView">
    <div class="appPanel">
      <div style="display:grid;grid-template-columns:auto 1fr auto;align-items:center;padding:0 18px;">
        <button id="logoutBtn" style="background:none;border:none;cursor:pointer;padding:6px 8px;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:8px;transition:background .2s;gap:2px;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#64748b;">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <polyline points="17 11 19 13 23 9"></polyline>
          </svg>
          <span style="font-size:9px;color:#64748b;font-weight:600;letter-spacing:0.3px;">ROL DEƒûƒ∞≈ûTƒ∞R</span>
        </button>
        <h1 class="appHeader" style="margin:0;text-align:center;">GABYA HOME</h1>
        <div style="width:80px;"></div>
      </div>
      <div class="roleLine" id="roleLine"></div>

      <!-- Context Menu -->
      <div id="contextMenu" class="context-menu">
        <div class="context-menu-item danger" id="contextMenuDelete">Talebi Sil</div>
      </div>

      <!-- Role Switch Modal -->
      <div id="roleSwitchModal" class="role-modal-overlay">
        <div class="role-modal">
          <h3>Hangi Role Ge√ßmek ƒ∞stersiniz?</h3>
          <div id="roleOptions"></div>
          <div class="role-modal-buttons">
            <button class="btn-cancel" id="btnCancelRoleSwitch">ƒ∞ptal</button>
          </div>
        </div>
      </div>

      <!-- Attendance Detail Modal -->
      <div id="attendanceDetailModal" class="role-modal-overlay">
        <div class="role-modal" style="max-width:700px;max-height:90vh;display:flex;flex-direction:column;">
          <h3 id="attendanceDetailTitle" style="margin:0 0 16px 0;flex-shrink:0;">Mesai Detayƒ±</h3>
          
          <div id="attendanceDetailContent" style="flex:1;overflow-y:auto;margin-bottom:16px;padding-right:8px;">
            <!-- Timestamps buraya gelecek -->
          </div>
          
          <div style="display:flex;gap:12px;flex-shrink:0;border-top:1px solid var(--border);padding-top:16px;">
            <button class="actionBtn" id="btnAddTimestamp" style="flex:1;">
              YENƒ∞ Gƒ∞Rƒ∞≈û/√áIKI≈û EKLE
            </button>
          </div>
          
          <div class="role-modal-buttons" style="margin-top:16px;flex-shrink:0;">
            <button class="btn-cancel" id="btnCloseAttendanceDetail">Kapat</button>
            <button class="actionBtn" id="btnSaveAttendanceDetail" style="flex:1;">Deƒüi≈üiklikleri Kaydet</button>
          </div>
        </div>
      </div>

      <div class="tabbar" id="tabbar">
        <div class="tab" id="tabPut">RAFA √úR√úN KOY</div>
        <div class="tab" id="tabClear">RAF BO≈ûALT</div>
        <div class="tab" id="tabSearch">√úR√úN ARA</div>
        <div class="tab" id="tabRack">RAF DURUMU</div>
        <div class="tab" id="tabRequest">√úR√úN TALEP</div>
        <div class="tab" id="tabMaterialRequest">MALZEME TALEP</div>
        <div class="tab" id="tabWelder">√úRETƒ∞M Gƒ∞Rƒ∞≈ûƒ∞</div>
        <div class="tab" id="tabWelderRequests">Sƒ∞PARƒ∞≈ûLER</div>
        <div class="tab" id="tabProduction">√úRETƒ∞M KAYITLARI</div>
        <div class="tab" id="tabPurchase">SATIN ALMA</div>
        <div class="tab" id="tabInstructions">√úRETƒ∞M TALƒ∞MATLARI</div>
        <div class="tab" id="tabPackaging">PAKETLEME TALƒ∞MATLARI</div>
        <div class="tab" id="tabPayments">PERSONEL √ñDEMELERƒ∞</div>
        <div class="tab" id="tabAccounts">CARƒ∞ HESAPLAR</div>
        <div class="tab" id="tabCommissionSummary">ETSY BAYƒ∞LERƒ∞</div>
        <div class="tab" id="tabCommission">HAK EDƒ∞≈û</div>
        <div class="tab" id="tabPlatformPayments">AMAZON & SHOPIFY</div>
        <div class="tab" id="tabAttendance">PUANTAJ</div>
        <div class="tab" id="tabAdmin">Y√ñNETƒ∞Cƒ∞</div>
      </div>

      <!-- Admin i√ßin gruplandƒ±rƒ±lmƒ±≈ü tabbar -->
      <div class="tabbar-grouped" id="tabbarGrouped" style="display:none;">
        <!-- Grup 1: Raf ƒ∞≈ülemleri -->
        <div class="tab-group">
          <div class="tab-group-header" data-group="raf">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
            <span>Raf ƒ∞≈ülemleri</span>
            <svg class="dropdown-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M4 6l4 4 4-4"/>
            </svg>
          </div>
        </div>

        <!-- Grup 2: Talep-Satƒ±n Alma -->
        <div class="tab-group">
          <div class="tab-group-header" data-group="talep">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            <span>Talep-Satƒ±n Alma</span>
            <svg class="dropdown-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M4 6l4 4 4-4"/>
            </svg>
          </div>
        </div>

        <!-- Grup 3: Talimatlar -->
        <div class="tab-group">
          <div class="tab-group-header" data-group="talimat">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span>Talimatlar</span>
            <svg class="dropdown-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M4 6l4 4 4-4"/>
            </svg>
          </div>
        </div>

        <!-- Grup 4: Finans -->
        <div class="tab-group">
          <div class="tab-group-header" data-group="finans">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            <span>Finans</span>
            <svg class="dropdown-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M4 6l4 4 4-4"/>
            </svg>
          </div>
        </div>

        <!-- Grup 5: Kayƒ±tlar -->
        <div class="tab-group">
          <div class="tab-group-header" data-group="kayit">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            <span>Kayƒ±tlar</span>
            <svg class="dropdown-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M4 6l4 4 4-4"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- Dropdown ƒ∞√ßerikleri (Body'de) -->
      <div class="tab-group-content" id="group-raf">
        <div class="tab-sub" data-target="put">Rafa √úr√ºn Koy</div>
        <div class="tab-sub" data-target="clear">Raf Bo≈üalt</div>
        <div class="tab-sub" data-target="rack">Raf Durumu</div>
        <div class="tab-sub" data-target="search">√úr√ºn Ara</div>
      </div>
      <div class="tab-group-content" id="group-talep">
        <div class="tab-sub" data-target="request">√úr√ºn Talep</div>
        <div class="tab-sub" data-target="materialRequest">Malzeme Talep</div>
        <div class="tab-sub" data-target="purchase">Satƒ±n Alma</div>
      </div>
      <div class="tab-group-content" id="group-talimat">
        <div class="tab-sub" data-target="instructions">√úretim Talimatlarƒ±</div>
        <div class="tab-sub" data-target="packaging">Paketleme Talimatlarƒ±</div>
      </div>
      <div class="tab-group-content" id="group-finans">
        <div class="tab-sub" data-target="payments">Personel √ñdemeleri</div>
        <div class="tab-sub" data-target="accounts">Cari Hesaplar</div>
        <div class="tab-sub" data-target="commissionSummary">Etsy Bayileri</div>
        <div class="tab-sub" data-target="platformPayments">Amazon & Shopify</div>
      </div>
      <div class="tab-group-content" id="group-kayit">
        <div class="tab-sub" data-target="admin">Y√∂netici</div>
        <div class="tab-sub" data-target="production">√úretim Kayƒ±tlarƒ±</div>
        <div class="tab-sub" data-target="attendance">Mesai Kayƒ±tlarƒ±</div>
      </div>

      <div class="content">

        <!-- VIEW: PUT -->
        <div id="viewPut" style="display:none;">
          <div class="sectionTitle"></div>
          <div class="card">
            <h3></h3>

            <label class="fieldLabel">√úr√ºn Kodu</label>
            <input id="inProduct" class="input" />

            <label class="fieldLabel">Raf Numarasƒ±</label>
            <select id="inShelfNum" class="input">
            </select>

            <label class="fieldLabel">Adet</label>
            <select id="inQty" class="input">
            </select>

            <button class="actionBtn" id="btnPut" type="button">√úR√úN√ú RAFA KOY</button>

            <div class="statusBox" id="statusPut" style="display:none;"></div>
          </div>
        </div>

        <!-- VIEW: CLEAR -->
        <div id="viewClear" style="display:none;">
          <div class="sectionTitle"></div>
          <div class="card">
            <h3></h3>

            <label class="fieldLabel">Raf Numarasƒ±</label>
            <select id="outShelfNum" class="input">
              <option value="">-- Raf se√ßiniz --</option>
            </select>

            <div class="subBox" id="clearProductBox">

              <label class="fieldLabel">√úr√ºn</label>
              <div id="productListContainer" class="product-list"></div>
              <input type="hidden" id="outProductCode" />

              <!-- ‚úÖ Adet azalt (her zaman g√∂r√ºn√ºr) -->
              <div id="clearQtyBox" style="margin-top:10px;">
                <label class="fieldLabel">Adet (Azalt)</label>
                <select id="outReduceQty" class="input">
                  <option value="1">1</option>
                </select>
              </div>
            </div>

            <button class="actionBtn red" id="btnClear" type="button">RAFI BO≈ûALT</button>

            <div class="statusBox" id="statusClear" style="display:none;"></div>
          </div>
        </div>

        <!-- VIEW: SEARCH -->
        <div id="viewSearch" style="display:none;">
          <div class="sectionTitle"></div>

          <div class="card">
            <h3 style="margin-top:0;"></h3>
            <div class="searchRow">
              <input id="searchCode" class="input" style="margin:0;" />
              <button class="searchBtn" id="btnSearch" type="button">ARA</button>
            </div>

            <div class="statusBox" id="statusSearch" style="margin-top:12px;display:none;"></div>

            <div class="tableWrap" id="searchWrap" style="display:none;">
              <table>
                <thead>
                  <tr><th>Raf</th><th>Adet</th></tr>
                </thead>
                <tbody id="searchBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: RACK STATUS -->
        <div id="viewRack" style="display:none;">
          <div style="padding:16px 20px;background:var(--panel);border-bottom:1px solid var(--border);">
            <div id="rackHint" style="font-size:14px;color:var(--muted);font-weight:600;"></div>
          </div>

          <div style="padding:20px;">
            <!-- Dolu Raflar -->
            <div style="margin-bottom:32px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                <span style="color:#00c853;font-size:18px;">‚óè</span>
                <h3 style="margin:0;font-size:16px;font-weight:700;color:var(--text);">DOLU RAFLAR</h3>
                <span id="fullRackCount" style="font-size:13px;color:var(--muted);font-weight:600;"></span>
              </div>
              <div id="rackGridFull" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;"></div>
              <div id="rackFullEmpty" style="display:none;text-align:center;padding:40px;color:var(--muted);font-size:14px;">Dolu raf yok</div>
            </div>
            
            <!-- Bo≈ü Raflar (Sadece Admin) -->
            <div id="emptyRacksSection" style="margin-bottom:32px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                <span style="color:var(--muted);font-size:18px;">‚óè</span>
                <h3 style="margin:0;font-size:16px;font-weight:700;color:var(--text);">BO≈û RAFLAR</h3>
                <span id="emptyRackCount" style="font-size:13px;color:var(--muted);font-weight:600;"></span>
              </div>
              <div id="rackGridEmpty" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;"></div>
              <div id="rackEmptyEmpty" style="display:none;text-align:center;padding:40px;color:var(--muted);font-size:14px;">Bo≈ü raf yok</div>
            </div>
            
            <div class="setupBox" id="setupBox" style="margin-top:20px;">
              <div class="setupTitle">ƒ∞lk Kurulum</div>
              <div class="setupRow">
                <input id="setupCount" class="input" type="number" min="1" value="300" style="margin:0;" />
                <input id="setupPrefix" class="input" value="R" style="margin:0;" />
              </div>
              <button class="setupBtn" id="btnSetup" type="button">RAFLARI OLU≈ûTUR</button>
              <div class="hintLine" id="setupStatus"></div>
            </div>
          </div>
        </div>

        <!-- VIEW: REQUEST -->
        <div id="viewRequest" style="display:none;">

          <div class="card">

            <label class="fieldLabel">√úr√ºn Kodu</label>
            <input id="reqProduct" class="input" placeholder="" />

            <label class="fieldLabel" style="margin-top:14px;">Adet</label>
            <input id="reqQuantity" class="input" type="number" min="1" value="1" placeholder="Adet giriniz" />

            <label class="fieldLabel" style="margin-top:14px;">√úretim Modeli</label>
            <select id="reqProductionType" class="input">
              <option value="">Se√ßiniz</option>
              <option value="welder">Kaynak</option>
              <option value="laser">Lazer</option>
            </select>

            <button class="actionBtn" id="btnReq" type="button">√úRETƒ∞MDEN TALEP ET</button>

            <div class="statusBox" id="statusReq" style="display:none;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">√úretim Taleplerim</h3>

            <div class="statusBox" id="statusReqList">Y√ºkleniyor...</div>

            <div class="tableWrap" id="reqWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>√úr√ºn Kodu</th>
                    <th>Adet</th>
                    <th>Durum</th>
                    <th>Talep Eden</th>
                    <th>Talebi Kar≈üƒ±layan</th>
                    <th>Sil</th>
                  </tr>
                </thead>
                <tbody id="reqBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: PRODUCTION (For Admin & Packer) -->
        <div id="viewProduction" style="display:none;">

          <div class="card">
            <h3 style="margin-top:0;">T√ºm √úretimler</h3>
            
            <div class="adminRow" style="gap:8px;">
              <button class="searchBtn" id="btnProdDay" type="button">G√úNL√úK</button>
              <button class="searchBtn" id="btnProdWeek" type="button">HAFTALIK</button>
              <button class="searchBtn" id="btnProdMonth" type="button">AYLIK</button>
              <button class="searchBtn" id="btnProdYear" type="button">YILLIK</button>
            </div>

            <div class="statusBox" id="statusProduction" style="margin-top:12px;display:none;"></div>

            <div class="tableWrap" id="productionWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih & Saat</th>
                    <th>√úr√ºn Kodu</th>
                    <th>Durum</th>
                    <th>Adet</th>
                    <th>√úretim</th>
                  </tr>
                </thead>
                <tbody id="productionBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: WELDER -->
        <div id="viewWelder" style="display:none;">
          <div class="sectionTitle">√úretim Giri≈üi</div>

          <div class="card">
            <h3 style="margin-top:0;">√úretilen √úr√ºn Giri≈üi</h3>
            
            <div class="formRow">
              <label>√úr√ºn Kodu</label>
              <input id="welderCode" class="input" type="text" placeholder="√úr√ºn kodu giriniz" />
            </div>

            <div class="formRow">
              <label>Durum</label>
              <select id="welderStatus" class="input" style="padding:10px;font-weight:600;">
                <option value="KESƒ∞LDƒ∞">KESƒ∞LDƒ∞</option>
                <option value="PUNTALANDI">PUNTALANDI</option>
                <option value="KAYNATILDI">KAYNATILDI</option>
                <option value="√úRETƒ∞LDƒ∞" selected>√úRETƒ∞LDƒ∞</option>
              </select>
            </div>

            <div class="formRow">
              <label>Adet</label>
              <select id="welderQty" class="input" style="padding:10px;font-weight:600;">
              </select>
            </div>

            <button class="btn" id="welderSave">KAYDET</button>

            <div class="statusBox" id="statusWelder" style="display:none;margin-top:12px;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Bug√ºnk√º √úretim</h3>
            <div class="statusBox" id="statusWelderToday" style="display:none;"></div>
            <div class="tableWrap" id="welderTodayWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Saat</th>
                    <th>√úr√ºn Kodu</th>
                    <th>Durum</th>
                    <th>Adet</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody id="welderTodayBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: WELDER REQUESTS -->
        <div id="viewWelderRequests" style="display:none;">
          <div class="sectionTitle">Talepler</div>

          <div class="card">
            <h3 style="margin-top:0;">T√ºm Talepler</h3>
            <div class="statusBox" id="statusWelderRequests" style="display:none;"></div>
            <div class="tableWrap" id="welderRequestsWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>√úr√ºn Kodu</th>
                    <th>Adet</th>
                    <th>Talep Eden</th>
                    <th>Durum</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody id="welderRequestsBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: MATERIAL REQUEST -->
        <div id="viewMaterialRequest" style="display:none;">

          <div class="card">

            <label class="fieldLabel">Malzeme</label>
            <input id="matReqName" class="input" placeholder="" />

            <label class="fieldLabel" style="margin-top:14px;">Adet</label>
            <input id="matReqQty" class="input" type="number" min="1" value="1" />

            <label class="fieldLabel" style="margin-top:14px;">Not</label>
            <input id="matReqNote" class="input" placeholder="Ek bilgi yazabilirsiniz" />

            <button class="actionBtn" id="btnMatReq" type="button">TALEP OLU≈ûTUR</button>

            <div class="statusBox" id="statusMatReq" style="display:none;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Malzeme Taleplerim</h3>

            <div class="statusBox" id="statusMatReqList">Y√ºkleniyor...</div>

            <div class="tableWrap" id="matReqWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Malzeme</th>
                    <th>Adet</th>
                    <th>Durum</th>
                    <th>Talep Eden</th>
                    <th>Not</th>
                  </tr>
                </thead>
                <tbody id="matReqBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: PURCHASE MANAGEMENT -->
        <div id="viewPurchase" style="display:none;">

          <div class="card">
            <h3 style="margin-top:0;">T√ºm Malzeme Talepleri</h3>
            
            <div class="statusBox" id="statusPurchase" style="margin-top:12px;display:none;"></div>

            <div class="tableWrap" id="purchaseWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Malzeme</th>
                    <th>Adet</th>
                    <th>Talep Eden</th>
                    <th>Not</th>
                    <th>Durum</th>
                    <th>ƒ∞≈ülem</th>
                    <th>Not Ekle</th>
                    <th>Reddet</th>
                    <th>Sil</th>
                  </tr>
                </thead>
                <tbody id="purchaseBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: INSTRUCTIONS -->
        <div id="viewInstructions" style="display:none;">
          <div class="card">
            <h3 style="margin-top:0;">√úretim Talimatlarƒ±</h3>
            
            <label class="fieldLabel">√úr√ºn Kodu</label>
            <input id="instructionsProductCode" class="input" placeholder="√ñrn: 7001" />
            
            <button class="actionBtn" id="btnLoadInstructions" type="button" style="margin-top:16px;">TALƒ∞MATI G√ñSTER</button>
            
            <div class="statusBox" id="statusInstructions" style="display:none;margin-top:16px;"></div>
            
            <div id="instructionsContent" style="margin-top:24px;display:none;">
              <h4 style="margin:0 0 12px 0;color:var(--text);">√úretim Talimatƒ±</h4>
              <div id="instructionContainer" style="width:100%;min-height:600px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--panel2);display:flex;align-items:center;justify-content:center;"></div>
            </div>
          </div>
        </div>

        <!-- VIEW: PACKAGING -->
        <div id="viewPackaging" style="display:none;">
          <div class="card">
            <h3 style="margin-top:0;">Paketleme Talimatlarƒ±</h3>
            
            <label class="fieldLabel">√úr√ºn Kodu</label>
            <input id="packagingProductCode" class="input" placeholder="√ñrn: 7001" />
            
            <button class="actionBtn" id="btnLoadPackaging" type="button" style="margin-top:16px;">TALƒ∞MATI G√ñSTER</button>
            
            <div class="statusBox" id="statusPackaging" style="display:none;margin-top:16px;"></div>
            
            <div id="packagingContent" style="margin-top:24px;display:none;">
              <h4 style="margin:0 0 12px 0;color:var(--text);">Paketleme Talimatƒ±</h4>
              <div id="packagingContainer" style="width:100%;min-height:600px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--panel2);display:flex;align-items:center;justify-content:center;"></div>
            </div>
          </div>
        </div>

        <!-- VIEW: PAYMENTS -->
        <div id="viewPayments" style="display:none;">
          
          <!-- Yakla≈üan ve Gecikmi≈ü √ñdemeler -->
          <div class="card" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;margin-bottom:16px;">
            <h3 style="margin:0 0 16px 0;color:white;">Maa≈ü √ñdeme Takibi</h3>
            
            <div id="upcomingPaymentsAlert" style="background:rgba(255,255,255,0.2);padding:16px;border-radius:8px;margin-bottom:12px;">
              <div style="font-weight:900;font-size:14px;margin-bottom:8px;">‚è∞ YAKINLA≈ûAN √ñDEMELER (7 G√ºn ƒ∞√ßinde)</div>
              <div id="upcomingPaymentsList" style="font-size:13px;"></div>
            </div>
            
            <div id="overduePaymentsAlert" style="background:rgba(255,59,48,0.3);padding:16px;border-radius:8px;">
              <div style="font-weight:900;font-size:14px;margin-bottom:8px;">üö® GECƒ∞KMƒ∞≈û √ñDEMELER</div>
              <div id="overduePaymentsList" style="font-size:13px;"></div>
            </div>
          </div>

          <!-- √ñdeme Yapma -->
          <div class="card">
            <h3 style="margin-top:0;">√ñdeme Yap</h3>
            
            <label class="fieldLabel">Personel Se√ß</label>
            <select id="paymentPersonSelect" class="input">
              <option value="">Personel Se√ßiniz...</option>
            </select>

            <label class="fieldLabel" style="margin-top:12px;">ƒ∞≈ülem Tipi</label>
            <select id="paymentType" class="input">
              <option value="salary">Maa≈ü</option>
              <option value="advance">Avans</option>
            </select>

            <label class="fieldLabel" style="margin-top:12px;">Tutar (TL)</label>
            <input id="paymentAmount" class="input" type="number" placeholder="Tutar giriniz" />

            <label class="fieldLabel" style="margin-top:12px;">Tarih</label>
            <input id="paymentDate" class="input" type="date" />

            <label class="fieldLabel" style="margin-top:12px;">Not / A√ßƒ±klama</label>
            <textarea id="paymentNote" class="input" rows="2" placeholder="ƒ∞steƒüe baƒülƒ± not ekleyin..."></textarea>

            <button class="actionBtn" id="btnAddPayment" type="button" style="margin-top:16px;">√ñDEME KAYDET</button>

            <div class="statusBox" id="statusPayment" style="display:none;margin-top:12px;"></div>
          </div>

          <!-- Kayƒ±tlƒ± Personeller -->
          <div class="card">
            <h4 style="margin:0 0 12px 0;color:var(--text);">Kayƒ±tlƒ± Personeller</h4>
            
            <div id="personnelListWrap" style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);margin-bottom:24px;">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">PERSONEL</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">PERƒ∞YOT</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">√ñDEME G√úN√ú</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">MAA≈û</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">SONRAKƒ∞ √ñDEME</th>
                    <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                  </tr>
                </thead>
                <tbody id="personnelListBody">
                  <tr><td colspan="6" style="padding:24px;text-align:center;color:var(--muted);">Personel y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- √ñdeme Kayƒ±tlarƒ± -->
          <div class="card">
            <h4 style="margin:0 0 12px 0;color:var(--text);">√ñdeme Kayƒ±tlarƒ±</h4>
            
            <div style="margin-bottom:12px;">
              <input id="paymentSearchName" class="input" placeholder="Personel adƒ±na g√∂re filtrele..." style="margin-bottom:8px;" />
              
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;">
                <button class="searchBtn" id="btnFilterAllPayments" type="button" style="font-size:13px;padding:10px;">T√úM√ú</button>
                <button class="searchBtn" id="btnFilterSalary" type="button" style="font-size:13px;padding:10px;">MAA≈ûLAR</button>
                <button class="searchBtn" id="btnFilterAdvance" type="button" style="font-size:13px;padding:10px;">AVANSLAR</button>
              </div>
            </div>

            <div id="paymentListWrap" style="max-height:500px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TARƒ∞H</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">PERSONEL</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Tƒ∞P</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TUTAR</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">NOT</th>
                    <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                  </tr>
                </thead>
                <tbody id="paymentListBody">
                  <tr><td colspan="6" style="padding:24px;text-align:center;color:var(--muted);">Kayƒ±t y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Personel Tanƒ±mlama -->
          <div class="card">
            <h3 style="margin-top:0;">Personel Tanƒ±mlama</h3>
            
            <div style="margin-bottom:24px;">
              <label class="fieldLabel">Personel Adƒ±</label>
              <input id="personnelName" class="input" placeholder="√ñrn: Evan" />

              <label class="fieldLabel" style="margin-top:12px;">Maa≈ü Periyodu</label>
              <select id="personnelPaymentPeriod" class="input">
                <option value="monthly">Aylƒ±k</option>
                <option value="weekly">Haftalƒ±k</option>
              </select>

              <div id="monthlyPaymentFields">
                <label class="fieldLabel" style="margin-top:12px;">Maa≈ü √ñdeme G√ºn√º (Ayƒ±n Ka√ßƒ±nda)</label>
                <input id="personnelPaymentDayMonthly" class="input" type="number" min="1" max="31" placeholder="√ñrn: 10 (ayƒ±n 10'unda)" />
              </div>

              <div id="weeklyPaymentFields" style="display:none;">
                <label class="fieldLabel" style="margin-top:12px;">Maa≈ü √ñdeme G√ºn√º (Haftanƒ±n Hangi G√ºn√º)</label>
                <select id="personnelPaymentDayWeekly" class="input">
                  <option value="1">Pazartesi</option>
                  <option value="2">Salƒ±</option>
                  <option value="3">√áar≈üamba</option>
                  <option value="4">Per≈üembe</option>
                  <option value="5">Cuma</option>
                  <option value="6">Cumartesi</option>
                  <option value="0">Pazar</option>
                </select>
              </div>

              <label class="fieldLabel" style="margin-top:12px;">Maa≈ü Tutarƒ± (TL)</label>
              <input id="personnelSalary" class="input" type="number" placeholder="√ñrn: 17000" />

              <label class="fieldLabel" style="margin-top:12px;">ƒ∞≈üe Ba≈ülama Tarihi</label>
              <input id="personnelStartDate" class="input" type="date" />

              <button class="actionBtn" id="btnAddPersonnel" type="button" style="margin-top:16px;">PERSONEL EKLE</button>

              <div class="statusBox" id="statusPersonnel" style="display:none;margin-top:12px;"></div>
            </div>

            <!-- Personel D√ºzenleme Formu -->
            <div id="editPersonnelSection" style="display:none;background:#fff3cd;padding:16px;border-radius:8px;margin-bottom:24px;border:2px solid #ffc107;">
              <h4 style="margin:0 0 12px 0;color:#856404;">Personel D√ºzenle</h4>
              
              <input id="editPersonnelId" type="hidden" />
              
              <label class="fieldLabel">Personel Adƒ±</label>
              <input id="editPersonnelName" class="input" placeholder="√ñrn: Evan" />

              <label class="fieldLabel" style="margin-top:12px;">Maa≈ü Periyodu</label>
              <select id="editPersonnelPaymentPeriod" class="input">
                <option value="monthly">Aylƒ±k</option>
                <option value="weekly">Haftalƒ±k</option>
              </select>

              <div id="editMonthlyPaymentFields">
                <label class="fieldLabel" style="margin-top:12px;">Maa≈ü √ñdeme G√ºn√º (Ayƒ±n Ka√ßƒ±nda)</label>
                <input id="editPersonnelPaymentDayMonthly" class="input" type="number" min="1" max="31" placeholder="√ñrn: 10" />
              </div>

              <div id="editWeeklyPaymentFields" style="display:none;">
                <label class="fieldLabel" style="margin-top:12px;">Maa≈ü √ñdeme G√ºn√º (Haftanƒ±n Hangi G√ºn√º)</label>
                <select id="editPersonnelPaymentDayWeekly" class="input">
                  <option value="1">Pazartesi</option>
                  <option value="2">Salƒ±</option>
                  <option value="3">√áar≈üamba</option>
                  <option value="4">Per≈üembe</option>
                  <option value="5">Cuma</option>
                  <option value="6">Cumartesi</option>
                  <option value="0">Pazar</option>
                </select>
              </div>

              <label class="fieldLabel" style="margin-top:12px;">Maa≈ü Tutarƒ± (TL)</label>
              <input id="editPersonnelSalary" class="input" type="number" placeholder="√ñrn: 17000" />

              <label class="fieldLabel" style="margin-top:12px;">ƒ∞≈üe Ba≈ülama Tarihi</label>
              <input id="editPersonnelStartDate" class="input" type="date" />

              <div style="display:flex;gap:8px;margin-top:16px;">
                <button class="actionBtn" id="btnUpdatePersonnel" type="button" style="flex:1;">G√úNCELLE</button>
                <button class="actionBtn" id="btnCancelEdit" type="button" style="flex:1;background:var(--muted);">ƒ∞PTAL</button>
              </div>

              <div class="statusBox" id="statusEditPersonnel" style="display:none;margin-top:12px;"></div>
            </div>
          </div>
        </div>

        <!-- VIEW: ACCOUNTS -->
        <div id="viewAccounts" style="display:none;">
          <div class="card">
            <h3 style="margin-top:0;">Firma Bor√ß Takibi</h3>
            
            <div style="margin-bottom:24px;">
              
              <label class="fieldLabel">Firma Adƒ±</label>
              <input id="accountCompanyName" class="input" list="companyList" />
              <datalist id="companyList"></datalist>

              <label class="fieldLabel" style="margin-top:12px;">ƒ∞≈ülem Tipi</label>
              <select id="accountTransactionType" class="input">
                <option value="purchase">Mal Alƒ±mƒ±</option>
                <option value="payment">√ñdeme</option>
                <option value="refundInvoice" style="display:none;">ƒ∞ade Fatura</option>
                <option value="cargoInvoice" style="display:none;">Kargo Faturasƒ±</option>
                <option value="customsInvoice" style="display:none;">G√ºmr√ºk Faturasƒ±</option>
                <option value="refund" style="display:none;">ƒ∞ade</option>
              </select>

              <div id="purchaseFields" style="display:block;">
                <label class="fieldLabel" style="margin-top:12px;">Mal/Hizmet Adƒ±</label>
                <input id="accountItemName" class="input" />

                <label class="fieldLabel" style="margin-top:12px;">Adet/Miktar</label>
                <input id="accountItemQuantity" class="input" type="number" />

                <label class="fieldLabel" style="margin-top:12px;">Fatura Tutarƒ± (TL)</label>
                <input id="accountInvoiceAmount" class="input" type="number" placeholder="√ñrn: 50000" />
              </div>

              <div id="paymentFields" style="display:none;">
                <label class="fieldLabel" style="margin-top:12px;">√ñdeme Tutarƒ± (TL)</label>
                <input id="accountPaymentAmount" class="input" type="number" placeholder="√ñrn: 25000" />
              </div>

              <label class="fieldLabel" style="margin-top:12px;">Not / A√ßƒ±klama</label>
              <textarea id="accountNote" class="input" rows="2" placeholder="ƒ∞steƒüe baƒülƒ± not ekleyin..."></textarea>

              <button class="actionBtn" id="btnAddAccountTransaction" type="button" style="margin-top:16px;">KAYDET</button>

              <div class="statusBox" id="statusAccount" style="display:none;margin-top:12px;"></div>
            </div>

            <!-- Firma Adƒ± D√ºzenleme Formu -->
            <div id="editCompanySection" style="display:none;background:#fff3cd;padding:16px;border-radius:8px;margin-top:24px;margin-bottom:24px;border:2px solid #ffc107;">
              <h4 style="margin:0 0 12px 0;color:#856404;">Firma Adƒ±nƒ± D√ºzenle</h4>
              
              <input id="editCompanyOldName" type="hidden" />
              
              <label class="fieldLabel">Yeni Firma Adƒ±</label>
              <input id="editCompanyNewName" class="input" placeholder="√ñrn: ABC Demir √áelik" />

              <div style="display:flex;gap:8px;margin-top:16px;">
                <button class="actionBtn" id="btnUpdateCompany" type="button" style="flex:1;">G√úNCELLE</button>
                <button class="actionBtn" id="btnCancelCompanyEdit" type="button" style="flex:1;background:var(--muted);">ƒ∞PTAL</button>
              </div>

              <div class="statusBox" id="statusEditCompany" style="display:none;margin-top:12px;"></div>
            </div>

            <div style="margin-top:24px;">
              <h4 style="margin:0 0 12px 0;color:var(--text);">Firma Bakiyeleri</h4>
              
              <div id="companyBalancesWrap" style="max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);margin-bottom:24px;">
                <table style="width:100%;border-collapse:collapse;">
                  <thead>
                    <tr style="background:var(--panel1);position:sticky;top:0;">
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Fƒ∞RMA</th>
                      <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TOPLAM ALIM</th>
                      <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TOPLAM √ñDEME</th>
                      <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">BAKƒ∞YE (BOR√á)</th>
                      <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                    </tr>
                  </thead>
                  <tbody id="companyBalancesBody">
                    <tr><td colspan="5" style="padding:24px;text-align:center;color:var(--muted);">Kayƒ±t y√ºkleniyor...</td></tr>
                  </tbody>
                </table>
              </div>

              <h4 style="margin:0 0 12px 0;color:var(--text);">ƒ∞≈ülem Ge√ßmi≈üi</h4>
              
              <div style="margin-bottom:12px;">
                <input id="accountSearchCompany" class="input" placeholder="Firmaya g√∂re filtrele..." style="margin-bottom:8px;" />
                
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;">
                  <button class="searchBtn" id="btnFilterAllTransactions" type="button" style="font-size:13px;padding:10px;">T√úM√ú</button>
                  <button class="searchBtn" id="btnFilterPurchases" type="button" style="font-size:13px;padding:10px;">ALIMLAR</button>
                  <button class="searchBtn" id="btnFilterPayments" type="button" style="font-size:13px;padding:10px;">√ñDEMELER</button>
                </div>
              </div>

              <div id="accountListWrap" style="max-height:500px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);">
                <table style="width:100%;border-collapse:collapse;">
                  <thead>
                    <tr style="background:var(--panel1);position:sticky;top:0;">
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TARƒ∞H</th>
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Fƒ∞RMA</th>
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Tƒ∞P</th>
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">DETAY</th>
                      <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TUTAR</th>
                      <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">NOT</th>
                      <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                    </tr>
                  </thead>
                  <tbody id="accountListBody">
                    <tr><td colspan="7" style="padding:24px;text-align:center;color:var(--muted);">Kayƒ±t y√ºkleniyor...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- VIEW: COMMISSION -->
        <div id="viewCommission" style="display:none;">
          <div class="card">
            <div id="commissionSummarySection" style="background:rgba(102,126,234,0.08);border:1px solid rgba(102,126,234,0.2);border-radius:6px;padding:16px;margin-bottom:20px;">
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">
                <div style="padding:10px;background:white;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                  <div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">Toplam Gelir</div>
                  <div style="font-size:20px;font-weight:700;color:#1e293b;" id="myTotalIncome">0 ‚Ç∫</div>
                </div>
                <div style="padding:10px;background:white;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                  <div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">Toplam Gider</div>
                  <div style="font-size:20px;font-weight:700;color:#1e293b;" id="myTotalExpense">0 ‚Ç∫</div>
                </div>
                <div style="padding:10px;background:white;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                  <div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;" id="myCommissionLabel">Payƒ±m (%20)</div>
                  <div style="font-size:22px;font-weight:700;color:#f59e0b;" id="myCommission">0 ‚Ç∫</div>
                </div>
                <div style="padding:10px;background:white;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                  <div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">≈ûirkete √ñdemem</div>
                  <div style="font-size:20px;font-weight:700;color:#ef4444;" id="myCompanyPayment">0 ‚Ç∫</div>
                  <div style="font-size:10px;color:#10b981;margin-top:4px;display:none;" id="myCollectionInfo">Tahsilat: 0 ‚Ç∫</div>
                </div>
                <div id="myTaxSection" style="grid-column:span 2;padding:10px;background:white;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                  <div style="font-size:11px;color:#64748b;font-weight:600;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Vergi Muafiyeti (1.900)</div>
                  <div style="display:flex;gap:20px;align-items:center;">
                    <div>
                      <div style="font-size:10px;color:#94a3b8;margin-bottom:2px;">Kullanƒ±lan</div>
                      <div style="font-size:16px;font-weight:700;color:#1e293b;" id="myTaxUsed">0 ‚Ç∫</div>
                    </div>
                    <div style="font-size:18px;color:#cbd5e1;">‚Üí</div>
                    <div>
                      <div style="font-size:10px;color:#94a3b8;margin-bottom:2px;">Kalan</div>
                      <div style="font-size:16px;font-weight:700;color:#10b981;" id="myTaxRemaining">1.900.000 ‚Ç∫</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="commissionFormSection" style="margin-bottom:24px;">
              <h3 style="margin:0 0 12px 0;color:var(--text);font-size:18px;font-weight:700;">Yeni ƒ∞≈ülem Ekle</h3>
              <label class="fieldLabel">ƒ∞≈ülem Tipi</label>
              <select id="commissionTransactionType" class="input">
                <option value="income">Gelir (Satƒ±≈ü)</option>
                <option value="expense">Gider (ƒ∞ade/Kesinti)</option>
              </select>

              <label class="fieldLabel" style="margin-top:12px;">Tutar (TL)</label>
              <input id="commissionAmount" class="input" type="number" placeholder="√ñrn: 5000" />

              <label class="fieldLabel" style="margin-top:12px;">A√ßƒ±klama</label>
              <textarea id="commissionNote" class="input" rows="2" placeholder="√ñrn: ETSY satƒ±≈ü √∂demesi, ƒ∞ade, Kargo kesintisi vb."></textarea>

              <button class="actionBtn" id="btnAddCommission" type="button" style="margin-top:16px;">KAYDET</button>

              <div class="statusBox" id="statusCommission" style="display:none;margin-top:12px;"></div>
            </div>

            <h3 style="margin:0 0 12px 0;color:var(--text);font-size:18px;font-weight:700;">ƒ∞≈ülem Ge√ßmi≈üi</h3>
            
            <div style="margin-bottom:12px;">
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;">
                <button class="searchBtn" id="btnFilterAllCommission" type="button" style="font-size:13px;padding:10px;">T√úM√ú</button>
                <button class="searchBtn" id="btnFilterIncome" type="button" style="font-size:13px;padding:10px;">GELƒ∞RLER</button>
                <button class="searchBtn" id="btnFilterExpense" type="button" style="font-size:13px;padding:10px;">Gƒ∞DERLER</button>
              </div>
            </div>

            <div id="commissionListWrap" style="max-height:500px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TARƒ∞H</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Tƒ∞P</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TUTAR</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">A√áIKLAMA</th>
                    <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                  </tr>
                </thead>
                <tbody id="commissionListBody">
                  <tr><td colspan="5" style="padding:24px;text-align:center;color:var(--muted);">Kayƒ±t y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>

            <h4 style="margin:24px 0 12px 0;color:var(--text);">Tahsilat Ge√ßmi≈üi</h4>
            <div id="myPaymentsWrap" style="max-height:400px;overflow-y:auto;overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid var(--border);border-radius:8px;background:var(--panel2);">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TARƒ∞H</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TUTAR</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">A√áIKLAMA</th>
                  </tr>
                </thead>
                <tbody id="myPaymentsBody">
                  <tr><td colspan="3" style="padding:24px;text-align:center;color:var(--muted);">Y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: COMMISSION SUMMARY -->
        <div id="viewCommissionSummary" style="display:none;">
          <div class="sectionTitle">Satƒ±≈ü √ñzeti</div>
          
          <div class="card">
            <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
              <table style="width:100%;border-collapse:collapse;margin-top:16px;font-size:13px;">
                <thead style="background:var(--card);">
                  <tr>
                    <th style="padding:10px;text-align:left;border-bottom:2px solid var(--border);font-size:12px;">SATICI</th>
                    <th style="padding:10px;text-align:right;border-bottom:2px solid var(--border);font-size:12px;">GELƒ∞R</th>
                    <th style="padding:10px;text-align:right;border-bottom:2px solid var(--border);font-size:12px;">Gƒ∞DER</th>
                    <th style="padding:10px;text-align:right;border-bottom:2px solid var(--border);font-size:12px;">≈ûƒ∞RKET BR√úT (%80)</th>
                    <th style="padding:10px;text-align:right;border-bottom:2px solid var(--border);font-size:12px;">SATICI (%20)</th>
                    <th style="padding:10px;text-align:right;border-bottom:2px solid var(--border);font-size:12px;">≈ûƒ∞RKETE √ñDEME</th>
                    <th style="padding:10px;text-align:right;border-bottom:2px solid var(--border);font-size:12px;">VERGI MUAFƒ∞YETƒ∞ KALAN</th>
                    <th style="padding:10px;text-align:right;border-bottom:2px solid var(--border);font-size:12px;">≈ûƒ∞RKET NET</th>
                    <th style="padding:10px;text-align:center;border-bottom:2px solid var(--border);font-size:12px;">ƒ∞≈ûLEM</th>
                  </tr>
                </thead>
                <tbody id="commissionSummaryBody">
                  <tr><td colspan="9" style="padding:24px;text-align:center;color:var(--muted);">Y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card" style="margin-top:24px;">
            <h2>Tahsilat Giri≈üi</h2>
            <p style="color:#666;font-size:14px;margin-top:8px;">Bayilerden yapƒ±lan tahsilatlarƒ± kaydedin. Tahsilatlar ≈üirket hak edi≈üinden d√º≈üer.</p>
            
            <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
              <div style="display:grid;grid-template-columns:1fr 1fr 2fr auto;gap:12px;margin-top:16px;align-items:end;min-width:600px;">
                <div>
                  <label class="fieldLabel">Satƒ±cƒ±</label>
                  <select id="collectionSellerPin" class="input">
                    <option value="">Satƒ±cƒ± Se√ßin</option>
                  </select>
                </div>
                <div>
                  <label class="fieldLabel">Tahsilat Tutarƒ± (‚Ç∫)</label>
                  <input type="number" id="collectionAmount" class="input" placeholder="0.00" step="0.01" />
                </div>
                <div>
                  <label class="fieldLabel">A√ßƒ±klama</label>
                  <input type="text" id="collectionNote" class="input" placeholder="√ñdeme a√ßƒ±klamasƒ±" />
                </div>
                <div>
                  <button id="btnAddCollection" style="padding:12px 24px;background:#28a745;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-size:14px;">TAHSƒ∞LAT KAYDET</button>
                </div>
              </div>
            </div>
            <div id="statusCollection" style="margin-top:12px;padding:8px;border-radius:4px;display:none;"></div>
          </div>

          <!-- Satƒ±cƒ± Detay Paneli -->
          <div id="sellerDetailSection" style="display:none;margin-top:24px;">
            <div class="card" style="background:#fff3cd;border:2px solid #ffc107;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h2 id="sellerDetailTitle" style="margin:0;">Satƒ±cƒ± Detaylarƒ±</h2>
                <button onclick="hideSellerDetail()" style="padding:8px 16px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:700;">KAPAT</button>
              </div>
              
              <div style="background:#fff;padding:16px;border-radius:8px;margin-bottom:16px;">
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;">
                  <div>
                    <div style="color:#666;font-size:12px;margin-bottom:4px;">Toplam Gelir</div>
                    <div id="detailIncome" style="font-size:20px;font-weight:bold;color:green;">0 ‚Ç∫</div>
                  </div>
                  <div>
                    <div style="color:#666;font-size:12px;margin-bottom:4px;">Toplam Gider</div>
                    <div id="detailExpense" style="font-size:20px;font-weight:bold;color:red;">0 ‚Ç∫</div>
                  </div>
                  <div>
                    <div style="color:#666;font-size:12px;margin-bottom:4px;">Net Tutar</div>
                    <div id="detailNet" style="font-size:20px;font-weight:bold;">0 ‚Ç∫</div>
                  </div>
                  <div>
                    <div style="color:#666;font-size:12px;margin-bottom:4px;">Y√∂netici Hak Edi≈ü (%80)</div>
                    <div id="detailCompanyShare" style="font-size:20px;font-weight:bold;color:blue;">0 ‚Ç∫</div>
                  </div>
                </div>
              </div>

              <h3 style="margin-top:24px;margin-bottom:12px;">ƒ∞≈ülem Ge√ßmi≈üi</h3>
              <table style="width:100%;border-collapse:collapse;">
                <thead style="background:#f8f9fa;">
                  <tr>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">TARƒ∞H</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">Tƒ∞P</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid #dee2e6;">TUTAR</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">A√áIKLAMA</th>
                    <th style="padding:12px;text-align:center;border-bottom:2px solid #dee2e6;">ƒ∞≈ûLEM</th>
                  </tr>
                </thead>
                <tbody id="detailTransactionsBody">
                  <tr><td colspan="5" style="padding:24px;text-align:center;color:#666;">Y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tahsilat Ge√ßmi≈üi -->
          <div class="card" style="margin-top:24px;">
            <h2>Tahsilat Ge√ßmi≈üi</h2>
            <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
              <table style="width:100%;border-collapse:collapse;margin-top:16px;">
              <thead style="background:var(--card);">
                <tr>
                  <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);">TARƒ∞H</th>
                  <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);">BAYƒ∞ ADI</th>
                  <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);">TUTAR</th>
                  <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);">A√áIKLAMA</th>
                  <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);">ƒ∞≈ûLEM</th>
                </tr>
              </thead>
              <tbody id="paymentsHistoryBody">
                <tr><td colspan="5" style="padding:24px;text-align:center;color:var(--muted);">Y√ºkleniyor...</td></tr>
              </tbody>
            </table>
            </div>
          </div>
        </div>

        <!-- VIEW: PLATFORM PAYMENTS (AMAZON & SHOPIFY) -->
        <div id="viewPlatformPayments" style="display:none;">
          <div class="card">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px;">
              <div>
                <div class="fieldLabel">Platform</div>
                <select id="platformPaymentPlatform" class="input">
                  <option value="">Platform Se√ßin</option>
                  <option value="Amazon">Amazon</option>
                  <option value="Shopify">Shopify</option>
                </select>
              </div>
              
              <div>
                <div class="fieldLabel">Tutar (USD)</div>
                <input id="platformPaymentAmount" class="input" type="number" step="0.01" placeholder="√ñrn: 1250.50" />
              </div>
              
              <div>
                <div class="fieldLabel">Tarih</div>
                <input id="platformPaymentDate" class="input" type="date" />
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <div class="fieldLabel">A√ßƒ±klama (Opsiyonel)</div>
              <textarea id="platformPaymentNote" class="input" rows="2" placeholder="√ñrn: Ocak ayƒ± √∂demesi, Transfer numarasƒ± vb."></textarea>
            </div>

            <button class="actionBtn" id="btnAddPlatformPayment" type="button">√ñDEME KAYDET</button>

            <div class="statusBox" id="statusPlatformPayment" style="display:none;margin-top:12px;"></div>

            <h4 style="margin-top:24px;margin-bottom:12px;">√ñdeme Ge√ßmi≈üi</h4>

            <div style="max-height:500px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TARƒ∞H</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">PLATFORM</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TUTAR (USD)</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">A√áIKLAMA</th>
                    <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                  </tr>
                </thead>
                <tbody id="platformPaymentsBody">
                  <tr><td colspan="5" style="padding:24px;text-align:center;color:var(--muted);">Hen√ºz √∂deme kaydƒ± yok.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: PUANTAJ -->
        <div id="viewAttendance" style="display:none;">
          <div class="card">
            <h2 style="margin:0 0 20px 0;">Puantaj Sistemi</h2>
            
            <!-- Giri≈ü-√áƒ±kƒ±≈ü Butonlarƒ± -->
            <div style="background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px;">
              <h3 style="margin:0 0 16px 0;font-size:18px;">Bug√ºnk√º √áalƒ±≈üma Kaydƒ±</h3>
              
              <!-- Kullanƒ±cƒ± Se√ßimi (Y√∂neticiler i√ßin) -->
              <div id="supervisorUserSelectBox" style="display:none;margin-bottom:16px;">
                <label style="display:block;font-weight:700;font-size:13px;color:var(--muted);margin-bottom:6px;">PUANTAJ KAYDI YAPILACAK KULLANICI</label>
                <select id="supervisorUserSelect" class="input" style="margin:0;font-weight:700;">
                  <option value="">Kendim</option>
                </select>
              </div>
              
              <!-- Durum Kartƒ± -->
              <div id="attendanceStatus" style="background:white;border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;">
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">
                  <div>
                    <div style="font-size:11px;font-weight:900;color:var(--muted);margin-bottom:4px;">DURUM</div>
                    <div id="currentStatus" style="font-size:16px;font-weight:700;color:var(--text);">-</div>
                  </div>
                  <div>
                    <div style="font-size:11px;font-weight:900;color:var(--muted);margin-bottom:4px;">ƒ∞LK Gƒ∞Rƒ∞≈û</div>
                    <div id="firstCheckIn" style="font-size:16px;font-weight:700;color:var(--text);">-</div>
                  </div>
                  <div>
                    <div style="font-size:11px;font-weight:900;color:var(--muted);margin-bottom:4px;">TOPLAM ƒ∞Zƒ∞N</div>
                    <div id="totalBreakTime" style="font-size:16px;font-weight:700;color:#d97706;">-</div>
                  </div>
                </div>
              </div>
              
              <!-- Giri≈ü/√áƒ±kƒ±≈ü Ge√ßmi≈üi -->
              <div id="todayTimestamps" style="margin-bottom:16px;max-height:200px;overflow-y:auto;"></div>
              
              <!-- Butonlar -->
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <button id="btnCheckIn" style="background:#00c853;color:#fff;border:none;padding:18px;border-radius:12px;font-size:18px;font-weight:900;cursor:pointer;transition:all 0.2s;">
                  Gƒ∞Rƒ∞≈û
                </button>
                <button id="btnCheckOut" style="background:#ef4444;color:#fff;border:none;padding:18px;border-radius:12px;font-size:18px;font-weight:900;cursor:pointer;transition:all 0.2s;">
                  √áIKI≈û
                </button>
              </div>
              
              <div class="statusBox" id="statusAttendance" style="display:none;margin-top:12px;"></div>
            </div>

            <!-- Filtreler -->
            <div style="margin-bottom:16px;">
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">
                <div>
                  <div class="fieldLabel">BA≈ûLANGI√á TARƒ∞Hƒ∞</div>
                  <input id="attendanceStartDate" class="input" type="date" />
                </div>
                <div>
                  <div class="fieldLabel">Bƒ∞Tƒ∞≈û TARƒ∞Hƒ∞</div>
                  <input id="attendanceEndDate" class="input" type="date" />
                </div>
                <div id="attendanceUserFilterDiv" style="display:none;">
                  <div class="fieldLabel">KULLANICI</div>
                  <select id="attendanceUserFilter" class="input">
                    <option value="">T√ºm Kullanƒ±cƒ±lar</option>
                  </select>
                </div>
              </div>
              <button class="searchBtn" id="btnLoadAttendance" type="button" style="margin-top:12px;">KAYITLARI Y√úKLE</button>
            </div>

            <!-- ƒ∞statistikler -->
            <div id="attendanceStats" style="display:none;margin-bottom:20px;">
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                <div style="background:rgba(0,200,83,0.1);border:1px solid rgba(0,200,83,0.3);border-radius:12px;padding:16px;">
                  <div style="font-size:12px;font-weight:900;color:var(--muted);margin-bottom:4px;">TOPLAM G√úN</div>
                  <div id="statTotalDays" style="font-size:28px;font-weight:900;color:#065f46;">0</div>
                </div>
                <div style="background:rgba(33,150,243,0.1);border:1px solid rgba(33,150,243,0.3);border-radius:12px;padding:16px;">
                  <div style="font-size:12px;font-weight:900;color:var(--muted);margin-bottom:4px;">TOPLAM SAAT</div>
                  <div id="statTotalHours" style="font-size:28px;font-weight:900;color:#1565c0;">0</div>
                </div>
                <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:16px;">
                  <div style="font-size:12px;font-weight:900;color:var(--muted);margin-bottom:4px;">ORT. G√úNL√úK SAAT</div>
                  <div id="statAvgHours" style="font-size:28px;font-weight:900;color:#d97706;">0</div>
                </div>
                <div style="background:rgba(156,39,176,0.1);border:1px solid rgba(156,39,176,0.3);border-radius:12px;padding:16px;">
                  <div style="font-size:12px;font-weight:900;color:var(--muted);margin-bottom:4px;">TOPLAM ƒ∞Zƒ∞N (DK)</div>
                  <div id="statTotalBreak" style="font-size:28px;font-weight:900;color:#7b1fa2;">0</div>
                </div>
              </div>
            </div>

            <!-- Kayƒ±t Listesi -->
            <div class="tableWrap" id="attendanceTableWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Kullanƒ±cƒ±</th>
                    <th>Giri≈ü</th>
                    <th>√áƒ±kƒ±≈ü</th>
                    <th>√áalƒ±≈üma S√ºresi</th>
                    <th>ƒ∞zin (DK)</th>
                    <th>Not</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody id="attendanceTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: ADMIN -->
        <div id="viewAdmin" style="display:none;">
          <div class="sectionTitle">Y√∂netici Paneli</div>
          
          <!-- Konum Ayarlarƒ± -->
          <div class="card">
            <h3 style="margin-top:0;">üìç ƒ∞≈üyeri Konum Ayarlarƒ±</h3>
            <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">
              √áalƒ±≈üanlar giri≈ü/√ßƒ±kƒ±≈ü yaparken bu konumun belirtilen mesafe sƒ±nƒ±rƒ± i√ßinde olmalƒ±dƒ±r.
            </p>
            
            <div style="margin-bottom:16px;">
              <label class="fieldLabel">GOOGLE MAPS Lƒ∞NKƒ∞</label>
              <input id="workplaceMapsLink" class="input" type="text" placeholder="https://maps.app.goo.gl/... veya tam link" />
              <button class="searchBtn" id="btnParseMapsLink" style="margin-top:8px;width:100%;">Lƒ∞NKTEN KOORDƒ∞NATLARI √áEK</button>
            </div>
            
            <div style="text-align:center;margin:16px 0;color:var(--muted);font-weight:700;">‚îÄ‚îÄ‚îÄ VEYA ‚îÄ‚îÄ‚îÄ</div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px;">
              <div>
                <label class="fieldLabel">ENLEM (Latitude)</label>
                <input id="workplaceLat" class="input" type="number" step="0.000001" placeholder="41.0082" />
              </div>
              <div>
                <label class="fieldLabel">BOYLAM (Longitude)</label>
                <input id="workplaceLng" class="input" type="number" step="0.000001" placeholder="28.9784" />
              </div>
              <div>
                <label class="fieldLabel">MAX MESAFE (metre)</label>
                <input id="workplaceMaxDistance" class="input" type="number" min="10" max="500" value="50" />
              </div>
            </div>
            
            <div style="display:flex;gap:8px;">
              <button class="actionBtn" id="btnSaveWorkplaceLocation" style="flex:1;">KONUMU KAYDET</button>
              <button class="searchBtn" id="btnGetCurrentLocation" style="flex:1;">MEVCUT KONUMU AL</button>
            </div>
            
            <div class="statusBox" id="statusWorkplaceLocation" style="display:none;margin-top:12px;"></div>
            
            <div style="margin-top:12px;padding:12px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:8px;">
              <div style="font-size:12px;font-weight:700;color:#d97706;margin-bottom:4px;">üí° Google Maps Linkini Nasƒ±l Alƒ±rƒ±m?</div>
              <div style="font-size:12px;color:var(--muted);">
                1. Google Maps'te i≈üyerinizi bulun<br>
                2. "Payla≈ü" butonuna tƒ±klayƒ±n<br>
                3. "Link kopyala" dedikten sonra buraya yapƒ±≈ütƒ±rƒ±n<br>
                4. "Linkten Koordinatlarƒ± √áek" butonuna basƒ±n
              </div>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-top:0;">√ñzet Panel</h3>

            <div class="statsGrid" style="margin-top:10px;">
              <div class="stat"><div class="k">Toplam Raf</div><div class="v" id="stTotal">-</div></div>
              <div class="stat"><div class="k">Bo≈ü Raf</div><div class="v" id="stEmpty">-</div></div>
              <div class="stat"><div class="k">Dolu Raf</div><div class="v" id="stFull">-</div></div>
              <div class="stat"><div class="k">Toplam √úr√ºn Adedi</div><div class="v" id="stQty">-</div></div>
            </div>

            <div class="hintLine" id="stHint" style="margin-top:10px;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Kullanƒ±cƒ± Rolleri ve Giri≈ü Bilgileri</h3>
            
            <div style="max-height:500px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);margin-top:16px;">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ROL</th>
                    <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Gƒ∞Rƒ∞≈û ≈ûƒ∞FRESƒ∞</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">KULLANICI ADI</th>
                  </tr>
                </thead>
                <tbody>
                  <tr style="background:rgba(255,0,0,0.05);">
                    <td colspan="3" style="padding:8px 12px;font-weight:900;font-size:12px;color:#d32f2f;border-bottom:1px solid var(--border);">Y√ñNETƒ∞Cƒ∞</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Admin</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">67431</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Burak</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Admin</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">99999</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Mesut</td>
                  </tr>
                  
                  <tr style="background:rgba(0,123,255,0.05);">
                    <td colspan="3" style="padding:8px 12px;font-weight:900;font-size:12px;color:#007bff;border-bottom:1px solid var(--border);">PAKET√áI</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Paket√ßi</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">45823</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">G√∂kmen (Talep Yetkili)</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Paket√ßi</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">73621</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">≈ûaban</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Paket√ßi</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">29847</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Bahriye</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Paket√ßi</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">58392</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Dilara</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Paket√ßi</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">61704</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Veli</td>
                  </tr>
                  
                  <tr style="background:rgba(255,152,0,0.05);">
                    <td colspan="3" style="padding:8px 12px;font-weight:900;font-size:12px;color:#ff9800;border-bottom:1px solid var(--border);">STOK√áU</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Stok√ßu</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">34562</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Bahriye</td>
                  </tr>
                  
                  <tr style="background:rgba(156,39,176,0.05);">
                    <td colspan="3" style="padding:8px 12px;font-weight:900;font-size:12px;color:#9c27b0;border-bottom:1px solid var(--border);">KAYNAK</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Kaynak√ßƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">64829</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Emin</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Kaynak√ßƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">28573</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">ƒ∞lhami</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Kaynak√ßƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">91346</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Atasoy</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Kaynak√ßƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">53018</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Veysel</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Kaynak√ßƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">82947</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Abdullah</td>
                  </tr>
                  
                  <tr style="background:rgba(233,30,99,0.05);">
                    <td colspan="3" style="padding:8px 12px;font-weight:900;font-size:12px;color:#e91e63;border-bottom:1px solid var(--border);">LAZER</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Lazer Op.</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">72541</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Emre K.</td>
                  </tr>
                  
                  <tr style="background:rgba(76,175,80,0.05);">
                    <td colspan="3" style="padding:8px 12px;font-weight:900;font-size:12px;color:#4caf50;border-bottom:1px solid var(--border);">SATIN ALMA</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Satƒ±n Alma</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">41927</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">≈ûeyma A.</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Satƒ±n Alma</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">68503</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Evan</td>
                  </tr>
                  
                  <tr style="background:rgba(255,107,53,0.05);">
                    <td colspan="3" style="padding:8px 12px;font-weight:900;font-size:12px;color:#ff6b35;border-bottom:1px solid var(--border);">BOYACI</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Boyacƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">87654</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Nasƒ±r</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Boyacƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">87655</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Talha</td>
                  </tr>
                  
                  <tr style="background:rgba(147,51,234,0.05);">
                    <td colspan="3" style="padding:8px 12px;font-weight:900;font-size:12px;color:#9333ea;border-bottom:1px solid var(--border);">ETSY SATI≈ûLARI</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">ETSY Satƒ±cƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">23764</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Murat O.</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">ETSY Satƒ±cƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">190706</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Aykut P.</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">ETSY Satƒ±cƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">190707</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">√ñznur P.</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">ETSY Satƒ±cƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">14698</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">√ñmer Faruk A.</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">ETSY Satƒ±cƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">76312</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Hasibe G.</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">ETSY Satƒ±cƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">31849</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Burak A.</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">ETSY Satƒ±cƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">62957</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Rukiye A.</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">ETSY Satƒ±cƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">48731</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Emre K.</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">ETSY Satƒ±cƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">95126</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">M√º≈üerref K.</td>
                  </tr>
                  <tr>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">ETSY Satƒ±cƒ±</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;font-family:monospace;font-weight:700;">52384</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">Komisyonlu Satƒ±≈ü</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card" id="sellerDetailSection" style="margin-top:14px;display:none;">
            <h3 style="margin-top:0;display:flex;justify-content:space-between;align-items:center;">
              <span id="sellerDetailName">Satƒ±cƒ± Detaylarƒ±</span>
              <button onclick="hideSellerDetail()" style="background:#6c757d;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:700;">KAPAT</button>
            </h3>
            
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;">
              <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:20px;border-radius:10px;color:#fff;">
                <div style="font-size:13px;font-weight:700;opacity:0.9;margin-bottom:8px;">TOPLAM GELƒ∞R</div>
                <div id="sellerDetailIncome" style="font-size:26px;font-weight:900;">0 ‚Ç∫</div>
              </div>
              <div style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);padding:20px;border-radius:10px;color:#fff;">
                <div style="font-size:13px;font-weight:700;opacity:0.9;margin-bottom:8px;">TOPLAM Gƒ∞DER</div>
                <div id="sellerDetailExpense" style="font-size:26px;font-weight:900;">0 ‚Ç∫</div>
              </div>
              <div style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);padding:20px;border-radius:10px;color:#fff;">
                <div style="font-size:13px;font-weight:700;opacity:0.9;margin-bottom:8px;">NET TUTAR</div>
                <div id="sellerDetailNet" style="font-size:26px;font-weight:900;">0 ‚Ç∫</div>
              </div>
              <div style="background:linear-gradient(135deg, #fa709a 0%, #fee140 100%);padding:20px;border-radius:10px;color:#fff;">
                <div style="font-size:13px;font-weight:700;opacity:0.9;margin-bottom:8px;">Y√ñNETƒ∞Cƒ∞ HAK EDƒ∞≈û (%80)</div>
                <div id="sellerDetailCommission" style="font-size:26px;font-weight:900;">0 ‚Ç∫</div>
              </div>
            </div>

            <h4 style="margin-top:24px;margin-bottom:12px;">ƒ∞≈ülem Ge√ßmi≈üi</h4>
            
            <div style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TARƒ∞H</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">Tƒ∞P</th>
                    <th style="padding:12px;text-align:right;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">TUTAR</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">A√áIKLAMA</th>
                  </tr>
                </thead>
                <tbody id="sellerDetailTransactions">
                  <tr><td colspan="4" style="padding:24px;text-align:center;color:var(--muted);">ƒ∞≈ülem y√ºkleniyor...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">√ñnemli Mail ve ≈ûifre Y√∂netimi</h3>
            
            <div style="margin-bottom:20px;">
              <div style="display:grid;grid-template-columns:1fr 1fr 2fr auto;gap:10px;align-items:end;">
                <div>
                  <label style="display:block;font-weight:700;font-size:13px;color:var(--muted);margin-bottom:6px;">SERVƒ∞S ADI</label>
                  <input id="credentialService" class="input" type="text" placeholder="√ñrn: Gmail, AWS, Shopify" style="margin:0;" />
                </div>
                <div>
                  <label style="display:block;font-weight:700;font-size:13px;color:var(--muted);margin-bottom:6px;">E-MAIL / KULLANICI ADI</label>
                  <input id="credentialEmail" class="input" type="text" placeholder="email@example.com" style="margin:0;" />
                </div>
                <div>
                  <label style="display:block;font-weight:700;font-size:13px;color:var(--muted);margin-bottom:6px;">≈ûƒ∞FRE</label>
                  <input id="credentialPassword" class="input" type="text" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="margin:0;" />
                </div>
                <button class="actionBtn" id="btnAddCredential" type="button" style="margin:0;height:42px;display:flex;align-items:center;justify-content:center;">EKLE</button>
              </div>
            </div>

            <div class="statusBox" id="statusCredentials" style="display:none;margin-bottom:12px;"></div>

            <div style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel2);">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:var(--panel1);position:sticky;top:0;">
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">SERVƒ∞S</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">E-MAIL / KULLANICI</th>
                    <th style="padding:12px;text-align:left;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">≈ûƒ∞FRE</th>
                    <th style="padding:12px;text-align:center;border-bottom:2px solid var(--border);font-weight:900;font-size:13px;">ƒ∞≈ûLEM</th>
                  </tr>
                </thead>
                <tbody id="credentialsBody">
                  <tr><td colspan="4" style="padding:24px;text-align:center;color:var(--muted);">Hen√ºz kayƒ±t yok.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Toplu √úretim Talimatƒ± Y√ºkleme</h3>
            
            <div style="margin-bottom:12px;color:var(--muted);font-size:14px;font-weight:800;">
              Her satƒ±ra bir √ºr√ºn yazƒ±n. Format: <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">√úr√ºnKodu,Tip,URL</code>
              <br>Tip: <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">pdf</code>, <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">image</code> veya <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">link</code>
            </div>

            <textarea id="bulkInstructionsInput" class="input" rows="10" placeholder="√ñrnek:
7001,pdf,https://firebasestorage.googleapis.com/.../talimat.pdf
7002,image,https://drive.google.com/.../resim.png
7003,link,https://drive.google.com/file/d/..." style="font-family:monospace;font-size:13px;"></textarea>

            <button class="actionBtn" id="btnBulkUploadInstructions" type="button" style="margin-top:12px;">TOPLU Y√úKLE</button>

            <div class="statusBox" id="statusBulkInstructions" style="display:none;margin-top:12px;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">Toplu Paketleme Talimatƒ± Y√ºkleme</h3>
            
            <div style="margin-bottom:12px;color:var(--muted);font-size:14px;font-weight:800;">
              Her satƒ±ra bir √ºr√ºn yazƒ±n. Format: <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">√úr√ºnKodu,Tip,URL</code>
              <br>Tip: <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">pdf</code>, <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">image</code> veya <code style="background:var(--panel2);padding:2px 6px;border-radius:4px;">link</code>
            </div>

            <textarea id="bulkPackagingInput" class="input" rows="10" placeholder="√ñrnek:
7001,pdf,https://firebasestorage.googleapis.com/.../paketleme.pdf
7002,image,https://drive.google.com/.../resim.png
7003,link,https://drive.google.com/file/d/..." style="font-family:monospace;font-size:13px;"></textarea>

            <button class="actionBtn" id="btnBulkUploadPackaging" type="button" style="margin-top:12px;">TOPLU Y√úKLE</button>

            <div class="statusBox" id="statusBulkPackaging" style="display:none;margin-top:12px;"></div>
          </div>

          <!-- Bildirim Ayarlarƒ± Paneli -->
          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">ü§ñ Telegram Bildirim Kurulumu</h3>
            <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">Mobil bildirimler i√ßin Telegram botunu kurun (iOS/Android destekler)</p>
            
            <div style="background:var(--panel2);padding:16px;border-radius:8px;margin-bottom:16px;">
              <div style="font-weight:600;margin-bottom:12px;">üì± Kurulum Adƒ±mlarƒ±:</div>
              <ol style="margin:0;padding-left:20px;font-size:13px;line-height:1.8;">
                <li>Telegram'da <a href="https://t.me/BotFather" target="_blank" style="color:#2196F3;">@BotFather</a> ile konu≈üun</li>
                <li><code>/newbot</code> yazƒ±p bot olu≈üturun</li>
                <li>Size verilen <strong>BOT TOKEN</strong>'ƒ± kopyalayƒ±n</li>
                <li>A≈üaƒüƒ±ya yapƒ±≈ütƒ±rƒ±p "Bot Token Kaydet" basƒ±n</li>
                <li>Botunuza Telegram'dan herhangi bir mesaj g√∂nderin</li>
                <li>"Chat ID Al" butonuna basƒ±n</li>
              </ol>
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;font-weight:600;margin-bottom:8px;">Bot Token:</label>
              <div style="display:flex;gap:8px;">
                <input type="text" id="telegramBotToken" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz" 
                  style="flex:1;padding:10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:monospace;">
                <button onclick="saveBotToken()" style="padding:10px 20px;background:#2196F3;color:white;border:none;border-radius:6px;cursor:pointer;white-space:nowrap;">
                  üíæ Bot Token Kaydet
                </button>
              </div>
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;font-weight:600;margin-bottom:8px;">Chat ID Al:</label>
              <button onclick="getTelegramChatId()" style="width:100%;padding:12px;background:#4CAF50;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                üì® Chat ID Al ve Kaydet
              </button>
              <div style="font-size:12px;color:var(--muted);margin-top:6px;">
                ‚ö†Ô∏è √ñnce botunuza Telegram'dan mesaj g√∂ndermelisiniz!
              </div>
            </div>

            <div id="telegramSetupStatus" style="display:none;padding:12px;background:var(--panel2);border-radius:8px;font-size:13px;margin-top:12px;"></div>
          </div>

          <!-- Kullanƒ±cƒ± Chat ID Y√∂netimi -->
          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">üë• Kullanƒ±cƒ± Telegram Baƒülantƒ±larƒ±</h3>
            <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">Her kullanƒ±cƒ± i√ßin Telegram Chat ID'sini girin</p>
            
            <div style="background:rgba(33,150,243,0.1);padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px;">
              <strong>üí° Chat ID Nasƒ±l √ñƒürenilir:</strong><br>
              1. Kullanƒ±cƒ± bota mesaj g√∂ndersin<br>
              2. <code style="background:rgba(0,0,0,0.1);padding:2px 6px;border-radius:3px;">https://api.telegram.org/bot&lt;TOKEN&gt;/getUpdates</code> linkine gidin<br>
              3. <code>"chat":{"id":123456789</code> sayƒ±sƒ±nƒ± kopyalayƒ±n
            </div>

            <div style="overflow-x:auto;">
              <table style="width:100%;border-collapse:collapse;font-size:13px;">
                <thead>
                  <tr style="background:var(--panel2);text-align:left;">
                    <th style="padding:10px;border:1px solid var(--border);">ƒ∞sim</th>
                    <th style="padding:10px;border:1px solid var(--border);">Rol</th>
                    <th style="padding:10px;border:1px solid var(--border);">PIN</th>
                    <th style="padding:10px;border:1px solid var(--border);">Telegram Chat ID</th>
                    <th style="padding:10px;border:1px solid var(--border);">ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody id="telegramUsersTableBody">
                  <!-- JavaScript ile doldurulacak -->
                </tbody>
              </table>
            </div>

            <button onclick="saveTelegramUsers()" style="margin-top:16px;width:100%;padding:12px;background:#4CAF50;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;">
              üíæ T√ºm Deƒüi≈üiklikleri Kaydet
            </button>

            <div id="telegramUsersStatus" style="display:none;margin-top:12px;padding:12px;background:var(--panel2);border-radius:8px;font-size:13px;"></div>
          </div>

          <!-- Bildirim Kurallarƒ± Paneli -->
          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">üîî Bildirim Ayarlarƒ±</h3>
            <p style="font-size:13px;color:var(--muted);margin-bottom:20px;">Hangi i≈ülemde kimlerin bildirim alacaƒüƒ±nƒ± se√ßin</p>
            
            <div style="display:grid;gap:16px;" id="notificationRulesContainer">
              <!-- Rafa √úr√ºn Eklendi -->
              <div style="padding:16px;background:var(--panel2);border-radius:8px;border:2px solid var(--border);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                  <div>
                    <strong style="font-size:15px;">üì¶ Rafa √úr√ºn Eklendi</strong>
                    <div style="font-size:12px;color:var(--muted);margin-top:4px;">Paket√ßi raf numarasƒ± girdiƒüinde</div>
                  </div>
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" checked data-event="shelf_product_added" onchange="toggleNotificationEventStatus(this)">
                    <span style="font-size:12px;font-weight:600;">Aktif</span>
                  </label>
                </div>
                <div style="margin-top:12px;">
                  <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px;">Bildirim Alacak Kullanƒ±cƒ±lar:</label>
                  <select multiple id="notify_shelf_product_added" style="width:100%;min-height:120px;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                    <!-- JavaScript ile doldurulacak -->
                  </select>
                  <div style="font-size:11px;color:var(--muted);margin-top:6px;">üí° Ctrl tu≈üuna basƒ±lƒ± tutarak √ßoklu se√ßim yapabilirsiniz</div>
                </div>
              </div>

              <!-- √úretim Talebi -->
              <div style="padding:16px;background:var(--panel2);border-radius:8px;border:2px solid var(--border);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                  <div>
                    <strong style="font-size:15px;">üî• √úretim Talebi</strong>
                    <div style="font-size:12px;color:var(--muted);margin-top:4px;">Paket√ßi √ºretim talep ettiƒüinde</div>
                  </div>
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" checked data-event="production_request" onchange="toggleNotificationEventStatus(this)">
                    <span style="font-size:12px;font-weight:600;">Aktif</span>
                  </label>
                </div>
                <div style="margin-top:12px;">
                  <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px;">Bildirim Alacak Kullanƒ±cƒ±lar:</label>
                  <select multiple id="notify_production_request" style="width:100%;min-height:120px;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                  </select>
                  <div style="font-size:11px;color:var(--muted);margin-top:6px;">üí° Ctrl tu≈üuna basƒ±lƒ± tutarak √ßoklu se√ßim yapabilirsiniz</div>
                </div>
              </div>

              <!-- √úretim Tamamlandƒ± -->
              <div style="padding:16px;background:var(--panel2);border-radius:8px;border:2px solid var(--border);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                  <div>
                    <strong style="font-size:15px;">‚úÖ √úretim Tamamlandƒ±</strong>
                    <div style="font-size:12px;color:var(--muted);margin-top:4px;">Kaynak√ßƒ±/Lazerci "√ºretildi" i≈üaretlediƒüinde</div>
                  </div>
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" checked data-event="production_completed" onchange="toggleNotificationEventStatus(this)">
                    <span style="font-size:12px;font-weight:600;">Aktif</span>
                  </label>
                </div>
                <div style="margin-top:12px;">
                  <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px;">Bildirim Alacak Kullanƒ±cƒ±lar:</label>
                  <select multiple id="notify_production_completed" style="width:100%;min-height:120px;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                  </select>
                  <div style="font-size:11px;color:var(--muted);margin-top:6px;">üí° Ctrl tu≈üuna basƒ±lƒ± tutarak √ßoklu se√ßim yapabilirsiniz</div>
                </div>
              </div>

              <!-- Malzeme Talebi -->
              <div style="padding:16px;background:var(--panel2);border-radius:8px;border:2px solid var(--border);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                  <div>
                    <strong style="font-size:15px;">üõí Malzeme Talebi</strong>
                    <div style="font-size:12px;color:var(--muted);margin-top:4px;">Kullanƒ±cƒ± malzeme talep ettiƒüinde</div>
                  </div>
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" checked data-event="material_request" onchange="toggleNotificationEventStatus(this)">
                    <span style="font-size:12px;font-weight:600;">Aktif</span>
                  </label>
                </div>
                <div style="margin-top:12px;">
                  <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px;">Bildirim Alacak Kullanƒ±cƒ±lar:</label>
                  <select multiple id="notify_material_request" style="width:100%;min-height:120px;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                  </select>
                  <div style="font-size:11px;color:var(--muted);margin-top:6px;">üí° Ctrl tu≈üuna basƒ±lƒ± tutarak √ßoklu se√ßim yapabilirsiniz</div>
                </div>
              </div>

              <!-- Malzeme Temin Edildi -->
              <div style="padding:16px;background:var(--panel2);border-radius:8px;border:2px solid var(--border);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                  <div>
                    <strong style="font-size:15px;">‚úÖ Malzeme Temin Edildi</strong>
                    <div style="font-size:12px;color:var(--muted);margin-top:4px;">Satƒ±n alma malzeme temin ettiƒüinde</div>
                  </div>
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" checked data-event="material_completed" onchange="toggleNotificationEventStatus(this)">
                    <span style="font-size:12px;font-weight:600;">Aktif</span>
                  </label>
                </div>
                <div style="margin-top:12px;">
                  <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px;">Bildirim Alacak Kullanƒ±cƒ±lar:</label>
                  <select multiple id="notify_material_completed" style="width:100%;min-height:120px;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                  </select>
                  <div style="font-size:11px;color:var(--muted);margin-top:6px;">üí° Ctrl tu≈üuna basƒ±lƒ± tutarak √ßoklu se√ßim yapabilirsiniz</div>
                </div>
              </div>

              <!-- ƒ∞≈üe Giri≈ü/√áƒ±kƒ±≈ü -->
              <div style="padding:16px;background:var(--panel2);border-radius:8px;border:2px solid var(--border);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                  <div>
                    <strong style="font-size:15px;">üë§ ƒ∞≈üe Giri≈ü/√áƒ±kƒ±≈ü</strong>
                    <div style="font-size:12px;color:var(--muted);margin-top:4px;">Kullanƒ±cƒ± puantaj i≈ülemi yaptƒ±ƒüƒ±nda</div>
                  </div>
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" checked data-event="attendance" onchange="toggleNotificationEventStatus(this)">
                    <span style="font-size:12px;font-weight:600;">Aktif</span>
                  </label>
                </div>
                <div style="margin-top:12px;">
                  <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px;">Bildirim Alacak Kullanƒ±cƒ±lar:</label>
                  <select multiple id="notify_attendance" style="width:100%;min-height:120px;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                  </select>
                  <div style="font-size:11px;color:var(--muted);margin-top:6px;">üí° Ctrl tu≈üuna basƒ±lƒ± tutarak √ßoklu se√ßim yapabilirsiniz</div>
                </div>
              </div>
            </div>

            <!-- Kaydet Butonu -->
            <button onclick="saveAllNotificationRecipients()" style="margin-top:16px;width:100%;padding:14px;background:#4CAF50;color:white;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(76,175,80,0.3);">
              üíæ Bildirim Alƒ±cƒ±larƒ±nƒ± Kaydet
            </button>
            <div id="notificationSaveStatus" style="display:none;margin-top:12px;padding:12px;border-radius:8px;font-size:13px;"></div>

            <div style="margin-top:16px;padding:12px;background:rgba(33,150,243,0.1);border-radius:8px;font-size:13px;">
              üí° <strong>Bilgi:</strong> Bildirimler Firebase Cloud Messaging ile g√∂nderilir. Mobil ve masa√ºst√ºnde √ßalƒ±≈üƒ±r.
            </div>

            <button onclick="testIOSNotification()" style="margin-top:16px;width:100%;padding:12px;background:#4CAF50;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">
              üîî Test Telegram Bildirimi G√∂nder
            </button>

            <div id="notificationTestStatus" style="display:none;margin-top:12px;padding:12px;background:var(--panel2);border-radius:8px;font-size:13px;"></div>
          </div>

          <div class="card" style="margin-top:14px;">
            <h3 style="margin-top:0;">ƒ∞≈ülem Ge√ßmi≈üi (LOG)</h3>

            <div style="margin-bottom:12px;">
              <div style="font-weight:900;font-size:14px;color:var(--muted);margin-bottom:6px;">ƒ∞≈ûLEM Tƒ∞Pƒ∞NE G√ñRE Fƒ∞LTRELE:</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:8px;">
                <button class="searchBtn" id="btnLogPut" type="button" style="font-size:13px;padding:10px;">RAFA KOY</button>
                <button class="searchBtn" id="btnLogClear" type="button" style="font-size:13px;padding:10px;">RAF BO≈ûALT</button>
                <button class="searchBtn" id="btnLogDecrease" type="button" style="font-size:13px;padding:10px;">ADET AZALT</button>
                <button class="searchBtn" id="btnLogMaterial" type="button" style="font-size:13px;padding:10px;">MALZEME TALEBƒ∞</button>
                <button class="searchBtn" id="btnLogProduction" type="button" style="font-size:13px;padding:10px;">√úRETƒ∞M</button>
                <button class="searchBtn" id="btnLogAccounts" type="button" style="font-size:13px;padding:10px;">CARƒ∞ HESAPLAR</button>
                <button class="searchBtn" id="btnLogPayments" type="button" style="font-size:13px;padding:10px;">PERSONEL √ñDEMELERƒ∞</button>
                <button class="searchBtn" id="btnLogCommission" type="button" style="font-size:13px;padding:10px;">KOMƒ∞SYON</button>
                <button class="searchBtn" id="btnLogAllActions" type="button" style="font-size:13px;padding:10px;">T√úM ƒ∞≈ûLEMLER</button>
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <div style="font-weight:900;font-size:14px;color:var(--muted);margin-bottom:6px;">ROLE G√ñRE Fƒ∞LTRELE:</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;">
                <button class="searchBtn" id="btnLogAdmin" type="button" style="font-size:13px;padding:10px;">Y√ñNETƒ∞Cƒ∞</button>
                <button class="searchBtn" id="btnLogPacker" type="button" style="font-size:13px;padding:10px;">PAKET√áƒ∞</button>
                <button class="searchBtn" id="btnLogStower" type="button" style="font-size:13px;padding:10px;">RAF Dƒ∞ZEN</button>
                <button class="searchBtn" id="btnLogWelder" type="button" style="font-size:13px;padding:10px;">√úRETƒ∞M</button>
                <button class="searchBtn" id="btnLogPurchase" type="button" style="font-size:13px;padding:10px;">SATIN ALMA</button>
                <button class="searchBtn" id="btnLogAllRoles" type="button" style="font-size:13px;padding:10px;">T√úM ROLLER</button>
              </div>
            </div>

            <div class="adminRow">
              <input id="logLimit" class="input" type="number" min="10" max="10000" value="1000" style="margin:0;" />
              <button class="searchBtn" id="btnLoadLogs" type="button">LOG Y√úKLE</button>
            </div>

            <div class="statusBox" id="statusLogs" style="margin-top:12px;display:none;"></div>

            <div class="tableWrap" id="logsWrap" style="display:none;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Kullanƒ±cƒ±</th>
                    <th>ƒ∞≈ülem</th>
                    <th>Raf</th>
                    <th>√úr√ºn</th>
                    <th>Adet</th>
                    <th>Detay</th>
                  </tr>
                </thead>
                <tbody id="logsBody"></tbody>
              </table>
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>

  <!-- LOGIN (module DI≈ûI) -->
  <script>
    // ====== PINLER ======
    const ADMIN_PINS = new Set(["67431","99999"]);
    const PACKER_PINS = new Set(["45823","73621","29847","58392","61704"]);
    const STOWER_PINS = new Set(["34562"]);
    const WELDER_PINS = new Set(["64829","28573","91346","53018","82947"]);
    const LASER_PINS = new Set(["72541"]);
    const PURCHASE_PINS = new Set(["41927","68503"]);
    const PAINTER_PINS = new Set(["87654","87655"]);
    const COMMISSION_PINS = new Set(["23764","190706","190707","14698","76312","31849","62957","48731","95126","52384"]);

    // PIN setlerini global scope'a ekle
    window.ADMIN_PINS = ADMIN_PINS;
    window.PACKER_PINS = PACKER_PINS;
    window.STOWER_PINS = STOWER_PINS;
    window.WELDER_PINS = WELDER_PINS;
    window.LASER_PINS = LASER_PINS;
    window.PURCHASE_PINS = PURCHASE_PINS;
    window.PAINTER_PINS = PAINTER_PINS;
    window.COMMISSION_PINS = COMMISSION_PINS;

    window.__SESSION = { role: null, pin: null };

    // PIN-isim e≈üle≈ütirmesi
    const PIN_NAMES = {
      "67431": "Burak",
      "99999": "Mesut",
      "45823": "G√∂kmen",
      "73621": "≈ûaban",
      "29847": "Bahriye",
      "58392": "Dilara",
      "61704": "Veli",
      "34562": "Bahriye",
      "64829": "Emin",
      "28573": "ƒ∞lhami",
      "91346": "Atasoy",
      "53018": "Veysel",
      "82947": "Abdullah",
      "72541": "Emre K.",
      "41927": "≈ûeyma A.",
      "68503": "Evan",
      "23764": "Murat O.",
      "190706": "Aykut P.",
      "190707": "√ñznur P.",
      "14698": "√ñmer Faruk A.",
      "76312": "Hasibe G.",
      "31849": "Burak A.",
      "62957": "Rukiye A.",
      "48731": "Emre K.",
      "95126": "M√º≈üerref K.",
      "52384": "Komisyonlu Satƒ±≈ü",
      "87654": "Nasƒ±r",
      "87655": "Talha"
    };

    // Puantaj y√∂neticileri - hangi kullanƒ±cƒ± hangi rollerin puantajƒ±nƒ± y√∂netebilir
    const ATTENDANCE_SUPERVISORS = {
      "64829": ["welder", "painter"],  // Emin, kaynak√ßƒ± ve boyacƒ± puantajlarƒ±nƒ± y√∂netebilir
      "61704": ["packer", "stower"],   // Veli, paket√ßi ve stok√ßu puantajlarƒ±nƒ± y√∂netebilir
      "41927": ["68503"]               // ≈ûeyma A., Evan'ƒ±n puantajƒ±nƒ± y√∂netebilir (√∂zel PIN)
    };

    function getNameByPin(pin){
      return PIN_NAMES[pin] || pin;
    }

    // PIN_NAMES'i global scope'a da ekle (module script i√ßinden eri≈üim i√ßin)
    window.PIN_NAMES = PIN_NAMES;
    window.ATTENDANCE_SUPERVISORS = ATTENDANCE_SUPERVISORS;

    const loginView = document.getElementById("loginView");
    const appView   = document.getElementById("appView");
    const pwInput   = document.getElementById("pwInput");
    const loginBtn  = document.getElementById("loginBtn");
    const loginNote = document.getElementById("loginNote");
    const roleLine  = document.getElementById("roleLine");
    const rememberMe = document.getElementById("rememberMe");

    function setLoginNote(msg, type){
      loginNote.className = "note" + (type ? " " + type : "");
      loginNote.textContent = msg;
    }

    function showApp(){
      loginView.style.display="none";
      appView.style.display="block";
    }

    function showLogin(){
      appView.style.display="none";
      loginView.style.display="flex";
      
      // "Beni Hatƒ±rla" i≈üaretli deƒüilse ≈üifreyi temizle
      if(!rememberMe || !rememberMe.checked) {
        pwInput.value="";
      }
      
      setLoginNote("Sadece yetkili kullanƒ±cƒ±lar eri≈üebilir.", "");
      window.__SESSION = { role: null, pin: null };
    }

    function getRoleByPin(pin){
      if(ADMIN_PINS.has(pin)) return "admin";
      if(PACKER_PINS.has(pin)) return "packer";
      if(STOWER_PINS.has(pin)) return "stower";
      if(WELDER_PINS.has(pin)) return "welder";
      if(LASER_PINS.has(pin)) return "welder";
      if(PURCHASE_PINS.has(pin)) return "purchase";
      if(PAINTER_PINS.has(pin)) return "painter";
      if(COMMISSION_PINS.has(pin)) return "commission";
      return null;
    }

    function roleBadge(role){
      if(role==="admin")  return `<span class="badge b-admin">Y√ñNETƒ∞Cƒ∞</span>`;
      if(role==="packer") return `<span class="badge b-packer">PAKET√áƒ∞</span>`;
      if(role==="stower") return `<span class="badge b-stower">RAF Dƒ∞ZEN</span>`;
      if(role==="welder") return `<span class="badge b-welder">√úRETƒ∞M</span>`;
      if(role==="purchase") return `<span class="badge b-admin">SATIN ALMA</span>`;
      if(role==="painter") return `<span class="badge" style="background:#ff6b35;color:#fff;">BOYACI</span>`;
      if(role==="commission") return `<span class="badge" style="background:#9333ea;color:#fff;">ETSY SATI≈ûLARI</span>`;
      return `<span class="badge">-</span>`;
    }

    function doLogin(){
      const v = (pwInput.value || "").trim();
      const role = getRoleByPin(v);

      if(!role){
        setLoginNote("≈ûifre yanlƒ±≈ü.", "error");
        // Yanlƒ±≈ü ≈üifre kaydedilmi≈üse temizle
        localStorage.removeItem('rememberedPin');
        if(rememberMe) rememberMe.checked = false;
        return;
      }

      window.__SESSION = { role, pin: v };

      // "Beni Hatƒ±rla" i≈üaretliyse localStorage'a kaydet
      if(rememberMe && rememberMe.checked) {
        localStorage.setItem('rememberedPin', v);
      } else {
        localStorage.removeItem('rememberedPin');
      }

      setLoginNote("Giri≈ü ba≈üarƒ±lƒ±.", "ok");
      showApp();

      if(roleLine){
        const userName = getNameByPin(v);
        if(role === "commission") {
          // ETSY satƒ±cƒ±larƒ± i√ßin √∂zel g√∂r√ºn√ºm
          roleLine.innerHTML = `
            <span style="display:inline-flex;align-items:center;gap:8px;">
              <svg width="24" height="24" viewBox="0 0 100 100" style="vertical-align:middle;">
                <rect width="100" height="100" rx="15" fill="#F1641E"/>
                <text x="50" y="70" font-family="Arial, sans-serif" font-size="60" font-weight="bold" fill="white" text-anchor="middle">E</text>
              </svg>
              <span style="font-weight:600;">Seller</span>
              <span style="opacity:0.6;">|</span>
              <span>${userName}</span>
            </span>
          `;
        } else {
          roleLine.innerHTML = `${roleBadge(role)} | ${userName}`;
        }
      }

      if (window.startFirebase) window.startFirebase();
    }

    loginBtn.addEventListener("click", doLogin);
    pwInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") doLogin(); });

    // Sayfa y√ºklenirken kaydedilmi≈ü ≈üifreyi y√ºkle ve otomatik giri≈ü yap
    const rememberedPin = localStorage.getItem('rememberedPin');
    if(rememberedPin) {
      pwInput.value = rememberedPin;
      if(rememberMe) rememberMe.checked = true;
      setTimeout(() => doLogin(), 100);
    } else {
      showLogin();
    }
  </script>

  <!-- FIREBASE + UYGULAMA (module) -->
  firebase deploy  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyC‚Ä¶‚Ä¶",
      authDomain: "depo-paketleme.firebaseapp.com",
      projectId: "depo-paketleme",
      storageBucket: "depo-paketleme.appspot.com",
      messagingSenderId: "2429493‚Ä¶",
      appId: "1:24294‚Ä¶"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, updateDoc, addDoc, deleteDoc,
      onSnapshot, serverTimestamp, writeBatch,
      getDoc, getDocs, query, limit, orderBy, where
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging.js";

    const tabbar   = document.getElementById("tabbar");
    const logoutBtn= document.getElementById("logoutBtn");

    const tabPut   = document.getElementById("tabPut");
    const tabClear = document.getElementById("tabClear");
    const tabSearch= document.getElementById("tabSearch");
    const tabRack  = document.getElementById("tabRack");
    const tabRequest= document.getElementById("tabRequest");
    const tabMaterialRequest= document.getElementById("tabMaterialRequest");
    const tabWelder= document.getElementById("tabWelder");
    const tabWelderRequests= document.getElementById("tabWelderRequests");
    const tabProduction= document.getElementById("tabProduction");
    const tabPurchase= document.getElementById("tabPurchase");
    const tabInstructions= document.getElementById("tabInstructions");
    const tabPackaging= document.getElementById("tabPackaging");
    const tabPayments= document.getElementById("tabPayments");
    const tabAccounts= document.getElementById("tabAccounts");
    const tabCommissionSummary= document.getElementById("tabCommissionSummary");
    const tabCommission= document.getElementById("tabCommission");
    const tabPlatformPayments= document.getElementById("tabPlatformPayments");
    const tabAttendance= document.getElementById("tabAttendance");
    const tabAdmin = document.getElementById("tabAdmin");

    const viewPut  = document.getElementById("viewPut");
    const viewClear= document.getElementById("viewClear");
    const viewSearch= document.getElementById("viewSearch");
    const viewRack = document.getElementById("viewRack");
    const viewRequest= document.getElementById("viewRequest");
    const viewMaterialRequest= document.getElementById("viewMaterialRequest");
    const viewWelder= document.getElementById("viewWelder");
    const viewWelderRequests= document.getElementById("viewWelderRequests");
    const viewProduction= document.getElementById("viewProduction");
    const viewPurchase= document.getElementById("viewPurchase");
    const viewInstructions= document.getElementById("viewInstructions");
    const viewPackaging= document.getElementById("viewPackaging");
    const viewPayments= document.getElementById("viewPayments");
    const viewAccounts= document.getElementById("viewAccounts");
    const viewCommissionSummary= document.getElementById("viewCommissionSummary");
    const viewCommission= document.getElementById("viewCommission");
    const viewPlatformPayments= document.getElementById("viewPlatformPayments");
    const viewAttendance= document.getElementById("viewAttendance");
    const viewAdmin= document.getElementById("viewAdmin");

    const inProduct  = document.getElementById("inProduct");
    const inShelfNum = document.getElementById("inShelfNum");
    const inQty      = document.getElementById("inQty");
    const btnPut     = document.getElementById("btnPut");
    const statusPut  = document.getElementById("statusPut");

    const outShelfNum     = document.getElementById("outShelfNum");
    const outProductCode  = document.getElementById("outProductCode");
    const productListContainer = document.getElementById("productListContainer");
    const clearProductBox = document.getElementById("clearProductBox");
    const btnClear        = document.getElementById("btnClear");
    const statusClear     = document.getElementById("statusClear");

    // ‚úÖ yeni alanlar (adet azalt)
    const clearQtyBox    = document.getElementById("clearQtyBox");
    const outReduceQty   = document.getElementById("outReduceQty");

    const searchCode   = document.getElementById("searchCode");
    const btnSearch    = document.getElementById("btnSearch");
    const statusSearch = document.getElementById("statusSearch");
    const searchWrap   = document.getElementById("searchWrap");
    const searchBody   = document.getElementById("searchBody");

    const rackHint  = document.getElementById("rackHint");
    const rackBody  = document.getElementById("rackBody");
    const rackGrid  = document.getElementById("rackGrid");
    const rackGridFull = document.getElementById("rackGridFull");
    const rackGridEmpty = document.getElementById("rackGridEmpty");
    const emptyRacksSection = document.getElementById("emptyRacksSection");
    const fullRackCount = document.getElementById("fullRackCount");
    const emptyRackCount = document.getElementById("emptyRackCount");
    const rackFullEmpty = document.getElementById("rackFullEmpty");
    const rackEmptyEmpty = document.getElementById("rackEmptyEmpty");

    const setupBox    = document.getElementById("setupBox");
    const setupCount  = document.getElementById("setupCount");
    const setupPrefix = document.getElementById("setupPrefix");
    const btnSetup    = document.getElementById("btnSetup");
    const setupStatus = document.getElementById("setupStatus");

    const reqProduct = document.getElementById("reqProduct");
    const reqProductionType = document.getElementById("reqProductionType");
    const btnReq     = document.getElementById("btnReq");
    const statusReq  = document.getElementById("statusReq");
    const statusReqList = document.getElementById("statusReqList");
    const reqWrap    = document.getElementById("reqWrap");
    const reqBody    = document.getElementById("reqBody");

    const stTotal = document.getElementById("stTotal");
    const stEmpty = document.getElementById("stEmpty");
    const stFull  = document.getElementById("stFull");
    const stQty   = document.getElementById("stQty");
    const stHint  = document.getElementById("stHint");

    // Personel y√∂netimi elementleri
    const personnelName = document.getElementById("personnelName");
    const personnelPaymentPeriod = document.getElementById("personnelPaymentPeriod");
    const personnelPaymentDayMonthly = document.getElementById("personnelPaymentDayMonthly");
    const personnelPaymentDayWeekly = document.getElementById("personnelPaymentDayWeekly");
    const personnelSalary = document.getElementById("personnelSalary");
    const personnelStartDate = document.getElementById("personnelStartDate");
    const btnAddPersonnel = document.getElementById("btnAddPersonnel");
    const statusPersonnel = document.getElementById("statusPersonnel");
    const personnelListBody = document.getElementById("personnelListBody");
    const monthlyPaymentFields = document.getElementById("monthlyPaymentFields");
    const weeklyPaymentFields = document.getElementById("weeklyPaymentFields");
    const upcomingPaymentsList = document.getElementById("upcomingPaymentsList");
    const overduePaymentsList = document.getElementById("overduePaymentsList");

    // Personel d√ºzenleme elementleri
    const editPersonnelSection = document.getElementById("editPersonnelSection");
    const editPersonnelId = document.getElementById("editPersonnelId");
    const editPersonnelName = document.getElementById("editPersonnelName");
    const editPersonnelPaymentPeriod = document.getElementById("editPersonnelPaymentPeriod");
    const editPersonnelPaymentDayMonthly = document.getElementById("editPersonnelPaymentDayMonthly");
    const editPersonnelPaymentDayWeekly = document.getElementById("editPersonnelPaymentDayWeekly");
    const editPersonnelSalary = document.getElementById("editPersonnelSalary");
    const editPersonnelStartDate = document.getElementById("editPersonnelStartDate");
    const editMonthlyPaymentFields = document.getElementById("editMonthlyPaymentFields");
    const editWeeklyPaymentFields = document.getElementById("editWeeklyPaymentFields");
    const btnUpdatePersonnel = document.getElementById("btnUpdatePersonnel");
    const btnCancelEdit = document.getElementById("btnCancelEdit");
    const statusEditPersonnel = document.getElementById("statusEditPersonnel");

    // √ñdeme elementleri
    const paymentPersonSelect = document.getElementById("paymentPersonSelect");
    const paymentType = document.getElementById("paymentType");
    const paymentAmount = document.getElementById("paymentAmount");
    const paymentDate = document.getElementById("paymentDate");
    const paymentNote = document.getElementById("paymentNote");
    const btnAddPayment = document.getElementById("btnAddPayment");
    const statusPayment = document.getElementById("statusPayment");
    const paymentListBody = document.getElementById("paymentListBody");
    const paymentSearchName = document.getElementById("paymentSearchName");
    const btnFilterAllPayments = document.getElementById("btnFilterAllPayments");
    const btnFilterSalary = document.getElementById("btnFilterSalary");
    const btnFilterAdvance = document.getElementById("btnFilterAdvance");

    // Komisyonlu satƒ±≈ü elementleri
    const commissionTransactionType = document.getElementById("commissionTransactionType");
    const commissionAmount = document.getElementById("commissionAmount");
    const commissionNote = document.getElementById("commissionNote");
    const btnAddCommission = document.getElementById("btnAddCommission");
    const statusCommission = document.getElementById("statusCommission");
    const myTotalIncome = document.getElementById("myTotalIncome");
    const myTotalExpense = document.getElementById("myTotalExpense");
    const myNetAmount = document.getElementById("myNetAmount");
    const myCommission = document.getElementById("myCommission");
    const commissionListBody = document.getElementById("commissionListBody");
    const myPaymentsBody = document.getElementById("myPaymentsBody");
    const btnFilterAllCommission = document.getElementById("btnFilterAllCommission");
    const btnFilterIncome = document.getElementById("btnFilterIncome");
    const btnFilterExpense = document.getElementById("btnFilterExpense");
    const commissionSummaryBody = document.getElementById("commissionSummaryBody");
    const paymentsHistoryBody = document.getElementById("paymentsHistoryBody");
    const collectionSellerPin = document.getElementById("collectionSellerPin");
    const collectionAmount = document.getElementById("collectionAmount");
    const collectionNote = document.getElementById("collectionNote");
    const btnAddCollection = document.getElementById("btnAddCollection");
    const statusCollection = document.getElementById("statusCollection");
    const sellerDetailSection = document.getElementById("sellerDetailSection");
    const sellerDetailTitle = document.getElementById("sellerDetailTitle");
    const detailIncome = document.getElementById("detailIncome");
    const detailExpense = document.getElementById("detailExpense");
    const detailNet = document.getElementById("detailNet");
    const detailCompanyShare = document.getElementById("detailCompanyShare");
    const detailTransactionsBody = document.getElementById("detailTransactionsBody");

    const accountCompanyName = document.getElementById("accountCompanyName");
    const accountTransactionType = document.getElementById("accountTransactionType");
    const purchaseFields = document.getElementById("purchaseFields");
    const paymentFields = document.getElementById("paymentFields");
    const accountItemName = document.getElementById("accountItemName");
    const accountItemQuantity = document.getElementById("accountItemQuantity");
    const accountInvoiceAmount = document.getElementById("accountInvoiceAmount");
    const accountPaymentAmount = document.getElementById("accountPaymentAmount");
    const accountTransactionDate = document.getElementById("accountTransactionDate");
    const accountNote = document.getElementById("accountNote");
    const btnAddAccountTransaction = document.getElementById("btnAddAccountTransaction");
    const statusAccount = document.getElementById("statusAccount");
    const companyBalancesBody = document.getElementById("companyBalancesBody");
    const accountListBody = document.getElementById("accountListBody");
    const accountSearchCompany = document.getElementById("accountSearchCompany");
    const btnFilterAllTransactions = document.getElementById("btnFilterAllTransactions");
    const btnFilterPurchases = document.getElementById("btnFilterPurchases");
    const btnFilterPayments = document.getElementById("btnFilterPayments");
    const companyList = document.getElementById("companyList");

    // Firma d√ºzenleme elementleri
    const editCompanySection = document.getElementById("editCompanySection");
    const editCompanyOldName = document.getElementById("editCompanyOldName");
    const editCompanyNewName = document.getElementById("editCompanyNewName");
    const btnUpdateCompany = document.getElementById("btnUpdateCompany");
    const btnCancelCompanyEdit = document.getElementById("btnCancelCompanyEdit");
    const statusEditCompany = document.getElementById("statusEditCompany");

    const logLimit = document.getElementById("logLimit");
    const btnLoadLogs = document.getElementById("btnLoadLogs");
    const btnLogPut = document.getElementById("btnLogPut");
    const btnLogClear = document.getElementById("btnLogClear");
    const btnLogDecrease = document.getElementById("btnLogDecrease");
    const btnLogMaterial = document.getElementById("btnLogMaterial");
    const btnLogProduction = document.getElementById("btnLogProduction");
    const btnLogAccounts = document.getElementById("btnLogAccounts");
    const btnLogPayments = document.getElementById("btnLogPayments");
    const btnLogCommission = document.getElementById("btnLogCommission");
    const btnLogAllActions = document.getElementById("btnLogAllActions");
    const btnLogAdmin = document.getElementById("btnLogAdmin");
    const btnLogPacker = document.getElementById("btnLogPacker");
    const btnLogStower = document.getElementById("btnLogStower");
    const btnLogWelder = document.getElementById("btnLogWelder");
    const btnLogPurchase = document.getElementById("btnLogPurchase");
    const btnLogAllRoles = document.getElementById("btnLogAllRoles");
    const statusLogs = document.getElementById("statusLogs");
    const logsWrap = document.getElementById("logsWrap");
    const logsBody = document.getElementById("logsBody");

    // ≈ûifre Y√∂netimi
    const pwdRole = document.getElementById("pwdRole");
    const pwdUserSelectBox = document.getElementById("pwdUserSelectBox");
    const pwdUserSelect = document.getElementById("pwdUserSelect");
    const pwdChangeBox = document.getElementById("pwdChangeBox");
    const pwdCurrentPin = document.getElementById("pwdCurrentPin");
    const pwdNewPin = document.getElementById("pwdNewPin");
    const pwdUserName = document.getElementById("pwdUserName");
    const btnUpdatePassword = document.getElementById("btnUpdatePassword");
    const statusPwdUpdate = document.getElementById("statusPwdUpdate");

    // Amazon & Shopify √ñdemeleri
    const platformPaymentPlatform = document.getElementById("platformPaymentPlatform");
    const platformPaymentAmount = document.getElementById("platformPaymentAmount");
    const platformPaymentDate = document.getElementById("platformPaymentDate");
    const platformPaymentNote = document.getElementById("platformPaymentNote");
    const btnAddPlatformPayment = document.getElementById("btnAddPlatformPayment");
    const statusPlatformPayment = document.getElementById("statusPlatformPayment");
    const platformPaymentsBody = document.getElementById("platformPaymentsBody");
    const totalAmazon = document.getElementById("totalAmazon");
    const totalShopify = document.getElementById("totalShopify");
    const totalPlatformPayments = document.getElementById("totalPlatformPayments");

    const welderCode = document.getElementById("welderCode");
    const welderStatus = document.getElementById("welderStatus");
    const welderQty = document.getElementById("welderQty");
    const welderSave = document.getElementById("welderSave");
    const statusWelder = document.getElementById("statusWelder");
    const statusWelderToday = document.getElementById("statusWelderToday");
    const welderTodayWrap = document.getElementById("welderTodayWrap");
    const welderTodayBody = document.getElementById("welderTodayBody");
    const statusWelderRequests = document.getElementById("statusWelderRequests");
    const welderRequestsWrap = document.getElementById("welderRequestsWrap");
    const welderRequestsBody = document.getElementById("welderRequestsBody");

    const btnProdDay = document.getElementById("btnProdDay");
    const btnProdWeek = document.getElementById("btnProdWeek");
    const btnProdMonth = document.getElementById("btnProdMonth");
    const btnProdYear = document.getElementById("btnProdYear");
    const statusProduction = document.getElementById("statusProduction");
    const productionWrap = document.getElementById("productionWrap");
    const productionBody = document.getElementById("productionBody");

    const matReqName = document.getElementById("matReqName");
    const matReqQty = document.getElementById("matReqQty");
    const matReqNote = document.getElementById("matReqNote");
    const btnMatReq = document.getElementById("btnMatReq");
    const statusMatReq = document.getElementById("statusMatReq");
    const statusMatReqList = document.getElementById("statusMatReqList");
    const matReqWrap = document.getElementById("matReqWrap");
    const matReqBody = document.getElementById("matReqBody");

    const statusPurchase = document.getElementById("statusPurchase");
    const purchaseWrap = document.getElementById("purchaseWrap");
    const purchaseBody = document.getElementById("purchaseBody");

    const instructionsProductCode = document.getElementById("instructionsProductCode");
    const btnLoadInstructions = document.getElementById("btnLoadInstructions");
    const statusInstructions = document.getElementById("statusInstructions");
    const instructionsContent = document.getElementById("instructionsContent");
    const instructionContainer = document.getElementById("instructionContainer");

    const bulkInstructionsInput = document.getElementById("bulkInstructionsInput");
    const btnBulkUploadInstructions = document.getElementById("btnBulkUploadInstructions");
    const statusBulkInstructions = document.getElementById("statusBulkInstructions");

    const packagingProductCode = document.getElementById("packagingProductCode");
    const btnLoadPackaging = document.getElementById("btnLoadPackaging");
    const statusPackaging = document.getElementById("statusPackaging");
    const packagingContent = document.getElementById("packagingContent");
    const packagingContainer = document.getElementById("packagingContainer");

    const bulkPackagingInput = document.getElementById("bulkPackagingInput");
    const btnBulkUploadPackaging = document.getElementById("btnBulkUploadPackaging");
    const statusBulkPackaging = document.getElementById("statusBulkPackaging");

    const credentialService = document.getElementById("credentialService");
    const credentialEmail = document.getElementById("credentialEmail");
    const credentialPassword = document.getElementById("credentialPassword");
    const btnAddCredential = document.getElementById("btnAddCredential");
    const statusCredentials = document.getElementById("statusCredentials");
    const credentialsBody = document.getElementById("credentialsBody");

    // Adet dropdown'ƒ±nƒ± doldur (1-100 arasƒ±)
    if(inQty){
      for(let i = 1; i <= 100; i++){
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i;
        inQty.appendChild(opt);
      }
      inQty.value = "1"; // Varsayƒ±lan deƒüer 1
    }

    // Raf numarasƒ± dropdown'ƒ±nƒ± doldur (1-300 arasƒ±)
    if(inShelfNum){
      inShelfNum.innerHTML = '<option value="">Se√ßiniz</option>';
      for(let i = 1; i <= 300; i++){
        const opt = document.createElement('option');
        opt.value = padShelf(i); // R001, R002, vb.
        opt.textContent = i; // Sadece sayƒ± g√∂ster: 1, 2, vb.
        inShelfNum.appendChild(opt);
      }
    }

    let shelvesCache = {};
    let role = null;
    let sessionPin = null;

    function padShelf(num){ return "R" + String(num).padStart(3,"0"); }

    function formatLogDate(date){
      if(!date) return "-";
      
      const now = new Date();
      const logDate = new Date(date);
      
      // Bug√ºn√ºn ba≈ülangƒ±cƒ±
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      // D√ºn√ºn ba≈ülangƒ±cƒ±
      const yesterdayStart = new Date(todayStart);
      yesterdayStart.setDate(yesterdayStart.getDate() - 1);
      // 2 g√ºn √∂ncesinin ba≈ülangƒ±cƒ±
      const twoDaysAgoStart = new Date(todayStart);
      twoDaysAgoStart.setDate(twoDaysAgoStart.getDate() - 2);
      
      const timeStr = logDate.toLocaleTimeString("tr-TR", { hour: "2-digit", minute: "2-digit" });
      
      if(logDate >= todayStart){
        return `Bug√ºn-${timeStr}`;
      } else if(logDate >= yesterdayStart){
        return `D√ºn-${timeStr}`;
      } else {
        const day = logDate.getDate();
        const monthNames = ["Ocak", "≈ûubat", "Mart", "Nisan", "Mayƒ±s", "Haziran", 
                           "Temmuz", "Aƒüustos", "Eyl√ºl", "Ekim", "Kasƒ±m", "Aralƒ±k"];
        const month = monthNames[logDate.getMonth()];
        return `${day} ${month}-${timeStr}`;
      }
    }

    function translateAction(action){
      const translations = {
        "PUT": "RAFA KOY",
        "CLEAR_SHELF": "RAF BO≈ûALT",
        "REMOVE_PRODUCT_ALL": "√úR√úN TAMAMEN √áIKAR",
        "DECREASE_QTY": "ADET AZALT",
        "REMOVE_PRODUCT": "√úR√úN √áIKAR",
        "PRODUCTION_REQUEST": "√úRETƒ∞M TALEBƒ∞",
        "PRODUCTION_REQUEST_DELETE": "√úRETƒ∞M TALEBƒ∞ Sƒ∞Lƒ∞NDƒ∞",
        "FULFILL_REQUESTS": "TALEPLERƒ∞ KAR≈ûILA",
        "MATERIAL_REQUEST": "MALZEME TALEBƒ∞",
        "MATERIAL_STATUS_UPDATE": "MALZEME DURUM G√úNCELLENMESƒ∞",
        "SETUP": "KURULUM",
        "PRODUCTION_COMPLETED": "√úRETƒ∞M TAMAMLANDI",
        "ACCOUNT_TRANSACTION": "CARƒ∞ HESAP ƒ∞≈ûLEMƒ∞",
        "PAYMENT_RECORD": "PERSONEL √ñDEMESƒ∞",
        "COMMISSION_TRANSACTION": "KOMƒ∞SYON ƒ∞≈ûLEMƒ∞",
        "COMMISSION_COLLECTION": "BAYƒ∞ TAHSƒ∞LATI"
      };
      return translations[action] || action;
    }

    function setStatusBox(el,msg,type){
      if(!el) return;
      if(!msg){
        el.style.display = "none";
        return;
      }
      el.style.display = "flex";
      el.className = "statusBox" + (type ? " " + type : "");
      el.textContent = msg || "";
    }

    function productsSummary(products){
      if(!products || Object.keys(products).length===0) return "-";
      return Object.entries(products).map(([c,q])=>`${c} x${q}`).join(", ");
    }
    
    function productsHTML(products){
      if(!products || Object.keys(products).length===0) {
        return '<span style="color:var(--muted);font-style:italic;">√úr√ºn yok</span>';
      }
      return Object.entries(products)
        .map(([code, qty]) => `
          <div class="product-tag">
            <span class="product-tag-code">${code}</span>
            <span class="product-tag-qty">√ó${qty}</span>
          </div>
        `).join('');
    }

    function isEmpty(data){
      const p = data?.products || {};
      return Object.keys(p).length===0;
    }

    function populateShelfDropdown(){
      if(!outShelfNum) return;
      
      // Dolu raflarƒ± bul ve sƒ±rala
      const fullShelves = [];
      for(const [shelfName, shelfData] of Object.entries(shelvesCache)){
        if(!isEmpty(shelfData)){
          fullShelves.push(shelfName);
        }
      }
      
      fullShelves.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
      
      // Dropdown'ƒ± doldur
      outShelfNum.innerHTML = '<option value="">Se√ßiniz</option>';
      fullShelves.forEach(shelfName => {
        const opt = document.createElement('option');
        opt.value = shelfName;
        // R001 -> 1, R012 -> 12 gibi g√∂ster
        const displayNumber = shelfName.replace(/^R0*/, '');
        opt.textContent = displayNumber;
        outShelfNum.appendChild(opt);
      });
    }

    function refreshClearMode(){
      const nStr = (outShelfNum.value || "").trim();
      if(!nStr){
        clearProductBox.style.display="none";
        if(productListContainer) productListContainer.innerHTML = "";
        if(outProductCode) outProductCode.value="";
        if(outReduceQty) outReduceQty.value="1";
        return;
      }

      const shelfName = nStr; // Artƒ±k direkt raf ismi geliyor (√∂rn: R001)
      const shelfData = shelvesCache[shelfName];
      if(!shelfData){
        clearProductBox.style.display="none";
        if(productListContainer) productListContainer.innerHTML = "";
        if(outReduceQty) outReduceQty.value="1";
        return;
      }

      const products = shelfData.products || {};
      const keys = Object.keys(products);
      const pcount = keys.length;

      if(pcount === 0){
        clearProductBox.style.display="none";
        if(productListContainer) productListContainer.innerHTML = "";
        if(outReduceQty) outReduceQty.value="1";
        return;
      }

      // √úr√ºnleri listele
      clearProductBox.style.display="block";
      
      // Mevcut se√ßimi kaydet
      const currentSelection = outProductCode.value || "";
      
      // √úr√ºn listesini olu≈ütur
      if(productListContainer){
        productListContainer.innerHTML = "";
        keys.forEach(k => {
          const div = document.createElement('div');
          div.className = 'product-item';
          div.textContent = k;
          div.dataset.productCode = k;
          
          // Eƒüer bu √ºr√ºn se√ßiliyse selected class ekle
          if(k === currentSelection){
            div.classList.add('selected');
          }
          
          // Tƒ±klama event'i
          div.addEventListener('click', () => {
            // T√ºm se√ßimleri kaldƒ±r
            productListContainer.querySelectorAll('.product-item').forEach(item => {
              item.classList.remove('selected');
            });
            
            // Bu √ºr√ºn√º se√ß
            div.classList.add('selected');
            outProductCode.value = k;
            
            // Adet dropdown'ƒ±nƒ± g√ºncelle
            const qty = Number(products[k] || 0);
            if(outReduceQty && qty >= 1){
              outReduceQty.innerHTML = '';
              for(let i = 1; i <= qty; i++){
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i;
                outReduceQty.appendChild(opt);
              }
              outReduceQty.value = "1";
            }
          });
          
          productListContainer.appendChild(div);
        });
        
        // Eƒüer se√ßili √ºr√ºn varsa adet dropdown'ƒ±nƒ± doldur
        if(currentSelection && products[currentSelection]){
          const selQty = Number(products[currentSelection] || 0);
          if(outReduceQty && selQty >= 1){
            outReduceQty.innerHTML = '';
            for(let i = 1; i <= selQty; i++){
              const opt = document.createElement('option');
              opt.value = i;
              opt.textContent = i;
              outReduceQty.appendChild(opt);
            }
            outReduceQty.value = "1";
          }
        }else{
          // Se√ßili √ºr√ºn yoksa varsayƒ±lan 1
          if(outReduceQty){
            outReduceQty.innerHTML = '<option value="1">1</option>';
            outReduceQty.value = "1";
          }
        }
      }
    }

    outShelfNum?.addEventListener("change", refreshClearMode);
    outShelfNum?.addEventListener("input", refreshClearMode);

    function runSearch(){
      setStatusBox(statusSearch, "Aranƒ±yor...", "");
      searchBody.innerHTML = "";
      searchWrap.style.display = "none";

      const code = (searchCode.value || "").trim();
      if(!code) return setStatusBox(statusSearch, "√úr√ºn kodu bo≈ü olamaz.", "error");

      const results = [];
      for(const [raf, data] of Object.entries(shelvesCache)){
        const qty = Number((data.products && data.products[code]) || 0);
        if(qty > 0) results.push({ raf, qty });
      }

      if(results.length === 0) return setStatusBox(statusSearch, "Bulunamadƒ±.", "error");

      results.sort((a,b)=>a.raf.localeCompare(b.raf));
      for(const r of results){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.raf}</td><td>${r.qty}</td>`;
        searchBody.appendChild(tr);
      }
      searchWrap.style.display = "block";
      setStatusBox(statusSearch, "Bulundu.", "ok");
    }
    btnSearch && (btnSearch.onclick = runSearch);
    searchCode && searchCode.addEventListener("keydown",(e)=>{ if(e.key==="Enter") runSearch(); });

    function computeSummary(){
      const names = Object.keys(shelvesCache);
      const total = names.length;
      let empty = 0;
      let full = 0;
      let totalQty = 0;

      for(const n of names){
        const p = shelvesCache[n]?.products || {};
        const keys = Object.keys(p);
        if(keys.length===0) empty++;
        else full++;
        for(const k of keys) totalQty += Number(p[k] || 0);
      }

      stTotal && (stTotal.textContent = total);
      stEmpty && (stEmpty.textContent = empty);
      stFull  && (stFull.textContent  = full);
      stQty   && (stQty.textContent   = totalQty);
      stHint  && (stHint.textContent  = `Son g√ºncelleme: ${new Date().toLocaleString("tr-TR")}`);
    }

    function setActiveTab(target){
      const allTabs = [tabPut, tabClear, tabSearch, tabRack, tabRequest, tabMaterialRequest, tabWelder, tabWelderRequests, tabProduction, tabPurchase, tabInstructions, tabPackaging, tabPayments, tabAccounts, tabCommissionSummary, tabCommission, tabPlatformPayments, tabAttendance, tabAdmin].filter(Boolean);
      allTabs.forEach(t=>t.classList.remove("active"));

      const hideAll = ()=>{
        viewPut && (viewPut.style.display="none");
        viewClear && (viewClear.style.display="none");
        viewSearch && (viewSearch.style.display="none");
        viewRack && (viewRack.style.display="none");
        viewRequest && (viewRequest.style.display="none");
        viewMaterialRequest && (viewMaterialRequest.style.display="none");
        viewWelder && (viewWelder.style.display="none");
        viewWelderRequests && (viewWelderRequests.style.display="none");
        viewProduction && (viewProduction.style.display="none");
        viewPurchase && (viewPurchase.style.display="none");
        viewInstructions && (viewInstructions.style.display="none");
        viewPackaging && (viewPackaging.style.display="none");
        viewPayments && (viewPayments.style.display="none");
        viewAccounts && (viewAccounts.style.display="none");
        viewCommissionSummary && (viewCommissionSummary.style.display="none");
        viewCommission && (viewCommission.style.display="none");
        viewPlatformPayments && (viewPlatformPayments.style.display="none");
        viewAttendance && (viewAttendance.style.display="none");
        viewAdmin && (viewAdmin.style.display="none");
      };

      hideAll();

      if(target==="put"){ tabPut?.classList.add("active"); viewPut.style.display="block"; setTimeout(()=>{ try{ inProduct.focus(); inProduct.select && inProduct.select(); }catch(e){} },50); }
      if(target==="clear"){ 
        tabClear?.classList.add("active"); 
        viewClear.style.display="block"; 
        populateShelfDropdown(); // Dolu raflarƒ± dropdown'a doldur
        setTimeout(()=>{ try{ outShelfNum.focus(); }catch(e){} },50); 
      }
      if(target==="search"){ tabSearch?.classList.add("active"); viewSearch.style.display="block"; setTimeout(()=>{ try{ searchCode.focus(); searchCode.select && searchCode.select(); }catch(e){} },50); }
      if(target==="rack"){ 
        tabRack?.classList.add("active"); 
        viewRack.style.display="block"; 
        setTimeout(()=>{ 
          try{ 
            const scrollTarget = rackGrid || rackBody;
            scrollTarget && scrollTarget.scrollIntoView && scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'start' }); 
          }catch(e){} 
        },50); 
      }
      if(target==="request"){ tabRequest?.classList.add("active"); viewRequest.style.display="block"; setTimeout(()=>{ try{ reqProduct.focus(); reqProduct.select && reqProduct.select(); }catch(e){} },50); }
      if(target==="materialRequest"){ tabMaterialRequest?.classList.add("active"); viewMaterialRequest.style.display="block"; setTimeout(()=>{ try{ matReqName.focus(); matReqName.select && matReqName.select(); }catch(e){} },50); }
      if(target==="welder"){ tabWelder?.classList.add("active"); viewWelder.style.display="block"; setTimeout(()=>{ try{ welderCode.focus(); welderCode.select && welderCode.select(); }catch(e){} },50); }
      if(target==="welderRequests"){ tabWelderRequests?.classList.add("active"); viewWelderRequests.style.display="block"; }
      if(target==="production"){ tabProduction?.classList.add("active"); viewProduction.style.display="block"; }
      if(target==="purchase"){ tabPurchase?.classList.add("active"); viewPurchase.style.display="block"; }
      if(target==="instructions"){ tabInstructions?.classList.add("active"); viewInstructions.style.display="block"; setTimeout(()=>{ try{ instructionsProductCode.focus(); instructionsProductCode.select && instructionsProductCode.select(); }catch(e){} },50); }
      if(target==="packaging"){ tabPackaging?.classList.add("active"); viewPackaging.style.display="block"; setTimeout(()=>{ try{ packagingProductCode.focus(); packagingProductCode.select && packagingProductCode.select(); }catch(e){} },50); }
      if(target==="payments"){ tabPayments?.classList.add("active"); viewPayments.style.display="block"; setTimeout(()=>{ try{ paymentPersonSelect.focus(); }catch(e){} },50); }
      if(target==="accounts"){ tabAccounts?.classList.add("active"); viewAccounts.style.display="block"; setTimeout(()=>{ try{ accountCompanyName.focus(); accountCompanyName.select && accountCompanyName.select(); }catch(e){} },50); }
      if(target==="commissionSummary"){ tabCommissionSummary?.classList.add("active"); viewCommissionSummary.style.display="block"; setTimeout(()=>{ try{ if(typeof loadCommissionSummary === "function"){ loadCommissionSummary(); } if(typeof loadPaymentsHistory === "function"){ loadPaymentsHistory(); } }catch(e){console.error(e);} },100); }
      if(target==="commission"){ 
        tabCommission?.classList.add("active"); 
        viewCommission.style.display="block"; 
        
        // Admin rol√º ise formu gizle, sadece raporlarƒ± g√∂ster
        const currentRole = window.__SESSION?.role;
        if(currentRole === "admin") {
          const formSection = document.getElementById("commissionFormSection");
          const summarySection = document.getElementById("commissionSummarySection");
          if(formSection) formSection.style.display = "none";
          if(summarySection) summarySection.style.display = "none";
        } else {
          const formSection = document.getElementById("commissionFormSection");
          const summarySection = document.getElementById("commissionSummarySection");
          if(formSection) formSection.style.display = "block";
          if(summarySection) summarySection.style.display = "block";
        }
        
        setTimeout(()=>{ try{ commissionTransactionType.focus(); }catch(e){} },50); 
      }
      if(target==="platformPayments"){ 
        tabPlatformPayments?.classList.add("active"); 
        viewPlatformPayments.style.display="block"; 
        setTimeout(()=>{ 
          try{ 
            if(typeof loadPlatformPayments === "function"){ loadPlatformPayments(); }
            // Bug√ºn√ºn tarihini otomatik doldur
            if(platformPaymentDate && !platformPaymentDate.value) {
              const today = new Date();
              const yyyy = today.getFullYear();
              const mm = String(today.getMonth() + 1).padStart(2, '0');
              const dd = String(today.getDate()).padStart(2, '0');
              platformPaymentDate.value = `${yyyy}-${mm}-${dd}`;
            }
          }catch(e){console.error(e);} 
        },100); 
      }
      if(target==="attendance"){ 
        tabAttendance?.classList.add("active"); 
        viewAttendance.style.display="block";
        setTimeout(()=>{ 
          try{ 
            initAttendance();
          }catch(e){console.error(e);} 
        },50); 
      }
      if(target==="admin"){ 
        tabAdmin?.classList.add("active"); 
        viewAdmin.style.display="block"; 
        
        // Sayfayƒ± en √ºste kaydƒ±r
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // loadCredentials'ƒ± bekleyen bir fonksiyon
        function waitForLoadCredentials(attempts = 0) {
          if(typeof window.loadCredentials === "function") {
            console.log("üîë window.loadCredentials √ßaƒürƒ±lƒ±yor...");
            window.loadCredentials();
          } else if(attempts < 10) {
            console.log(`‚è≥ window.loadCredentials bekleniyor... (${attempts + 1}/10)`);
            setTimeout(() => waitForLoadCredentials(attempts + 1), 100);
          } else {
            console.error("‚ùå window.loadCredentials 1 saniye sonra bile bulunamadƒ±!");
          }
        }
        
        setTimeout(()=>{ 
          try{ 
            console.log("üîß Admin sekmesi a√ßƒ±lƒ±yor...");
            if(typeof loadCommissionSummary === "function"){ 
              console.log("üìä loadCommissionSummary √ßaƒürƒ±lƒ±yor...");
              loadCommissionSummary(); 
            }
            waitForLoadCredentials();
            
            // Konum ayarlarƒ±nƒ± y√ºkle
            if(typeof loadWorkplaceLocation === "function") {
              console.log("üìç Konum ayarlarƒ± y√ºkleniyor...");
              loadWorkplaceLocation();
            }
            if(typeof setupLocationButtons === "function") {
              console.log("üîò Konum butonlarƒ± ayarlanƒ±yor...");
              setupLocationButtons();
            }
            
            // Telegram kullanƒ±cƒ± tablosunu doldur
            if(typeof populateTelegramUsersTable === "function") {
              console.log("üë• Telegram kullanƒ±cƒ± tablosu dolduruluyor...");
              populateTelegramUsersTable();
            }
            
            // Bildirim ayarlarƒ± kullanƒ±cƒ± listesini doldur
            if(typeof populateNotificationRecipients === "function") {
              console.log("üîî Bildirim ayarlarƒ± kullanƒ±cƒ± listesi dolduruluyor...");
              populateNotificationRecipients();
            }
          }catch(e){console.error("‚ùå Admin sekmesi y√ºkleme hatasƒ±:", e);} 
        },100); 
      }
    }

    function setTabsByRole(r){
      const tabbar = document.getElementById("tabbar");
      const tabbarGrouped = document.getElementById("tabbarGrouped");
      
      const pairs = [
        [tabPut, viewPut],
        [tabClear, viewClear],
        [tabSearch, viewSearch],
        [tabRack, viewRack],
        [tabRequest, viewRequest],
        [tabMaterialRequest, viewMaterialRequest],
        [tabWelder, viewWelder],
        [tabWelderRequests, viewWelderRequests],
        [tabProduction, viewProduction],
        [tabPurchase, viewPurchase],
        [tabInstructions, viewInstructions],
        [tabPackaging, viewPackaging],
        [tabPayments, viewPayments],
        [tabAccounts, viewAccounts],
        [tabCommissionSummary, viewCommissionSummary],
        [tabCommission, viewCommission],
        [tabPlatformPayments, viewPlatformPayments],
        [tabAttendance, viewAttendance],
        [tabAdmin, viewAdmin]
      ];

      pairs.forEach(([t,v])=>{
        t && (t.style.display="none");
        v && (v.style.display="none");
      });

      if(r==="packer"){
        tabbar.style.display="flex";
        tabbarGrouped.style.display="none";
        
        tabClear.style.display="block";
        tabSearch.style.display="block";
        tabRack.style.display="block";
        tabPackaging.style.display="block";
        tabAttendance.style.display="block";
        
        // Sadece 2001 ve 45823 (G√∂kmen) ≈üifresi ile giri≈ü yapan paket√ßi talep sekmelerini g√∂rebilir
        const currentPin = window.__SESSION?.pin;
        if(currentPin === "2001" || currentPin === "45823"){
          tabRequest.style.display="block";
          tabMaterialRequest.style.display="block";
          tabbar.style.gridTemplateColumns = "1fr 1fr 1fr 1fr 1fr 1fr 1fr";
        } else {
          tabbar.style.gridTemplateColumns = "1fr 1fr 1fr 1fr 1fr";
        }
        
        setActiveTab("clear");
      }else if(r==="stower"){
        tabbar.style.display="flex";
        tabbarGrouped.style.display="none";
        
        tabPut.style.display="block";
        tabPackaging.style.display="block";
        tabAttendance.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr 1fr 1fr";
        setActiveTab("put");
      }else if(r==="welder"){
        tabbar.style.display="flex";
        tabbarGrouped.style.display="none";
        
        tabWelder.style.display="block";
        tabWelderRequests.style.display="block";
        tabMaterialRequest.style.display="block";
        tabInstructions.style.display="block";
        tabAttendance.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr 1fr 1fr 1fr 1fr";
        setActiveTab("welder");
      }else if(r==="purchase"){
        tabbar.style.display="flex";
        tabbarGrouped.style.display="none";
        
        tabPurchase.style.display="block";
        tabAttendance.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr 1fr";
        setActiveTab("purchase");
      }else if(r==="painter"){
        tabbar.style.display="flex";
        tabbarGrouped.style.display="none";
        
        tabAttendance.style.display="block";
        tabbar.style.gridTemplateColumns = "1fr";
        setActiveTab("attendance");
      }else if(r==="admin"){
        // Admin i√ßin gruplandƒ±rƒ±lmƒ±≈ü men√º kullan
        tabbar.style.display="none";
        tabbarGrouped.style.display="flex";
        
        setActiveTab("admin");
        
        // Sayfayƒ± en √ºste kaydƒ±r
        setTimeout(() => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
      }else if(r==="commission"){
        tabbar.style.display="none";
        tabbarGrouped.style.display="none";
        tabCommission.style.display="block";
        setActiveTab("commission");
      }else{
        tabbar.style.display="flex";
        tabbarGrouped.style.display="none";
        tabbar.style.gridTemplateColumns = "1fr";
      }
    }

    let groupedTabbarInitialized = false;
    
    function initGroupedTabbar(){
      if(groupedTabbarInitialized) return; // Sadece bir kez √ßalƒ±≈ütƒ±r
      groupedTabbarInitialized = true;
      
      // Grup ba≈ülƒ±klarƒ±na tƒ±klama
      document.querySelectorAll('.tab-group-header').forEach(header => {
        header.addEventListener('click', (e) => {
          e.stopPropagation();
          const groupId = header.dataset.group;
          const content = document.getElementById(`group-${groupId}`);
          const isOpen = content.classList.contains('open');
          
          // Diƒüer t√ºm gruplarƒ± kapat
          document.querySelectorAll('.tab-group-content').forEach(c => c.classList.remove('open'));
          document.querySelectorAll('.tab-group-header').forEach(h => h.classList.remove('open'));
          
          // Bu grubu a√ß/kapat
          if(!isOpen){
            content.classList.add('open');
            header.classList.add('open');
            
            // Pozisyonu dinamik olarak ayarla
            const rect = header.getBoundingClientRect();
            content.style.top = `${rect.bottom + 2}px`;
            content.style.left = `${rect.left}px`;
            
            // Saƒüa ta≈üarsa sola yasla
            setTimeout(() => {
              const contentRect = content.getBoundingClientRect();
              if(contentRect.right > window.innerWidth - 16){
                content.style.left = `${window.innerWidth - contentRect.width - 16}px`;
              }
            }, 0);
          }
        });
      });
      
      // Alt sekmelere tƒ±klama
      document.querySelectorAll('.tab-sub').forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.stopPropagation();
          const target = tab.dataset.target;
          
          // T√ºm alt sekmelerin active class'ƒ±nƒ± kaldƒ±r
          document.querySelectorAll('.tab-sub').forEach(t => t.classList.remove('active'));
          
          // Bu sekmeyi aktif yap
          tab.classList.add('active');
          
          // Grubu kapat
          document.querySelectorAll('.tab-group-content').forEach(c => c.classList.remove('open'));
          document.querySelectorAll('.tab-group-header').forEach(h => h.classList.remove('open'));
          
          // Sayfayƒ± deƒüi≈ütir
          setActiveTab(target);
        });
      });
      
      // Sayfa dƒ±≈üƒ±na tƒ±klandƒ±ƒüƒ±nda t√ºm gruplarƒ± kapat
      document.addEventListener('click', (e) => {
        if(!e.target.closest('.tab-group')){
          document.querySelectorAll('.tab-group-content').forEach(c => c.classList.remove('open'));
          document.querySelectorAll('.tab-group-header').forEach(h => h.classList.remove('open'));
        }
      });
      
      // Scroll yapƒ±nca dropdown'larƒ± kapat
      let scrollTimeout;
      window.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          document.querySelectorAll('.tab-group-content').forEach(c => c.classList.remove('open'));
          document.querySelectorAll('.tab-group-header').forEach(h => h.classList.remove('open'));
        }, 50);
      }, true);
    }

    function playBeep(){
      try{
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if(!AudioCtx) return;

        const ctx = new AudioCtx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.type = "sine";
        osc.frequency.value = 880;

        gain.gain.setValueAtTime(0.001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);

        osc.connect(gain);
        gain.connect(ctx.destination);

        osc.start();
        osc.stop(ctx.currentTime + 0.26);
        osc.onended = ()=>{ try{ ctx.close(); }catch(e){} };
      }catch(e){}
    }

    window.startFirebase = async function(){
      try{
        const sess = window.__SESSION || {};
        role = sess.role;
        sessionPin = sess.pin || null;

        setTabsByRole(role);
        
        // Grouped tabbar'ƒ± ba≈ülat (sadece bir kez √ßalƒ±≈üacak)
        initGroupedTabbar();
        
        // Admin kullanƒ±cƒ±larƒ± i√ßin notification permission iste
        if(role === 'admin') {
          console.log('Admin kullanƒ±cƒ±, bildirim sistemi ba≈ülatƒ±lƒ±yor...');
          requestNotificationPermission().then(granted => {
            console.log('Bildirim izni durumu:', granted);
            if(granted) {
              listenForAttendanceNotifications();
            } else {
              console.warn('Bildirim izni verilmedi!');
            }
          });
        }

        tabPut && (tabPut.onclick = ()=>setActiveTab("put"));
        tabClear && (tabClear.onclick = ()=>setActiveTab("clear"));
        tabSearch && (tabSearch.onclick = ()=>setActiveTab("search"));
        tabRack && (tabRack.onclick = ()=>setActiveTab("rack"));
        tabRequest && (tabRequest.onclick = ()=>setActiveTab("request"));
        tabMaterialRequest && (tabMaterialRequest.onclick = ()=>setActiveTab("materialRequest"));
        tabWelder && (tabWelder.onclick = ()=>setActiveTab("welder"));
        tabWelderRequests && (tabWelderRequests.onclick = ()=>setActiveTab("welderRequests"));
        tabProduction && (tabProduction.onclick = ()=>setActiveTab("production"));
        tabPurchase && (tabPurchase.onclick = ()=>setActiveTab("purchase"));
        tabInstructions && (tabInstructions.onclick = ()=>setActiveTab("instructions"));
        tabPackaging && (tabPackaging.onclick = ()=>setActiveTab("packaging"));
        tabPayments && (tabPayments.onclick = ()=>setActiveTab("payments"));
        tabAccounts && (tabAccounts.onclick = ()=>setActiveTab("accounts"));
        tabCommissionSummary && (tabCommissionSummary.onclick = ()=>setActiveTab("commissionSummary"));
        tabCommission && (tabCommission.onclick = ()=>setActiveTab("commission"));
        tabPlatformPayments && (tabPlatformPayments.onclick = ()=>setActiveTab("platformPayments"));
        tabAttendance && (tabAttendance.onclick = ()=>setActiveTab("attendance"));
        tabAdmin && (tabAdmin.onclick = ()=>setActiveTab("admin"));

        logoutBtn.onclick = ()=>{
          const currentRole = window.__SESSION?.role;
          
          // Admin rol√ºndeyse rol se√ßim modal'ƒ±nƒ± g√∂ster
          if(currentRole === "admin") {
            showRoleSwitchModal();
          } else {
            // Diƒüer roller i√ßin direkt √ßƒ±kƒ±≈ü yap
            window.__SESSION = { role: null, pin: null };
            localStorage.removeItem('rememberedPin');
            location.reload();
          }
        };

        // Rol deƒüi≈ütirme modal fonksiyonlarƒ±
        function showRoleSwitchModal() {
          const modal = document.getElementById('roleSwitchModal');
          const roleOptions = document.getElementById('roleOptions');
          
          const roles = [
            { id: 'admin', name: 'Y√∂netici', badge: 'Y√ñNETƒ∞Cƒ∞', color: '#00c853' },
            { id: 'packer', name: 'Paket√ßi', badge: 'PAKET√áƒ∞', color: '#2196f3' },
            { id: 'stower', name: 'Stok√ßu / Raf Dizen', badge: 'RAF Dƒ∞ZEN', color: '#ff9800' },
            { id: 'welder', name: '√úretim', badge: '√úRETƒ∞M', color: '#9c27b0' },
            { id: 'purchase', name: 'Satƒ±n Alma', badge: 'SATIN ALMA', color: '#00c853' },
            { id: 'painter', name: 'Boyacƒ±', badge: 'BOYACI', color: '#ff6b35' },
            { id: 'commission', name: 'Etsy Satƒ±≈ülarƒ±', badge: 'ETSY SATI≈ûLARI', color: '#9333ea' },
            { id: 'logout', name: '√áƒ±kƒ±≈ü Yap', badge: '√áIKI≈û', color: '#ef4444' }
          ];
          
          roleOptions.innerHTML = roles.map(role => `
            <div class="role-option" data-role="${role.id}">
              <span class="role-badge-preview" style="background:${role.color};color:#fff;">${role.badge}</span>
              <span class="role-name">${role.name}</span>
            </div>
          `).join('');
          
          // Rol se√ßeneklerine tƒ±klama event'i
          roleOptions.querySelectorAll('.role-option').forEach(option => {
            option.addEventListener('click', () => {
              const selectedRole = option.dataset.role;
              
              if(selectedRole === 'logout') {
                // √áƒ±kƒ±≈ü yap
                window.__SESSION = { role: null, pin: null };
                localStorage.removeItem('rememberedPin');
                location.reload();
              } else {
                // Se√ßilen role ge√ß
                window.__SESSION.role = selectedRole;
                modal.classList.remove('active');
                
                // UI'ƒ± g√ºncelle
                setTabsByRole(selectedRole);
                
                // Rol bilgisini g√ºncelle
                const userName = getNameByPin(window.__SESSION.pin);
                if(roleLine) {
                  roleLine.innerHTML = `${roleBadge(selectedRole)} | ${userName}`;
                }
              }
            });
          });
          
          modal.classList.add('active');
        }
        
        // Modal'ƒ± kapatma
        document.getElementById('btnCancelRoleSwitch')?.addEventListener('click', () => {
          document.getElementById('roleSwitchModal').classList.remove('active');
        });
        
        // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapat
        document.getElementById('roleSwitchModal')?.addEventListener('click', (e) => {
          if(e.target.id === 'roleSwitchModal') {
            e.target.classList.remove('active');
          }
        });

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        const db = window.db;
        
        // Firebase Messaging
        const messaging = getMessaging(app);
        window.messaging = messaging;

        // Firebase fonksiyonlarƒ±nƒ± global scope'a ta≈üƒ±
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.setDoc = setDoc;
        window.doc = doc;
        window.collection = collection;
        window.serverTimestamp = serverTimestamp;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.limit = limit;
        window.onSnapshot = onSnapshot;
        
        // Firebase hazƒ±r olduƒüunda bildirim ayarlarƒ±nƒ± y√ºkle
        console.log('üî• Firebase ba≈ülatƒ±ldƒ±, bildirim ayarlarƒ± y√ºkleniyor...');
        setTimeout(async () => {
          try {
            // Bildirim alƒ±cƒ±larƒ±nƒ± y√ºkle
            const configDoc = await getDoc(doc(db, 'config', 'notificationRecipients'));
            if (configDoc.exists()) {
              Object.assign(window.notificationRecipients, configDoc.data());
              console.log('‚úÖ Bildirim alƒ±cƒ±larƒ± y√ºklendi:', window.notificationRecipients);
            }
            
            // Event durumlarƒ±nƒ± y√ºkle
            const statusDoc = await getDoc(doc(db, 'config', 'notificationEventStatus'));
            if (statusDoc.exists()) {
              Object.assign(window.notificationEventStatus, statusDoc.data());
              console.log('‚úÖ Bildirim event durumlarƒ± y√ºklendi:', window.notificationEventStatus);
            }
          } catch (error) {
            console.error('‚ùå Bildirim ayarlarƒ± y√ºkleme hatasƒ±:', error);
          }
        }, 1000);

        const shelvesCol = collection(db, "shelves");
        const logsCol = collection(db, "logs");
        const reqCol = collection(db, "requests");
        const productionCol = collection(db, "production");
        const materialReqCol = collection(db, "materialRequests");
        const instructionsCol = collection(db, "productInstructions");
        const packagingCol = collection(db, "packagingInstructions");
        const paymentCol = collection(db, "paymentRecords");
        const personnelCol = collection(db, "personnel");
        const accountCol = collection(db, "accountTransactions");
        const commissionCol = collection(db, "commissionSales");
        const collectionCol = collection(db, "commissionCollections");
        const platformPaymentsCol = collection(db, "platformPayments");
        const credentialsCol = collection(db, "credentials");
        
        // Global eri≈üim i√ßin
        window.credentialsCol = credentialsCol;

        const initRef = doc(db, "system", "shelves_init");

        // Context Menu i√ßin global deƒüi≈üken
        let currentContextRequestId = null;
        const contextMenu = document.getElementById('contextMenu');
        const contextMenuDelete = document.getElementById('contextMenuDelete');

        // Context men√º g√∂ster
        window.showContextMenu = function(event, requestId) {
          currentContextRequestId = requestId;
          contextMenu.style.display = 'block';
          contextMenu.style.left = event.pageX + 'px';
          contextMenu.style.top = event.pageY + 'px';
        };

        // Context men√º gizle
        function hideContextMenu() {
          contextMenu.style.display = 'none';
          currentContextRequestId = null;
        }

        // Sayfa herhangi bir yerine tƒ±klandƒ±ƒüƒ±nda men√ºy√º gizle
        document.addEventListener('click', hideContextMenu);
        
        // Context men√ºn√ºn i√ßine tƒ±klandƒ±ƒüƒ±nda kapatma
        contextMenu.addEventListener('click', (e) => {
          e.stopPropagation();
        });

        // Silme i≈ülemi
        contextMenuDelete.addEventListener('click', async () => {
          if (!currentContextRequestId) return;
          
          if (confirm('Bu malzeme talebini silmek istediƒüinize emin misiniz?')) {
            try {
              const requestRef = doc(db, 'materialRequests', currentContextRequestId);
              await deleteDoc(requestRef);
              
              await addDoc(logsCol, {
                action: 'MATERIAL_STATUS_UPDATE',
                shelf: '-',
                product: '-',
                qty: 0,
                detail: 'Malzeme talebi silindi',
                ts: serverTimestamp(),
                role: role || '-',
                pin: sessionPin || '-'
              });
              
              playBeep();
              if (typeof loadMaterialRequests === 'function') {
                loadMaterialRequests();
              }
              alert('Talep ba≈üarƒ±yla silindi.');
            } catch (e) {
              alert('Hata: ' + e.message);
            }
          }
          hideContextMenu();
        });

        async function ensureShelvesOnce(){
          const initSnap = await getDoc(initRef);
          if (initSnap.exists() && initSnap.data()?.done === true) return;

          const q = query(shelvesCol, limit(1));
          const existing = await getDocs(q);
          if (!existing.empty) {
            await setDoc(initRef, { done:true, count: null, updated: serverTimestamp() }, { merge:true });
            return;
          }

          const count = Number(setupCount?.value || 300);
          const CHUNK_SIZE = 450;

          for (let start = 1; start <= count; start += CHUNK_SIZE) {
            const batch = writeBatch(db);
            const end = Math.min(start + CHUNK_SIZE - 1, count);

            for (let i = start; i <= end; i++) {
              const rafAdi = padShelf(i);
              batch.set(
                doc(shelvesCol, rafAdi),
                { name: rafAdi, products: {}, updated: serverTimestamp() },
                { merge: true }
              );
            }
            await batch.commit();
          }

          await setDoc(initRef, { done:true, count, updated: serverTimestamp() }, { merge:true });
        }

        await ensureShelvesOnce();

        async function writeLog(payload){
          try{
            await addDoc(logsCol, { ...payload, ts: serverTimestamp(), role: role || "-", pin: sessionPin || "-" });
          }catch(e){}
        }

        // raf kurulum kutusu sadece admin
        if(role !== "admin"){
          if(setupBox) setupBox.style.display = "none";
          if(btnSetup){
            btnSetup.disabled = true;
            btnSetup.style.opacity = .6;
            btnSetup.style.pointerEvents = "none";
          }
        }

        // Raflar snapshot
        onSnapshot(shelvesCol, (snapshot) => {
          shelvesCache = {};
          if(rackBody) rackBody.innerHTML = "";
          if(rackGridFull) rackGridFull.innerHTML = "";
          if(rackGridEmpty) rackGridEmpty.innerHTML = "";

          const total = snapshot.size;
          let emptyCount = 0;
          let fullCount = 0;

          snapshot.forEach((docSnap) => {
            const d = docSnap.data();
            const name = d.name || docSnap.id;
            const products = d.products || {};
            shelvesCache[name] = { ...d, name, products };

            const empty = Object.keys(products).length===0;
            if(empty) emptyCount++; else fullCount++;

            const card = document.createElement("div");
            card.className = "rack-card";
            if(empty) card.classList.add('empty');
            
            const statusClass = empty ? 'empty' : 'full';
            const statusText = empty ? 'BO≈û' : 'DOLU';
            const productsText = empty ? '<span style="color:var(--muted);font-style:italic;">√úr√ºn yok</span>' : productsHTML(products);
            
            card.innerHTML = `
              <div class="rack-card-header">
                <div class="rack-card-name">${name}</div>
                <div class="rack-card-status ${statusClass}">${statusText}</div>
              </div>
              <div class="rack-card-products">${productsText}</div>
            `;
            
            // Dolu/bo≈ü raflarƒ± ayrƒ± gruplara ekle
            if(empty && rackGridEmpty) {
              rackGridEmpty.appendChild(card);
            } else if(!empty && rackGridFull) {
              rackGridFull.appendChild(card);
            }
            
            // Eski tablo i√ßin geriye d√∂n√ºk uyumluluk
            if(rackBody){
              if(role !== "admin" && empty) return;
              
              const badge = empty
                ? '<span class="badge b-empty">BO≈û</span>'
                : '<span class="badge b-full">DOLU</span>';

              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${name}</td><td>${badge}</td><td>${productsSummary(products)}</td>`;
              rackBody.appendChild(tr);
            }
          });
          
          // Sayƒ±larƒ± g√ºncelle
          if(fullRackCount) fullRackCount.textContent = `(${fullCount})`;
          if(emptyRackCount) emptyRackCount.textContent = `(${emptyCount})`;
          
          // Bo≈ü mesajlarƒ± kontrol et
          if(rackFullEmpty) {
            rackFullEmpty.style.display = fullCount === 0 ? 'block' : 'none';
          }
          if(rackEmptyEmpty) {
            rackEmptyEmpty.style.display = emptyCount === 0 ? 'block' : 'none';
          }
          
          // Admin deƒüilse bo≈ü raflar b√∂l√ºm√ºn√º gizle
          if(role !== "admin" && emptyRacksSection) {
            emptyRacksSection.style.display = "none";
          }

          if(rackHint){
            if(role === "admin"){
              rackHint.textContent = `Toplam: ${total} raf ‚Ä¢ Dolu: ${fullCount} ‚Ä¢ Bo≈ü: ${emptyCount}`;
            }else{
              rackHint.textContent = `Dolu raf: ${fullCount}`;
            }
          }

          populateShelfDropdown();
          refreshClearMode();
          if(role==="admin") computeSummary();
        });

        // REQUEST LIST
        function renderReqRows(docs){
          if(!reqBody) return;
          reqBody.innerHTML = "";
          if(!docs || docs.length===0){
            reqWrap.style.display="none";
            setStatusBox(statusReqList, "Talep yok.", "warn");
            return;
          }

          for(const x of docs){
            const d = x.data();
            const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
            const dtStr = formatLogDate(dt);

            const badge = (d.status === "produced")
              ? `<span class="badge b-done">√úRETƒ∞LDƒ∞</span>`
              : `<span class="badge b-wait">BEKLƒ∞YOR</span>`;

            const requesterName = getNameByPin(d.requestedBy);
            const producerName = d.producedBy ? getNameByPin(d.producedBy) : "-";

            const quantity = d.quantity || 1;
            const quantityStyle = quantity > 1 ? 'color:#dc3545;font-weight:bold;' : '';
            
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${dtStr}</td>
              <td>${d.product || "-"}</td>
              <td style="${quantityStyle}">${quantity}</td>
              <td>${badge}</td>
              <td>${requesterName}</td>
              <td>${producerName}</td>
            `;
            
            // Sil butonu - sadece packer (2001) ve admin i√ßin
            const deleteTd = document.createElement('td');
            deleteTd.style.textAlign = 'center';
            
            const currentPin = window.__SESSION?.pin;
            const currentRole = window.__SESSION?.role;
            if(currentRole === 'admin' || currentPin === '2001') {
              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = 'üóëÔ∏è';
              deleteBtn.title = 'Sil';
              deleteBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:18px;padding:4px 8px;color:#dc3545;';
              deleteBtn.onclick = () => window.deleteProductionRequest(x.id);
              deleteTd.appendChild(deleteBtn);
            } else {
              deleteTd.textContent = '-';
            }
            
            tr.appendChild(deleteTd);
            reqBody.appendChild(tr);
          }

          reqWrap.style.display="block";
          setStatusBox(statusReqList, `G√∂steriliyor: ${docs.length}`, "ok");
        }

        // √úr√ºn talebini sil
        window.deleteProductionRequest = async function(requestId){
          if(!requestId) return;
          
          if(!confirm("Bu √ºretim talebini silmek istediƒüinize emin misiniz?")){
            return;
          }
          
          try{
            await deleteDoc(doc(db, "requests", requestId));
            
            await writeLog({ 
              action: "PRODUCTION_REQUEST_DELETE", 
              shelf: "-", 
              product: "-", 
              qty: 0, 
              detail: "√úretim talebi silindi" 
            });
            
            playBeep();
          }catch(e){
            alert("Hata: " + e.message);
          }
        };

        if(role==="packer" || role==="admin"){
          const qReq = query(reqCol, orderBy("createdAt","desc"), limit(200));
          onSnapshot(qReq, (snap)=> renderReqRows(snap.docs));
        }

        // Packer: fulfilled taleplerde sesli bildirim
        if(role==="packer"){
          const key = "seen_fulfilled_requests";
          const seen = new Set(JSON.parse(localStorage.getItem(key) || "[]"));

          const qFul = query(reqCol, where("status","==","fulfilled"), orderBy("fulfilledAt","desc"), limit(50));
          onSnapshot(qFul, (snap)=>{
            let playedAny = false;

            snap.forEach(docSnap=>{
              const id = docSnap.id;
              if(seen.has(id)) return;
              seen.add(id);
              playedAny = true;
            });

            if(playedAny){
              localStorage.setItem(key, JSON.stringify(Array.from(seen).slice(-500)));
              playBeep(); setTimeout(()=>playBeep(), 350);
              setStatusBox(statusReq, "üîî Bildirim: Yeni talep kar≈üƒ±landƒ±!", "ok");
              setTimeout(()=>setStatusBox(statusReq, "Hazƒ±r.", ""), 2500);
            }
          });
        }

        // PUT
        btnPut && (btnPut.onclick = async () => {
          setStatusBox(statusPut, "ƒ∞≈ülem yapƒ±lƒ±yor...", "");

          const code = (inProduct.value || "").trim();
          const shelfName = (inShelfNum.value || "").trim();
          const qty  = Number(inQty.value || 0);

          if(!code) return setStatusBox(statusPut, "√úr√ºn kodu bo≈ü olamaz.", "error");
          if(!shelfName) return setStatusBox(statusPut, "L√ºtfen bir raf se√ßiniz.", "error");
          if(!qty || qty < 1) return setStatusBox(statusPut, "Adet en az 1 olmalƒ±.", "error");

          const shelfData = shelvesCache[shelfName];
          if(!shelfData) return setStatusBox(statusPut, "Bu raf yok: " + shelfName, "error");

          const products = { ...(shelfData.products || {}) };
          products[code] = (products[code] || 0) + qty;

          try{
            await updateDoc(doc(shelvesCol, shelfName), { products, updated: serverTimestamp() });

            await writeLog({ action: "PUT", shelf: shelfName, product: code, qty, detail: "Rafa √ºr√ºn eklendi" });

            // Bildirim g√∂nder (Admin tarafƒ±ndan se√ßilen kullanƒ±cƒ±lara)
            const recipients = window.notificationRecipients.shelf_product_added || [];
            if (recipients.length > 0 && window.notificationEventStatus.shelf_product_added) {
              await sendNotification({
                eventType: 'shelf_product_added',
                targetPins: recipients,
                title: 'üì¶ Rafa √úr√ºn Eklendi',
                body: `${code} √ºr√ºn√ºnden ${qty} adet ${shelfName} rafƒ±na konuldu`
              });
            }

            // talepleri kar≈üƒ±la
            try{
              const qWait = query(reqCol, where("status","==","waiting"), where("product","==",code), limit(200));
              const waitSnap = await getDocs(qWait);
              if(!waitSnap.empty){
                const batch = writeBatch(db);
                waitSnap.forEach(r=>{
                  batch.update(r.ref, {
                    status: "fulfilled",
                    fulfilledAt: serverTimestamp(),
                    fulfilledBy: sessionPin || "-",
                    fulfilledShelf: shelfName
                  });
                });
                await batch.commit();

                await writeLog({ action: "FULFILL_REQUESTS", shelf: shelfName, product: code, qty, detail: `Bekleyen talepler: ${waitSnap.size}` });
                setStatusBox(statusPut, `Kaydedildi. ‚úÖ Talepler kar≈üƒ±landƒ±: ${waitSnap.size}`, "ok");
              }else{
                setStatusBox(statusPut, "Kaydedildi.", "ok");
              }
            }catch(e){
              setStatusBox(statusPut, "Kaydedildi. (Talep kontrol√º hata: " + e.message + ")", "warn");
            }

            inProduct.value = "";
            inShelfNum.value = "";
            inQty.value = "1";
          }catch(e){
            setStatusBox(statusPut, "Hata: " + e.message, "error");
          }
        });

        // CLEAR (adet azalt modu)
        btnClear && (btnClear.onclick = async () => {
          setStatusBox(statusClear, "ƒ∞≈ülem yapƒ±lƒ±yor...", "");

          const shelfName = (outShelfNum.value || "").trim();
          if(!shelfName) return setStatusBox(statusClear, "L√ºtfen bir raf se√ßiniz.", "error");

          const shelfData = shelvesCache[shelfName];
          if(!shelfData) return setStatusBox(statusClear, "Bu raf yok: " + shelfName, "error");
          if(isEmpty(shelfData)) return setStatusBox(statusClear, "Raf zaten bo≈ü.", "error");

          const productsNow = { ...(shelfData.products || {}) };
          const keys = Object.keys(productsNow);

          try{
            // 1 √ºr√ºn varsa
            if(keys.length === 1){
              const onlyCode = keys[0];
              const onlyQty  = Number(productsNow[onlyCode] || 0);

              // qty=1 => rafƒ± komple bo≈üalt
              if(onlyQty <= 1){
                await updateDoc(doc(shelvesCol, shelfName), { products: {}, updated: serverTimestamp() });
                await writeLog({ action: "CLEAR_SHELF", shelf: shelfName, product: "-", qty: 0, detail: "Raf tamamen bo≈üaltƒ±ldƒ±" });

                setStatusBox(statusClear, "Raf bo≈üaltƒ±ldƒ±.", "ok");
                outShelfNum.value = "";
                outProductCode.value = "";
                if(outReduceQty) outReduceQty.value = "1";
                clearProductBox.style.display = "none";
                clearHint.textContent = "";
                if(clearQtyBox) clearQtyBox.style.display="none";
                return;
              }

              // qty>1 => adet azalt
              const reduce = Math.max(1, Number(outReduceQty?.value || 1));
              const newQty = onlyQty - reduce;

              if(newQty <= 0){
                await updateDoc(doc(shelvesCol, shelfName), { products: {}, updated: serverTimestamp() });
                await writeLog({ action: "REMOVE_PRODUCT_ALL", shelf: shelfName, product: onlyCode, qty: reduce, detail: `√úr√ºn tamamen √ßƒ±karƒ±ldƒ± (Mevcut ${onlyQty})` });
                setStatusBox(statusClear, "√úr√ºn tamamen √ßƒ±karƒ±ldƒ±.", "ok");
              }else{
                productsNow[onlyCode] = newQty;
                await updateDoc(doc(shelvesCol, shelfName), { products: productsNow, updated: serverTimestamp() });
                await writeLog({ action: "DECREASE_QTY", shelf: shelfName, product: onlyCode, qty: reduce, detail: `Adet azaltƒ±ldƒ±: ${onlyQty} ‚Üí ${newQty}` });
                setStatusBox(statusClear, `Adet azaltƒ±ldƒ±. Kalan: ${newQty}`, "ok");
              }

              outProductCode.value = "";
              if(outReduceQty) outReduceQty.value = "1";
              refreshClearMode();
              return;
            }

            // Birden fazla √ºr√ºn varsa: √ºr√ºn kodu ≈üart
            const code = (outProductCode.value || "").trim();
            if(!code) return setStatusBox(statusClear, "√úr√ºn kodu yazƒ±n.", "error");
            if(!(code in productsNow)) return setStatusBox(statusClear, "Bu √ºr√ºn bu rafta yok.", "error");

            const currentQty = Number(productsNow[code] || 0);
            if(currentQty <= 0) return setStatusBox(statusClear, "Bu √ºr√ºn√ºn adedi ge√ßersiz.", "error");

            // qty>1 ise azalt; qty=1 ise direkt kaldƒ±r
            let reduce = 1;
            if(currentQty > 1){
              reduce = Math.max(1, Number(outReduceQty?.value || 1));
            }

            const newQty = currentQty - reduce;

            if(newQty <= 0){
              delete productsNow[code];
              await writeLog({ action: "REMOVE_PRODUCT", shelf: shelfName, product: code, qty: reduce, detail: `√úr√ºn √ßƒ±karƒ±ldƒ± (Mevcut ${currentQty})` });
            }else{
              productsNow[code] = newQty;
              await writeLog({ action: "DECREASE_QTY", shelf: shelfName, product: code, qty: reduce, detail: `Adet azaltƒ±ldƒ±: ${currentQty} ‚Üí ${newQty}` });
            }

            await updateDoc(doc(shelvesCol, shelfName), { products: productsNow, updated: serverTimestamp() });

            setStatusBox(
              statusClear,
              (newQty <= 0) ? "√úr√ºn raftan √ßƒ±karƒ±ldƒ±." : `Adet azaltƒ±ldƒ±. Kalan: ${newQty}`,
              "ok"
            );

            outProductCode.value = "";
            if(outReduceQty) outReduceQty.value = "1";
            refreshClearMode();

          }catch(e){
            setStatusBox(statusClear, "Hata: " + e.message, "error");
          }
        });

        // PRODUCTION REQUEST CREATE
        btnReq && (btnReq.onclick = async () => {
          setStatusBox(statusReq, "Talep g√∂nderiliyor...", "");

          const code = (reqProduct.value || "").trim();
          const qty = Math.max(1, Number(reqQuantity.value || 1));
          const prodType = reqProductionType?.value || "welder";
          
          if(!code) return setStatusBox(statusReq, "√úr√ºn kodu bo≈ü olamaz.", "error");

          try{
            await addDoc(reqCol, {
              product: code,
              quantity: qty,
              productionType: prodType,
              status: "pending",
              createdAt: serverTimestamp(),
              requestedBy: sessionPin || "-",
              producedAt: null,
              producedBy: null
            });

            await writeLog({ action: "PRODUCTION_REQUEST", shelf: "-", product: code, qty: qty, detail: `√úretim talebi olu≈üturuldu (${prodType === 'laser' ? 'Lazer' : 'Kaynak'}) - ${qty} adet` });

            // Bildirim g√∂nder (Admin tarafƒ±ndan se√ßilen kullanƒ±cƒ±lara)
            const recipients = window.notificationRecipients.production_request || [];
            console.log('üîî √úretim talebi bildirimi g√∂nderiliyor...');
            console.log('  - Recipients:', recipients);
            console.log('  - Event Status:', window.notificationEventStatus.production_request);
            console.log('  - Notification Recipients Object:', window.notificationRecipients);
            
            if (recipients.length > 0 && window.notificationEventStatus.production_request) {
              console.log('‚úÖ Bildirim g√∂nderiliyor:', {
                eventType: 'production_request',
                targetPins: recipients,
                title: prodType === 'laser' ? '‚ö° Lazer Talebi' : 'üî• Kaynak Talebi',
                body: `${code} √ºr√ºn√ºnden ${qty} adet talep edildi`
              });
              
              await sendNotification({
                eventType: 'production_request',
                targetPins: recipients,
                title: prodType === 'laser' ? '‚ö° Lazer Talebi' : 'üî• Kaynak Talebi',
                body: `${code} √ºr√ºn√ºnden ${qty} adet talep edildi`
              });
              
              console.log('‚úÖ Bildirim ba≈üarƒ±yla Firestore\'a eklendi');
            } else {
              console.warn('‚ö†Ô∏è Bildirim g√∂nderilmedi! Recipients:', recipients.length, 'Event aktif:', window.notificationEventStatus.production_request);
            }

            setStatusBox(statusReq, "Talep alƒ±ndƒ±. ‚úÖ", "ok");
            reqProduct.value = "";
            reqQuantity.value = "1";
            playBeep();
          }catch(e){
            setStatusBox(statusReq, "Hata: " + e.message, "error");
          }
        });

        // MATERIAL REQUEST CREATE
        btnMatReq && (btnMatReq.onclick = async () => {
          setStatusBox(statusMatReq, "Talep g√∂nderiliyor...", "");

          const name = (matReqName.value || "").trim();
          const qty = Math.max(1, Number(matReqQty.value || 1));
          const note = (matReqNote.value || "").trim();
          
          if(!name) return setStatusBox(statusMatReq, "Malzeme adƒ± bo≈ü olamaz.", "error");

          try{
            await addDoc(materialReqCol, {
              materialName: name,
              quantity: qty,
              note: note,
              status: "pending",
              createdAt: serverTimestamp(),
              requestedBy: sessionPin || "-",
              requestedByRole: role || "-",
              completedAt: null,
              completedBy: null
            });

            await writeLog({ action: "MATERIAL_REQUEST", shelf: "-", product: name, qty: qty, detail: `Malzeme talebi olu≈üturuldu: ${note || '-'}` });

            // Bildirim g√∂nder (Admin tarafƒ±ndan se√ßilen kullanƒ±cƒ±lara)
            const recipients = window.notificationRecipients.material_request || [];
            if (recipients.length > 0 && window.notificationEventStatus.material_request) {
              await sendNotification({
                eventType: 'material_request',
                targetPins: recipients,
                title: 'üõí Malzeme Talebi',
                body: `${name} - ${qty} adet ${note ? '(' + note + ')' : ''}`
              });
            }

            setStatusBox(statusMatReq, "Malzeme talebi alƒ±ndƒ±. ‚úÖ", "ok");
            matReqName.value = "";
            matReqQty.value = "1";
            matReqNote.value = "";
            playBeep();
          }catch(e){
            setStatusBox(statusMatReq, "Hata: " + e.message, "error");
          }
        });

        // MATERIAL REQUEST LIST (for requester)
        function renderMatReqRows(docs){
          if(!matReqBody) return;
          matReqBody.innerHTML = "";
          if(!docs || docs.length===0){
            matReqWrap.style.display="none";
            setStatusBox(statusMatReqList, "Talep yok.", "warn");
            return;
          }

          for(const x of docs){
            const d = x.data();
            const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
            const dtStr = formatLogDate(dt);

            let badge = `<span class="badge b-wait">BEKLEYEN</span>`;
            if(d.status === "processing") badge = `<span class="badge" style="background:rgba(59,130,246,.12);color:#1e3a8a;border-color:rgba(59,130,246,.18);">Sƒ∞PARƒ∞≈û VERƒ∞LDƒ∞</span>`;
            if(d.status === "completed") badge = `<span class="badge b-done">MALZEME ALINDI</span>`;
            if(d.status === "rejected") badge = `<span class="badge" style="background:rgba(239,68,68,.12);color:#7f1d1d;border-color:rgba(239,68,68,.18);">REDDEDƒ∞LDƒ∞</span>`;

            const requesterName = getNameByPin(d.requestedBy);
            
            let noteDisplay = d.note || "-";
            if(d.status === "rejected" && d.rejectionNote){
              noteDisplay = `<span style="color:#dc2626;font-weight:500;">Red Nedeni: ${d.rejectionNote}</span>`;
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${dtStr}</td>
              <td>${d.materialName || "-"}</td>
              <td>${d.quantity || 1}</td>
              <td>${badge}</td>
              <td>${requesterName}</td>
              <td>${noteDisplay}</td>
            `;
            matReqBody.appendChild(tr);
          }

          matReqWrap.style.display="block";
          setStatusBox(statusMatReqList, `G√∂steriliyor: ${docs.length}`, "ok");
        }

        if(role==="packer" || role==="admin" || role==="welder" || role==="stower"){
          const qMatReq = query(materialReqCol, orderBy("createdAt","desc"), limit(200));
          onSnapshot(qMatReq, (snap)=> renderMatReqRows(snap.docs));
        }

        // PURCHASE MANAGEMENT (for purchase role)
        async function loadMaterialRequests(){
          try{
            setStatusBox(statusPurchase, "Y√ºkleniyor...", "");
            
            const q = query(materialReqCol, orderBy("createdAt", "desc"), limit(500));
            
            const snap = await getDocs(q);
            purchaseBody.innerHTML = "";
            
            if(snap.empty){
              purchaseWrap.style.display = "none";
              setStatusBox(statusPurchase, "Talep bulunamadƒ±.", "warn");
              return;
            }

            snap.forEach(docSnap => {
              const d = docSnap.data();
              const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
              const dateStr = formatLogDate(dt);
              
              let statusBadge = `<span class="badge b-wait">BEKLEYEN</span>`;
              if(d.status === "processing") statusBadge = `<span class="badge" style="background:rgba(59,130,246,.12);color:#1e3a8a;border-color:rgba(59,130,246,.18);">Sƒ∞PARƒ∞≈û VERƒ∞LDƒ∞</span>`;
              if(d.status === "completed") statusBadge = `<span class="badge b-done">MALZEME ALINDI</span>`;
              if(d.status === "rejected") statusBadge = `<span class="badge" style="background:rgba(239,68,68,.12);color:#7f1d1d;border-color:rgba(239,68,68,.18);">REDDEDƒ∞LDƒ∞</span>`;
              
              const requesterName = getNameByPin(d.requestedBy);
              
              // Not g√∂sterimi - √∂nce kullanƒ±cƒ± notu, sonra satƒ±n alma notu
              let noteDisplay = d.note || "-";
              if(d.purchaseNote) {
                noteDisplay = `${d.note || '-'} <br><span style="color:#2563eb;font-weight:500;">Satƒ±n Alma: ${d.purchaseNote}</span>`;
              }
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${d.materialName || "-"}</td>
                <td>${d.quantity || 1}</td>
                <td>${requesterName}</td>
                <td>${noteDisplay}</td>
                <td>${statusBadge}</td>
                <td class="action-cell"></td>
              `;
              
              const actionCell = tr.querySelector('.action-cell');
              
              if(d.status === "pending"){
                const processBtn = document.createElement('button');
                processBtn.className = 'searchBtn';
                processBtn.textContent = 'Sƒ∞PARƒ∞≈û VER';
                processBtn.style.cssText = 'font-size:14px;padding:8px;';
                processBtn.onclick = () => window.updateMaterialStatus(docSnap.id, 'processing');
                
                actionCell.appendChild(processBtn);
              } else if(d.status === "processing"){
                const completeBtn = document.createElement('button');
                completeBtn.className = 'searchBtn';
                completeBtn.textContent = 'MALZEME ALINDI';
                completeBtn.style.cssText = 'font-size:14px;padding:8px;background:rgba(0,200,83,.12);';
                completeBtn.onclick = () => window.updateMaterialStatus(docSnap.id, 'completed');
                
                actionCell.appendChild(completeBtn);
              } else {
                actionCell.textContent = '-';
              }
              
              // Not ekleme butonu
              const noteTd = document.createElement('td');
              noteTd.style.textAlign = 'center';
              
              const noteBtn = document.createElement('button');
              noteBtn.textContent = 'üìù';
              noteBtn.title = 'Not Ekle/D√ºzenle';
              noteBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:18px;padding:4px 8px;';
              noteBtn.onclick = () => window.addPurchaseNote(docSnap.id, d.purchaseNote || '');
              
              noteTd.appendChild(noteBtn);
              tr.appendChild(noteTd);
              
              // Reddet butonu (sadece bekleyen ve i≈ülemdeki talepler i√ßin)
              const rejectTd = document.createElement('td');
              rejectTd.style.textAlign = 'center';
              
              if(d.status === 'pending' || d.status === 'processing') {
                const rejectBtn = document.createElement('button');
                rejectBtn.textContent = '‚ùå';
                rejectBtn.title = 'Reddet';
                rejectBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:18px;padding:4px 8px;';
                rejectBtn.onclick = () => window.rejectMaterialRequest(docSnap.id);
                rejectTd.appendChild(rejectBtn);
              } else {
                rejectTd.textContent = '-';
              }
              
              tr.appendChild(rejectTd);
              
              // Sil butonu (t√ºm talepler i√ßin)
              const deleteTd = document.createElement('td');
              deleteTd.style.textAlign = 'center';
              
              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = 'üóëÔ∏è';
              deleteBtn.title = 'Sil';
              deleteBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:18px;padding:4px 8px;color:#dc3545;';
              deleteBtn.onclick = () => window.deleteMaterialRequest(docSnap.id);
              deleteTd.appendChild(deleteBtn);
              
              tr.appendChild(deleteTd);
              
              purchaseBody.appendChild(tr);
            });

            purchaseWrap.style.display = "block";
            setStatusBox(statusPurchase, `Toplam: ${snap.size} kayƒ±t`, "ok");
          }catch(e){
            setStatusBox(statusPurchase, "Hata: " + e.message, "error");
          }
        }

        window.deleteMaterialRequest = async function(requestId){
          if(!requestId) return;
          
          if(!confirm("Bu talebi silmek istediƒüinize emin misiniz?")){
            return;
          }
          
          try{
            const requestRef = doc(db, "materialRequests", requestId);
            await deleteDoc(requestRef);
            
            await writeLog({ 
              action: "MATERIAL_STATUS_UPDATE", 
              shelf: "-", 
              product: "-", 
              qty: 0, 
              detail: `Malzeme talebi silindi` 
            });
            
            playBeep();
            loadMaterialRequests();
          }catch(e){
            alert("Hata: " + e.message);
          }
        };

        window.addPurchaseNote = async function(requestId, currentNote){
          try {
            const newNote = prompt('Satƒ±n alma notu:', currentNote || '');
            if(newNote !== null) {
              await updateDoc(doc(db, 'materialRequests', requestId), {
                purchaseNote: newNote.trim()
              });
              playBeep();
              loadMaterialRequests();
            }
          } catch (e) {
            console.error('Not ekleme hatasƒ±:', e);
            alert('Hata: ' + e.message);
          }
        };

        window.rejectMaterialRequest = async function(requestId){
          try {
            if(!confirm('Bu talebi reddetmek istediƒüinize emin misiniz?')){
              return;
            }
            await updateDoc(doc(db, 'materialRequests', requestId), {
              status: 'rejected',
              rejectedAt: serverTimestamp(),
              rejectedBy: sessionPin || '-'
            });
            playBeep();
            loadMaterialRequests();
          } catch (e) {
            console.error('Reddetme hatasƒ±:', e);
            alert('Hata: ' + e.message);
          }
        };

        window.updateMaterialStatus = async function(requestId, newStatus){
          if(!requestId) return;
          
          try{
            const requestRef = doc(db, "materialRequests", requestId);
            const updateData = { status: newStatus };
            
            if(newStatus === "completed"){
              updateData.completedAt = serverTimestamp();
              updateData.completedBy = sessionPin || "-";
            }
            
            await updateDoc(requestRef, updateData);
            
            await writeLog({ 
              action: "MATERIAL_STATUS_UPDATE", 
              shelf: "-", 
              product: "-", 
              qty: 0, 
              detail: `Malzeme talebi durumu: ${newStatus}` 
            });
            
            // Mal alƒ±ndƒ±ysa talep edene bildirim g√∂nder
            if(newStatus === "completed"){
              const requestSnap = await getDoc(requestRef);
              const requestData = requestSnap.data();
              
              if(requestData && requestData.requestedBy && window.notificationEventStatus.material_completed){
                await sendNotification({
                  eventType: 'material_completed',
                  targetPins: [requestData.requestedBy],
                  title: '‚úÖ Malzeme Alƒ±ndƒ±',
                  body: `${requestData.materialName} malzemesi temin edildi`
                });
              }
            }
            
            playBeep();
            loadMaterialRequests();
          }catch(e){
            alert("Hata: " + e.message);
          }
        };
        
        if(role === 'purchase' || role === 'admin'){
          loadMaterialRequests();
        }

        // SETUP (admin only)
        if(btnSetup && role==="admin"){
          btnSetup.onclick = async () => {
            setupStatus.textContent = "Raflar olu≈üturuluyor...";

            const count = Number(setupCount.value || 0);
            const prefix = (setupPrefix.value || "R").trim().toUpperCase();

            if (!count || count < 1) {
              setupStatus.textContent = "Raf sayƒ±sƒ± 1 veya daha b√ºy√ºk olmalƒ±.";
              return;
            }
            if (prefix !== "R") {
              setupStatus.textContent = "Prefix R olmalƒ±.";
              return;
            }

            try {
              const CHUNK_SIZE = 450;
              let created = 0;

              for (let start = 1; start <= count; start += CHUNK_SIZE) {
                const batch = writeBatch(db);
                const end = Math.min(start + CHUNK_SIZE - 1, count);

                for (let i = start; i <= end; i++) {
                  const rafAdi = padShelf(i);
                  batch.set(
                    doc(shelvesCol, rafAdi),
                    { name: rafAdi, products: {}, updated: serverTimestamp() },
                    { merge: true }
                  );
                }

                await batch.commit();
                created = end;
                setupStatus.textContent = `Olu≈üturuldu: ${created} / ${count}`;
              }

              await setDoc(initRef, { done:true, count, updated: serverTimestamp() }, { merge:true });
              await writeLog({ action: "SETUP", shelf: "-", product: "-", qty: 0, detail: `Manuel kurulum: ${count} raf` });

              setupStatus.textContent = `Bƒ∞TTƒ∞ ‚úÖ Toplam ${count} raf olu≈üturuldu.`;
            } catch (e) {
              setupStatus.textContent = "Hata: " + e.message;
            }
          };
        }

        // ADMIN: LOG Y√úKLE
        let currentLogActionFilter = 'all';
        let currentLogRoleFilter = 'all';

        async function loadLogs(actionFilter = 'all', roleFilter = 'all'){
          if(role!=="admin") return;

          setStatusBox(statusLogs, "Loglar y√ºkleniyor...", "");
          logsBody.innerHTML = "";
          logsWrap.style.display = "none";

          currentLogActionFilter = actionFilter;
          currentLogRoleFilter = roleFilter;

          // Action filter butonlarƒ±nƒ± g√ºncelle
          [btnLogPut, btnLogClear, btnLogDecrease, btnLogMaterial, btnLogProduction, btnLogAccounts, btnLogPayments, btnLogCommission, btnLogAllActions].forEach(btn => {
            btn && btn.classList.remove('active');
          });
          // Role filter butonlarƒ±nƒ± g√ºncelle
          [btnLogAdmin, btnLogPacker, btnLogStower, btnLogWelder, btnLogPurchase, btnLogAllRoles].forEach(btn => {
            btn && btn.classList.remove('active');
          });

          if(actionFilter === 'put') btnLogPut?.classList.add('active');
          else if(actionFilter === 'clear') btnLogClear?.classList.add('active');
          else if(actionFilter === 'decrease') btnLogDecrease?.classList.add('active');
          else if(actionFilter === 'material') btnLogMaterial?.classList.add('active');
          else if(actionFilter === 'production') btnLogProduction?.classList.add('active');
          else if(actionFilter === 'accounts') btnLogAccounts?.classList.add('active');
          else if(actionFilter === 'payments') btnLogPayments?.classList.add('active');
          else if(actionFilter === 'commission') btnLogCommission?.classList.add('active');
          else btnLogAllActions?.classList.add('active');

          if(roleFilter === 'admin') btnLogAdmin?.classList.add('active');
          else if(roleFilter === 'packer') btnLogPacker?.classList.add('active');
          else if(roleFilter === 'stower') btnLogStower?.classList.add('active');
          else if(roleFilter === 'welder') btnLogWelder?.classList.add('active');
          else if(roleFilter === 'purchase') btnLogPurchase?.classList.add('active');
          else btnLogAllRoles?.classList.add('active');

          const lim = Math.max(10, Math.min(10000, Number(logLimit.value || 1000)));

          try{
            const ql = query(logsCol, orderBy("ts","desc"), limit(lim));
            const snap = await getDocs(ql);

            if(snap.empty){
              setStatusBox(statusLogs, "Log bulunamadƒ±.", "warn");
              return;
            }

            let filteredLogs = [];

            snap.forEach(docSnap=>{
              const d = docSnap.data() || {};
              
              // Action filter
              let passActionFilter = true;
              if(actionFilter !== 'all'){
                const action = d.action || "";
                if(actionFilter === 'put' && action !== 'PUT') passActionFilter = false;
                else if(actionFilter === 'clear' && !['CLEAR_SHELF', 'REMOVE_PRODUCT_ALL', 'REMOVE_PRODUCT'].includes(action)) passActionFilter = false;
                else if(actionFilter === 'decrease' && action !== 'DECREASE_QTY') passActionFilter = false;
                else if(actionFilter === 'material' && !['MATERIAL_REQUEST', 'MATERIAL_STATUS_UPDATE'].includes(action)) passActionFilter = false;
                else if(actionFilter === 'production' && !['PRODUCTION_REQUEST', 'PRODUCTION_REQUEST_DELETE', 'PRODUCTION_COMPLETED', 'FULFILL_REQUESTS'].includes(action)) passActionFilter = false;
                else if(actionFilter === 'accounts' && action !== 'ACCOUNT_TRANSACTION') passActionFilter = false;
                else if(actionFilter === 'payments' && action !== 'PAYMENT_RECORD') passActionFilter = false;
                else if(actionFilter === 'commission' && !['COMMISSION_TRANSACTION', 'COMMISSION_COLLECTION'].includes(action)) passActionFilter = false;
              }

              // Role filter
              let passRoleFilter = true;
              if(roleFilter !== 'all'){
                const logRole = d.role || "";
                if(logRole !== roleFilter) passRoleFilter = false;
              }

              if(passActionFilter && passRoleFilter){
                filteredLogs.push(d);
              }
            });

            if(filteredLogs.length === 0){
              setStatusBox(statusLogs, "Bu filtreye uygun log bulunamadƒ±.", "warn");
              return;
            }

            filteredLogs.forEach(d => {
              const dt = d.ts?.toDate ? d.ts.toDate() : null;
              const dtStr = formatLogDate(dt);
              
              const userName = getNameByPin(d.pin);
              const roleText = d.role || "-";

              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${dtStr}</td>
                <td>${roleText} / ${userName}</td>
                <td>${translateAction(d.action || "-")}</td>
                <td>${(d.shelf || "-")}</td>
                <td>${(d.product || "-")}</td>
                <td>${(d.qty ?? "-")}</td>
                <td>${(d.detail || "-")}</td>
              `;
              logsBody.appendChild(tr);
            });

            logsWrap.style.display = "block";
            const actionText = actionFilter === 'put' ? 'Rafa Koy' : 
                              actionFilter === 'clear' ? 'Raf Bo≈üalt' : 
                              actionFilter === 'decrease' ? 'Adet Azalt' : 
                              actionFilter === 'material' ? 'Malzeme' : 
                              actionFilter === 'production' ? '√úretim' : 
                              actionFilter === 'accounts' ? 'Cari Hesaplar' : 
                              actionFilter === 'payments' ? 'Personel √ñdemeleri' : 
                              actionFilter === 'commission' ? 'Komisyon' : 'T√ºm';
            const roleText = roleFilter === 'admin' ? 'Y√∂netici' : 
                            roleFilter === 'packer' ? 'Paket√ßi' : 
                            roleFilter === 'stower' ? 'Raf Dizen' : 
                            roleFilter === 'welder' ? '√úretim' : 
                            roleFilter === 'purchase' ? 'Satƒ±n Alma' : 'T√ºm';
            setStatusBox(statusLogs, `${actionText} / ${roleText}: ${filteredLogs.length} kayƒ±t`, "ok");
          }catch(e){
            setStatusBox(statusLogs, "Hata: " + e.message, "error");
          }
        }

        btnLoadLogs && (btnLoadLogs.onclick = () => loadLogs(currentLogActionFilter, currentLogRoleFilter));
        
        btnLogPut && (btnLogPut.onclick = () => loadLogs('put', currentLogRoleFilter));
        btnLogClear && (btnLogClear.onclick = () => loadLogs('clear', currentLogRoleFilter));
        btnLogDecrease && (btnLogDecrease.onclick = () => loadLogs('decrease', currentLogRoleFilter));
        btnLogMaterial && (btnLogMaterial.onclick = () => loadLogs('material', currentLogRoleFilter));
        btnLogProduction && (btnLogProduction.onclick = () => loadLogs('production', currentLogRoleFilter));
        btnLogAccounts && (btnLogAccounts.onclick = () => loadLogs('accounts', currentLogRoleFilter));
        btnLogPayments && (btnLogPayments.onclick = () => loadLogs('payments', currentLogRoleFilter));
        btnLogCommission && (btnLogCommission.onclick = () => loadLogs('commission', currentLogRoleFilter));
        btnLogAllActions && (btnLogAllActions.onclick = () => loadLogs('all', currentLogRoleFilter));
        
        btnLogAdmin && (btnLogAdmin.onclick = () => loadLogs(currentLogActionFilter, 'admin'));
        btnLogPacker && (btnLogPacker.onclick = () => loadLogs(currentLogActionFilter, 'packer'));
        btnLogStower && (btnLogStower.onclick = () => loadLogs(currentLogActionFilter, 'stower'));
        btnLogWelder && (btnLogWelder.onclick = () => loadLogs(currentLogActionFilter, 'welder'));
        btnLogPurchase && (btnLogPurchase.onclick = () => loadLogs(currentLogActionFilter, 'purchase'));
        btnLogAllRoles && (btnLogAllRoles.onclick = () => loadLogs(currentLogActionFilter, 'all'));

        // Welder (Kaynak ƒ∞malat) functionality
        // Adet dropdown'ƒ±nƒ± doldur (1-40 arasƒ±)
        if(welderQty){
          for(let i = 1; i <= 40; i++){
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = i;
            welderQty.appendChild(opt);
          }
          welderQty.value = "1"; // Varsayƒ±lan deƒüer 1
        }

        let editingProductionId = null;

        window.editProduction = function(docId, productCode, status, quantity) {
          console.log("üîß editProduction √ßaƒürƒ±ldƒ±:", docId);
          
          if(!welderCode || !welderStatus || !welderQty || !welderSave) {
            console.error("‚ùå Form elementleri bulunamadƒ±!");
            return;
          }
          
          editingProductionId = docId;
          welderCode.value = productCode;
          welderStatus.value = status;
          welderQty.value = quantity;
          
          welderSave.textContent = "G√úNCELLE";
          welderSave.style.background = "#0891b2";
          
          setStatusBox(statusWelder, "D√ºzenleme modu - deƒüi≈üiklikleri yapƒ±n ve G√úNCELLE'ye tƒ±klayƒ±n.", "info");
          
          // ƒ∞ptal butonu ekle
          if(!document.getElementById("btnCancelProductionEdit")) {
            const cancelBtn = document.createElement("button");
            cancelBtn.id = "btnCancelProductionEdit";
            cancelBtn.textContent = "ƒ∞PTAL";
            cancelBtn.className = "btn";
            cancelBtn.style.background = "#6c757d";
            cancelBtn.style.marginLeft = "10px";
            cancelBtn.onclick = cancelProductionEdit;
            welderSave.parentNode.insertBefore(cancelBtn, welderSave.nextSibling);
          }
          
          // Formu scroll
          welderCode.focus();
          welderCode.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          console.log("‚úÖ D√ºzenleme modu aktif");
        };

        window.deleteProduction = async function(docId) {
          if(!confirm("Bu √ºretim kaydƒ±nƒ± silmek istediƒüinizden emin misiniz?")) return;
          
          try {
            await deleteDoc(doc(db, "production", docId));
            setStatusBox(statusWelderToday, "‚úì Kayƒ±t silindi.", "ok");
            playBeep();
            loadTodayProduction();
          } catch(e) {
            setStatusBox(statusWelderToday, "Hata: " + e.message, "error");
          }
        };

        function cancelProductionEdit() {
          editingProductionId = null;
          welderCode.value = "";
          welderQty.value = "1";
          welderStatus.value = "√úRETƒ∞LDƒ∞";
          welderSave.textContent = "KAYDET";
          welderSave.style.background = "";
          
          const cancelBtn = document.getElementById("btnCancelProductionEdit");
          if(cancelBtn) cancelBtn.remove();
          
          setStatusBox(statusWelder, "", "");
          statusWelder.style.display = "none";
        }

        async function saveProduction(){
          const code = (welderCode.value || "").trim();
          // Lazerci i√ßin varsayƒ±lan durum "KESƒ∞LDƒ∞", diƒüerleri i√ßin se√ßilen durum
          const status = LASER_PINS.has(sessionPin) ? "KESƒ∞LDƒ∞" : (welderStatus.value || "√úRETƒ∞LDƒ∞");
          const qty = parseInt(welderQty.value || "0", 10);

          if(!code){
            setStatusBox(statusWelder, "√úr√ºn kodu giriniz.", "error");
            return;
          }
          if(qty <= 0){
            setStatusBox(statusWelder, "Ge√ßerli bir adet giriniz.", "error");
            return;
          }

          try{
            if(editingProductionId) {
              // G√úNCELLEME MODU
              setStatusBox(statusWelder, "G√ºncelleniyor...", "info");
              
              await updateDoc(doc(db, "production", editingProductionId), {
                productCode: code,
                productionStatus: status,
                quantity: qty,
                updatedAt: serverTimestamp()
              });
              
              setStatusBox(statusWelder, "‚úì Ba≈üarƒ±yla g√ºncellendi.", "ok");
              cancelProductionEdit();
              
            } else {
              // YENƒ∞ KAYIT MODU
              setStatusBox(statusWelder, "Kaydediliyor...", "");
              await addDoc(productionCol, {
                productCode: code,
                productionStatus: status,
                quantity: qty,
                welderPin: sessionPin,
                createdAt: serverTimestamp()
              });

              setStatusBox(statusWelder, "√úretim kaydedildi!", "ok");
              welderCode.value = "";
              welderQty.value = "1";
              welderStatus.value = "√úRETƒ∞LDƒ∞";
            }
            
            playBeep();
            setTimeout(()=>welderCode.focus(), 100);
            loadTodayProduction();
          }catch(e){
            setStatusBox(statusWelder, "Hata: " + e.message, "error");
          }
        }

        async function loadTodayProduction(){
          try{
            setStatusBox(statusWelderToday, "Y√ºkleniyor...", "");
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const q = query(
              productionCol,
              where("createdAt", ">=", today),
              orderBy("createdAt", "desc")
            );
            
            const snap = await getDocs(q);
            welderTodayBody.innerHTML = "";
            
            if(snap.empty){
              welderTodayWrap.style.display = "none";
              setStatusBox(statusWelderToday, "Bug√ºn √ºretim kaydƒ± yok.", "warn");
              return;
            }

            snap.forEach(docSnap => {
              const d = docSnap.data();
              const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
              const timeStr = dt ? dt.toLocaleTimeString("tr-TR") : "-";
              
              const statusBadge = d.productionStatus || "√úRETƒ∞LDƒ∞";
              let statusColor = "#10b981"; // Ye≈üil
              if(statusBadge === "KESƒ∞LDƒ∞") statusColor = "#f59e0b"; // Turuncu
              else if(statusBadge === "PUNTALANDI") statusColor = "#3b82f6"; // Mavi
              else if(statusBadge === "KAYNATILDI") statusColor = "#8b5cf6"; // Mor
              
              // G√ºvenli veri
              const safeProductCode = (d.productCode || "").replace(/'/g, "&#39;").replace(/"/g, "&quot;");
              const safeStatus = (statusBadge || "").replace(/'/g, "&#39;").replace(/"/g, "&quot;");
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${timeStr}</td>
                <td>${d.productCode || "-"}</td>
                <td><span style="background:${statusColor};color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:700;">${statusBadge}</span></td>
                <td>${d.quantity || 0}</td>
                <td style="text-align:center;">
                  <button data-id="${docSnap.id}" data-code="${safeProductCode}" data-status="${safeStatus}" data-qty="${d.quantity || 1}" class="btn-edit-production" style="background:#0891b2;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-weight:700;font-size:11px;margin-right:4px;">D√úZENLE</button>
                  <button data-id="${docSnap.id}" class="btn-delete-production" style="background:#dc2626;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-weight:700;font-size:11px;">Sƒ∞L</button>
                </td>
              `;
              welderTodayBody.appendChild(tr);
            });
            
            // Event listener'larƒ± ekle
            document.querySelectorAll('.btn-edit-production').forEach(btn => {
              btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const code = this.getAttribute('data-code').replace(/&#39;/g, "'").replace(/&quot;/g, '"');
                const status = this.getAttribute('data-status').replace(/&#39;/g, "'").replace(/&quot;/g, '"');
                const qty = parseInt(this.getAttribute('data-qty') || "1", 10);
                window.editProduction(id, code, status, qty);
              });
            });
            
            document.querySelectorAll('.btn-delete-production').forEach(btn => {
              btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                window.deleteProduction(id);
              });
            });

            welderTodayWrap.style.display = "block";
            setStatusBox(statusWelderToday, `Toplam ${snap.size} kayƒ±t`, "ok");
          }catch(e){
            setStatusBox(statusWelderToday, "Hata: " + e.message, "error");
          }
        }

        welderSave && (welderSave.onclick = saveProduction);
        
        // Lazerci rol√º i√ßin durum alanƒ±nƒ± gizle
        if(role === "welder" && LASER_PINS.has(sessionPin)) {
          const welderStatusRow = welderStatus?.closest('.formRow');
          if(welderStatusRow) {
            welderStatusRow.style.display = 'none';
          }
        }
        
        if(role === "welder"){
          loadTodayProduction();
          loadWelderRequests();
        }

        // Welder requests list
        async function loadWelderRequests(){
          try{
            setStatusBox(statusWelderRequests, "Y√ºkleniyor...", "");
            
            // Kullanƒ±cƒ±nƒ±n tipini belirle (laser mi welder mƒ±?)
            let userProductionType = null;
            if(LASER_PINS.has(sessionPin)){
              userProductionType = "laser";
            } else if(WELDER_PINS.has(sessionPin)){
              userProductionType = "welder";
            }
            
            // T√ºm talepleri al ve client-side filtrele (index hatasƒ± olmasƒ±n diye)
            const q = query(reqCol, orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            
            welderRequestsBody.innerHTML = "";
            
            let filteredDocs = [];
            if(role === "admin"){
              // Admin t√ºm talepleri g√∂r√ºr
              filteredDocs = snap.docs;
            } else if(userProductionType){
              // Sadece kendi tipine ait talepleri filtrele
              filteredDocs = snap.docs.filter(doc => {
                const data = doc.data();
                return data.productionType === userProductionType;
              });
            }
            
            if(filteredDocs.length === 0){
              welderRequestsWrap.style.display = "none";
              setStatusBox(statusWelderRequests, "Talep bulunamadƒ±.", "warn");
              return;
            }

            filteredDocs.forEach(doc => {
              const d = doc.data();
              const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
              const dateStr = dt ? formatLogDate(dt) : "-";
              
              const statusBadge = (d.status === "produced")
                ? `<span class="badge b-done">√úRETƒ∞LDƒ∞</span>`
                : `<span class="badge b-wait">BEKLƒ∞YOR</span>`;
              
              const actionBtn = (d.status === "pending")
                ? `<button class="searchBtn" onclick="markAsProduced('${doc.id}', '${d.product}')">√úRETTƒ∞M</button>`
                : "-";
              
              const requesterName = getNameByPin(d.requestedBy);
              
              const quantity = d.quantity || 1;
              const quantityStyle = quantity > 1 ? 'color:#dc3545;font-weight:bold;' : '';
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${d.product || "-"}</td>
                <td style="${quantityStyle}">${quantity}</td>
                <td>${requesterName}</td>
                <td>${statusBadge}</td>
                <td>${actionBtn}</td>
              `;
              welderRequestsBody.appendChild(tr);
            });

            welderRequestsWrap.style.display = "block";
            setStatusBox(statusWelderRequests, `Toplam ${filteredDocs.length} talep`, "ok");
          }catch(e){
            setStatusBox(statusWelderRequests, "Hata: " + e.message, "error");
          }
        }

        // Mark production request as produced
        window.markAsProduced = async function(requestId, productCode){
          if(!requestId) return;
          
          try{
            const requestRef = doc(db, "requests", requestId);
            await updateDoc(requestRef, {
              status: "produced",
              producedAt: serverTimestamp(),
              producedBy: sessionPin || "-"
            });
            
            await writeLog({ 
              action: "PRODUCTION_COMPLETED", 
              shelf: "-", 
              product: productCode, 
              qty: 0, 
              detail: `√úretim talebi tamamlandƒ± (Kaynak√ßƒ±: ${sessionPin})` 
            });
            
            // Bildirim g√∂nder (Admin tarafƒ±ndan se√ßilen kullanƒ±cƒ±lara)
            const recipients = window.notificationRecipients.production_completed || [];
            if (recipients.length > 0 && window.notificationEventStatus.production_completed) {
              await sendNotification({
                eventType: 'production_completed',
                targetPins: recipients,
                title: '‚úÖ √úretim Tamamlandƒ±',
                body: `${productCode} √ºr√ºn√º hazƒ±r, paketlenebilir`
              });
            }
            
            playBeep();
            loadWelderRequests(); // Reload the list
          }catch(e){
            alert("Hata: " + e.message);
          }
        };

        // Production list for admin & packer
        async function loadProduction(filter = 'day'){
          try{
            setStatusBox(statusProduction, "Y√ºkleniyor...", "");
            
            // Filtre butonlarƒ±nƒ±n aktif durumunu g√ºncelle
            [btnProdDay, btnProdWeek, btnProdMonth, btnProdYear].forEach(btn => {
              btn && btn.classList.remove('active');
            });
            
            if(filter === 'day') btnProdDay?.classList.add('active');
            else if(filter === 'week') btnProdWeek?.classList.add('active');
            else if(filter === 'month') btnProdMonth?.classList.add('active');
            else if(filter === 'year') btnProdYear?.classList.add('active');
            
            const now = new Date();
            let startDate = new Date();
            
            if(filter === 'day'){
              startDate.setHours(0, 0, 0, 0);
            } else if(filter === 'week'){
              startDate.setDate(now.getDate() - 7);
              startDate.setHours(0, 0, 0, 0);
            } else if(filter === 'month'){
              startDate.setMonth(now.getMonth() - 1);
              startDate.setHours(0, 0, 0, 0);
            } else if(filter === 'year'){
              startDate.setFullYear(now.getFullYear() - 1);
              startDate.setHours(0, 0, 0, 0);
            }
            
            const q = query(
              productionCol,
              where("createdAt", ">=", startDate),
              orderBy("createdAt", "desc")
            );
            
            const snap = await getDocs(q);
            productionBody.innerHTML = "";
            
            if(snap.empty){
              productionWrap.style.display = "none";
              setStatusBox(statusProduction, "√úretim kaydƒ± bulunamadƒ±.", "warn");
              return;
            }

            let totalQty = 0;
            snap.forEach(doc => {
              const d = doc.data();
              const dt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
              const dateStr = formatLogDate(dt);
              totalQty += (d.quantity || 0);
              
              const welderName = getNameByPin(d.welderPin);
              
              const statusBadge = d.productionStatus || "√úRETƒ∞LDƒ∞";
              let statusColor = "#10b981"; // Ye≈üil
              if(statusBadge === "KESƒ∞LDƒ∞") statusColor = "#f59e0b"; // Turuncu
              else if(statusBadge === "PUNTALANDI") statusColor = "#3b82f6"; // Mavi
              else if(statusBadge === "KAYNATILDI") statusColor = "#8b5cf6"; // Mor
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${dateStr}</td>
                <td>${d.productCode || "-"}</td>
                <td><span style="background:${statusColor};color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:700;">${statusBadge}</span></td>
                <td>${d.quantity || 0}</td>
                <td>${welderName}</td>
              `;
              productionBody.appendChild(tr);
            });

            productionWrap.style.display = "block";
            const filterText = filter === 'day' ? 'G√ºnl√ºk' : filter === 'week' ? 'Haftalƒ±k' : filter === 'month' ? 'Aylƒ±k' : 'Yƒ±llƒ±k';
            setStatusBox(statusProduction, `${filterText}: ${snap.size} kayƒ±t, Toplam ${totalQty} adet`, "ok");
          }catch(e){
            setStatusBox(statusProduction, "Hata: " + e.message, "error");
          }
        }

        btnProdDay && (btnProdDay.onclick = () => loadProduction('day'));
        btnProdWeek && (btnProdWeek.onclick = () => loadProduction('week'));
        btnProdMonth && (btnProdMonth.onclick = () => loadProduction('month'));
        btnProdYear && (btnProdYear.onclick = () => loadProduction('year'));
        
        // Admin veya packer i√ßin otomatik y√ºkleme
        if(role === 'admin' || role === 'packer'){
          // √ñnce g√ºnl√ºk kontrol et
          (async () => {
            try {
              const now = new Date();
              const todayStart = new Date();
              todayStart.setHours(0, 0, 0, 0);
              
              const qDay = query(
                productionCol,
                where("createdAt", ">=", todayStart),
                limit(1)
              );
              
              const daySnap = await getDocs(qDay);
              
              if(daySnap.empty) {
                // G√ºnl√ºk √ºretim yoksa haftalƒ±k g√∂ster
                loadProduction('week');
              } else {
                // G√ºnl√ºk √ºretim varsa g√ºnl√ºk g√∂ster
                loadProduction('day');
              }
            } catch(e) {
              // Hata durumunda g√ºnl√ºk g√∂ster
              loadProduction('day');
            }
          })();
        }

        // INSTRUCTIONS: √úr√ºn talimatlarƒ±nƒ± y√ºkle
        async function loadInstructions() {
          const productCode = (instructionsProductCode.value || "").trim();
          if(!productCode) {
            setStatusBox(statusInstructions, "√úr√ºn kodu giriniz.", "error");
            return;
          }

          setStatusBox(statusInstructions, "Y√ºkleniyor...", "");
          instructionsContent.style.display = "none";
          instructionContainer.innerHTML = "";

          try {
            // Firestore'dan √ºr√ºn talimatƒ±nƒ± getir
            const q = query(instructionsCol, where("productCode", "==", productCode), limit(1));
            const snap = await getDocs(q);
            
            if(snap.empty) {
              setStatusBox(statusInstructions, `${productCode} kodlu √ºr√ºn i√ßin talimat bulunamadƒ±.`, "error");
              instructionContainer.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);">Bu √ºr√ºn i√ßin hen√ºz talimat eklenmemi≈ü.</div>';
              instructionsContent.style.display = "block";
              return;
            }

            const data = snap.docs[0].data();
            const type = data.instructionType || "pdf"; // pdf, image, link
            const url = data.instructionUrl || "";

            if(!url) {
              setStatusBox(statusInstructions, "Talimat URL'si bulunamadƒ±.", "error");
              return;
            }

            instructionsContent.style.display = "block";

            if(type === "pdf") {
              // PDF i√ßin iframe
              const iframe = document.createElement('iframe');
              iframe.src = url;
              iframe.style.cssText = 'width:100%;height:600px;border:none;';
              instructionContainer.appendChild(iframe);
              setStatusBox(statusInstructions, "Talimat y√ºklendi.", "ok");
            } else if(type === "image") {
              // Resim i√ßin img
              const img = document.createElement('img');
              img.src = url;
              img.style.cssText = 'width:100%;height:auto;max-height:600px;object-fit:contain;';
              img.onerror = () => {
                setStatusBox(statusInstructions, "Resim y√ºklenemedi.", "error");
              };
              img.onload = () => {
                setStatusBox(statusInstructions, "Talimat y√ºklendi.", "ok");
              };
              instructionContainer.appendChild(img);
            } else if(type === "link") {
              // Link i√ßin buton
              const linkDiv = document.createElement('div');
              linkDiv.style.cssText = 'padding:40px;text-align:center;';
              
              const linkBtn = document.createElement('a');
              linkBtn.href = url;
              linkBtn.target = "_blank";
              linkBtn.textContent = "Talimatƒ± A√ß (Yeni Sekmede)";
              linkBtn.style.cssText = 'display:inline-block;padding:14px 24px;background:var(--green);color:#07210f;text-decoration:none;border-radius:12px;font-weight:900;font-size:16px;';
              
              linkDiv.appendChild(linkBtn);
              instructionContainer.appendChild(linkDiv);
              setStatusBox(statusInstructions, "Talimat linki hazƒ±r.", "ok");
            } else {
              setStatusBox(statusInstructions, "Bilinmeyen talimat tipi.", "error");
            }
          } catch(e) {
            console.error('Talimat y√ºkleme hatasƒ±:', e);
            setStatusBox(statusInstructions, "Hata: " + e.message, "error");
          }
        }

        btnLoadInstructions && (btnLoadInstructions.onclick = loadInstructions);
        instructionsProductCode && instructionsProductCode.addEventListener("keydown", (e) => {
          if(e.key === "Enter") loadInstructions();
        });

        // Toplu talimat y√ºkleme fonksiyonu
        async function bulkUploadInstructions() {
          if(!bulkInstructionsInput || !statusBulkInstructions) return;
          
          try {
            const text = bulkInstructionsInput.value.trim();
            if(!text) {
              setStatusBox(statusBulkInstructions, "L√ºtfen veri girin.", "error");
              return;
            }

            const lines = text.split('\n').filter(line => line.trim());
            if(lines.length === 0) {
              setStatusBox(statusBulkInstructions, "Hi√ß satƒ±r bulunamadƒ±.", "error");
              return;
            }

            setStatusBox(statusBulkInstructions, `${lines.length} satƒ±r y√ºkleniyor...`, "info");

            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            for(let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              const parts = line.split(',').map(p => p.trim());
              
              if(parts.length !== 3) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: Yanlƒ±≈ü format (3 alan gerekli)`);
                continue;
              }

              const [productCode, instructionType, instructionUrl] = parts;

              if(!productCode || !instructionType || !instructionUrl) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: Bo≈ü alan var`);
                continue;
              }

              if(!['pdf', 'image', 'link'].includes(instructionType.toLowerCase())) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: Ge√ßersiz tip (pdf, image veya link olmalƒ±)`);
                continue;
              }

              try {
                await addDoc(instructionsCol, {
                  productCode: productCode,
                  instructionType: instructionType.toLowerCase(),
                  instructionUrl: instructionUrl,
                  createdAt: serverTimestamp(),
                  updatedAt: serverTimestamp()
                });
                successCount++;
              } catch(e) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: ${e.message}`);
              }
            }

            let message = `‚úì ${successCount} ba≈üarƒ±lƒ±`;
            if(errorCount > 0) {
              message += `, ‚úó ${errorCount} hata`;
            }
            
            if(errors.length > 0 && errors.length <= 5) {
              message += '\n' + errors.join('\n');
            } else if(errors.length > 5) {
              message += '\n' + errors.slice(0, 5).join('\n') + `\n... ve ${errors.length - 5} hata daha`;
            }

            setStatusBox(statusBulkInstructions, message, errorCount > 0 ? "warn" : "ok");
            
            if(successCount > 0) {
              bulkInstructionsInput.value = '';
            }
          } catch(e) {
            console.error('Toplu y√ºkleme hatasƒ±:', e);
            setStatusBox(statusBulkInstructions, "Hata: " + e.message, "error");
          }
        }

        btnBulkUploadInstructions && (btnBulkUploadInstructions.onclick = bulkUploadInstructions);

        // Mail ve ≈üifre y√∂netimi fonksiyonlarƒ± - GLOBAL SCOPE
        window.loadCredentials = async function() {
          try {
            console.log("üîë loadCredentials √ßaƒürƒ±ldƒ±");
            
            // Koleksiyon kontrol√º
            if(!window.credentialsCol) {
              console.error("‚ùå credentialsCol tanƒ±mlƒ± deƒüil, bekliyor...");
              setTimeout(() => window.loadCredentials(), 200);
              return;
            }
            
            // Firebase fonksiyonu kontrol√º
            if(!window.getDocs) {
              console.error("‚ùå getDocs tanƒ±mlƒ± deƒüil, bekliyor...");
              setTimeout(() => window.loadCredentials(), 200);
              return;
            }
            
            const snap = await window.getDocs(window.credentialsCol);
            
            const credentialsBody = document.getElementById("credentialsBody");
            if(!credentialsBody) {
              console.error("‚ùå credentialsBody elementi bulunamadƒ±");
              return;
            }
            
            credentialsBody.innerHTML = "";
            
            if(snap.empty) {
              console.log("‚ÑπÔ∏è Hen√ºz kimlik bilgisi kaydƒ± yok");
              credentialsBody.innerHTML = "<tr><td colspan='4' style='padding:24px;text-align:center;color:var(--muted);'>Hen√ºz kayƒ±t yok.</td></tr>";
              return;
            }
            
            console.log("‚úÖ Kimlik bilgileri y√ºkleniyor:", snap.size, "kayƒ±t");
            
            snap.forEach(docSnap => {
              const data = docSnap.data();
              const tr = document.createElement("tr");
              
              // G√ºvenli veri
              const safeService = (data.service || "").replace(/'/g, "&#39;").replace(/"/g, "&quot;");
              const safeEmail = (data.email || "").replace(/'/g, "&#39;").replace(/"/g, "&quot;");
              const safePassword = (data.password || "").replace(/'/g, "&#39;").replace(/"/g, "&quot;");
              
              tr.innerHTML = `
                <td style="padding:12px;border-bottom:1px solid var(--border);font-weight:700;">${data.service || ""}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);">${data.email || ""}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);font-family:monospace;">${data.password || ""}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;">
                  <button data-id="${docSnap.id}" data-service="${safeService}" data-email="${safeEmail}" data-password="${safePassword}" class="btn-edit-credential" style="background:#0891b2;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:700;font-size:12px;margin-right:6px;">D√úZENLE</button>
                  <button data-id="${docSnap.id}" class="btn-delete-credential" style="background:#dc2626;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:700;font-size:12px;">Sƒ∞L</button>
                </td>
              `;
              credentialsBody.appendChild(tr);
            });
            
            // Event listener'larƒ± ekle
            document.querySelectorAll('.btn-edit-credential').forEach(btn => {
              btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const service = this.getAttribute('data-service').replace(/&#39;/g, "'").replace(/&quot;/g, '"');
                const email = this.getAttribute('data-email').replace(/&#39;/g, "'").replace(/&quot;/g, '"');
                const password = this.getAttribute('data-password').replace(/&#39;/g, "'").replace(/&quot;/g, '"');
                window.editCredential(id, service, email, password);
              });
            });
            
            document.querySelectorAll('.btn-delete-credential').forEach(btn => {
              btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                window.deleteCredential(id);
              });
            });
            
            console.log("‚úÖ Kimlik bilgileri ba≈üarƒ±yla y√ºklendi");
          } catch(e) {
            console.error("‚ùå Kimlik bilgileri y√ºklenemedi:", e);
            if(credentialsBody) {
              credentialsBody.innerHTML = `<tr><td colspan='4' style='padding:24px;text-align:center;color:red;'>Hata: ${e.message}</td></tr>`;
            }
          }
        };

        let editingCredentialId = null;

        // D√úZENLE fonksiyonu - hem window hem global scope'ta
        window.editCredential = function(docId, service, email, password) {
          console.log("üîß editCredential √ßaƒürƒ±ldƒ±:", docId);
          
          if(!credentialService || !credentialEmail || !credentialPassword || !btnAddCredential) {
            console.error("‚ùå Form elementleri bulunamadƒ±!");
            return;
          }
          
          editingCredentialId = docId;
          credentialService.value = service;
          credentialEmail.value = email;
          credentialPassword.value = password;
          
          btnAddCredential.textContent = "G√úNCELLE";
          btnAddCredential.style.background = "#0891b2";
          
          setStatusBox(statusCredentials, "D√ºzenleme modu - deƒüi≈üiklikleri yapƒ±n ve G√úNCELLE'ye tƒ±klayƒ±n.", "info");
          
          // ƒ∞ptal butonu ekle
          if(!document.getElementById("btnCancelEdit")) {
            const cancelBtn = document.createElement("button");
            cancelBtn.id = "btnCancelEdit";
            cancelBtn.textContent = "ƒ∞PTAL";
            cancelBtn.className = "actionBtn";
            cancelBtn.style.background = "#6c757d";
            cancelBtn.style.marginLeft = "10px";
            cancelBtn.onclick = cancelEdit;
            btnAddCredential.parentNode.appendChild(cancelBtn);
          }
          
          console.log("‚úÖ D√ºzenleme modu aktif");
        };

        function cancelEdit() {
          editingCredentialId = null;
          credentialService.value = "";
          credentialEmail.value = "";
          credentialPassword.value = "";
          btnAddCredential.textContent = "EKLE";
          btnAddCredential.style.background = "";
          
          const cancelBtn = document.getElementById("btnCancelEdit");
          if(cancelBtn) cancelBtn.remove();
          
          setStatusBox(statusCredentials, "", "");
          statusCredentials.style.display = "none";
        }

        async function addCredential() {
          try {
            const service = (credentialService.value || "").trim();
            const email = (credentialEmail.value || "").trim();
            const password = (credentialPassword.value || "").trim();
            
            if(!service || !email || !password) {
              setStatusBox(statusCredentials, "T√ºm alanlarƒ± doldurun.", "error");
              return;
            }
            
            if(editingCredentialId) {
              // G√úNCELLEME MODU
              setStatusBox(statusCredentials, "G√ºncelleniyor...", "info");
              
              await window.updateDoc(window.doc(window.db, "credentials", editingCredentialId), {
                service,
                email,
                password,
                updatedAt: new Date().toISOString(),
                updatedBy: window.__SESSION?.pin || "unknown"
              });
              
              setStatusBox(statusCredentials, "‚úì Ba≈üarƒ±yla g√ºncellendi.", "ok");
              cancelEdit();
              
            } else {
              // YENƒ∞ KAYIT MODU
              setStatusBox(statusCredentials, "Kaydediliyor...", "info");
              
              await window.addDoc(window.credentialsCol, {
                service,
                email,
                password,
                createdAt: new Date().toISOString(),
                createdBy: window.__SESSION?.pin || "unknown"
              });
              
              credentialService.value = "";
              credentialEmail.value = "";
              credentialPassword.value = "";
              
              setStatusBox(statusCredentials, "‚úì Ba≈üarƒ±yla kaydedildi.", "ok");
            }
            
            window.loadCredentials();
            
          } catch(e) {
            console.error("Kimlik bilgisi i≈ülemi ba≈üarƒ±sƒ±z:", e);
            setStatusBox(statusCredentials, "Hata: " + e.message, "error");
          }
        }

        window.deleteCredential = async function(docId) {
          if(!confirm("Bu kaydƒ± silmek istediƒüinizden emin misiniz?")) return;
          
          try {
            await window.deleteDoc(window.doc(window.db, "credentials", docId));
            setStatusBox(statusCredentials, "‚úì Kayƒ±t silindi.", "ok");
            window.loadCredentials();
          } catch(e) {
            setStatusBox(statusCredentials, "Hata: " + e.message, "error");
          }
        };

        btnAddCredential && (btnAddCredential.onclick = addCredential);

        // Paketleme talimatlarƒ±nƒ± y√ºkleme fonksiyonu
        async function loadPackagingInstructions() {
          if(!packagingProductCode || !statusPackaging || !packagingContainer) return;
          
          try {
            const productCode = (packagingProductCode.value || "").trim();
            if(!productCode) {
              setStatusBox(statusPackaging, "L√ºtfen √ºr√ºn kodu girin.", "error");
              return;
            }

            setStatusBox(statusPackaging, "Y√ºkleniyor...", "info");
            packagingContainer.innerHTML = "";
            packagingContent.style.display = "none";

            const snap = await getDocs(query(packagingCol, where("productCode", "==", productCode), limit(1)));
            
            if(snap.empty) {
              setStatusBox(statusPackaging, "Bu √ºr√ºn i√ßin paketleme talimatƒ± bulunamadƒ±.", "warn");
              return;
            }

            const data = snap.docs[0].data();
            const type = data.instructionType;
            const url = data.instructionUrl;

            packagingContent.style.display = "block";

            if(type === "pdf") {
              const iframe = document.createElement('iframe');
              iframe.src = url;
              iframe.style.cssText = 'width:100%;height:600px;border:none;';
              iframe.onload = () => {
                setStatusBox(statusPackaging, "Talimat y√ºklendi.", "ok");
              };
              packagingContainer.appendChild(iframe);
            } else if(type === "image") {
              const img = document.createElement('img');
              img.src = url;
              img.style.cssText = 'max-width:100%;height:auto;display:block;margin:0 auto;';
              img.onload = () => {
                setStatusBox(statusPackaging, "Talimat y√ºklendi.", "ok");
              };
              packagingContainer.appendChild(img);
            } else if(type === "link") {
              const linkDiv = document.createElement('div');
              linkDiv.style.cssText = 'padding:40px;text-align:center;';
              
              const linkBtn = document.createElement('a');
              linkBtn.href = url;
              linkBtn.target = "_blank";
              linkBtn.textContent = "Talimatƒ± A√ß (Yeni Sekmede)";
              linkBtn.style.cssText = 'display:inline-block;padding:14px 24px;background:var(--green);color:#07210f;text-decoration:none;border-radius:12px;font-weight:900;font-size:16px;';
              
              linkDiv.appendChild(linkBtn);
              packagingContainer.appendChild(linkDiv);
              setStatusBox(statusPackaging, "Talimat linki hazƒ±r.", "ok");
            } else {
              setStatusBox(statusPackaging, "Bilinmeyen talimat tipi.", "error");
            }
          } catch(e) {
            console.error('Paketleme talimatƒ± y√ºkleme hatasƒ±:', e);
            setStatusBox(statusPackaging, "Hata: " + e.message, "error");
          }
        }

        btnLoadPackaging && (btnLoadPackaging.onclick = loadPackagingInstructions);
        packagingProductCode && packagingProductCode.addEventListener("keydown", (e) => {
          if(e.key === "Enter") loadPackagingInstructions();
        });

        // Toplu paketleme talimatƒ± y√ºkleme fonksiyonu
        async function bulkUploadPackaging() {
          if(!bulkPackagingInput || !statusBulkPackaging) return;
          
          try {
            const text = bulkPackagingInput.value.trim();
            if(!text) {
              setStatusBox(statusBulkPackaging, "L√ºtfen veri girin.", "error");
              return;
            }

            const lines = text.split('\n').filter(line => line.trim());
            if(lines.length === 0) {
              setStatusBox(statusBulkPackaging, "Hi√ß satƒ±r bulunamadƒ±.", "error");
              return;
            }

            setStatusBox(statusBulkPackaging, `${lines.length} satƒ±r y√ºkleniyor...`, "info");

            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            for(let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              const parts = line.split(',').map(p => p.trim());
              
              if(parts.length !== 3) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: Yanlƒ±≈ü format (3 alan gerekli)`);
                continue;
              }

              const [productCode, instructionType, instructionUrl] = parts;

              if(!productCode || !instructionType || !instructionUrl) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: Bo≈ü alan var`);
                continue;
              }

              if(!['pdf', 'image', 'link'].includes(instructionType.toLowerCase())) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: Ge√ßersiz tip (pdf, image veya link olmalƒ±)`);
                continue;
              }

              try {
                await addDoc(packagingCol, {
                  productCode: productCode,
                  instructionType: instructionType.toLowerCase(),
                  instructionUrl: instructionUrl,
                  createdAt: serverTimestamp(),
                  updatedAt: serverTimestamp()
                });
                successCount++;
              } catch(e) {
                errorCount++;
                errors.push(`Satƒ±r ${i+1}: ${e.message}`);
              }
            }

            let message = `‚úì ${successCount} ba≈üarƒ±lƒ±`;
            if(errorCount > 0) {
              message += `, ‚úó ${errorCount} hata`;
            }
            
            if(errors.length > 0 && errors.length <= 5) {
              message += '\n' + errors.join('\n');
            } else if(errors.length > 5) {
              message += '\n' + errors.slice(0, 5).join('\n') + `\n... ve ${errors.length - 5} hata daha`;
            }

            setStatusBox(statusBulkPackaging, message, errorCount > 0 ? "warn" : "ok");
            
            if(successCount > 0) {
              bulkPackagingInput.value = '';
            }
          } catch(e) {
            console.error('Toplu paketleme y√ºkleme hatasƒ±:', e);
            setStatusBox(statusBulkPackaging, "Hata: " + e.message, "error");
          }
        }

        btnBulkUploadPackaging && (btnBulkUploadPackaging.onclick = bulkUploadPackaging);

        // ============================
        // PERSONEL Y√ñNETƒ∞Mƒ∞ VE MAA≈û TAKƒ∞Bƒ∞
        // ============================

        // Periyot alanlarƒ±nƒ± g√∂ster/gizle
        personnelPaymentPeriod && personnelPaymentPeriod.addEventListener("change", (e) => {
          if(e.target.value === "monthly") {
            monthlyPaymentFields.style.display = "block";
            weeklyPaymentFields.style.display = "none";
          } else {
            monthlyPaymentFields.style.display = "none";
            weeklyPaymentFields.style.display = "block";
          }
        });

        // Personel ekleme
        async function addPersonnel() {
          try {
            const name = personnelName.value.trim();
            const period = personnelPaymentPeriod.value;
            const salary = Number(personnelSalary.value);
            const startDate = personnelStartDate.value;

            if(!name) {
              setStatusBox(statusPersonnel, "Personel adƒ± zorunludur.", "error");
              return;
            }

            if(!salary || salary <= 0) {
              setStatusBox(statusPersonnel, "Ge√ßerli bir maa≈ü tutarƒ± girin.", "error");
              return;
            }

            if(!startDate) {
              setStatusBox(statusPersonnel, "ƒ∞≈üe ba≈ülama tarihi zorunludur.", "error");
              return;
            }

            let paymentDay;
            if(period === "monthly") {
              paymentDay = Number(personnelPaymentDayMonthly.value);
              if(!paymentDay || paymentDay < 1 || paymentDay > 31) {
                setStatusBox(statusPersonnel, "Ge√ßerli bir √∂deme g√ºn√º girin (1-31).", "error");
                return;
              }
            } else {
              paymentDay = Number(personnelPaymentDayWeekly.value);
            }

            setStatusBox(statusPersonnel, "Kaydediliyor...", "info");

            await addDoc(personnelCol, {
              name,
              paymentPeriod: period,
              paymentDay,
              salary,
              startDate,
              active: true,
              createdAt: new Date().toISOString(),
              createdBy: window.__SESSION?.pin || "admin"
            });

            setStatusBox(statusPersonnel, "Personel ba≈üarƒ±yla eklendi.", "ok");
            
            // Formu temizle
            personnelName.value = "";
            personnelSalary.value = "";
            personnelStartDate.value = "";
            personnelPaymentDayMonthly.value = "";

            loadPersonnel();
            updatePaymentAlerts();
          } catch(e) {
            console.error('Personel ekleme hatasƒ±:', e);
            setStatusBox(statusPersonnel, "Hata: " + e.message, "error");
          }
        }

        btnAddPersonnel && (btnAddPersonnel.onclick = addPersonnel);

        // Sonraki √∂deme tarihini hesapla
        function calculateNextPaymentDate(personnel, lastPaymentDate = null) {
          const today = new Date();
          let referenceDate = lastPaymentDate ? new Date(lastPaymentDate) : new Date(personnel.startDate);

          if(personnel.paymentPeriod === "monthly") {
            const paymentDay = personnel.paymentDay;
            let nextDate = new Date(referenceDate);
            
            // Bir sonraki √∂deme ayƒ±nƒ± bul
            if(lastPaymentDate) {
              nextDate.setMonth(nextDate.getMonth() + 1);
            }
            
            // √ñdeme g√ºn√ºn√º ayarla
            nextDate.setDate(Math.min(paymentDay, new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate()));
            
            // Eƒüer tarih ge√ßmi≈üte kaldƒ±ysa, bir sonraki aya ge√ß
            while(nextDate <= today) {
              nextDate.setMonth(nextDate.getMonth() + 1);
              nextDate.setDate(Math.min(paymentDay, new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate()));
            }
            
            return nextDate;
          } else {
            // Haftalƒ±k
            const targetDay = personnel.paymentDay;
            let nextDate = new Date(referenceDate);
            
            if(lastPaymentDate) {
              nextDate.setDate(nextDate.getDate() + 7);
            } else {
              // ƒ∞lk √∂deme tarihini bul
              while(nextDate.getDay() !== targetDay) {
                nextDate.setDate(nextDate.getDate() + 1);
              }
            }
            
            // Eƒüer tarih ge√ßmi≈üte kaldƒ±ysa, bir sonraki haftaya ge√ß
            while(nextDate <= today) {
              nextDate.setDate(nextDate.getDate() + 7);
            }
            
            return nextDate;
          }
        }

        // Personelleri y√ºkle
        let allPersonnel = [];
        async function loadPersonnel() {
          if(!personnelListBody) return;

          try {
            const snap = await getDocs(query(personnelCol, where("active", "==", true)));
            
            allPersonnel = snap.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));

            // Her personel i√ßin son √∂deme tarihini bul
            const paymentSnap = await getDocs(query(paymentCol, where("paymentType", "==", "salary"), orderBy("paymentDate", "desc")));
            const lastPayments = {};
            
            paymentSnap.docs.forEach(doc => {
              const data = doc.data();
              if(!lastPayments[data.personnelId]) {
                lastPayments[data.personnelId] = data.paymentDate;
              }
            });

            if(allPersonnel.length === 0) {
              personnelListBody.innerHTML = `<tr><td colspan="6" style="padding:24px;text-align:center;color:var(--muted);">Hen√ºz personel eklenmedi.</td></tr>`;
            } else {
              // Personelleri alfabetik olarak sƒ±rala
              allPersonnel.sort((a, b) => a.name.localeCompare(b.name, 'tr'));
              
              let totalSalary = 0;
              const personnelRows = allPersonnel.map(p => {
                totalSalary += p.salary;
                const nextPayment = calculateNextPaymentDate(p, lastPayments[p.id]);
                const daysUntil = Math.ceil((nextPayment - new Date()) / (1000 * 60 * 60 * 24));
                const periodText = p.paymentPeriod === "monthly" ? "Aylƒ±k" : "Haftalƒ±k";
                const dayText = p.paymentPeriod === "monthly" 
                  ? `Ayƒ±n ${p.paymentDay}. g√ºn√º`
                  : ["Pazar", "Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma", "Cumartesi"][p.paymentDay];
                
                const dateColor = daysUntil <= 3 ? "red" : daysUntil <= 7 ? "orange" : "var(--text)";
                
                return `
                  <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:12px;font-weight:900;font-size:13px;">${p.name}</td>
                    <td style="padding:12px;font-size:13px;">${periodText}</td>
                    <td style="padding:12px;font-size:13px;">${dayText}</td>
                    <td style="padding:12px;text-align:right;font-weight:900;font-size:14px;">${new Intl.NumberFormat('tr-TR').format(p.salary)} ‚Ç∫</td>
                    <td style="padding:12px;font-size:13px;color:${dateColor};font-weight:${daysUntil <= 7 ? 'bold' : 'normal'};">
                      ${nextPayment.toLocaleDateString('tr-TR')} (${daysUntil} g√ºn)
                    </td>
                    <td style="padding:12px;text-align:center;">
                      <div style="display:flex;gap:4px;justify-content:center;">
                        <button onclick="editPersonnel('${p.id}')" style="background:#007bff;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:12px;font-weight:900;cursor:pointer;">D√úZENLE</button>
                        <button onclick="deletePersonnel('${p.id}')" style="background:#dc3545;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:12px;font-weight:900;cursor:pointer;">Sƒ∞L</button>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('');
              
              personnelListBody.innerHTML = personnelRows + `
                <tr style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;">
                  <td colspan="3" style="padding:14px;font-weight:900;font-size:14px;text-align:right;">TOPLAM MAA≈û:</td>
                  <td style="padding:14px;text-align:right;font-weight:900;font-size:16px;">${new Intl.NumberFormat('tr-TR').format(totalSalary)} ‚Ç∫</td>
                  <td colspan="2"></td>
                </tr>
              `;
            }

            // Personel se√ßim listesini g√ºncelle
            updatePersonnelSelectList();
          } catch(e) {
            console.error('Personel y√ºkleme hatasƒ±:', e);
            personnelListBody.innerHTML = `<tr><td colspan="6" style="padding:24px;text-align:center;color:var(--red);">Hata: ${e.message}</td></tr>`;
          }
        }

        // Personeli pasife al
        // Personeli sil
        window.deletePersonnel = async function(personnelId) {
          if(!confirm('Bu personeli kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz!')) return;

          try {
            await deleteDoc(doc(personnelCol, personnelId));
            loadPersonnel();
            updatePaymentAlerts();
            alert('Personel silindi.');
          } catch(e) {
            alert('Hata: ' + e.message);
          }
        };

        // Personel d√ºzenleme formunu a√ß
        window.editPersonnel = function(personnelId) {
          const personnel = allPersonnel.find(p => p.id === personnelId);
          if(!personnel) return;

          // Formu doldur
          editPersonnelId.value = personnelId;
          editPersonnelName.value = personnel.name;
          editPersonnelPaymentPeriod.value = personnel.paymentPeriod;
          editPersonnelSalary.value = personnel.salary;
          editPersonnelStartDate.value = personnel.startDate;

          if(personnel.paymentPeriod === "monthly") {
            editPersonnelPaymentDayMonthly.value = personnel.paymentDay;
            editMonthlyPaymentFields.style.display = "block";
            editWeeklyPaymentFields.style.display = "none";
          } else {
            editPersonnelPaymentDayWeekly.value = personnel.paymentDay;
            editMonthlyPaymentFields.style.display = "none";
            editWeeklyPaymentFields.style.display = "block";
          }

          // D√ºzenleme b√∂l√ºm√ºn√º g√∂ster
          editPersonnelSection.style.display = "block";
          editPersonnelSection.scrollIntoView({ behavior: 'smooth' });
        };

        // D√ºzenleme periyot deƒüi≈üimi
        editPersonnelPaymentPeriod && editPersonnelPaymentPeriod.addEventListener("change", (e) => {
          if(e.target.value === "monthly") {
            editMonthlyPaymentFields.style.display = "block";
            editWeeklyPaymentFields.style.display = "none";
          } else {
            editMonthlyPaymentFields.style.display = "none";
            editWeeklyPaymentFields.style.display = "block";
          }
        });

        // Personel g√ºncelleme
        btnUpdatePersonnel && (btnUpdatePersonnel.onclick = async function() {
          try {
            const personnelId = editPersonnelId.value;
            const name = editPersonnelName.value.trim();
            const period = editPersonnelPaymentPeriod.value;
            const salary = Number(editPersonnelSalary.value);
            const startDate = editPersonnelStartDate.value;

            if(!name) {
              setStatusBox(statusEditPersonnel, "Personel adƒ± zorunludur.", "error");
              return;
            }

            if(!salary || salary <= 0) {
              setStatusBox(statusEditPersonnel, "Ge√ßerli bir maa≈ü tutarƒ± girin.", "error");
              return;
            }

            if(!startDate) {
              setStatusBox(statusEditPersonnel, "ƒ∞≈üe ba≈ülama tarihi zorunludur.", "error");
              return;
            }

            let paymentDay;
            if(period === "monthly") {
              paymentDay = Number(editPersonnelPaymentDayMonthly.value);
              if(!paymentDay || paymentDay < 1 || paymentDay > 31) {
                setStatusBox(statusEditPersonnel, "Ge√ßerli bir √∂deme g√ºn√º girin (1-31).", "error");
                return;
              }
            } else {
              paymentDay = Number(editPersonnelPaymentDayWeekly.value);
            }

            setStatusBox(statusEditPersonnel, "G√ºncelleniyor...", "info");

            await updateDoc(doc(personnelCol, personnelId), {
              name,
              paymentPeriod: period,
              paymentDay,
              salary,
              startDate,
              updatedAt: new Date().toISOString()
            });

            setStatusBox(statusEditPersonnel, "Personel g√ºncellendi.", "ok");
            
            // Formu gizle
            editPersonnelSection.style.display = "none";
            
            loadPersonnel();
            updatePaymentAlerts();
          } catch(e) {
            console.error('Personel g√ºncelleme hatasƒ±:', e);
            setStatusBox(statusEditPersonnel, "Hata: " + e.message, "error");
          }
        });

        // D√ºzenleme iptali
        btnCancelEdit && (btnCancelEdit.onclick = function() {
          editPersonnelSection.style.display = "none";
        });

        // Personel se√ßim listesini g√ºncelle
        function updatePersonnelSelectList() {
          if(!paymentPersonSelect) return;
          
          paymentPersonSelect.innerHTML = '<option value="">Personel Se√ßiniz...</option>' +
            allPersonnel.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        // Yakla≈üan ve gecikmi≈ü √∂demeleri g√∂ster
        async function updatePaymentAlerts() {
          if(!upcomingPaymentsList || !overduePaymentsList) return;

          try {
            const paymentSnap = await getDocs(query(paymentCol, where("paymentType", "==", "salary"), orderBy("paymentDate", "desc")));
            const lastPayments = {};
            
            paymentSnap.docs.forEach(doc => {
              const data = doc.data();
              if(!lastPayments[data.personnelId]) {
                lastPayments[data.personnelId] = data.paymentDate;
              }
            });

            const today = new Date();
            const upcoming = [];
            const overdue = [];

            allPersonnel.forEach(p => {
              const nextPayment = calculateNextPaymentDate(p, lastPayments[p.id]);
              const daysUntil = Math.ceil((nextPayment - today) / (1000 * 60 * 60 * 24));

              if(daysUntil < 0) {
                overdue.push({ ...p, nextPayment, daysUntil: Math.abs(daysUntil) });
              } else if(daysUntil <= 7) {
                upcoming.push({ ...p, nextPayment, daysUntil });
              }
            });

            if(upcoming.length === 0) {
              upcomingPaymentsList.innerHTML = '<div style="color:rgba(255,255,255,0.8);">üìÖ Yakla≈üan √∂deme yok.</div>';
            } else {
              let totalUpcoming = 0;
              const upcomingHtml = upcoming.map(p => {
                // Haftalƒ±k maa≈ü ise aylƒ±k maa≈üƒ± 4'e b√∂l
                const displayAmount = p.paymentPeriod === 'weekly' ? (p.salary / 4) : p.salary;
                totalUpcoming += displayAmount;
                return `<div style="padding:4px 0;color:rgba(255,255,255,0.9);">‚Ä¢ <strong>${p.name}</strong>: ${p.nextPayment.toLocaleDateString('tr-TR')} (${p.daysUntil} g√ºn kaldƒ±) - ${new Intl.NumberFormat('tr-TR').format(displayAmount)} ‚Ç∫</div>`;
              }).join('');
              upcomingPaymentsList.innerHTML = upcomingHtml + `<div style="padding:8px 0;border-top:2px solid rgba(255,255,255,0.3);margin-top:8px;font-weight:900;font-size:15px;color:#fff;">TOPLAM TUTAR: ${new Intl.NumberFormat('tr-TR').format(totalUpcoming)} ‚Ç∫</div>`;
            }

            if(overdue.length === 0) {
              overduePaymentsList.innerHTML = '<div style="color:rgba(255,255,255,0.8);">‚úÖ Gecikmi≈ü √∂deme yok.</div>';
            } else {
              let totalOverdue = 0;
              const overdueHtml = overdue.map(p => {
                // Haftalƒ±k maa≈ü ise aylƒ±k maa≈üƒ± 4'e b√∂l
                const displayAmount = p.paymentPeriod === 'weekly' ? (p.salary / 4) : p.salary;
                totalOverdue += displayAmount;
                return `<div style="padding:4px 0;color:#fff;font-weight:bold;">‚Ä¢ <strong>${p.name}</strong>: ${p.nextPayment.toLocaleDateString('tr-TR')} (${p.daysUntil} g√ºn gecikmi≈ü!) - ${new Intl.NumberFormat('tr-TR').format(displayAmount)} ‚Ç∫</div>`;
              }).join('');
              overduePaymentsList.innerHTML = overdueHtml + `<div style="padding:8px 0;border-top:2px solid rgba(255,255,255,0.5);margin-top:8px;font-weight:900;font-size:15px;color:#fff;">TOPLAM TUTAR: ${new Intl.NumberFormat('tr-TR').format(totalOverdue)} ‚Ç∫</div>`;
            }
          } catch(e) {
            console.error('√ñdeme uyarƒ±larƒ± hatasƒ±:', e);
          }
        }

        // √ñdeme kaydƒ± ekleme (YENƒ∞ Sƒ∞STEM)
        let currentPaymentFilter = "all";
        let allPayments = [];

        // Tarih input'una bug√ºn√ºn tarihini otomatik ayarla
        if(paymentDate) {
          const today = new Date().toISOString().split('T')[0];
          paymentDate.value = today;
        }

        async function addPaymentRecord() {
          if(!paymentPersonSelect || !paymentType || !paymentAmount || !paymentDate || !statusPayment) return;

          try {
            const personnelId = paymentPersonSelect.value;
            const type = paymentType.value;
            const amount = Number(paymentAmount.value);
            const date = paymentDate.value;
            const note = (paymentNote?.value || "").trim();

            if(!personnelId) {
              setStatusBox(statusPayment, "Personel se√ßiniz.", "error");
              return;
            }

            if(!amount || amount <= 0) {
              setStatusBox(statusPayment, "Ge√ßerli bir tutar girin.", "error");
              return;
            }

            if(!date) {
              setStatusBox(statusPayment, "Tarih se√ßin.", "error");
              return;
            }

            const personnel = allPersonnel.find(p => p.id === personnelId);
            if(!personnel) {
              setStatusBox(statusPayment, "Personel bulunamadƒ±.", "error");
              return;
            }

            setStatusBox(statusPayment, "Kaydediliyor...", "info");

            await addDoc(paymentCol, {
              personnelId: personnelId,
              personName: personnel.name,
              paymentType: type,
              amount: amount,
              paymentDate: date,
              note: note,
              createdAt: serverTimestamp(),
              createdBy: window.__SESSION?.pin || "admin"
            });
            
            // Log kaydƒ± ekle
            const paymentTypeText = type === "salary" ? "Maa≈ü" : "Avans";
            await writeLog({ 
              action: "PAYMENT_RECORD", 
              shelf: "-", 
              product: personnel.name, 
              qty: 0, 
              detail: `${paymentTypeText} √ñdeme: ${amount} TL - ${note || '-'}`
            });

            setStatusBox(statusPayment, "√ñdeme kaydƒ± ba≈üarƒ±yla eklendi.", "ok");
            
            // Formu temizle
            paymentPersonSelect.value = "";
            paymentAmount.value = "";
            paymentNote && (paymentNote.value = "");
            const today = new Date().toISOString().split('T')[0];
            paymentDate.value = today;

            // Listeyi ve uyarƒ±larƒ± yenile
            loadPaymentRecords();
            loadPersonnel();
            updatePaymentAlerts();
          } catch(e) {
            console.error('√ñdeme kaydƒ± hatasƒ±:', e);
            setStatusBox(statusPayment, "Hata: " + e.message, "error");
          }
        }

        btnAddPayment && (btnAddPayment.onclick = addPaymentRecord);

        // Personel se√ßildiƒüinde maa≈ü tutarƒ±nƒ± otomatik doldur
        paymentPersonSelect && paymentPersonSelect.addEventListener("change", (e) => {
          const personnelId = e.target.value;
          if(personnelId && paymentType.value === "salary") {
            const personnel = allPersonnel.find(p => p.id === personnelId);
            if(personnel && paymentAmount) {
              paymentAmount.value = personnel.salary;
            }
          }
        });

        // √ñdeme tipi deƒüi≈ütiƒüinde maa≈ü tutarƒ±nƒ± otomatik ayarla
        paymentType && paymentType.addEventListener("change", (e) => {
          if(e.target.value === "salary" && paymentPersonSelect.value) {
            const personnelId = paymentPersonSelect.value;
            const personnel = allPersonnel.find(p => p.id === personnelId);
            if(personnel && paymentAmount) {
              paymentAmount.value = personnel.salary;
            }
          } else if(e.target.value === "advance" && paymentAmount) {
            paymentAmount.value = "";
          }
        });

        // √ñdeme kayƒ±tlarƒ±nƒ± y√ºkleme
        async function loadPaymentRecords(filterType = "all", searchName = "") {
          if(!paymentListBody) return;

          try {
            const snap = await getDocs(query(paymentCol, orderBy("paymentDate", "desc")));
            
            allPayments = snap.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));

            displayPayments(filterType, searchName);
          } catch(e) {
            console.error('√ñdeme kayƒ±tlarƒ± y√ºkleme hatasƒ±:', e);
            paymentListBody.innerHTML = `<tr><td colspan="6" style="padding:24px;text-align:center;color:var(--red);">Hata: ${e.message}</td></tr>`;
          }
        }

        // √ñdeme kayƒ±tlarƒ±nƒ± filtreleyip g√∂r√ºnt√ºleme
        function displayPayments(filterType = "all", searchName = "") {
          if(!paymentListBody) return;

          let filtered = allPayments;

          // Tip filtreleme
          if(filterType === "salary") {
            filtered = filtered.filter(p => p.paymentType === "salary");
          } else if(filterType === "advance") {
            filtered = filtered.filter(p => p.paymentType === "advance");
          }

          // ƒ∞sim filtreleme
          if(searchName) {
            const search = searchName.toLowerCase();
            filtered = filtered.filter(p => p.personName.toLowerCase().includes(search));
          }

          if(filtered.length === 0) {
            paymentListBody.innerHTML = `<tr><td colspan="6" style="padding:24px;text-align:center;color:var(--muted);">Kayƒ±t bulunamadƒ±.</td></tr>`;
            return;
          }

          paymentListBody.innerHTML = filtered.map(payment => {
            const typeText = payment.paymentType === "salary" ? "Maa≈ü" : "Avans";
            const typeColor = payment.paymentType === "salary" ? "var(--green)" : "var(--yellow)";
            const formattedAmount = new Intl.NumberFormat('tr-TR').format(payment.amount);
            
            return `
              <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:12px;font-size:13px;">${payment.paymentDate}</td>
                <td style="padding:12px;font-weight:900;font-size:13px;">${payment.personName}</td>
                <td style="padding:12px;"><span style="background:${typeColor};color:#07210f;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:900;">${typeText}</span></td>
                <td style="padding:12px;text-align:right;font-weight:900;font-size:14px;">${formattedAmount} ‚Ç∫</td>
                <td style="padding:12px;font-size:13px;color:var(--muted);">${payment.note || "-"}</td>
                <td style="padding:12px;text-align:center;">
                  <button onclick="deletePaymentRecord('${payment.id}')" style="background:var(--red);color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:900;cursor:pointer;">Sƒ∞L</button>
                </td>
              </tr>
            `;
          }).join('');
        }

        // √ñdeme kaydƒ± silme
        window.deletePaymentRecord = async function(paymentId) {
          if(!confirm('Bu √∂deme kaydƒ±nƒ± silmek istediƒüinizden emin misiniz?')) return;

          try {
            await deleteDoc(doc(paymentCol, paymentId));
            loadPaymentRecords(currentPaymentFilter, paymentSearchName?.value || "");
            alert('√ñdeme kaydƒ± silindi.');
          } catch(e) {
            alert('Hata: ' + e.message);
          }
        };

        // Filtre butonlarƒ±
        btnFilterAllPayments && (btnFilterAllPayments.onclick = () => {
          currentPaymentFilter = "all";
          displayPayments("all", paymentSearchName?.value || "");
        });

        btnFilterSalary && (btnFilterSalary.onclick = () => {
          currentPaymentFilter = "salary";
          displayPayments("salary", paymentSearchName?.value || "");
        });

        btnFilterAdvance && (btnFilterAdvance.onclick = () => {
          currentPaymentFilter = "advance";
          displayPayments("advance", paymentSearchName?.value || "");
        });

        // Arama kutusu
        paymentSearchName && paymentSearchName.addEventListener("input", (e) => {
          displayPayments(currentPaymentFilter, e.target.value);
        });

        // Sayfa y√ºklendiƒüinde personel ve √∂deme kayƒ±tlarƒ±nƒ± y√ºkle
        loadPersonnel();
        loadPaymentRecords();
        updatePaymentAlerts();
        
        // Her 5 dakikada bir √∂deme uyarƒ±larƒ±nƒ± g√ºncelle
        setInterval(updatePaymentAlerts, 5 * 60 * 1000);

        // ============================
        // CARƒ∞ HESAPLAR FONKSƒ∞YONLARI
        // ============================

        // ƒ∞≈ülem tipi deƒüi≈ütiƒüinde alanlarƒ± g√∂ster/gizle
        accountTransactionType && accountTransactionType.addEventListener("change", (e) => {
          const isFedex = accountCompanyName.value.trim().toUpperCase() === "FEDEX";
          
          if(e.target.value === "purchase") {
            // FEDEX i√ßin hi√ßbir zaman purchase fields g√∂sterme
            if(isFedex) {
              purchaseFields.style.display = "none";
              paymentFields.style.display = "block";
            } else {
              purchaseFields.style.display = "block";
              paymentFields.style.display = "none";
            }
          } else if(["payment", "refundInvoice", "cargoInvoice", "customsInvoice", "refund"].includes(e.target.value)) {
            purchaseFields.style.display = "none";
            paymentFields.style.display = "block";
          }
        });
        
        // Firma adƒ± deƒüi≈ütiƒüinde FEDEX kontrol√º yap
        accountCompanyName && accountCompanyName.addEventListener("input", (e) => {
          const companyName = e.target.value.trim().toUpperCase();
          const refundInvoiceOption = accountTransactionType.querySelector('option[value="refundInvoice"]');
          const cargoInvoiceOption = accountTransactionType.querySelector('option[value="cargoInvoice"]');
          const customsInvoiceOption = accountTransactionType.querySelector('option[value="customsInvoice"]');
          const refundOption = accountTransactionType.querySelector('option[value="refund"]');
          const purchaseOption = accountTransactionType.querySelector('option[value="purchase"]');
          const paymentOption = accountTransactionType.querySelector('option[value="payment"]');
          
          if(companyName === "FEDEX") {
            // FEDEX √∂zel se√ßeneklerini g√∂ster
            if(cargoInvoiceOption) cargoInvoiceOption.style.display = "block";
            if(customsInvoiceOption) customsInvoiceOption.style.display = "block";
            if(refundOption) refundOption.style.display = "block";
            if(paymentOption) paymentOption.style.display = "block";
            // Normal se√ßenekleri gizle
            if(purchaseOption) purchaseOption.style.display = "none";
            if(refundInvoiceOption) refundInvoiceOption.style.display = "none";
            
            // Eƒüer Mal Alƒ±mƒ± se√ßiliyse, Kargo Faturasƒ±'na ge√ß
            if(accountTransactionType.value === "purchase") {
              accountTransactionType.value = "cargoInvoice";
            }
            
            // FEDEX yazƒ±ldƒ±ƒüƒ±nda mevcut i≈ülem tipine bakƒ±lmaksƒ±zƒ±n purchase fields'ƒ± gizle
            purchaseFields.style.display = "none";
            paymentFields.style.display = "block";
          } else {
            // Normal firma se√ßeneklerini g√∂ster
            if(purchaseOption) purchaseOption.style.display = "block";
            if(paymentOption) paymentOption.style.display = "block";
            // FEDEX √∂zel se√ßeneklerini gizle
            if(cargoInvoiceOption) cargoInvoiceOption.style.display = "none";
            if(customsInvoiceOption) customsInvoiceOption.style.display = "none";
            if(refundOption) refundOption.style.display = "none";
            if(refundInvoiceOption) refundInvoiceOption.style.display = "none";
            
            // Eƒüer FEDEX √∂zel se√ßeneklerinden biri se√ßiliyse, Mal Alƒ±mƒ±'na d√∂nd√ºr
            if(["cargoInvoice", "customsInvoice", "refund", "refundInvoice"].includes(accountTransactionType.value)) {
              accountTransactionType.value = "purchase";
              purchaseFields.style.display = "block";
              paymentFields.style.display = "none";
            } else if(accountTransactionType.value === "purchase") {
              // Normal firma i√ßin purchase fields'ƒ± g√∂ster
              purchaseFields.style.display = "block";
              paymentFields.style.display = "none";
            }
          }
        });

        // Cari i≈ülem ekleme
        window.addAccountTransaction = async function() {
          try {
            const companyName = accountCompanyName.value.trim();
            const transactionType = accountTransactionType.value;
            const note = accountNote.value.trim();
            const now = new Date().toISOString();
            
            if(!companyName) {
              setStatusBox(statusAccount, "Firma adƒ± bo≈ü olamaz.", "error");
              return;
            }
            
            const transactionData = {
              companyName,
              transactionType,
              transactionDate: now,
              note,
              createdAt: now,
              createdBy: window.__SESSION?.pin || "admin"
            };
            
            const isFedex = companyName.toUpperCase() === "FEDEX";
            
            if(transactionType === "purchase" && !isFedex) {
              const itemName = accountItemName.value.trim();
              const quantity = accountItemQuantity.value.trim();
              const invoiceAmount = Number(accountInvoiceAmount.value);
              
              if(!itemName) {
                setStatusBox(statusAccount, "Mal adƒ± bo≈ü olamaz.", "error");
                return;
              }
              
              if(!quantity) {
                setStatusBox(statusAccount, "Adet bo≈ü olamaz.", "error");
                return;
              }
              
              if(!invoiceAmount || invoiceAmount <= 0) {
                setStatusBox(statusAccount, "Fatura tutarƒ± ge√ßersiz.", "error");
                return;
              }
              
              transactionData.itemName = itemName;
              transactionData.quantity = quantity;
              transactionData.invoiceAmount = invoiceAmount;
            } else if(transactionType === "purchase" && isFedex) {
              // FEDEX i√ßin Mal Alƒ±mƒ± se√ßilse bile sadece tutar alanƒ±nƒ± kullan
              const paymentAmount = Number(accountPaymentAmount.value);
              
              if(!paymentAmount || paymentAmount <= 0) {
                setStatusBox(statusAccount, "Tutar ge√ßersiz.", "error");
                return;
              }
              
              transactionData.invoiceAmount = paymentAmount;
              transactionData.itemName = "FEDEX ƒ∞≈ülemi";
              transactionData.quantity = "1";
            } else if(["payment", "refundInvoice", "cargoInvoice", "customsInvoice", "refund"].includes(transactionType)) {
              const paymentAmount = Number(accountPaymentAmount.value);
              
              if(!paymentAmount || paymentAmount <= 0) {
                setStatusBox(statusAccount, "√ñdeme tutarƒ± ge√ßersiz.", "error");
                return;
              }
              
              transactionData.paymentAmount = paymentAmount;
            }
            
            setStatusBox(statusAccount, "Kaydediliyor...", "");
            await addDoc(accountCol, transactionData);
            
            // Log kaydƒ± ekle
            let logDetail;
            if(transactionType === "purchase") {
              logDetail = `Mal Alƒ±mƒ±: ${transactionData.itemName} (${transactionData.quantity} adet) - ${transactionData.invoiceAmount || transactionData.paymentAmount} TL`;
            } else if(transactionType === "refundInvoice") {
              logDetail = `ƒ∞ade Fatura: ${transactionData.paymentAmount} TL`;
            } else if(transactionType === "cargoInvoice") {
              logDetail = `Kargo Faturasƒ±: ${transactionData.paymentAmount} TL`;
            } else if(transactionType === "customsInvoice") {
              logDetail = `G√ºmr√ºk Faturasƒ±: ${transactionData.paymentAmount} TL`;
            } else if(transactionType === "refund") {
              logDetail = `ƒ∞ade: ${transactionData.paymentAmount} TL`;
            } else {
              logDetail = `√ñdeme: ${transactionData.paymentAmount} TL`;
            }
            await writeLog({ 
              action: "ACCOUNT_TRANSACTION", 
              shelf: "-", 
              product: companyName, 
              qty: 0, 
              detail: logDetail
            });
            
            // Formu temizle
            accountCompanyName.value = "";
            accountTransactionType.value = "purchase";
            accountItemName.value = "";
            accountItemQuantity.value = "";
            accountInvoiceAmount.value = "";
            accountPaymentAmount.value = "";
            accountNote.value = "";
            purchaseFields.style.display = "block";
            paymentFields.style.display = "none";
            
            setStatusBox(statusAccount, "Cari i≈ülem kaydedildi.", "ok");
            loadAccountTransactions();
          } catch(e) {
            setStatusBox(statusAccount, "Hata: " + e.message, "error");
          }
        };
        
        // KAYDET butonuna event listener ekle
        btnAddAccountTransaction && (btnAddAccountTransaction.onclick = addAccountTransaction);

        // Cari i≈ülemleri y√ºkleme ve bakiye hesaplama
        async function loadAccountTransactions() {
          try {
            const snap = await getDocs(query(accountCol, orderBy("transactionDate", "desc")));
            const transactions = [];
            snap.forEach(doc => {
              transactions.push({ id: doc.id, ...doc.data() });
            });
            
            // Firma bazlƒ± bakiye hesaplama
            const companyBalances = {};
            transactions.forEach(t => {
              if(!companyBalances[t.companyName]) {
                companyBalances[t.companyName] = { purchases: 0, payments: 0 };
              }
              
              if(t.transactionType === "purchase") {
                companyBalances[t.companyName].purchases += t.invoiceAmount || 0;
              } else if(t.transactionType === "cargoInvoice" || t.transactionType === "customsInvoice") {
                // FEDEX i√ßin Kargo ve G√ºmr√ºk Faturasƒ± ‚Üí Bor√ß
                companyBalances[t.companyName].purchases += t.paymentAmount || 0;
              } else if(["payment", "refundInvoice", "refund"].includes(t.transactionType)) {
                // √ñdeme, ƒ∞ade Fatura ve ƒ∞ade ‚Üí Alacak
                companyBalances[t.companyName].payments += t.paymentAmount || 0;
              }
            });
            
            // Bakiyeleri g√∂ster
            companyBalancesBody.innerHTML = "";
            for(const [company, balance] of Object.entries(companyBalances)) {
              const totalDebt = balance.purchases - balance.payments;
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td style="padding:12px;border-bottom:1px solid var(--border);">${company}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;">${balance.purchases.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;">${balance.payments.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;color:${totalDebt > 0 ? 'red' : 'green'};">${totalDebt.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;">
                  <div style="display:flex;gap:4px;justify-content:center;">
                    <button onclick="editCompany('${company.replace(/'/g, "\\'")}')" style="background:#007bff;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:12px;font-weight:900;cursor:pointer;">D√úZENLE</button>
                    <button onclick="deleteCompany('${company.replace(/'/g, "\\'")}')" style="background:#dc3545;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:12px;font-weight:900;cursor:pointer;">Sƒ∞L</button>
                  </div>
                </td>
              `;
              companyBalancesBody.appendChild(tr);
            }
            
            // T√ºm i≈ülemleri g√∂ster
            displayAccountTransactions(transactions, "all", "");
            
            // Autocomplete i√ßin firma listesi
            const companyList = document.getElementById("companyList");
            companyList.innerHTML = "";
            Object.keys(companyBalances).forEach(company => {
              const option = document.createElement("option");
              option.value = company;
              companyList.appendChild(option);
            });
            
          } catch(e) {
            console.error("Cari i≈ülemler y√ºklenemedi:", e);
          }
        }

        // ƒ∞≈ülemleri filtreleme ve g√∂r√ºnt√ºleme
        function displayAccountTransactions(transactions, filterType, searchText) {
          accountListBody.innerHTML = "";
          
          const filtered = transactions.filter(t => {
            const matchesType = filterType === "all" || t.transactionType === filterType;
            const matchesSearch = !searchText || t.companyName.toLowerCase().includes(searchText.toLowerCase());
            return matchesType && matchesSearch;
          });
          
          filtered.forEach(t => {
            const tr = document.createElement("tr");
            let typeText, amount, details;
            
            if(t.transactionType === "purchase") {
              typeText = "MAL ALIMI";
              amount = `${(t.invoiceAmount || 0).toLocaleString('tr-TR')} ‚Ç∫`;
              details = `${t.itemName || ""} (${t.quantity || ""})`;
            } else if(t.transactionType === "refundInvoice") {
              typeText = "ƒ∞ADE FATURA";
              amount = `${(t.paymentAmount || 0).toLocaleString('tr-TR')} ‚Ç∫`;
              details = "";
            } else if(t.transactionType === "cargoInvoice") {
              typeText = "KARGO FATURASI";
              amount = `${(t.paymentAmount || 0).toLocaleString('tr-TR')} ‚Ç∫`;
              details = "";
            } else if(t.transactionType === "customsInvoice") {
              typeText = "G√úMR√úK FATURASI";
              amount = `${(t.paymentAmount || 0).toLocaleString('tr-TR')} ‚Ç∫`;
              details = "";
            } else if(t.transactionType === "refund") {
              typeText = "ƒ∞ADE";
              amount = `${(t.paymentAmount || 0).toLocaleString('tr-TR')} ‚Ç∫`;
              details = "";
            } else {
              typeText = "√ñDEME";
              amount = `${(t.paymentAmount || 0).toLocaleString('tr-TR')} ‚Ç∫`;
              details = "";
            }
            
            tr.innerHTML = `
              <td style="padding:12px;border-bottom:1px solid var(--border);">${new Date(t.transactionDate).toLocaleDateString('tr-TR')}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);">${t.companyName}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);">${typeText}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);">${details}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;">${amount}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);">${t.note || ""}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;"><button onclick="deleteAccountTransaction('${t.id}')" style="padding:6px 12px;background:red;color:white;border:none;border-radius:4px;cursor:pointer;">Sil</button></td>
            `;
            accountListBody.appendChild(tr);
          });
        }

        // Cari i≈ülem silme
        window.deleteAccountTransaction = async function(docId) {
          if(!confirm("Bu i≈ülemi silmek istediƒüinizden emin misiniz?")) return;
          
          try {
            await deleteDoc(doc(db, "accountTransactions", docId));
            setStatusBox(statusAccount, "ƒ∞≈ülem silindi.", "ok");
            loadAccountTransactions();
          } catch(e) {
            alert("Hata: " + e.message);
          }
        };

        // Filtre butonlarƒ±
        let currentAccountFilter = "all";
        
        btnFilterAllTransactions && (btnFilterAllTransactions.onclick = async () => {
          currentAccountFilter = "all";
          const snap = await getDocs(query(accountCol, orderBy("transactionDate", "desc")));
          const transactions = [];
          snap.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
          displayAccountTransactions(transactions, "all", accountSearchCompany?.value || "");
        });

        btnFilterPurchases && (btnFilterPurchases.onclick = async () => {
          currentAccountFilter = "purchase";
          const snap = await getDocs(query(accountCol, orderBy("transactionDate", "desc")));
          const transactions = [];
          snap.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
          displayAccountTransactions(transactions, "purchase", accountSearchCompany?.value || "");
        });

        btnFilterPayments && (btnFilterPayments.onclick = async () => {
          currentAccountFilter = "payment";
          const snap = await getDocs(query(accountCol, orderBy("transactionDate", "desc")));
          const transactions = [];
          snap.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
          displayAccountTransactions(transactions, "payment", accountSearchCompany?.value || "");
        });

        // Arama kutusu
        accountSearchCompany && accountSearchCompany.addEventListener("input", async (e) => {
          const snap = await getDocs(query(accountCol, orderBy("transactionDate", "desc")));
          const transactions = [];
          snap.forEach(doc => transactions.push({ id: doc.id, ...doc.data() }));
          displayAccountTransactions(transactions, currentAccountFilter, e.target.value);
        });

        // Firma adƒ±nƒ± d√ºzenle
        window.editCompany = function(companyName) {
          editCompanyOldName.value = companyName;
          editCompanyNewName.value = companyName;
          editCompanySection.style.display = "block";
          editCompanySection.scrollIntoView({ behavior: 'smooth' });
        };

        // Firma adƒ± g√ºncelleme
        btnUpdateCompany && (btnUpdateCompany.onclick = async function() {
          try {
            const oldName = editCompanyOldName.value;
            const newName = editCompanyNewName.value.trim();

            if(!newName) {
              setStatusBox(statusEditCompany, "Firma adƒ± bo≈ü olamaz.", "error");
              return;
            }

            if(oldName === newName) {
              setStatusBox(statusEditCompany, "Yeni firma adƒ± eskisiyle aynƒ±.", "error");
              return;
            }

            setStatusBox(statusEditCompany, "G√ºncelleniyor...", "info");

            // Bu firmaya ait t√ºm i≈ülemleri bul ve g√ºncelle
            const snap = await getDocs(query(accountCol, where("companyName", "==", oldName)));
            const batch = writeBatch(db);

            snap.docs.forEach(docSnap => {
              batch.update(docSnap.ref, { companyName: newName });
            });

            await batch.commit();

            setStatusBox(statusEditCompany, "Firma adƒ± g√ºncellendi.", "ok");
            editCompanySection.style.display = "none";
            loadAccountTransactions();
          } catch(e) {
            console.error('Firma g√ºncelleme hatasƒ±:', e);
            setStatusBox(statusEditCompany, "Hata: " + e.message, "error");
          }
        });

        // D√ºzenleme iptali
        btnCancelCompanyEdit && (btnCancelCompanyEdit.onclick = function() {
          editCompanySection.style.display = "none";
        });

        // Firmayƒ± ve t√ºm i≈ülemlerini sil
        window.deleteCompany = async function(companyName) {
          if(!confirm(`${companyName} firmasƒ±nƒ± ve bu firmaya ait T√úM i≈ülemleri silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz!`)) return;

          try {
            const snap = await getDocs(query(accountCol, where("companyName", "==", companyName)));
            const batch = writeBatch(db);

            snap.docs.forEach(docSnap => {
              batch.delete(docSnap.ref);
            });

            await batch.commit();

            alert(`${companyName} firmasƒ± ve ${snap.docs.length} i≈ülem silindi.`);
            loadAccountTransactions();
          } catch(e) {
            alert('Hata: ' + e.message);
          }
        };

        // Sayfa y√ºklendiƒüinde cari i≈ülemleri y√ºkle
        loadAccountTransactions();

        // ============================
        // ETSY SATI≈ûLARI FONKSƒ∞YONLARI
        // ============================

        // Komisyon i≈ülemi ekleme
        window.addCommissionTransaction = async function() {
          try {
            console.log("addCommissionTransaction called");
            const transactionType = commissionTransactionType.value;
            const amount = Number(commissionAmount.value);
            const note = commissionNote.value.trim();
            const sellerPin = window.__SESSION?.pin;
            const sellerName = PIN_NAMES[sellerPin] || "Bilinmeyen Satƒ±cƒ±";
            
            console.log("Commission data:", { transactionType, amount, note, sellerPin, sellerName });
            
            if(!amount || amount <= 0) {
              setStatusBox(statusCommission, "Tutar ge√ßersiz.", "error");
              console.error("Invalid amount:", amount);
              return;
            }
            
            setStatusBox(statusCommission, "Kaydediliyor...", "");
            
            console.log("Attempting to save to commissionCol...");
            await addDoc(commissionCol, {
              sellerPin,
              sellerName,
              transactionType,
              amount,
              note,
              createdAt: new Date().toISOString()
            });
            
            console.log("Document saved successfully");
            
            // Log kaydƒ± ekle
            const transactionTypeText = transactionType === "income" ? "Gelir" : "Gider";
            await writeLog({ 
              action: "COMMISSION_TRANSACTION", 
              shelf: "-", 
              product: sellerName, 
              qty: 0, 
              detail: `${transactionTypeText}: ${amount} TL - ${note || '-'}`
            });
            
            // Formu temizle
            commissionTransactionType.value = "income";
            commissionAmount.value = "";
            commissionNote.value = "";
            
            setStatusBox(statusCommission, "ƒ∞≈ülem kaydedildi.", "ok");
            loadMyCommissions();
          } catch(e) {
            console.error("addCommissionTransaction error:", e);
            setStatusBox(statusCommission, "Hata: " + e.message, "error");
          }
        };
        
        // KAYDET butonuna event listener ekle
        btnAddCommission && (btnAddCommission.onclick = addCommissionTransaction);

        // Satƒ±cƒ±nƒ±n kendi i≈ülemlerini y√ºkleme
        async function loadMyCommissions() {
          try {
            const sellerPin = window.__SESSION?.pin;
            const sellerName = window.PIN_NAMES[sellerPin];
            console.log("Loading commissions for PIN:", sellerPin, "Name:", sellerName);
            
            // ƒ∞SME G√ñRE T√úM KAYITLARI √áEK (hem eski hem yeni PIN'lerle yapƒ±lanlar)
            const allSnap = await getDocs(commissionCol);
            
            let totalIncome = 0;
            let totalExpense = 0;
            const transactions = [];
            const seenTransactions = new Set(); // M√ºkerrer kayƒ±tlarƒ± √∂nlemek i√ßin
            
            allSnap.forEach(docSnap => {
              const data = docSnap.data();
              
              // Sadece bu kullanƒ±cƒ±nƒ±n ismindeki kayƒ±tlarƒ± al
              if(data.sellerName === sellerName) {
                // M√ºkerrer kayƒ±t kontrol√º (aynƒ± tarih, tutar ve tip)
                const transactionKey = `${data.createdAt}_${data.amount}_${data.transactionType}_${data.description || ''}`;
                
                if(!seenTransactions.has(transactionKey)) {
                  seenTransactions.add(transactionKey);
                  console.log("Transaction data:", data, "(PIN:", data.sellerPin, ")");
                  transactions.push({ id: docSnap.id, ...data });
                  
                  if(data.transactionType === "income") {
                    totalIncome += data.amount || 0;
                  } else {
                    totalExpense += data.amount || 0;
                  }
                } else {
                  console.log("‚ö†Ô∏è M√ºkerrer kayƒ±t atlandƒ±:", data);
                }
              }
            });
            
            console.log("Found documents:", transactions.length, "(M√ºkerrer olmayan)");
            
            // Tarihe g√∂re sƒ±rala (client-side)
            transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Vergi muafiyeti olan satƒ±cƒ±lar (Murat O., Aykut P., √ñznur P.)
            const taxExemptPins = new Set(["23764", "190706", "190707"]);
            const hasTaxExemption = taxExemptPins.has(sellerPin);
            
            // Hesaplamalar
            // √ñmer Faruk A. (14698) i√ßin %10, diƒüerleri i√ßin %20 komisyon
            const commissionRate = sellerPin === "14698" ? 0.10 : 0.20;
            
            let netIncome, sellerShare, companyGrossShare;
            
            if(hasTaxExemption) {
              // VERGƒ∞ MUAFƒ∞YETƒ∞ OLAN SATICILAR - Gelir √ºzerinden hesaplama
              sellerShare = totalIncome * commissionRate; // Satƒ±cƒ± payƒ±
              companyGrossShare = totalIncome * (1 - commissionRate); // ≈ûirket br√ºt payƒ±
              netIncome = totalIncome;
            } else {
              // VERGƒ∞ MUAFƒ∞YETƒ∞ OLMAYAN SATICILAR - Net gelir √ºzerinden hesaplama
              netIncome = totalIncome - totalExpense; // Net gelir (gider d√º≈ü√ºlm√º≈ü)
              sellerShare = netIncome * commissionRate; // Satƒ±cƒ± payƒ± net gelirden
              companyGrossShare = netIncome * (1 - commissionRate); // ≈ûirket payƒ± net gelirden
            }
            
            const companyPaymentBeforeCollection = hasTaxExemption 
              ? companyGrossShare - totalExpense  // Vergi muafiyeti varsa gideri d√º≈ü
              : companyGrossShare; // Vergi muafiyeti yoksa zaten net gelirden hesaplandƒ±
            
            // Tahsilatlarƒ± y√ºkle - ƒ∞SME G√ñRE T√úM TAHSƒ∞LATLARI √áEK
            const allCollectionSnap = await getDocs(collectionCol);
            let totalCollections = 0;
            allCollectionSnap.forEach(doc => {
              const data = doc.data();
              if(data.sellerName === sellerName) {
                totalCollections += data.amount || 0;
              }
            });
            
            // Tahsilatlar d√º≈ü√ºld√ºkten sonra kalan bor√ß
            const companyPayment = companyPaymentBeforeCollection - totalCollections;
            
            // Esnaf vergi muafiyeti hesaplama - SADECE MUAFƒ∞YETƒ∞ OLAN SATICILAR ƒ∞√áƒ∞N
            let taxUsed = 0;
            let taxRemaining = 0;
            const TAX_EXEMPTION_LIMIT = 1900000;
            
            if(hasTaxExemption) {
              taxUsed = totalIncome / 0.96; // Komisyonlu satƒ±≈ü geliri 0.96'ya b√∂l√ºnerek vergi muafiyetinden d√º≈üer
              taxRemaining = Math.max(0, TAX_EXEMPTION_LIMIT - taxUsed);
            }
            
            myTotalIncome.textContent = Math.round(totalIncome).toLocaleString('tr-TR') + " ‚Ç∫";
            myTotalExpense.textContent = Math.round(totalExpense).toLocaleString('tr-TR') + " ‚Ç∫";
            myCommission.textContent = Math.round(sellerShare).toLocaleString('tr-TR') + " ‚Ç∫";
            
            // Komisyon oranƒ± etiketini g√ºncelle ve vergi muafiyeti alanƒ±nƒ± ayarla
            const myCommissionLabel = document.getElementById('myCommissionLabel');
            const myTaxSection = document.getElementById('myTaxSection');
            
            if(sellerPin === "14698") {
              if(myCommissionLabel) myCommissionLabel.textContent = "Payƒ±m (%10)";
            } else {
              if(myCommissionLabel) myCommissionLabel.textContent = "Payƒ±m (%20)";
            }
            
            // Vergi muafiyeti alanƒ±nƒ± sadece muafiyeti olan satƒ±cƒ±lara g√∂ster
            if(myTaxSection) {
              if(hasTaxExemption) {
                myTaxSection.style.display = "block";
              } else {
                myTaxSection.style.display = "none";
              }
            }
            
            // Yeni alanlar
            const myCompanyPayment = document.getElementById('myCompanyPayment');
            const myCollectionInfo = document.getElementById('myCollectionInfo');
            const myTaxUsed = document.getElementById('myTaxUsed');
            const myTaxRemaining = document.getElementById('myTaxRemaining');
            
            if(myCompanyPayment) myCompanyPayment.textContent = Math.round(companyPayment).toLocaleString('tr-TR') + " ‚Ç∫";
            
            // Tahsilat bilgisini g√∂ster
            if(myCollectionInfo) {
              if(totalCollections > 0) {
                myCollectionInfo.textContent = "Tahsilat: -" + Math.round(totalCollections).toLocaleString('tr-TR') + " ‚Ç∫";
                myCollectionInfo.style.display = "block";
              } else {
                myCollectionInfo.style.display = "none";
              }
            }
            
            if(myTaxUsed) myTaxUsed.textContent = Math.round(taxUsed).toLocaleString('tr-TR') + " ‚Ç∫";
            if(myTaxRemaining) {
              myTaxRemaining.textContent = Math.round(taxRemaining).toLocaleString('tr-TR') + " ‚Ç∫";
              myTaxRemaining.style.color = taxRemaining > 0 ? "#10b981" : "#ef4444";
            }
            
            console.log("Calling displayMyCommissions with", transactions.length, "transactions");
            displayMyCommissions(transactions, "all");
            loadMyPayments(); // Tahsilatlarƒ± y√ºkle
            
          } catch(e) {
            console.error("Komisyon i≈ülemleri y√ºklenemedi:", e);
            setStatusBox(statusCommission, "Y√ºkleme hatasƒ±: " + e.message, "error");
          }
        }

        // ƒ∞≈ülemleri g√∂r√ºnt√ºleme
        function displayMyCommissions(transactions, filter) {
          commissionListBody.innerHTML = "";
          
          const filtered = transactions.filter(t => {
            if(filter === "all") return true;
            return t.transactionType === filter;
          });
          
          filtered.forEach(t => {
            const tr = document.createElement("tr");
            const typeText = t.transactionType === "income" ? "GELƒ∞R" : "Gƒ∞DER";
            const typeColor = t.transactionType === "income" ? "green" : "red";
            const date = new Date(t.createdAt).toLocaleDateString('tr-TR');
            
            tr.innerHTML = `
              <td style="padding:12px;border-bottom:1px solid var(--border);">${date}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);color:${typeColor};font-weight:bold;">${typeText}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;">${Math.round(t.amount).toLocaleString('tr-TR')} ‚Ç∫</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);">${t.note || ""}</td>
              <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;">
                <button onclick="deleteCommissionTransaction('${t.id}')" style="padding:6px 12px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:700;">Sƒ∞L</button>
              </td>
            `;
            commissionListBody.appendChild(tr);
          });
        }

        // Komisyon i≈ülemi silme
        window.deleteCommissionTransaction = async function(docId) {
          if(!confirm("Bu i≈ülemi silmek istediƒüinizden emin misiniz?")) return;
          
          try {
            await deleteDoc(doc(db, "commissionSales", docId));
            setStatusBox(statusCommission, "ƒ∞≈ülem silindi.", "ok");
            loadMyCommissions();
          } catch(e) {
            alert("Hata: " + e.message);
          }
        };

        // Filtre butonlarƒ±
        let allCommissionTransactions = [];

        btnFilterAllCommission && (btnFilterAllCommission.onclick = async () => {
          const sellerPin = window.__SESSION?.pin;
          const sellerName = window.PIN_NAMES[sellerPin];
          const allSnap = await getDocs(commissionCol);
          const transactions = [];
          allSnap.forEach(doc => {
            const data = doc.data();
            if(data.sellerName === sellerName) {
              transactions.push({ id: doc.id, ...data });
            }
          });
          transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          displayMyCommissions(transactions, "all");
        });

        btnFilterIncome && (btnFilterIncome.onclick = async () => {
          const sellerPin = window.__SESSION?.pin;
          const sellerName = window.PIN_NAMES[sellerPin];
          const allSnap = await getDocs(commissionCol);
          const transactions = [];
          allSnap.forEach(doc => {
            const data = doc.data();
            if(data.sellerName === sellerName) {
              transactions.push({ id: doc.id, ...data });
            }
          });
          transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          displayMyCommissions(transactions, "income");
        });

        btnFilterExpense && (btnFilterExpense.onclick = async () => {
          const sellerPin = window.__SESSION?.pin;
          const sellerName = window.PIN_NAMES[sellerPin];
          const allSnap = await getDocs(commissionCol);
          const transactions = [];
          allSnap.forEach(doc => {
            const data = doc.data();
            if(data.sellerName === sellerName) {
              transactions.push({ id: doc.id, ...data });
            }
          });
          transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          displayMyCommissions(transactions, "expense");
        });

        // Admin i√ßin t√ºm satƒ±cƒ±larƒ±n √∂zetini y√ºkleme
        async function loadCommissionSummary() {
          try {
            console.log("üîÑ loadCommissionSummary √ßaƒürƒ±ldƒ±");
            const snap = await getDocs(commissionCol);
            const collectionSnap = await getDocs(collectionCol);
            
            const sellerData = {};
            let totalCompanyShare = 0;
            let totalCollections = 0;
            
            // PIN_NAMES'den isim->PIN haritasƒ± olu≈ütur (g√ºncel PIN'ler)
            const nameToCurrentPin = {};
            for(const [pin, name] of Object.entries(window.PIN_NAMES || {})) {
              nameToCurrentPin[name] = pin;
            }
            
            // Komisyon i≈ülemlerini topla - ƒ∞SME G√ñRE GRUPLA (hem eski hem yeni PIN'lerle yapƒ±lan kayƒ±tlar)
            const seenTransactions = new Set(); // M√ºkerrer kayƒ±t kontrol√º
            
            snap.forEach(doc => {
              const data = doc.data();
              const sellerName = data.sellerName;
              const currentPin = nameToCurrentPin[sellerName]; // Bu isim i√ßin g√ºncel PIN
              
              if(!currentPin) {
                console.log("‚ö†Ô∏è PIN_NAMES'de bulunamayan isim:", sellerName);
                return; // Bu isim i√ßin g√ºncel PIN yok, atla
              }
              
              // M√ºkerrer kayƒ±t kontrol√º
              const transactionKey = `${data.createdAt}_${data.amount}_${data.transactionType}_${data.description || ''}`;
              if(seenTransactions.has(transactionKey)) {
                console.log("‚ö†Ô∏è M√ºkerrer kayƒ±t atlandƒ±:", data);
                return;
              }
              seenTransactions.add(transactionKey);
              
              // ƒ∞sme g√∂re grupla (her isim i√ßin tek kayƒ±t)
              if(!sellerData[sellerName]) {
                sellerData[sellerName] = {
                  name: sellerName,
                  pin: currentPin, // G√ºncel PIN'i kullan
                  income: 0,
                  expense: 0,
                  collections: 0
                };
              }
              
              if(data.transactionType === "income") {
                sellerData[sellerName].income += data.amount || 0;
              } else {
                sellerData[sellerName].expense += data.amount || 0;
              }
            });
            
            // Tahsilatlarƒ± topla - ƒ∞SME G√ñRE
            collectionSnap.forEach(doc => {
              const data = doc.data();
              const sellerName = data.sellerName;
              
              if(sellerData[sellerName]) {
                sellerData[sellerName].collections += data.amount || 0;
              }
            });
            
            // Satƒ±cƒ± se√ßim listesini g√ºncelle
            if(collectionSellerPin) {
              collectionSellerPin.innerHTML = "<option value=''>Satƒ±cƒ± Se√ßin</option>";
              for(const [sellerName, data] of Object.entries(sellerData)) {
                const option = document.createElement("option");
                option.value = data.pin;
                option.textContent = data.name;
                collectionSellerPin.appendChild(option);
              }
            }
            
            commissionSummaryBody.innerHTML = "";
            
            if(Object.keys(sellerData).length === 0) {
              commissionSummaryBody.innerHTML = "<tr><td colspan='9' style='padding:24px;text-align:center;color:var(--muted);'>Hen√ºz komisyon verisi yok.</td></tr>";
              return;
            }
            
            const TAX_EXEMPTION_LIMIT = 1900000;
            const taxExemptPins = new Set(["23764", "190706", "190707"]); // Murat O., Aykut P., √ñznur P.
            
            for(const [sellerName, data] of Object.entries(sellerData)) {
              const hasTaxExemption = taxExemptPins.has(data.pin);
              
              // Hesaplamalar
              // √ñmer Faruk A. (PIN 14698) i√ßin %10, diƒüerleri i√ßin %20 komisyon
              const commissionRate = data.pin === "14698" ? 0.10 : 0.20;
              
              let sellerShare, companyGrossShare, companyPayment;
              
              if(hasTaxExemption) {
                // VERGƒ∞ MUAFƒ∞YETƒ∞ OLAN SATICILAR - Gelir √ºzerinden hesaplama
                sellerShare = data.income * commissionRate;
                companyGrossShare = data.income * (1 - commissionRate);
                companyPayment = companyGrossShare - data.expense;
              } else {
                // VERGƒ∞ MUAFƒ∞YETƒ∞ OLMAYAN SATICILAR - Net gelir √ºzerinden hesaplama
                const netIncome = data.income - data.expense;
                sellerShare = netIncome * commissionRate;
                companyGrossShare = netIncome * (1 - commissionRate);
                companyPayment = companyGrossShare;
              }
              
              // Esnaf vergi muafiyeti hesaplama - SADECE MUAFƒ∞YETƒ∞ OLAN SATICILAR ƒ∞√áƒ∞N
              let taxUsed = 0;
              let taxRemaining = 0;
              
              if(hasTaxExemption) {
                taxUsed = data.income / 0.96;
                taxRemaining = Math.max(0, TAX_EXEMPTION_LIMIT - taxUsed);
              }
              
              // ≈ûirket net (tahsilat d√º≈üt√ºkten sonra)
              const companyFinalShare = companyPayment - data.collections;
              totalCompanyShare += companyFinalShare;
              totalCollections += data.collections;
              
              const taxColor = taxRemaining > 0 ? '#10b981' : '#ef4444';
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td style="padding:10px;border-bottom:1px solid var(--border);">${data.name}</td>
                <td style="padding:10px;border-bottom:1px solid var(--border);text-align:right;">${Math.round(data.income).toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:10px;border-bottom:1px solid var(--border);text-align:right;">${Math.round(data.expense).toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:10px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;">${Math.round(companyGrossShare).toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:10px;border-bottom:1px solid var(--border);text-align:right;color:green;font-weight:bold;">${Math.round(sellerShare).toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:10px;border-bottom:1px solid var(--border);text-align:right;color:#ef4444;font-weight:bold;">${Math.round(companyPayment).toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:10px;border-bottom:1px solid var(--border);text-align:right;">
                  ${hasTaxExemption ? `
                    <div style="font-size:11px;color:#666;margin-bottom:2px;">Kullanƒ±lan: ${Math.round(taxUsed).toLocaleString('tr-TR')} ‚Ç∫</div>
                    <div style="font-weight:bold;color:${taxColor};">${Math.round(taxRemaining).toLocaleString('tr-TR')} ‚Ç∫</div>
                  ` : `<div style="font-size:12px;color:#94a3b8;">Muafiyet Yok</div>`}
                </td>
                <td style="padding:10px;border-bottom:1px solid var(--border);text-align:right;">
                  <div style="color:blue;font-weight:bold;">${Math.round(companyPayment).toLocaleString('tr-TR')} ‚Ç∫</div>
                  ${data.collections > 0 ? `<div style="color:red;font-size:11px;margin-top:2px;">- ${Math.round(data.collections).toLocaleString('tr-TR')} ‚Ç∫</div>` : ''}
                  ${data.collections > 0 ? `<div style="color:#0d47a1;font-size:12px;margin-top:2px;font-weight:bold;">${Math.round(companyFinalShare).toLocaleString('tr-TR')} ‚Ç∫</div>` : ''}
                </td>
                <td style="padding:10px;border-bottom:1px solid var(--border);text-align:center;">
                  <button onclick="showSellerDetail('${data.pin}')" style="padding:6px 12px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:700;font-size:12px;">DETAY</button>
                </td>
              `;
              commissionSummaryBody.appendChild(tr);
            }
            
            // Toplam ≈üirket hak edi≈üi satƒ±rƒ±
            const totalTr = document.createElement("tr");
            totalTr.style.background = "#e3f2fd";
            totalTr.style.fontWeight = "bold";
            totalTr.innerHTML = `
              <td colspan="7" style="padding:16px;text-align:right;font-size:16px;">
                <div>TOPLAM ≈ûƒ∞RKET HAK EDƒ∞≈ûƒ∞</div>
                ${totalCollections > 0 ? `<div style="color:red;font-size:14px;margin-top:4px;">- ${totalCollections.toLocaleString('tr-TR')} ‚Ç∫ (tahsilatlar)</div>` : ''}
              </td>
              <td style="padding:16px;text-align:right;color:#0d47a1;font-size:18px;font-weight:900;">${totalCompanyShare.toLocaleString('tr-TR')} ‚Ç∫</td>
              <td></td>
            `;
            commissionSummaryBody.appendChild(totalTr);
            
            console.log("‚úÖ Komisyon √∂zeti y√ºklendi");
            
          } catch(e) {
            console.error("‚ùå Komisyon √∂zeti y√ºklenemedi:", e);
            commissionSummaryBody.innerHTML = `<tr><td colspan='7' style='padding:24px;text-align:center;color:red;'>Hata: ${e.message}</td></tr>`;
          }
        }

        // Satƒ±cƒ± detaylarƒ±nƒ± g√∂ster
        window.showSellerDetail = async function(sellerPin) {
          try {
            console.log('üìã Satƒ±cƒ± detayƒ± y√ºkleniyor, PIN:', sellerPin);
            const snap = await getDocs(query(commissionCol, where("sellerPin", "==", sellerPin)));
            
            let totalIncome = 0;
            let totalExpense = 0;
            const transactions = [];
            
            snap.forEach(doc => {
              const data = doc.data();
              transactions.push({ id: doc.id, ...data });
              
              if(data.transactionType === "income") {
                totalIncome += data.amount || 0;
              } else {
                totalExpense += data.amount || 0;
              }
            });
            
            // √ñmer Faruk A. (9301) i√ßin %10, diƒüerleri i√ßin %20 komisyon
            const commissionRate = sellerPin === "9301" ? 0.10 : 0.20;
            // Satƒ±cƒ± payƒ± = Gelir * komisyon oranƒ±
            // ≈ûirket br√ºt payƒ± = Gelir * (1 - komisyon oranƒ±)
            // ≈ûirket net payƒ± = Br√ºt pay - Gider
            const sellerShare = totalIncome * commissionRate;
            const companyGrossShare = totalIncome * (1 - commissionRate);
            const companyNetShare = companyGrossShare - totalExpense;
            const sellerName = transactions.length > 0 ? transactions[0].sellerName : "Satƒ±cƒ±";
            
            console.log('üí∞ Gelir:', totalIncome, 'Gider:', totalExpense, '≈ûirket Net:', companyNetShare);
            
            sellerDetailTitle.textContent = sellerName + " - Detaylarƒ±";
            detailIncome.textContent = totalIncome.toLocaleString('tr-TR') + " ‚Ç∫";
            detailExpense.textContent = totalExpense.toLocaleString('tr-TR') + " ‚Ç∫ (≈ûirket √ústlenir)";
            detailNet.textContent = companyGrossShare.toLocaleString('tr-TR') + " ‚Ç∫ (Br√ºt)";
            detailCompanyShare.textContent = companyNetShare.toLocaleString('tr-TR') + " ‚Ç∫ (Net)";
            
            detailTransactionsBody.innerHTML = "";
            
            if(transactions.length === 0) {
              detailTransactionsBody.innerHTML = "<tr><td colspan='5' style='padding:24px;text-align:center;color:var(--muted);'>ƒ∞≈ülem bulunamadƒ±.</td></tr>";
            } else {
              transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
              
              transactions.forEach(t => {
                const tr = document.createElement("tr");
                const typeText = t.transactionType === "income" ? "GELƒ∞R" : "Gƒ∞DER";
                const typeColor = t.transactionType === "income" ? "green" : "red";
                const date = new Date(t.createdAt).toLocaleDateString('tr-TR');
                
                tr.innerHTML = `
                  <td style="padding:12px;border-bottom:1px solid var(--border);">${date}</td>
                  <td style="padding:12px;border-bottom:1px solid var(--border);color:${typeColor};font-weight:bold;">${typeText}</td>
                  <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;">${t.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                  <td style="padding:12px;border-bottom:1px solid var(--border);">${t.note || ""}</td>
                  <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;">
                    <button onclick="deleteCommissionFromDetail('${t.id}', '${sellerPin}')" style="padding:6px 12px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:700;">Sƒ∞L</button>
                  </td>
                `;
                detailTransactionsBody.appendChild(tr);
              });
            }
            
            sellerDetailSection.style.display = "block";
            sellerDetailSection.scrollIntoView({ behavior: 'smooth' });
            console.log('‚úÖ Detay paneli g√∂sterildi');
            
          } catch(e) {
            console.error("‚ùå Satƒ±cƒ± detaylarƒ± hatasƒ±:", e);
            alert("Satƒ±cƒ± detaylarƒ± y√ºklenemedi: " + e.message);
          }
        };

        // Satƒ±cƒ± detay panelini kapat
        window.hideSellerDetail = function() {
          sellerDetailSection.style.display = "none";
        };

        // Tahsilat ekleme
        window.addCollection = async function() {
          try {
            const sellerPin = collectionSellerPin.value;
            const amount = Number(collectionAmount.value);
            const note = collectionNote.value.trim();
            
            if(!sellerPin) {
              setStatusBox(statusCollection, "Satƒ±cƒ± se√ßin.", "error");
              return;
            }
            
            if(!amount || amount <= 0) {
              setStatusBox(statusCollection, "Tutar ge√ßersiz.", "error");
              return;
            }
            
            setStatusBox(statusCollection, "Kaydediliyor...", "");
            
            // Satƒ±cƒ± adƒ±nƒ± bul
            const sellerName = collectionSellerPin.options[collectionSellerPin.selectedIndex].text;
            
            await addDoc(collectionCol, {
              sellerPin,
              sellerName,
              amount,
              note,
              createdAt: new Date().toISOString(),
              createdBy: window.__SESSION?.pin || "admin"
            });
            
            // Log kaydƒ± ekle
            await writeLog({ 
              action: "COMMISSION_COLLECTION", 
              shelf: "-", 
              product: sellerName, 
              qty: 0, 
              detail: `Tahsilat: ${amount} TL - ${note || '-'}`
            });
            
            // Formu temizle
            collectionSellerPin.value = "";
            collectionAmount.value = "";
            collectionNote.value = "";
            
            setStatusBox(statusCollection, "Tahsilat kaydedildi.", "ok");
            loadCommissionSummary();
            loadPaymentsHistory(); // Tahsilat ge√ßmi≈üini g√ºncelle
          } catch(e) {
            setStatusBox(statusCollection, "Hata: " + e.message, "error");
          }
        };
        
        btnAddCollection && (btnAddCollection.onclick = addCollection);

        // Tahsilat ge√ßmi≈üini y√ºkleme
        async function loadPaymentsHistory() {
          try {
            const snap = await getDocs(query(collectionCol, orderBy("createdAt", "desc")));
            paymentsHistoryBody.innerHTML = "";
            
            if(snap.empty) {
              paymentsHistoryBody.innerHTML = "<tr><td colspan='5' style='padding:24px;text-align:center;color:var(--muted);'>Hen√ºz tahsilat kaydƒ± yok.</td></tr>";
              return;
            }
            
            snap.forEach(doc => {
              const data = doc.data();
              const date = new Date(data.createdAt).toLocaleDateString('tr-TR');
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td style="padding:12px;border-bottom:1px solid var(--border);">${date}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);">${data.sellerName}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;color:#28a745;">${data.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);">${data.note || ""}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;">
                  <button onclick="deletePayment('${doc.id}')" style="padding:6px 12px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:700;">Sƒ∞L</button>
                </td>
              `;
              paymentsHistoryBody.appendChild(tr);
            });
          } catch(e) {
            console.error("Tahsilat ge√ßmi≈üi y√ºklenemedi:", e);
            paymentsHistoryBody.innerHTML = `<tr><td colspan='5' style='padding:24px;text-align:center;color:red;'>Hata: ${e.message}</td></tr>`;
          }
        }

        // Tahsilat kaydƒ±nƒ± silme
        window.deletePayment = async function(docId) {
          if(!confirm("Bu tahsilat kaydƒ±nƒ± silmek istediƒüinizden emin misiniz?")) return;
          
          try {
            await deleteDoc(doc(db, "commissionCollections", docId));
            alert("Tahsilat kaydƒ± silindi.");
            loadPaymentsHistory();
            loadCommissionSummary(); // √ñzeti de g√ºncelle
          } catch(e) {
            alert("Hata: " + e.message);
          }
        };

        // Komisyonlu satƒ±cƒ±nƒ±n kendi tahsilatlarƒ±nƒ± y√ºkleme
        async function loadMyPayments() {
          try {
            const sellerPin = window.__SESSION?.pin;
            const sellerName = window.PIN_NAMES[sellerPin];
            
            // ƒ∞SME G√ñRE T√úM TAHSƒ∞LATLARI √áEK (eski ve yeni PIN'lerle yapƒ±lanlar)
            const allSnap = await getDocs(collectionCol);
            const payments = [];
            
            allSnap.forEach(doc => {
              const data = doc.data();
              if(data.sellerName === sellerName) {
                payments.push({ id: doc.id, ...data });
              }
            });
            
            // Tarihe g√∂re sƒ±rala
            payments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            myPaymentsBody.innerHTML = "";
            
            if(payments.length === 0) {
              myPaymentsBody.innerHTML = "<tr><td colspan='3' style='padding:24px;text-align:center;color:var(--muted);'>Hen√ºz tahsilat kaydƒ± yok.</td></tr>";
              return;
            }
            
            payments.forEach(payment => {
              const date = new Date(payment.createdAt).toLocaleDateString('tr-TR');
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td style="padding:12px;border-bottom:1px solid var(--border);">${date}</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;color:#28a745;">${payment.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                <td style="padding:12px;border-bottom:1px solid var(--border);">${payment.note || ""}</td>
              `;
              myPaymentsBody.appendChild(tr);
            });
          } catch(e) {
            console.error("Tahsilat ge√ßmi≈üi y√ºklenemedi:", e);
            myPaymentsBody.innerHTML = `<tr><td colspan='3' style='padding:24px;text-align:center;color:red;'>Hata: ${e.message}</td></tr>`;
          }
        }

        // Detaydan komisyon i≈ülemi silme
        window.deleteCommissionFromDetail = async function(docId, sellerPin) {
          if(!confirm("Bu i≈ülemi silmek istediƒüinizden emin misiniz?")) return;
          
          try {
            await deleteDoc(doc(db, "commissionSales", docId));
            alert("ƒ∞≈ülem silindi.");
            showSellerDetail(sellerPin); // Detayƒ± yeniden y√ºkle
            loadCommissionSummary(); // √ñzeti g√ºncelle
          } catch(e) {
            alert("Hata: " + e.message);
          }
        };

        // Sayfa y√ºklendiƒüinde komisyon verilerini y√ºkle
        const currentRole = window.__SESSION?.role;
        if(currentRole === "commission") {
          loadMyCommissions();
        } else if(currentRole === "admin") {
          loadCommissionSummary();
          loadPaymentsHistory();
        }

        // ====== AMAZON & SHOPIFY √ñDEMELERI ======
        
        // Platform √∂demelerini y√ºkle
        async function loadPlatformPayments() {
          try {
            console.log("üîÑ Platform √∂demeleri y√ºkleniyor...");
            const snap = await getDocs(query(platformPaymentsCol, orderBy("paymentDate", "desc")));
            
            let totalAmazonAmount = 0;
            let totalShopifyAmount = 0;
            const payments = [];
            
            snap.forEach(doc => {
              const data = doc.data();
              payments.push({ id: doc.id, ...data });
              
              if(data.platform === "Amazon") {
                totalAmazonAmount += data.amount || 0;
              } else if(data.platform === "Shopify") {
                totalShopifyAmount += data.amount || 0;
              }
            });
            
            // Toplamlarƒ± g√ºncelle
            if(totalAmazon) totalAmazon.textContent = "$" + totalAmazonAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            if(totalShopify) totalShopify.textContent = "$" + totalShopifyAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            if(totalPlatformPayments) totalPlatformPayments.textContent = "$" + (totalAmazonAmount + totalShopifyAmount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Tabloyu doldur
            if(platformPaymentsBody) {
              if(payments.length === 0) {
                platformPaymentsBody.innerHTML = "<tr><td colspan='5' style='padding:24px;text-align:center;color:var(--muted);'>Hen√ºz √∂deme kaydƒ± yok.</td></tr>";
              } else {
                platformPaymentsBody.innerHTML = "";
                payments.forEach(payment => {
                  const tr = document.createElement("tr");
                  const date = payment.paymentDate || "";
                  const platformColor = payment.platform === "Amazon" ? "#FF9900" : "#96BF48";
                  
                  tr.innerHTML = `
                    <td style="padding:12px;border-bottom:1px solid var(--border);">${date}</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);color:${platformColor};font-weight:bold;">${payment.platform}</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:right;font-weight:bold;">$${payment.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);">${payment.note || ""}</td>
                    <td style="padding:12px;border-bottom:1px solid var(--border);text-align:center;">
                      <button onclick="deletePlatformPayment('${payment.id}')" style="padding:6px 12px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:700;font-size:11px;">Sƒ∞L</button>
                    </td>
                  `;
                  platformPaymentsBody.appendChild(tr);
                });
              }
            }
            
            console.log("‚úÖ Platform √∂demeleri y√ºklendi");
          } catch(e) {
            console.error("‚ùå Platform √∂demeleri y√ºklenemedi:", e);
            if(platformPaymentsBody) {
              platformPaymentsBody.innerHTML = `<tr><td colspan='5' style='padding:24px;text-align:center;color:red;'>Hata: ${e.message}</td></tr>`;
            }
          }
        }
        
        // Platform √∂demesi ekle
        btnAddPlatformPayment && (btnAddPlatformPayment.onclick = async () => {
          try {
            const platform = platformPaymentPlatform.value.trim();
            const amount = parseFloat(platformPaymentAmount.value);
            const date = platformPaymentDate.value;
            const note = platformPaymentNote.value.trim();
            
            if(!platform) {
              setStatusBox(statusPlatformPayment, "L√ºtfen platform se√ßin.", "error");
              return;
            }
            
            if(!amount || amount <= 0) {
              setStatusBox(statusPlatformPayment, "L√ºtfen ge√ßerli bir tutar girin.", "error");
              return;
            }
            
            if(!date) {
              setStatusBox(statusPlatformPayment, "L√ºtfen tarih se√ßin.", "error");
              return;
            }
            
            setStatusBox(statusPlatformPayment, "Kaydediliyor...", "info");
            
            const paymentData = {
              platform: platform,
              amount: amount,
              paymentDate: date,
              note: note,
              createdAt: new Date().toISOString(),
              createdBy: window.__SESSION?.pin || "unknown"
            };
            
            await addDoc(platformPaymentsCol, paymentData);
            
            // Log kaydƒ±
            await addDoc(logsCol, {
              timestamp: new Date().toISOString(),
              action: "platformPayment",
              pin: window.__SESSION?.pin || "unknown",
              role: window.__SESSION?.role || "unknown",
              details: `${platform} - $${amount.toFixed(2)}`
            });
            
            setStatusBox(statusPlatformPayment, "√ñdeme kaydedildi.", "ok");
            
            // Formu temizle
            platformPaymentPlatform.value = "";
            platformPaymentAmount.value = "";
            platformPaymentDate.value = "";
            platformPaymentNote.value = "";
            
            // Listeyi g√ºncelle
            loadPlatformPayments();
            
          } catch(e) {
            console.error("Platform √∂demesi eklenemedi:", e);
            setStatusBox(statusPlatformPayment, "Hata: " + e.message, "error");
          }
        });
        
        // Platform √∂demesi sil
        window.deletePlatformPayment = async function(docId) {
          if(!confirm("Bu √∂deme kaydƒ±nƒ± silmek istediƒüinizden emin misiniz?")) return;
          
          try {
            await deleteDoc(doc(db, "platformPayments", docId));
            
            // Log kaydƒ±
            await addDoc(logsCol, {
              timestamp: new Date().toISOString(),
              action: "deletePlatformPayment",
              pin: window.__SESSION?.pin || "unknown",
              role: window.__SESSION?.role || "unknown",
              details: `Payment ID: ${docId}`
            });
            
            alert("√ñdeme kaydƒ± silindi.");
            loadPlatformPayments();
          } catch(e) {
            alert("Hata: " + e.message);
          }
        };

        // ========== ≈ûƒ∞FRE Y√ñNETƒ∞Mƒ∞ ==========
        if(role === "admin"){
          console.log("≈ûifre y√∂netimi y√ºkleniyor...", {
            pwdRole: !!pwdRole,
            pwdUserSelectBox: !!pwdUserSelectBox,
            pwdUserSelect: !!pwdUserSelect,
            pwdChangeBox: !!pwdChangeBox,
            ADMIN_PINS: window.ADMIN_PINS?.size
          });

          if(!pwdRole || !pwdUserSelectBox || !pwdUserSelect || !pwdChangeBox){
            console.error("≈ûifre y√∂netimi elementleri bulunamadƒ±!");
            return;
          }

          // Rol se√ßildiƒüinde
          pwdRole.addEventListener("change", () => {
            console.log("Rol deƒüi≈üti:", pwdRole.value);
            const selectedRole = pwdRole.value;
            if(!selectedRole){
              pwdUserSelectBox.style.display = "none";
              pwdChangeBox.style.display = "none";
              return;
            }

            // Kullanƒ±cƒ±larƒ± listele
            pwdUserSelect.innerHTML = '<option value="">Se√ßiniz</option>';
            
            const users = [];
            if(selectedRole === "admin"){
              window.ADMIN_PINS.forEach(pin => users.push({pin, name: window.PIN_NAMES[pin] || pin}));
            } else if(selectedRole === "packer"){
              window.PACKER_PINS.forEach(pin => users.push({pin, name: window.PIN_NAMES[pin] || pin}));
            } else if(selectedRole === "stower"){
              window.STOWER_PINS.forEach(pin => users.push({pin, name: window.PIN_NAMES[pin] || pin}));
            } else if(selectedRole === "welder"){
              window.WELDER_PINS.forEach(pin => users.push({pin, name: window.PIN_NAMES[pin] || pin}));
            } else if(selectedRole === "laser"){
              window.LASER_PINS.forEach(pin => users.push({pin, name: window.PIN_NAMES[pin] || pin}));
            } else if(selectedRole === "purchase"){
              window.PURCHASE_PINS.forEach(pin => users.push({pin, name: window.PIN_NAMES[pin] || pin}));
            } else if(selectedRole === "painter"){
              window.PAINTER_PINS.forEach(pin => users.push({pin, name: window.PIN_NAMES[pin] || pin}));
            } else if(selectedRole === "commission"){
              window.COMMISSION_PINS.forEach(pin => users.push({pin, name: window.PIN_NAMES[pin] || pin}));
            }

            console.log("Bulunan kullanƒ±cƒ±lar:", users.length);

            users.forEach(u => {
              const opt = document.createElement('option');
              opt.value = u.pin;
              opt.textContent = `${u.pin} - ${u.name}`;
              pwdUserSelect.appendChild(opt);
            });

            pwdUserSelectBox.style.display = "block";
            pwdChangeBox.style.display = "none";
          });

          // Kullanƒ±cƒ± se√ßildiƒüinde
          pwdUserSelect?.addEventListener("change", () => {
            const selectedPin = pwdUserSelect.value;
            if(!selectedPin){
              pwdChangeBox.style.display = "none";
              return;
            }

            pwdCurrentPin.value = selectedPin;
            pwdNewPin.value = "";
            pwdUserName.value = window.PIN_NAMES[selectedPin] || "";
            pwdChangeBox.style.display = "block";
            statusPwdUpdate.style.display = "none";
          });

          // ≈ûifre g√ºncelle
          btnUpdatePassword?.addEventListener("click", async () => {
            const currentPin = pwdCurrentPin.value.trim();
            const newPin = pwdNewPin.value.trim();
            const userName = pwdUserName.value.trim();
            const selectedRole = pwdRole.value;

            if(!currentPin || !newPin || !userName){
              setStatusBox(statusPwdUpdate, "T√ºm alanlarƒ± doldurun.", "error");
              return;
            }

            if(newPin === currentPin){
              setStatusBox(statusPwdUpdate, "Yeni ≈üifre eskisiyle aynƒ± olamaz.", "error");
              return;
            }

            if(!confirm(`${userName} kullanƒ±cƒ±sƒ±nƒ±n ≈üifresini deƒüi≈ütirmek istediƒüinizden emin misiniz?\n\nEski: ${currentPin}\nYeni: ${newPin}`)){
              return;
            }

            setStatusBox(statusPwdUpdate, "G√ºncelleniyor...", "");

            try {
              // JavaScript kodunda PIN'leri g√ºncelle (sayfa yenilenmeden √∂nce ge√ßerli olacak)
              let pinSet;
              if(selectedRole === "admin") pinSet = window.ADMIN_PINS;
              else if(selectedRole === "packer") pinSet = window.PACKER_PINS;
              else if(selectedRole === "stower") pinSet = window.STOWER_PINS;
              else if(selectedRole === "welder") pinSet = window.WELDER_PINS;
              else if(selectedRole === "laser") pinSet = window.LASER_PINS;
              else if(selectedRole === "purchase") pinSet = window.PURCHASE_PINS;
              else if(selectedRole === "painter") pinSet = window.PAINTER_PINS;
              else if(selectedRole === "commission") pinSet = window.COMMISSION_PINS;

              if(pinSet){
                pinSet.delete(currentPin);
                pinSet.add(newPin);
              }

              // ƒ∞sim g√ºncellemesi
              delete window.PIN_NAMES[currentPin];
              window.PIN_NAMES[newPin] = userName;

              // Firebase'e kaydet
              await setDoc(doc(db, "config", "pins"), {
                admin: Array.from(window.ADMIN_PINS),
                packer: Array.from(window.PACKER_PINS),
                stower: Array.from(window.STOWER_PINS),
                welder: Array.from(window.WELDER_PINS),
                laser: Array.from(window.LASER_PINS),
                purchase: Array.from(window.PURCHASE_PINS),
                painter: Array.from(window.PAINTER_PINS),
                commission: Array.from(window.COMMISSION_PINS),
                names: window.PIN_NAMES,
                updatedAt: serverTimestamp()
              });

              // Log kaydƒ±
              await addDoc(logsCol, {
                timestamp: new Date().toISOString(),
                action: "PASSWORD_UPDATE",
                pin: window.__SESSION?.pin || "admin",
                role: "admin",
                shelf: "-",
                product: "-",
                qty: 0,
                detail: `${selectedRole.toUpperCase()}: ${userName} (${currentPin} ‚Üí ${newPin})`
              });

              setStatusBox(statusPwdUpdate, "≈ûifre ba≈üarƒ±yla g√ºncellendi. Sayfa yenilenecek...", "ok");

              // 2 saniye sonra sayfayƒ± yenile
              setTimeout(() => {
                location.reload();
              }, 2000);

            } catch(e){
              console.error("≈ûifre g√ºncellenemedi:", e);
              setStatusBox(statusPwdUpdate, "Hata: " + e.message, "error");
            }
          });

          // Sayfa y√ºklendiƒüinde Firebase'den PIN'leri y√ºkle
          try {
            const pinsDoc = await getDoc(doc(db, "config", "pins"));
            if(pinsDoc.exists()){
              const data = pinsDoc.data();
              
              // Set'leri g√ºncelle
              if(data.admin) {
                window.ADMIN_PINS.clear();
                data.admin.forEach(pin => window.ADMIN_PINS.add(pin));
              }
              if(data.packer) {
                window.PACKER_PINS.clear();
                data.packer.forEach(pin => window.PACKER_PINS.add(pin));
              }
              if(data.stower) {
                window.STOWER_PINS.clear();
                data.stower.forEach(pin => window.STOWER_PINS.add(pin));
              }
              if(data.welder) {
                window.WELDER_PINS.clear();
                data.welder.forEach(pin => window.WELDER_PINS.add(pin));
              }
              if(data.laser) {
                window.LASER_PINS.clear();
                data.laser.forEach(pin => window.LASER_PINS.add(pin));
              }
              if(data.purchase) {
                window.PURCHASE_PINS.clear();
                data.purchase.forEach(pin => window.PURCHASE_PINS.add(pin));
              }
              if(data.painter) {
                window.PAINTER_PINS.clear();
                data.painter.forEach(pin => window.PAINTER_PINS.add(pin));
              }
              if(data.commission) {
                window.COMMISSION_PINS.clear();
                data.commission.forEach(pin => window.COMMISSION_PINS.add(pin));
              }
              
              // ƒ∞simleri g√ºncelle
              if(data.names){
                Object.keys(window.PIN_NAMES).forEach(key => delete window.PIN_NAMES[key]);
                Object.assign(window.PIN_NAMES, data.names);
              }
            }
          } catch(e){
            console.error("PIN'ler y√ºklenemedi:", e);
          }
        }

        setStatusBox(statusReqList, "Y√ºkleniyor...", "");
      }catch(e){
        setStatusBox(statusPut, "Firebase y√ºklenemedi: " + e.message, "error");
        setStatusBox(statusClear, "Firebase y√ºklenemedi: " + e.message, "error");
        setStatusBox(statusSearch, "Firebase y√ºklenemedi: " + e.message, "error");
        setStatusBox(statusReq, "Firebase y√ºklenemedi: " + e.message, "error");
        setStatusBox(statusReqList, "Firebase y√ºklenemedi: " + e.message, "error");
        setStatusBox(statusLogs, "Firebase y√ºklenemedi: " + e.message, "error");
      }
    };

    // ============================================
    // PUANTAJ Sƒ∞STEMƒ∞ FONKSƒ∞YONLARI
    // ============================================
    
    const WORK_START = "07:45"; // Mesai ba≈ülangƒ±√ß
    const WORK_END = "17:45";   // Mesai biti≈ü
    
    async function initAttendance() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      
      // Bug√ºn√ºn tarihini ba≈ülangƒ±√ß ve biti≈ü olarak ayarla
      const todayStr = `${yyyy}-${mm}-${dd}`;
      document.getElementById('attendanceStartDate').value = todayStr;
      document.getElementById('attendanceEndDate').value = todayStr;
      
      // Admin ise kullanƒ±cƒ± filtresi g√∂ster
      const currentRole = window.__SESSION?.role;
      const currentPin = window.__SESSION?.pin;
      
      if(currentRole === 'admin') {
        document.getElementById('attendanceUserFilterDiv').style.display = 'block';
        populateUserFilter();
      }
      
      // Supervisor ise y√∂nettiƒüi kullanƒ±cƒ±larƒ± g√∂ster
      const supervisedRoles = window.ATTENDANCE_SUPERVISORS?.[currentPin];
      if(supervisedRoles && supervisedRoles.length > 0) {
        const supervisorSelectBox = document.getElementById('supervisorUserSelectBox');
        const supervisorSelect = document.getElementById('supervisorUserSelect');
        
        supervisorSelectBox.style.display = 'block';
        
        // Y√∂netilen rollerdeki kullanƒ±cƒ±larƒ± listele
        supervisorSelect.innerHTML = '<option value="">Kendim</option>';
        
        supervisedRoles.forEach(role => {
          let pins = [];
          
          // Eƒüer rol deƒüil de direkt PIN ise (√∂rn: ≈ûeyma -> Evan)
          if(role.length === 5 && !isNaN(role)) {
            pins = [role];
          } else {
            // Rol bazlƒ±
            if(role === 'welder') pins = [...window.WELDER_PINS, ...window.LASER_PINS];
            else if(role === 'painter') pins = [...window.PAINTER_PINS];
            else if(role === 'packer') pins = [...window.PACKER_PINS];
            else if(role === 'stower') pins = [...window.STOWER_PINS];
            else if(role === 'purchase') pins = [...window.PURCHASE_PINS];
          }
          
          pins.forEach(pin => {
            if(pin !== currentPin) { // Kendisi hari√ß
              const name = window.PIN_NAMES?.[pin] || pin;
              // Rol etiketini belirle
              let roleLabel = '';
              if(window.WELDER_PINS.has(pin) || window.LASER_PINS.has(pin)) roleLabel = 'Kaynak√ßƒ±';
              else if(window.PAINTER_PINS.has(pin)) roleLabel = 'Boyacƒ±';
              else if(window.PACKER_PINS.has(pin)) roleLabel = 'Paket√ßi';
              else if(window.STOWER_PINS.has(pin)) roleLabel = 'Stok√ßu';
              else if(window.PURCHASE_PINS.has(pin)) roleLabel = 'Satƒ±n Alma';
              
              supervisorSelect.innerHTML += `<option value="${pin}">${name} (${roleLabel})</option>`;
            }
          });
        });
        
        // Kullanƒ±cƒ± deƒüi≈ütiƒüinde kaydƒ± y√ºkle
        supervisorSelect.addEventListener('change', loadTodayAttendance);
      }
      
      // Bug√ºnk√º kaydƒ± y√ºkle
      await loadTodayAttendance();
      
      // Event listener'lar
      document.getElementById('btnCheckIn').onclick = handleCheckIn;
      document.getElementById('btnCheckOut').onclick = handleCheckOut;
      document.getElementById('btnLoadAttendance').onclick = loadAttendanceRecords;
      
      // Konum ayarlarƒ± fonksiyonlarƒ±
      await loadWorkplaceLocation();
      setupLocationButtons();
    }
    
    function populateUserFilter() {
      const select = document.getElementById('attendanceUserFilter');
      const allUsers = [
        ...Array.from(window.ADMIN_PINS || []),
        ...Array.from(window.PACKER_PINS || []),
        ...Array.from(window.STOWER_PINS || []),
        ...Array.from(window.WELDER_PINS || []),
        ...Array.from(window.LASER_PINS || []),
        ...Array.from(window.PURCHASE_PINS || []),
        ...Array.from(window.PAINTER_PINS || [])
      ];
      
      select.innerHTML = '<option value="">T√ºm Kullanƒ±cƒ±lar</option>';
      allUsers.forEach(pin => {
        const name = window.PIN_NAMES?.[pin] || pin;
        select.innerHTML += `<option value="${pin}">${name}</option>`;
      });
    }
    
    async function loadTodayAttendance() {
      try {
        const currentPin = window.__SESSION?.pin;
        const supervisorSelect = document.getElementById('supervisorUserSelect');
        
        // Supervisor ise se√ßili kullanƒ±cƒ±nƒ±n kaydƒ±nƒ± y√ºkle
        let targetPin = currentPin;
        if(supervisorSelect && supervisorSelect.value) {
          targetPin = supervisorSelect.value;
        }
        
        const today = new Date().toISOString().split('T')[0];
        
        const attendanceCol = window.collection(window.db, 'attendance');
        const q = window.query(
          attendanceCol,
          window.where('pin', '==', targetPin),
          window.where('date', '==', today)
        );
        
        const snapshot = await window.getDocs(q);
        
        if (!snapshot.empty) {
          const data = snapshot.docs[0].data();
          window.currentAttendanceId = snapshot.docs[0].id;
          window.currentAttendanceData = data;
          updateAttendanceUI(data);
        } else {
          window.currentAttendanceId = null;
          window.currentAttendanceData = null;
          updateAttendanceUI(null);
        }
      } catch (e) {
        console.error('Bug√ºnk√º kayƒ±t y√ºklenirken hata:', e);
      }
    }
    
    function updateAttendanceUI(data) {
      const statusDiv = document.getElementById('currentStatus');
      const firstCheckInDiv = document.getElementById('firstCheckIn');
      const totalBreakDiv = document.getElementById('totalBreakTime');
      const timestampsDiv = document.getElementById('todayTimestamps');
      
      if (!data || !data.timestamps || data.timestamps.length === 0) {
        statusDiv.innerHTML = '<span style="color:#64748b;">Giri≈ü Bekleniyor</span>';
        firstCheckInDiv.textContent = '-';
        totalBreakDiv.textContent = '-';
        timestampsDiv.innerHTML = '';
        return;
      }
      
      const timestamps = data.timestamps || [];
      const lastTimestamp = timestamps[timestamps.length - 1];
      
      // Durum (i√ßeride mi dƒ±≈üarƒ±da mƒ±)
      if (lastTimestamp.type === 'in') {
        statusDiv.innerHTML = '<span style="color:#00c853;">ƒ∞√áERƒ∞DE</span>';
      } else {
        statusDiv.innerHTML = '<span style="color:#ef4444;">DI≈ûARIDA</span>';
      }
      
      // ƒ∞lk giri≈ü
      const firstIn = timestamps.find(t => t.type === 'in');
      firstCheckInDiv.textContent = firstIn ? firstIn.time : '-';
      
      // Toplam izin
      const breakMinutes = calculateTotalBreak(timestamps);
      totalBreakDiv.textContent = breakMinutes + ' dk';
      
      // Zaman damgalarƒ± listesi
      timestampsDiv.innerHTML = `
        <div style="background:white;border:1px solid var(--border);border-radius:8px;padding:12px;">
          <div style="font-size:11px;font-weight:900;color:var(--muted);margin-bottom:8px;">BUG√úNK√ú HAREKETLERƒ∞Nƒ∞Z</div>
          ${timestamps.map(t => `
            <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--panel2);">
              <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${t.type === 'in' ? '#00c853' : '#ef4444'};"></span>
              <span style="font-weight:700;">${t.time}</span>
              <span style="color:var(--muted);font-size:13px;">${t.type === 'in' ? 'Giri≈ü' : '√áƒ±kƒ±≈ü'}</span>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    // ƒ∞≈üyeri konumu (Koordinatlarƒ± buraya girin)
    const WORKPLACE_LOCATION = {
      lat: 41.0082,  // √ñrnek: ƒ∞stanbul koordinatƒ±
      lng: 28.9784,  // Bu koordinatlarƒ± ger√ßek i≈üyeri koordinatlarƒ±yla deƒüi≈ütirin
      maxDistance: 50 // metre
    };
    
    // ƒ∞ki koordinat arasƒ±ndaki mesafeyi hesapla (Haversine form√ºl√º)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // D√ºnya'nƒ±n yarƒ±√ßapƒ± (metre)
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

      const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

      return R * c; // Metre cinsinden mesafe
    }
    
    // Konum kontrol√º yap
    async function checkLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Tarayƒ±cƒ±nƒ±z konum servisi desteklemiyor.'));
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            const distance = calculateDistance(
              userLat,
              userLng,
              WORKPLACE_LOCATION.lat,
              WORKPLACE_LOCATION.lng
            );
            
            console.log(`Kullanƒ±cƒ± konumu: ${userLat}, ${userLng}`);
            console.log(`ƒ∞≈üyerine mesafe: ${Math.round(distance)} metre`);
            
            if (distance <= WORKPLACE_LOCATION.maxDistance) {
              resolve({ success: true, distance: Math.round(distance) });
            } else {
              resolve({ 
                success: false, 
                distance: Math.round(distance),
                message: `ƒ∞≈üyerine ${Math.round(distance)} metre uzaklƒ±ktasƒ±nƒ±z. Giri≈ü yapmak i√ßin ${WORKPLACE_LOCATION.maxDistance} metre yakƒ±nlƒ±kta olmalƒ±sƒ±nƒ±z.`
              });
            }
          },
          (error) => {
            let errorMessage = 'Konum alƒ±namadƒ±.';
            if (error.code === error.PERMISSION_DENIED) {
              errorMessage = 'Konum izni verilmedi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan konum iznini a√ßƒ±n.';
            } else if (error.code === error.POSITION_UNAVAILABLE) {
              errorMessage = 'Konum bilgisi alƒ±namƒ±yor.';
            } else if (error.code === error.TIMEOUT) {
              errorMessage = 'Konum alma zaman a≈üƒ±mƒ±na uƒüradƒ±.';
            }
            reject(new Error(errorMessage));
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      });
    }
    
    // Konum ayarlarƒ±nƒ± y√ºkle
    async function loadWorkplaceLocation() {
      try {
        const settingsDoc = await window.getDoc(window.doc(window.db, 'settings', 'workplace'));
        if (settingsDoc.exists()) {
          const data = settingsDoc.data();
          WORKPLACE_LOCATION.lat = data.lat || WORKPLACE_LOCATION.lat;
          WORKPLACE_LOCATION.lng = data.lng || WORKPLACE_LOCATION.lng;
          WORKPLACE_LOCATION.maxDistance = data.maxDistance || WORKPLACE_LOCATION.maxDistance;
          
          // Input alanlarƒ±nƒ± doldur
          const latInput = document.getElementById('workplaceLat');
          const lngInput = document.getElementById('workplaceLng');
          const distInput = document.getElementById('workplaceMaxDistance');
          
          if(latInput) latInput.value = data.lat || '';
          if(lngInput) lngInput.value = data.lng || '';
          if(distInput) distInput.value = data.maxDistance || 50;
          
          console.log('ƒ∞≈üyeri konumu y√ºklendi:', WORKPLACE_LOCATION);
        }
      } catch (error) {
        console.error('Konum ayarlarƒ± y√ºklenirken hata:', error);
      }
    }
    
    // Konum butonlarƒ±nƒ± ayarla
    function setupLocationButtons() {
      const btnSave = document.getElementById('btnSaveWorkplaceLocation');
      const btnGetCurrent = document.getElementById('btnGetCurrentLocation');
      const btnParseMapsLink = document.getElementById('btnParseMapsLink');
      
      // Google Maps linkinden koordinat √ßƒ±kar
      if(btnParseMapsLink) {
        btnParseMapsLink.onclick = async () => {
          const statusDiv = document.getElementById('statusWorkplaceLocation');
          const mapsLinkInput = document.getElementById('workplaceMapsLink');
          const latInput = document.getElementById('workplaceLat');
          const lngInput = document.getElementById('workplaceLng');
          
          let link = mapsLinkInput.value.trim();
          
          if(!link) {
            setStatusBox(statusDiv, 'L√ºtfen Google Maps linkini yapƒ±≈ütƒ±rƒ±n!', 'error');
            return;
          }
          
          setStatusBox(statusDiv, 'üîç Link analiz ediliyor...', '');
          
          try {
            // Kƒ±sa linkler i√ßin (maps.app.goo.gl) - y√∂nlendirmeyi takip et
            if(link.includes('maps.app.goo.gl') || link.includes('goo.gl')) {
              try {
                setStatusBox(statusDiv, 'üîó Kƒ±sa link geni≈ületiliyor...', '');
                const response = await fetch(link, { 
                  method: 'HEAD',
                  redirect: 'follow'
                });
                link = response.url;
                console.log('Geni≈ületilmi≈ü link:', link);
              } catch (e) {
                // CORS hatasƒ± olabilir, tarayƒ±cƒ±da a√ß
                setStatusBox(statusDiv, '‚ö†Ô∏è Kƒ±sa link otomatik a√ßƒ±lamadƒ±. Tarayƒ±cƒ±da a√ßƒ±lƒ±yor...', '');
                const newWindow = window.open(link, '_blank');
                setTimeout(() => {
                  setStatusBox(statusDiv, 'üìã L√ºtfen a√ßƒ±lan sayfadaki UZUN linki kopyalayƒ±p buraya yapƒ±≈ütƒ±rƒ±n.', 'warn');
                }, 2000);
                return;
              }
            }
            
            let lat = null;
            let lng = null;
            
            // Farklƒ± Google Maps link formatlarƒ±nƒ± dene
            // Format 1: @LAT,LNG,15z gibi
            let match = link.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
            if(match) {
              lat = parseFloat(match[1]);
              lng = parseFloat(match[2]);
            }
            
            // Format 2: ?q=LAT,LNG gibi
            if(!lat || !lng) {
              match = link.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/);
              if(match) {
                lat = parseFloat(match[1]);
                lng = parseFloat(match[2]);
              }
            }
            
            // Format 3: place/ sonrasƒ± LAT,LNG
            if(!lat || !lng) {
              match = link.match(/place\/[^@]*@(-?\d+\.\d+),(-?\d+\.\d+)/);
              if(match) {
                lat = parseFloat(match[1]);
                lng = parseFloat(match[2]);
              }
            }
            
            // Format 4: /maps/ ile ba≈ülayan ve @ i√ßeren
            if(!lat || !lng) {
              match = link.match(/\/maps\/.*@(-?\d+\.\d+),(-?\d+\.\d+)/);
              if(match) {
                lat = parseFloat(match[1]);
                lng = parseFloat(match[2]);
              }
            }
            
            if(lat && lng && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
              latInput.value = lat.toFixed(6);
              lngInput.value = lng.toFixed(6);
              setStatusBox(statusDiv, `‚úÖ Koordinatlar bulundu: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'ok');
            } else {
              setStatusBox(statusDiv, '‚ùå Linkten koordinat √ßƒ±karƒ±lamadƒ±. L√ºtfen linki tarayƒ±cƒ±da a√ßƒ±p adres √ßubuƒüundaki UZUN linki kopyalayƒ±n.', 'error');
            }
          } catch (error) {
            console.error('Link parse hatasƒ±:', error);
            setStatusBox(statusDiv, '‚ùå Link i≈ülenirken hata olu≈ütu: ' + error.message, 'error');
          }
        };
      }
      
      if(btnSave) {
        btnSave.onclick = async () => {
          const statusDiv = document.getElementById('statusWorkplaceLocation');
          const latInput = document.getElementById('workplaceLat');
          const lngInput = document.getElementById('workplaceLng');
          const distInput = document.getElementById('workplaceMaxDistance');
          
          const lat = parseFloat(latInput.value);
          const lng = parseFloat(lngInput.value);
          const maxDistance = parseInt(distInput.value);
          
          if(isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
            setStatusBox(statusDiv, 'Ge√ßersiz koordinatlar! L√ºtfen doƒüru deƒüerler girin.', 'error');
            return;
          }
          
          if(isNaN(maxDistance) || maxDistance < 10 || maxDistance > 500) {
            setStatusBox(statusDiv, 'Mesafe 10-500 metre arasƒ±nda olmalƒ±!', 'error');
            return;
          }
          
          try {
            setStatusBox(statusDiv, 'Kaydediliyor...', '');
            
            await window.setDoc(
              window.doc(window.db, 'settings', 'workplace'),
              {
                lat: lat,
                lng: lng,
                maxDistance: maxDistance,
                updatedAt: window.serverTimestamp(),
                updatedBy: window.__SESSION?.pin || 'unknown'
              },
              { merge: true }
            );
            
            // Global deƒüi≈ükeni g√ºncelle
            WORKPLACE_LOCATION.lat = lat;
            WORKPLACE_LOCATION.lng = lng;
            WORKPLACE_LOCATION.maxDistance = maxDistance;
            
            setStatusBox(statusDiv, `‚úÖ Konum kaydedildi! (${lat.toFixed(6)}, ${lng.toFixed(6)} - ${maxDistance}m)`, 'ok');
          } catch (error) {
            console.error('Konum kaydetme hatasƒ±:', error);
            setStatusBox(statusDiv, '‚ùå Hata: ' + error.message, 'error');
          }
        };
      }
      
      if(btnGetCurrent) {
        btnGetCurrent.onclick = async () => {
          const statusDiv = document.getElementById('statusWorkplaceLocation');
          const latInput = document.getElementById('workplaceLat');
          const lngInput = document.getElementById('workplaceLng');
          
          setStatusBox(statusDiv, 'üìç Mevcut konumunuz alƒ±nƒ±yor...', '');
          
          try {
            const position = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
              });
            });
            
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            latInput.value = lat.toFixed(6);
            lngInput.value = lng.toFixed(6);
            
            setStatusBox(statusDiv, `‚úÖ Konum alƒ±ndƒ±: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'ok');
          } catch (error) {
            let errorMessage = 'Konum alƒ±namadƒ±.';
            if (error.code === error.PERMISSION_DENIED) {
              errorMessage = 'Konum izni verilmedi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan konum iznini a√ßƒ±n.';
            }
            setStatusBox(statusDiv, '‚ùå ' + errorMessage, 'error');
          }
        };
      }
    }
    
    async function handleCheckIn() {
      const statusBox = document.getElementById('statusAttendance');
      const currentPin = window.__SESSION?.pin;
      const currentRole = window.__SESSION?.role;
      const supervisorSelect = document.getElementById('supervisorUserSelect');
      
      /* Konum kontrol√º - ≈ûimdilik deaktif
      if(!supervisorSelect || !supervisorSelect.value) {
        try {
          setStatusBox(statusBox, 'üìç Konumunuz kontrol ediliyor...', '');
          const locationCheck = await checkLocation();
          
          if (!locationCheck.success) {
            setStatusBox(statusBox, `‚ùå ${locationCheck.message}`, 'error');
            return;
          }
          
          console.log(`‚úÖ Konum kontrol√º ba≈üarƒ±lƒ±: ${locationCheck.distance} metre`);
        } catch (error) {
          setStatusBox(statusBox, `‚ùå ${error.message}`, 'error');
          return;
        }
      }
      */
      
      // Hedef kullanƒ±cƒ±yƒ± belirle (supervisor ise se√ßili kullanƒ±cƒ±, deƒüilse kendisi)
      let targetPin = currentPin;
      let targetUserName = window.PIN_NAMES?.[currentPin] || currentPin;
      let targetRole = currentRole;
      
      if(supervisorSelect && supervisorSelect.value) {
        targetPin = supervisorSelect.value;
        targetUserName = window.PIN_NAMES?.[targetPin] || targetPin;
        // Hedef kullanƒ±cƒ±nƒ±n rol√ºn√º bul
        if(window.WELDER_PINS.has(targetPin) || window.LASER_PINS.has(targetPin)) targetRole = 'welder';
        else if(window.PAINTER_PINS.has(targetPin)) targetRole = 'painter';
        else if(window.PACKER_PINS.has(targetPin)) targetRole = 'packer';
        else if(window.STOWER_PINS.has(targetPin)) targetRole = 'stower';
        else if(window.PURCHASE_PINS.has(targetPin)) targetRole = 'purchase';
      }
      
      try {
        setStatusBox(statusBox, `${targetUserName} i√ßin giri≈ü kaydediliyor...`, '');
        
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const currentTime = now.toTimeString().slice(0, 5); // HH:MM
        
        const attendanceCol = window.collection(window.db, 'attendance');
        
        // Bug√ºnk√º kaydƒ± kontrol et
        const q = window.query(
          attendanceCol,
          window.where('pin', '==', targetPin),
          window.where('date', '==', today)
        );
        
        const snapshot = await window.getDocs(q);
        
        const timestamp = {
          type: 'in',
          time: currentTime,
          timestamp: now.toISOString()
        };
        
        if (!snapshot.empty) {
          // Mevcut kayda ekle
          const docId = snapshot.docs[0].id;
          const data = snapshot.docs[0].data();
          const timestamps = data.timestamps || [];
          
          // Son kayƒ±t giri≈ü ise yeni giri≈ü yapƒ±lmasƒ±n
          if (timestamps.length > 0 && timestamps[timestamps.length - 1].type === 'in') {
            setStatusBox(statusBox, 'Zaten i√ßeride! √ñnce √ßƒ±kƒ±≈ü yapmalƒ±.', 'error');
            return;
          }
          
          timestamps.push(timestamp);
          
          await window.updateDoc(window.doc(window.db, 'attendance', docId), {
            timestamps: timestamps,
            lastUpdate: window.serverTimestamp()
          });
          
          setStatusBox(statusBox, `${targetUserName} i√ßin giri≈ü kaydedildi: ${currentTime}`, 'ok');
        } else {
          // Yeni kayƒ±t olu≈ütur
          await window.addDoc(attendanceCol, {
            pin: targetPin,
            userName: targetUserName,
            role: targetRole,
            date: today,
            timestamps: [timestamp],
            lastUpdate: window.serverTimestamp()
          });
          
          setStatusBox(statusBox, `${targetUserName} i√ßin giri≈ü kaydedildi: ${currentTime}`, 'ok');
        }
        
        // Admin kullanƒ±cƒ±larƒ±na bildirim g√∂nder
        await sendAttendanceNotification(targetPin, targetUserName, 'in', currentTime);
        
        await loadTodayAttendance();
        
      } catch (e) {
        console.error('Giri≈ü hatasƒ±:', e);
        setStatusBox(statusBox, 'Hata: ' + e.message, 'error');
      }
    }
    
    async function handleCheckOut() {
      const statusBox = document.getElementById('statusAttendance');
      const currentPin = window.__SESSION?.pin;
      const currentRole = window.__SESSION?.role;
      const supervisorSelect = document.getElementById('supervisorUserSelect');
      
      /* Konum kontrol√º - ≈ûimdilik deaktif
      if(!supervisorSelect || !supervisorSelect.value) {
        try {
          setStatusBox(statusBox, 'üìç Konumunuz kontrol ediliyor...', '');
          const locationCheck = await checkLocation();
          
          if (!locationCheck.success) {
            setStatusBox(statusBox, `‚ùå ${locationCheck.message}`, 'error');
            return;
          }
          
          console.log(`‚úÖ Konum kontrol√º ba≈üarƒ±lƒ±: ${locationCheck.distance} metre`);
        } catch (error) {
          setStatusBox(statusBox, `‚ùå ${error.message}`, 'error');
          return;
        }
      }
      */
      
      // Hedef kullanƒ±cƒ±yƒ± belirle
      let targetPin = currentPin;
      let targetUserName = window.PIN_NAMES?.[currentPin] || currentPin;
      let targetRole = currentRole;
      
      if(supervisorSelect && supervisorSelect.value) {
        targetPin = supervisorSelect.value;
        targetUserName = window.PIN_NAMES?.[targetPin] || targetPin;
        // Hedef kullanƒ±cƒ±nƒ±n rol√ºn√º bul
        if(window.WELDER_PINS.has(targetPin) || window.LASER_PINS.has(targetPin)) targetRole = 'welder';
        else if(window.PAINTER_PINS.has(targetPin)) targetRole = 'painter';
        else if(window.PACKER_PINS.has(targetPin)) targetRole = 'packer';
        else if(window.STOWER_PINS.has(targetPin)) targetRole = 'stower';
        else if(window.PURCHASE_PINS.has(targetPin)) targetRole = 'purchase';
      }
      
      try {
        setStatusBox(statusBox, `${targetUserName} i√ßin √ßƒ±kƒ±≈ü kaydediliyor...`, '');
        
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const currentTime = now.toTimeString().slice(0, 5); // HH:MM
        
        const attendanceCol = window.collection(window.db, 'attendance');
        
        // Bug√ºnk√º kaydƒ± kontrol et
        const q = window.query(
          attendanceCol,
          window.where('pin', '==', targetPin),
          window.where('date', '==', today)
        );
        
        const snapshot = await window.getDocs(q);
        
        if (snapshot.empty) {
          setStatusBox(statusBox, '√ñnce giri≈ü yapmalƒ±!', 'error');
          return;
        }
        
        const docId = snapshot.docs[0].id;
        const data = snapshot.docs[0].data();
        const timestamps = data.timestamps || [];
        
        // Son kayƒ±t √ßƒ±kƒ±≈ü ise yeni √ßƒ±kƒ±≈ü yapƒ±lmasƒ±n
        if (timestamps.length > 0 && timestamps[timestamps.length - 1].type === 'out') {
          setStatusBox(statusBox, 'Zaten dƒ±≈üarƒ±da! √ñnce giri≈ü yapmalƒ±.', 'error');
          return;
        }
        
        const timestamp = {
          type: 'out',
          time: currentTime,
          timestamp: now.toISOString()
        };
        
        timestamps.push(timestamp);
        
        await window.updateDoc(window.doc(window.db, 'attendance', docId), {
          timestamps: timestamps,
          lastUpdate: window.serverTimestamp()
        });
        
        setStatusBox(statusBox, `${targetUserName} i√ßin √ßƒ±kƒ±≈ü kaydedildi: ${currentTime}`, 'ok');
        
        // Admin kullanƒ±cƒ±larƒ±na bildirim g√∂nder
        await sendAttendanceNotification(targetPin, targetUserName, 'out', currentTime);
        
        await loadTodayAttendance();
        
      } catch (e) {
        console.error('√áƒ±kƒ±≈ü hatasƒ±:', e);
        setStatusBox(statusBox, 'Hata: ' + e.message, 'error');
      }
    }
    
    function calculateTotalBreak(timestamps) {
      if (!timestamps || timestamps.length === 0) return 0;
      
      const workStartMinutes = timeToMinutes(WORK_START); // 465 (07:45)
      const workEndMinutes = timeToMinutes(WORK_END);     // 1065 (17:45)
      
      let totalBreak = 0;
      let firstIn = null;
      
      // ƒ∞lk giri≈üi bul
      for (let i = 0; i < timestamps.length; i++) {
        if (timestamps[i].type === 'in') {
          firstIn = timestamps[i].time;
          break;
        }
      }
      
      // Ge√ß gelme (ilk giri≈ü mesai ba≈ülangƒ±cƒ±ndan sonraysa)
      if (firstIn) {
        const firstInMinutes = timeToMinutes(firstIn);
        if (firstInMinutes > workStartMinutes) {
          totalBreak += firstInMinutes - workStartMinutes;
        }
      }
      
      // G√ºn i√ßi √ßƒ±kƒ±≈ü-giri≈ü aralarƒ± (izin)
      for (let i = 0; i < timestamps.length - 1; i++) {
        if (timestamps[i].type === 'out' && timestamps[i + 1].type === 'in') {
          const outMinutes = timeToMinutes(timestamps[i].time);
          const inMinutes = timeToMinutes(timestamps[i + 1].time);
          totalBreak += inMinutes - outMinutes;
        }
      }
      
      // Erken √ßƒ±kƒ±≈ü - SADECE son kayƒ±t "out" ise hesapla
      const lastTimestamp = timestamps[timestamps.length - 1];
      if (lastTimestamp && lastTimestamp.type === 'out') {
        const lastOutMinutes = timeToMinutes(lastTimestamp.time);
        if (lastOutMinutes < workEndMinutes) {
          totalBreak += workEndMinutes - lastOutMinutes;
        }
      }
      
      return totalBreak;
    }
    
    function timeToMinutes(timeStr) {
      const [h, m] = timeStr.split(':').map(Number);
      return h * 60 + m;
    }
    
    function minutesToTime(minutes) {
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }
    
    async function loadAttendanceRecords() {
      try {
        const currentPin = window.__SESSION?.pin;
        const currentRole = window.__SESSION?.role;
        const startDate = document.getElementById('attendanceStartDate').value;
        const endDate = document.getElementById('attendanceEndDate').value;
        const userFilter = document.getElementById('attendanceUserFilter')?.value || '';
        
        if (!startDate || !endDate) {
          alert('Ba≈ülangƒ±√ß ve biti≈ü tarihlerini se√ßin.');
          return;
        }
        
        const attendanceCol = window.collection(window.db, 'attendance');
        let q;
        
        if (currentRole === 'admin' && userFilter) {
          // Admin - belirli kullanƒ±cƒ±
          q = window.query(
            attendanceCol,
            window.where('pin', '==', userFilter),
            window.where('date', '>=', startDate),
            window.where('date', '<=', endDate)
          );
        } else if (currentRole === 'admin') {
          // Admin - t√ºm kullanƒ±cƒ±lar
          q = window.query(
            attendanceCol,
            window.where('date', '>=', startDate),
            window.where('date', '<=', endDate)
          );
        } else {
          // Normal kullanƒ±cƒ± - sadece kendi kayƒ±tlarƒ±
          q = window.query(
            attendanceCol,
            window.where('pin', '==', currentPin),
            window.where('date', '>=', startDate),
            window.where('date', '<=', endDate)
          );
        }
        
        const snapshot = await window.getDocs(q);
        const records = [];
        
        snapshot.forEach(doc => {
          records.push({ id: doc.id, ...doc.data() });
        });
        
        // JavaScript'te tarihe g√∂re sƒ±rala (yeniden eskiye)
        records.sort((a, b) => b.date.localeCompare(a.date));
        
        renderAttendanceTable(records);
        calculateAttendanceStats(records);
        
      } catch (e) {
        console.error('Kayƒ±tlar y√ºklenirken hata:', e);
        alert('Hata: ' + e.message);
      }
    }
    
    function renderAttendanceTable(records) {
      const tbody = document.getElementById('attendanceTableBody');
      const tableWrap = document.getElementById('attendanceTableWrap');
      
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:24px;color:var(--muted);">Kayƒ±t bulunamadƒ±.</td></tr>';
        tableWrap.style.display = 'block';
        return;
      }
      
      const currentRole = window.__SESSION?.role;
      const currentPin = window.__SESSION?.pin;
      
      tbody.innerHTML = records.map(rec => {
        const timestamps = rec.timestamps || [];
        const firstIn = timestamps.find(t => t.type === 'in');
        const lastOut = timestamps.filter(t => t.type === 'out').pop();
        const breakMinutes = calculateTotalBreak(timestamps);
        const workHours = calculateWorkHours(timestamps, breakMinutes);
        const canDelete = currentRole === 'admin' || rec.pin === currentPin;
        const isAdmin = currentRole === 'admin';
        
        return `
          <tr>
            <td>${formatDate(rec.date)}</td>
            <td>${rec.userName || rec.pin}</td>
            <td>${firstIn ? firstIn.time : '-'}</td>
            <td>${lastOut ? lastOut.time : (timestamps.length > 0 && timestamps[timestamps.length - 1].type === 'in' ? 'ƒ∞√ßeride' : '-')}</td>
            <td style="font-weight:700;color:${workHours > 0 ? '#065f46' : 'var(--muted)'};">${workHours > 0 ? workHours.toFixed(2) + ' saat' : '-'}</td>
            <td style="color:#d97706;font-weight:700;">${breakMinutes} dk</td>
            <td style="font-size:11px;">${timestamps.map(t => t.time + ' ' + (t.type === 'in' ? '‚Üì' : '‚Üë')).join(', ')}</td>
            <td style="white-space:nowrap;">
              ${isAdmin ? `<button onclick="showAttendanceDetail('${rec.id}')" style="background:#2196f3;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:700;margin-right:4px;">DETAY</button>` : ''}
              ${canDelete ? `<button onclick="deleteAttendance('${rec.id}')" style="background:#ef4444;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:700;">Sƒ∞L</button>` : '-'}
            </td>
          </tr>
        `;
      }).join('');
      
      tableWrap.style.display = 'block';
    }
    
    function calculateWorkHours(timestamps, breakMinutes) {
      if (!timestamps || timestamps.length === 0) return 0;
      
      const workStartMinutes = timeToMinutes(WORK_START);
      const workEndMinutes = timeToMinutes(WORK_END);
      const totalWorkMinutes = workEndMinutes - workStartMinutes; // 600 dakika (10 saat)
      
      // Toplam √ßalƒ±≈üma s√ºresi = Standart mesai - ƒ∞zin s√ºresi
      const actualWorkMinutes = totalWorkMinutes - breakMinutes;
      
      return actualWorkMinutes / 60;
    }
    
    function calculateAttendanceStats(records) {
      const statsDiv = document.getElementById('attendanceStats');
      
      if (records.length === 0) {
        statsDiv.style.display = 'none';
        return;
      }
      
      let totalDays = records.length;
      let totalHours = 0;
      let totalBreak = 0;
      
      records.forEach(rec => {
        const timestamps = rec.timestamps || [];
        if (timestamps.length > 0) {
          const breakMinutes = calculateTotalBreak(timestamps);
          const workHours = calculateWorkHours(timestamps, breakMinutes);
          totalHours += workHours;
          totalBreak += breakMinutes;
        }
      });
      
      const avgHours = totalDays > 0 ? totalHours / totalDays : 0;
      
      document.getElementById('statTotalDays').textContent = totalDays;
      document.getElementById('statTotalHours').textContent = totalHours.toFixed(2);
      document.getElementById('statAvgHours').textContent = avgHours.toFixed(2);
      document.getElementById('statTotalBreak').textContent = totalBreak;
      
      statsDiv.style.display = 'block';
    }
    
    window.deleteAttendance = async function(recordId) {
      if (!confirm('Bu kaydƒ± silmek istediƒüinizden emin misiniz?')) return;
      
      try {
        await window.deleteDoc(window.doc(window.db, 'attendance', recordId));
        await loadAttendanceRecords();
        await loadTodayAttendance();
        alert('Kayƒ±t silindi.');
      } catch (e) {
        console.error('Silme hatasƒ±:', e);
        alert('Hata: ' + e.message);
      }
    };
    
    function formatDate(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return `${d}.${m}.${y}`;
    }
    
    // ============================================
    // ATTENDANCE DETAIL MODAL
    // ============================================
    
    let currentEditingRecord = null;
    
    window.showAttendanceDetail = async function(recordId) {
      try {
        const docRef = window.doc(window.db, 'attendance', recordId);
        const docSnap = await window.getDoc(docRef);
        
        if (!docSnap.exists()) {
          alert('Kayƒ±t bulunamadƒ±.');
          return;
        }
        
        const data = docSnap.data();
        currentEditingRecord = { id: recordId, ...data };
        
        const modal = document.getElementById('attendanceDetailModal');
        const title = document.getElementById('attendanceDetailTitle');
        const content = document.getElementById('attendanceDetailContent');
        
        title.textContent = `${data.userName || data.pin} - ${formatDate(data.date)} Mesai Detayƒ±`;
        
        renderTimestampEditor(data.timestamps || []);
        
        modal.classList.add('active');
      } catch (e) {
        console.error('Detay y√ºkleme hatasƒ±:', e);
        alert('Hata: ' + e.message);
      }
    };
    
    function renderTimestampEditor(timestamps) {
      const content = document.getElementById('attendanceDetailContent');
      
      let html = '<div style="max-height:400px;overflow-y:auto;">';
      
      timestamps.forEach((ts, index) => {
        html += `
          <div style="display:grid;grid-template-columns:80px 1fr 120px 40px;gap:12px;align-items:center;padding:12px;background:var(--panel2);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;">
            <select data-index="${index}" data-field="type" class="input" style="margin:0;padding:8px;">
              <option value="in" ${ts.type === 'in' ? 'selected' : ''}>Giri≈ü</option>
              <option value="out" ${ts.type === 'out' ? 'selected' : ''}>√áƒ±kƒ±≈ü</option>
            </select>
            <input type="time" value="${ts.time}" data-index="${index}" data-field="time" class="input" style="margin:0;padding:8px;" />
            <span style="font-size:12px;color:var(--muted);">${new Date(ts.timestamp).toLocaleTimeString('tr-TR')}</span>
            <button onclick="removeTimestamp(${index})" style="background:#ef4444;color:#fff;border:none;width:32px;height:32px;border-radius:6px;cursor:pointer;font-size:16px;font-weight:700;">√ó</button>
          </div>
        `;
      });
      
      html += '</div>';
      
      content.innerHTML = html;
      
      // Event listener'lar ekle
      content.querySelectorAll('select, input').forEach(el => {
        el.addEventListener('change', handleTimestampChange);
      });
    }
    
    function handleTimestampChange(e) {
      const index = parseInt(e.target.dataset.index);
      const field = e.target.dataset.field;
      const value = e.target.value;
      
      if (!currentEditingRecord || !currentEditingRecord.timestamps) return;
      
      if (field === 'type') {
        currentEditingRecord.timestamps[index].type = value;
      } else if (field === 'time') {
        currentEditingRecord.timestamps[index].time = value;
        // Timestamp'i g√ºncelle
        const date = currentEditingRecord.date;
        currentEditingRecord.timestamps[index].timestamp = `${date}T${value}:00.000Z`;
      }
    }
    
    window.removeTimestamp = function(index) {
      if (!currentEditingRecord || !currentEditingRecord.timestamps) return;
      
      if (confirm('Bu giri≈ü/√ßƒ±kƒ±≈ü kaydƒ±nƒ± silmek istediƒüinizden emin misiniz?')) {
        currentEditingRecord.timestamps.splice(index, 1);
        renderTimestampEditor(currentEditingRecord.timestamps);
      }
    };
    
    document.getElementById('btnAddTimestamp')?.addEventListener('click', () => {
      if (!currentEditingRecord) return;
      
      const now = new Date();
      const currentTime = now.toTimeString().slice(0, 5);
      
      const newTimestamp = {
        type: 'in',
        time: currentTime,
        timestamp: now.toISOString()
      };
      
      if (!currentEditingRecord.timestamps) {
        currentEditingRecord.timestamps = [];
      }
      
      currentEditingRecord.timestamps.push(newTimestamp);
      renderTimestampEditor(currentEditingRecord.timestamps);
    });
    
    document.getElementById('btnSaveAttendanceDetail')?.addEventListener('click', async () => {
      if (!currentEditingRecord) return;
      
      try {
        const docRef = window.doc(window.db, 'attendance', currentEditingRecord.id);
        
        await window.updateDoc(docRef, {
          timestamps: currentEditingRecord.timestamps,
          lastUpdate: window.serverTimestamp()
        });
        
        alert('Deƒüi≈üiklikler kaydedildi!');
        document.getElementById('attendanceDetailModal').classList.remove('active');
        
        // Listeyi yenile
        await loadAttendanceRecords();
        
      } catch (e) {
        console.error('Kaydetme hatasƒ±:', e);
        alert('Hata: ' + e.message);
      }
    });
    
    document.getElementById('btnCloseAttendanceDetail')?.addEventListener('click', () => {
      document.getElementById('attendanceDetailModal').classList.remove('active');
      currentEditingRecord = null;
    });
    
    // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapat
    document.getElementById('attendanceDetailModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'attendanceDetailModal') {
        e.target.classList.remove('active');
        currentEditingRecord = null;
      }
    });
    
    // ========== TELEGRAM NOTIFICATION SYSTEM ==========
    
    // Telegram bildirim sistemi - Browser bildirimlerin yerine
    async function requestNotificationPermission() {
      console.log('Bildirim sistemi: Telegram kullanƒ±lƒ±yor');
      
      // Kullanƒ±cƒ±nƒ±n Telegram chat ID'si var mƒ± kontrol et
      const role = window.__SESSION?.role;
      const pin = window.__SESSION?.pin;
      
      if (!role || !pin) {
        console.error('Oturum bilgisi bulunamadƒ±');
        return false;
      }
      
      // Firestore'dan kullanƒ±cƒ±nƒ±n Telegram chat ID'sini kontrol et
      try {
        const userDoc = await window.getDoc(window.doc(window.db, 'telegramUsers', pin));
        if (userDoc.exists() && userDoc.data().chatId) {
          console.log('Telegram chat ID mevcut:', userDoc.data().chatId);
          return true;
        } else {
          console.log('Telegram chat ID kayƒ±tlƒ± deƒüil');
          showTelegramSetupPrompt();
          return false;
        }
      } catch (error) {
        console.error('Telegram kontrol hatasƒ±:', error);
        return false;
      }
    }
    
    // Telegram kurulum prompt'unu g√∂ster
    function showTelegramSetupPrompt() {
      const setupDiv = document.getElementById('telegramSetupPrompt');
      if (setupDiv) {
        setupDiv.style.display = 'block';
      }
    }
    
    // Telegram Chat ID kaydet
    async function saveTelegramChatId(chatId) {
      try {
        const role = window.__SESSION?.role;
        const pin = window.__SESSION?.pin;
        const name = window.PIN_NAMES[pin] || pin;
        
        if (!role || !pin) {
          console.error('Oturum bilgisi eksik');
          return false;
        }
        
        await window.setDoc(window.doc(window.db, 'telegramUsers', pin), {
          chatId: chatId,
          role: role,
          pin: pin,
          name: name,
          updatedAt: new Date().toISOString()
        }, { merge: true });
        
        console.log('Telegram Chat ID kaydedildi:', chatId);
        return true;
      } catch (error) {
        console.error('Chat ID kaydetme hatasƒ±:', error);
        return false;
      }
    }
    
    window.saveTelegramChatId = saveTelegramChatId;
    
    // Bot Token kaydet (Admin)
    window.saveBotToken = async function() {
      const token = document.getElementById('telegramBotToken').value.trim();
      const statusDiv = document.getElementById('telegramSetupStatus');
      
      if (!token) {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '‚ùå L√ºtfen bot token girin!';
        return;
      }
      
      try {
        await window.setDoc(window.doc(window.db, 'config', 'telegram'), {
          botToken: token,
          updatedAt: new Date().toISOString(),
          updatedBy: window.__SESSION?.pin
        });
        
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '‚úÖ Bot token kaydedildi! ≈ûimdi botunuza mesaj g√∂nderin ve "Chat ID Al" butonuna basƒ±n.';
        statusDiv.style.background = 'rgba(76, 175, 80, 0.1)';
        
      } catch (error) {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '‚ùå Hata: ' + error.message;
        statusDiv.style.background = 'rgba(244, 67, 54, 0.1)';
      }
    };
    
    // Chat ID al (kullanƒ±cƒ±)
    window.getTelegramChatId = async function() {
      const statusDiv = document.getElementById('telegramSetupStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '‚è≥ Chat ID alƒ±nƒ±yor...';
      
      try {
        // Bot token'ƒ± config'den al
        const configDoc = await window.getDoc(window.doc(window.db, 'config', 'telegram'));
        if (!configDoc.exists()) {
          statusDiv.innerHTML = '‚ùå Bot token hen√ºz kaydedilmemi≈ü! √ñnce admin bot token kaydetmeli.';
          statusDiv.style.background = 'rgba(244, 67, 54, 0.1)';
          return;
        }
        
        const botToken = configDoc.data().botToken;
        
        // Telegram API'den updates al
        const response = await fetch(`https://api.telegram.org/bot${botToken}/getUpdates`);
        const data = await response.json();
        
        if (!data.ok) {
          throw new Error('Telegram API hatasƒ±: ' + data.description);
        }
        
        if (data.result.length === 0) {
          statusDiv.innerHTML = '‚ùå Hen√ºz mesaj alƒ±nmamƒ±≈ü! L√ºtfen botunuza Telegram\'dan bir mesaj g√∂nderin.';
          statusDiv.style.background = 'rgba(255, 152, 0, 0.1)';
          return;
        }
        
        // Son mesajƒ±n chat ID'sini al
        const lastMessage = data.result[data.result.length - 1];
        const chatId = lastMessage.message.chat.id;
        const username = lastMessage.message.from.username || lastMessage.message.from.first_name;
        
        // Chat ID'yi kaydet
        const saved = await saveTelegramChatId(chatId);
        
        if (saved) {
          statusDiv.innerHTML = `‚úÖ Chat ID kaydedildi!<br><br>` +
            `üë§ Kullanƒ±cƒ±: ${username}<br>` +
            `üÜî Chat ID: ${chatId}<br>` +
            `üì± Artƒ±k Telegram bildirimleriniz aktif!`;
          statusDiv.style.background = 'rgba(76, 175, 80, 0.1)';
        }
        
      } catch (error) {
        console.error('Chat ID alma hatasƒ±:', error);
        statusDiv.innerHTML = '‚ùå Hata: ' + error.message;
        statusDiv.style.background = 'rgba(244, 67, 54, 0.1)';
      }
    };
    
    // Browser notification (opsiyonel - Telegram'a ek olarak)
    function showBrowserNotification(title, body) {
      if (!('Notification' in window) || Notification.permission !== 'granted') {
        console.log('Browser notification izni yok');
        return;
      }
      
      try {
        new Notification(title, {
          body: body,
          icon: '/icon-192.png',
          badge: '/icon-192.png',
          tag: 'depo-notification-' + Date.now(),
          requireInteraction: false
        });
        
        notification.onclick = function() {
          window.focus();
          notification.close();
        };
        
        console.log('Browser notification g√∂sterildi');
      } catch (error) {
        console.error('Browser notification hatasƒ±:', error);
      }
    }
    
    function listenForAttendanceNotifications() {
      console.log('Bildirim dinleyici ba≈ülatƒ±ldƒ±');
      
      const notificationsCol = window.collection(window.db, 'attendanceNotifications');
      const now = new Date();
      const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);
      
      // Son 5 dakikadaki bildirimleri dinle
      const q = window.query(
        notificationsCol,
        window.where('timestamp', '>', fiveMinutesAgo.toISOString())
      );
      
      // Realtime listener
      const unsubscribe = window.onSnapshot(q, (snapshot) => {
        console.log('Snapshot alƒ±ndƒ±, deƒüi≈üiklik sayƒ±sƒ±:', snapshot.docChanges().length);
        
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'added') {
            const data = change.doc.data();
            console.log('Yeni bildirim:', data);
            
            // Kendi i≈ülemini bildirim olarak g√∂sterme
            const currentPin = window.__SESSION?.pin;
            if (data.pin === currentPin) {
              console.log('Kendi i≈ülemi, bildirim g√∂sterilmeyecek');
              return;
            }
            
            const userName = data.userName || 'Kullanƒ±cƒ±';
            const action = data.type === 'in' ? 'Gƒ∞Rƒ∞≈û' : '√áIKI≈û';
            const time = data.time || '';
            
            showBrowserNotification(
              `${action} Bildirimi`,
              `${userName} ${action} yaptƒ± (${time})`,
              data.type === 'in' ? '‚úÖ' : '‚ùå'
            );
          }
        });
      }, (error) => {
        console.error('Snapshot dinleme hatasƒ±:', error);
      });
      
      return unsubscribe;
    }
    
    async function sendAttendanceNotification(pin, userName, type, time) {
      try {
        console.log('Bildirim g√∂nderiliyor...', { pin, userName, type, time });
        
        // Firestore'a kaydet (geriye d√∂n√ºk log i√ßin)
        const notificationsCol = window.collection(window.db, 'attendanceNotifications');
        await window.addDoc(notificationsCol, {
          pin: pin,
          userName: userName,
          type: type,
          time: time,
          timestamp: new Date().toISOString(),
          read: false
        });
        
        // Admin kullanƒ±cƒ±larƒ±n token'larƒ±nƒ± al ve FCM ile bildirim g√∂nder
        await sendFCMToAdmins(userName, type, time);
        
        console.log('Bildirim ba≈üarƒ±yla g√∂nderildi');
      } catch (e) {
        console.error('Bildirim g√∂nderme hatasƒ±:', e);
      }
    }
    
    async function sendFCMToAdmins(userName, type, time) {
      const message = type === 'in' 
        ? `${userName} i≈üe giri≈ü yaptƒ± (${time})`
        : `${userName} i≈üten √ßƒ±kƒ±≈ü yaptƒ± (${time})`;
      
      await sendNotification({
        eventType: 'attendance',
        targetRoles: ['admin'],
        title: type === 'in' ? 'üü¢ ƒ∞≈üe Giri≈ü' : 'üî¥ ƒ∞≈üten √áƒ±kƒ±≈ü',
        body: message
      });
    }
    
    // Genel bildirim g√∂nderme fonksiyonu
    async function sendNotification({ eventType, targetRoles, targetPins, title, body, data = {} }) {
      try {
        console.log('Bildirim g√∂nderiliyor:', { eventType, targetRoles, targetPins, title });
        
        const notificationsCol = window.collection(window.db, 'notifications');
        await window.addDoc(notificationsCol, {
          eventType: eventType,
          targetRoles: targetRoles || [],
          targetPins: targetPins || [],
          title: title,
          body: body,
          data: data,
          timestamp: window.serverTimestamp(),
          createdAt: new Date().toISOString()
        });
        
        console.log('Bildirim isteƒüi olu≈üturuldu');
      } catch (error) {
        console.error('Bildirim g√∂nderme hatasƒ±:', error);
      }
    }
    
    // Global bildirim fonksiyonunu payla≈ü
    window.sendNotification = sendNotification;
    
    // Bildirim alƒ±cƒ±larƒ± - her event i√ßin hangi PIN'lerin bildirim alacaƒüƒ±
    window.notificationRecipients = {
      shelf_product_added: [],
      production_request: [],
      production_completed: [],
      material_request: [],
      material_completed: [],
      attendance: []
    };

    // Bildirim event aktif/pasif durumu
    window.notificationEventStatus = {
      shelf_product_added: true,
      production_request: true,
      production_completed: true,
      material_request: true,
      material_completed: true,
      attendance: true
    };
    
    // Kullanƒ±cƒ± listesini select'lere doldur (sadece Chat ID'si olanlar)
    async function populateNotificationRecipients() {
      try {
        // Firestore'dan Chat ID'si olan kullanƒ±cƒ±larƒ± al
        const telegramUsersSnapshot = await window.getDocs(window.collection(window.db, 'telegramUsers'));
        const usersWithChatId = [];
        
        telegramUsersSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.chatId && data.chatId.trim()) {
            usersWithChatId.push({
              pin: data.pin,
              name: data.name,
              role: data.role,
              chatId: data.chatId
            });
          }
        });
        
        console.log(`üîî ${usersWithChatId.length} kullanƒ±cƒ±nƒ±n Chat ID'si var`, usersWithChatId);
        
        // Her event i√ßin select'i doldur
        const events = ['shelf_product_added', 'production_request', 'production_completed', 
                        'material_request', 'material_completed', 'attendance'];
        
        events.forEach(eventType => {
          const select = document.getElementById(`notify_${eventType}`);
          if (select) {
            select.innerHTML = '';
            
            if (usersWithChatId.length === 0) {
              const option = document.createElement('option');
              option.disabled = true;
              option.textContent = '‚ö†Ô∏è Hen√ºz Chat ID eklenmi≈ü kullanƒ±cƒ± yok';
              select.appendChild(option);
            } else {
              usersWithChatId.forEach(user => {
                const option = document.createElement('option');
                option.value = user.pin;
                option.textContent = `${user.name} (${user.role.toUpperCase()} - ${user.pin})`;
                select.appendChild(option);
              });
            }
          }
        });
        
        // Kayƒ±tlƒ± se√ßimleri y√ºkle
        await loadNotificationRecipients();
      } catch (error) {
        console.error('Bildirim alƒ±cƒ±larƒ± y√ºkleme hatasƒ±:', error);
      }
    }
    
    // Firestore'dan bildirim alƒ±cƒ±larƒ±nƒ± y√ºkle
    async function loadNotificationRecipients() {
      try {
        const configDoc = await window.getDoc(window.doc(window.db, 'config', 'notificationRecipients'));
        if (configDoc.exists()) {
          const data = configDoc.data();
          Object.assign(window.notificationRecipients, data);
          console.log('üì• Bildirim alƒ±cƒ±larƒ± y√ºklendi:', window.notificationRecipients);
          
          // Select'lerdeki se√ßimleri g√ºncelle
          Object.entries(window.notificationRecipients).forEach(([eventType, pins]) => {
            const select = document.getElementById(`notify_${eventType}`);
            if (select && pins) {
              Array.from(select.options).forEach(option => {
                option.selected = pins.includes(option.value);
              });
            }
          });
        }
        
        // Event durumlarƒ±nƒ± y√ºkle
        const statusDoc = await window.getDoc(window.doc(window.db, 'config', 'notificationEventStatus'));
        if (statusDoc.exists()) {
          const data = statusDoc.data();
          Object.assign(window.notificationEventStatus, data);
          console.log('üì• Bildirim event durumlarƒ± y√ºklendi:', window.notificationEventStatus);
          
          // Checkbox'larƒ± g√ºncelle
          document.querySelectorAll('[data-event]').forEach(checkbox => {
            const eventType = checkbox.getAttribute('data-event');
            checkbox.checked = window.notificationEventStatus[eventType] !== false;
          });
        }
      } catch (error) {
        console.error('Bildirim ayarlarƒ± y√ºkleme hatasƒ±:', error);
      }
    }
    
    // T√ºm bildirim alƒ±cƒ±larƒ±nƒ± kaydet (Toplu)
    window.saveAllNotificationRecipients = async function() {
      const statusDiv = document.getElementById('notificationSaveStatus');
      if (!statusDiv) return;
      
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.color = '#856404';
      statusDiv.innerHTML = '‚è≥ Kaydediliyor...';
      
      try {
        // T√ºm event tiplerini d√∂ng√ºyle kontrol et
        const events = ['shelf_product_added', 'production_request', 'production_completed', 
                        'material_request', 'material_completed', 'attendance'];
        
        events.forEach(eventType => {
          const select = document.getElementById(`notify_${eventType}`);
          if (select) {
            const selectedPins = Array.from(select.selectedOptions).map(opt => opt.value);
            window.notificationRecipients[eventType] = selectedPins;
            console.log(`üìù ${eventType}: ${selectedPins.length} kullanƒ±cƒ± se√ßildi`, selectedPins);
          }
        });
        
        // Firestore'a kaydet
        await window.setDoc(
          window.doc(window.db, 'config', 'notificationRecipients'),
          window.notificationRecipients,
          { merge: true }
        );
        
        console.log('‚úÖ T√ºm bildirim alƒ±cƒ±larƒ± kaydedildi:', window.notificationRecipients);
        
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.innerHTML = '‚úÖ Bildirim alƒ±cƒ±larƒ± ba≈üarƒ±yla kaydedildi!';
        
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
        
      } catch (error) {
        console.error('Bildirim alƒ±cƒ±larƒ± kaydetme hatasƒ±:', error);
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.innerHTML = '‚ùå Hata: ' + error.message;
      }
    };
    
    // Bildirim alƒ±cƒ±larƒ±nƒ± kaydet (tekli - eski fonksiyon, geriye d√∂n√ºk uyumluluk i√ßin)
    window.saveNotificationRecipients = async function(eventType, selectElement) {
      const selectedPins = Array.from(selectElement.selectedOptions).map(opt => opt.value);
      window.notificationRecipients[eventType] = selectedPins;
      
      try {
        await window.setDoc(
          window.doc(window.db, 'config', 'notificationRecipients'),
          window.notificationRecipients,
          { merge: true }
        );
        console.log(`‚úÖ Bildirim alƒ±cƒ±larƒ± g√ºncellendi: ${eventType}`, selectedPins);
        console.log('üì§ Firestore\'a kaydedildi:', window.notificationRecipients);
      } catch (error) {
        console.error('Bildirim alƒ±cƒ±larƒ± kaydetme hatasƒ±:', error);
      }
    };
    
    // Event aktif/pasif durumu deƒüi≈ütir
    window.toggleNotificationEventStatus = async function(checkbox) {
      const eventType = checkbox.getAttribute('data-event');
      window.notificationEventStatus[eventType] = checkbox.checked;
      
      try {
        await window.setDoc(
          window.doc(window.db, 'config', 'notificationEventStatus'),
          window.notificationEventStatus,
          { merge: true }
        );
        console.log(`‚úÖ Bildirim event durumu: ${eventType} = ${checkbox.checked}`);
        console.log('üì§ Firestore\'a kaydedildi:', window.notificationEventStatus);
      } catch (error) {
        console.error('Event durumu kaydetme hatasƒ±:', error);
      }
    };
    
    // Not: Bildirim ayarlarƒ± Firebase ba≈ülatƒ±lƒ±rken y√ºkleniyor (yukarƒ±da)
    
    // Eski fonksiyon - geriye uyumluluk i√ßin
    window.toggleNotificationRule = function(checkbox) {
      toggleNotificationEventStatus(checkbox);
    };

    // LocalStorage'dan eski kurallarƒ± y√ºkle (migration i√ßin)
    function loadNotificationRules() {
      const saved = localStorage.getItem('notificationRules');
      if (saved) {
        try {
          const oldRules = JSON.parse(saved);
          Object.assign(notificationEventStatus, oldRules);
        } catch (e) {}
      }
    }

    // Telegram Bot Token kaydet
    window.saveBotToken = async function() {
      const statusDiv = document.getElementById('telegramSetupStatus');
      const tokenInput = document.getElementById('telegramBotToken');
      const botToken = tokenInput.value.trim();
      
      if (!botToken) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#ffebee';
        statusDiv.style.color = '#c62828';
        statusDiv.innerHTML = '‚ùå Bot token bo≈ü olamaz!';
        return;
      }
      
      if (!botToken.match(/^\d+:[A-Za-z0-9_-]+$/)) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#ffebee';
        statusDiv.style.color = '#c62828';
        statusDiv.innerHTML = '‚ùå Ge√ßersiz bot token formatƒ±! Format: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz';
        return;
      }
      
      try {
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--panel2)';
        statusDiv.style.color = 'inherit';
        statusDiv.innerHTML = '‚è≥ Bot token kaydediliyor...';
        
        // Firestore config koleksiyonuna kaydet
        await window.setDoc(
          window.doc(window.db, 'config', 'telegram'),
          { botToken: botToken, updatedAt: new Date().toISOString() },
          { merge: true }
        );
        
        statusDiv.style.background = '#e8f5e9';
        statusDiv.style.color = '#2e7d32';
        statusDiv.innerHTML = '‚úÖ Bot token ba≈üarƒ±yla kaydedildi!<br><br>≈ûimdi botunuza Telegram\'dan bir mesaj g√∂nderin ve "Chat ID Al" butonuna basƒ±n.';
        
        console.log('Bot token kaydedildi');
      } catch (error) {
        console.error('Bot token kaydetme hatasƒ±:', error);
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#ffebee';
        statusDiv.style.color = '#c62828';
        statusDiv.innerHTML = '‚ùå Hata: ' + error.message;
      }
    };
    
    // Telegram Chat ID al ve kaydet
    window.getTelegramChatId = async function() {
      const statusDiv = document.getElementById('telegramSetupStatus');
      
      try {
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--panel2)';
        statusDiv.style.color = 'inherit';
        statusDiv.innerHTML = '‚è≥ Bot token alƒ±nƒ±yor...';
        
        // Firestore'dan bot token'ƒ± al
        const configDoc = await window.getDoc(window.doc(window.db, 'config', 'telegram'));
        if (!configDoc.exists() || !configDoc.data().botToken) {
          statusDiv.style.background = '#ffebee';
          statusDiv.style.color = '#c62828';
          statusDiv.innerHTML = '‚ùå √ñnce bot token kaydetmelisiniz!';
          return;
        }
        
        const botToken = configDoc.data().botToken;
        
        statusDiv.innerHTML = '‚è≥ Telegram API ile ileti≈üime ge√ßiliyor...';
        
        // Telegram getUpdates API ile mesajlarƒ± al
        const response = await fetch(`https://api.telegram.org/bot${botToken}/getUpdates`);
        const data = await response.json();
        
        if (!data.ok) {
          statusDiv.style.background = '#ffebee';
          statusDiv.style.color = '#c62828';
          statusDiv.innerHTML = '‚ùå Telegram API hatasƒ±: ' + (data.description || 'Bilinmeyen hata');
          return;
        }
        
        if (!data.result || data.result.length === 0) {
          statusDiv.style.background = '#fff3e0';
          statusDiv.style.color = '#e65100';
          statusDiv.innerHTML = '‚ö†Ô∏è Hi√ß mesaj bulunamadƒ±!<br><br>Botunuza Telegram\'dan herhangi bir mesaj g√∂nderin ve tekrar deneyin.';
          return;
        }
        
        // Son mesajdan chat ID al
        const lastMessage = data.result[data.result.length - 1];
        const chatId = lastMessage.message?.chat?.id || lastMessage.message?.from?.id;
        const firstName = lastMessage.message?.chat?.first_name || lastMessage.message?.from?.first_name || 'Kullanƒ±cƒ±';
        
        if (!chatId) {
          statusDiv.style.background = '#ffebee';
          statusDiv.style.color = '#c62828';
          statusDiv.innerHTML = '‚ùå Chat ID alƒ±namadƒ±!';
          return;
        }
        
        statusDiv.innerHTML = `‚è≥ Chat ID bulundu: ${chatId}<br>Kaydediliyor...`;
        
        // Firestore'a kullanƒ±cƒ± kaydƒ± ekle
        const pin = window.__SESSION?.pin;
        const role = window.__SESSION?.role;
        
        if (!pin || !role) {
          statusDiv.style.background = '#ffebee';
          statusDiv.style.color = '#c62828';
          statusDiv.innerHTML = '‚ùå Kullanƒ±cƒ± bilgileri bulunamadƒ±! Giri≈ü yapmalƒ±sƒ±nƒ±z.';
          return;
        }
        
        await window.setDoc(
          window.doc(window.db, 'telegramUsers', pin),
          {
            chatId: chatId,
            pin: pin,
            role: role,
            firstName: firstName,
            updatedAt: new Date().toISOString()
          },
          { merge: true }
        );
        
        statusDiv.style.background = '#e8f5e9';
        statusDiv.style.color = '#2e7d32';
        statusDiv.innerHTML = `‚úÖ Ba≈üarƒ±yla kaydedildi!<br><br>` +
          `üë§ ƒ∞sim: ${firstName}<br>` +
          `üÜî Chat ID: ${chatId}<br>` +
          `üëî Rol: ${role}<br>` +
          `üìç PIN: ${pin}<br><br>` +
          `üéâ Artƒ±k Telegram bildirimleriniz gelecek!`;
        
        console.log('Chat ID kaydedildi:', { chatId, pin, role });
        
      } catch (error) {
        console.error('Chat ID alma hatasƒ±:', error);
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#ffebee';
        statusDiv.style.color = '#c62828';
        statusDiv.innerHTML = '‚ùå Hata: ' + error.message;
      }
    };

    // iOS Test butonu -> Telegram Test
    window.testIOSNotification = async function() {
      try {
        console.log('üß™ Test Telegram bildirimi ba≈ülatƒ±lƒ±yor...');
        
        // 1. Bot Token kontrol√º
        const botTokenDoc = await window.getDoc(window.doc(window.db, 'config', 'telegram'));
        const botToken = botTokenDoc.exists() ? botTokenDoc.data().botToken : null;
        console.log('üîë Bot Token:', botToken ? '‚úÖ Var' : '‚ùå YOK!');
        
        if (!botToken) {
          alert('‚ùå Bot Token kayƒ±tlƒ± deƒüil! L√ºtfen Telegram Bot Token\'ƒ± ekleyin.');
          return;
        }
        
        // 2. Telegram kullanƒ±cƒ±larƒ± kontrol√º
        const telegramUsersSnapshot = await window.getDocs(window.collection(window.db, 'telegramUsers'));
        console.log('üë• Telegram Kullanƒ±cƒ±larƒ±:', telegramUsersSnapshot.size);
        
        const users = [];
        telegramUsersSnapshot.forEach(doc => {
          const data = doc.data();
          users.push(`${data.name} (${data.pin}): ${data.chatId}`);
          console.log(`  - ${data.name} (${data.pin}): ${data.chatId}`);
        });
        
        if (telegramUsersSnapshot.size === 0) {
          alert('‚ùå Hi√ß Telegram kullanƒ±cƒ±sƒ± kayƒ±tlƒ± deƒüil! Chat ID ekleyin.');
          return;
        }
        
        // 3. Bildirim alƒ±cƒ±larƒ± kontrol√º
        console.log('üìã Kayƒ±tlƒ± Bildirim Alƒ±cƒ±larƒ±:', window.notificationRecipients);
        
        // 4. Test bildirimi olu≈ütur
        console.log('üì§ Firestore\'a bildirim ekleniyor...');
        const notificationData = {
          eventType: 'test',
          title: 'üß™ Test Bildirimi',
          body: `Test mesajƒ± - ${new Date().toLocaleTimeString('tr-TR')}`,
          targetRoles: ['admin', 'packer', 'welder', 'laser'],
          targetPins: [],
          timestamp: window.serverTimestamp(),
          createdAt: new Date().toISOString()
        };
        
        const notifRef = await window.addDoc(
          window.collection(window.db, 'notifications'),
          notificationData
        );
        
        console.log('‚úÖ Bildirim olu≈üturuldu:', notifRef.id);
        
        alert(`‚úÖ Test bildirimi olu≈üturuldu!\n\n` +
              `Bildirim ID: ${notifRef.id}\n` +
              `Bot Token: ${botToken ? 'Var' : 'Yok'}\n` +
              `Kullanƒ±cƒ± Sayƒ±sƒ±: ${telegramUsersSnapshot.size}\n\n` +
              `Telegram'ƒ±nƒ±zƒ± kontrol edin!\n\n` +
              `Kullanƒ±cƒ±lar:\n${users.join('\n')}`);
        
      } catch (error) {
        console.error('‚ùå Test bildirimi hatasƒ±:', error);
        alert('‚ùå Hata: ' + error.message);
      }
    };

    // Kullanƒ±cƒ± Telegram listesini doldur
    async function populateTelegramUsersTable() {
      const tbody = document.getElementById('telegramUsersTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:12px;">‚è≥ Y√ºkleniyor...</td></tr>';
      
      try {
        // Firestore'dan mevcut Chat ID'leri al
        const telegramUsersSnapshot = await window.getDocs(window.collection(window.db, 'telegramUsers'));
        const savedChatIds = {};
        
        telegramUsersSnapshot.forEach(doc => {
          const data = doc.data();
          savedChatIds[data.pin] = data.chatId;
        });
        
        // T√ºm kullanƒ±cƒ±larƒ± listele
        const rows = [];
        Object.entries(PIN_NAMES).forEach(([pin, name]) => {
          const role = getRoleByPin(pin);
          if (role) {
            const roleNames = {
              'admin': 'Y√∂netici',
              'packer': 'Paket√ßi',
              'welder': 'Kaynak√ßƒ±',
              'laser': 'Lazerci',
              'stower': 'Stok√ßu',
              'purchase': 'Satƒ±n Alma',
              'painter': 'Boyacƒ±',
              'commission': 'Komisyon'
            };
            
            rows.push(`
              <tr>
                <td style="padding:10px;border:1px solid var(--border);">${name}</td>
                <td style="padding:10px;border:1px solid var(--border);">${roleNames[role] || role}</td>
                <td style="padding:10px;border:1px solid var(--border);"><code>${pin}</code></td>
                <td style="padding:10px;border:1px solid var(--border);">
                  <input type="text" 
                    id="chatid_${pin}" 
                    value="${savedChatIds[pin] || ''}" 
                    placeholder="123456789"
                    style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;font-family:monospace;font-size:12px;">
                </td>
                <td style="padding:10px;border:1px solid var(--border);text-align:center;">
                  ${savedChatIds[pin] ? '<span style="color:#4CAF50;">‚úÖ</span>' : '<span style="color:#999;">‚ö™</span>'}
                </td>
              </tr>
            `);
          }
        });
        
        tbody.innerHTML = rows.join('');
      } catch (error) {
        console.error('Kullanƒ±cƒ± listesi y√ºkleme hatasƒ±:', error);
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:12px;color:#f44336;">‚ùå Hata: ${error.message}</td></tr>`;
      }
    }
    
    // Telegram kullanƒ±cƒ±larƒ±nƒ± kaydet
    window.saveTelegramUsers = async function() {
      const statusDiv = document.getElementById('telegramUsersStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '‚è≥ Kaydediliyor...';
      
      try {
        let savedCount = 0;
        const updates = [];
        
        // T√ºm input'larƒ± tara
        Object.entries(PIN_NAMES).forEach(([pin, name]) => {
          const input = document.getElementById(`chatid_${pin}`);
          if (input && input.value.trim()) {
            const chatId = input.value.trim();
            const role = getRoleByPin(pin);
            
            updates.push(
              window.setDoc(
                window.doc(window.db, 'telegramUsers', pin),
                {
                  pin: pin,
                  name: name,
                  role: role,
                  chatId: chatId,
                  updatedAt: new Date().toISOString()
                },
                { merge: true }
              )
            );
            savedCount++;
          }
        });
        
        if (updates.length === 0) {
          statusDiv.style.background = '#fff3cd';
          statusDiv.style.color = '#856404';
          statusDiv.innerHTML = '‚ö†Ô∏è Hi√ß Chat ID girilmemi≈ü!';
          return;
        }
        
        // Toplu kaydet
        await Promise.all(updates);
        
        statusDiv.style.background = '#e8f5e9';
        statusDiv.style.color = '#2e7d32';
        statusDiv.innerHTML = `‚úÖ ${savedCount} kullanƒ±cƒ±nƒ±n Chat ID'si ba≈üarƒ±yla kaydedildi!`;
        
        // Tabloyu yenile
        setTimeout(() => {
          populateTelegramUsersTable();
          statusDiv.style.display = 'none';
        }, 2000);
        
        console.log(`${savedCount} Chat ID kaydedildi`);
        
      } catch (error) {
        console.error('Kaydetme hatasƒ±:', error);
        statusDiv.style.background = '#ffebee';
        statusDiv.style.color = '#c62828';
        statusDiv.innerHTML = '‚ùå Hata: ' + error.message;
      }
    };
    
    // Admin ise tabloyu doldur
    if (window.__SESSION?.role === 'admin') {
      setTimeout(populateTelegramUsersTable, 500);
    }
    
    // Test fonksiyonlarƒ±
    window.testNotification = function() {
      console.log('Test bildirimi g√∂nderiliyor...');
      showBrowserNotification('Test Bildirimi', 'Bu bir test bildirimidir. Eƒüer bunu g√∂r√ºyorsanƒ±z, bildirimler √ßalƒ±≈üƒ±yor!');
    };
    
    window.checkNotificationStatus = function() {
      const statusDiv = document.getElementById('notificationStatus');
      statusDiv.style.display = 'block';
      
      let html = '<strong>Bildirim Sistemi Durumu:</strong><br><br>';
      html += '‚úì Notification API: ' + ('Notification' in window ? 'Destekleniyor ‚úÖ' : 'Desteklenmiyor ‚ùå') + '<br>';
      html += '‚úì ƒ∞zin Durumu: ' + Notification.permission + '<br>';
      html += '‚úì onSnapshot: ' + (typeof window.onSnapshot === 'function' ? 'Y√ºklendi ‚úÖ' : 'Y√ºklenmedi ‚ùå') + '<br>';
      html += '‚úì Firebase DB: ' + (window.db ? 'Baƒülƒ± ‚úÖ' : 'Baƒülƒ± Deƒüil ‚ùå') + '<br>';
      html += '‚úì Rol: ' + (window.__SESSION?.role || 'Bilinmiyor') + '<br>';
      html += '‚úì PIN: ' + (window.__SESSION?.pin || 'Bilinmiyor') + '<br>';
      
      statusDiv.innerHTML = html;
    };
    
  </script>

</body>
</html>
